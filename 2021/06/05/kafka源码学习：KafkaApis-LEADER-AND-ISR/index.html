<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icons/favicon-16x16.png?v=2.6.2" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/favicon-32x32.png?v=2.6.2" type="image/png" sizes="32x32"><meta name="google-site-verification" content="hnyb1jnM5Q6co65Dc7FMFxsxfL0wQ_aH1"><meta name="msvalidate.01" content="F2FFFBA1A6155C91A31EAC77F525BBD5"><meta name="baidu-site-verification" content="code-v7NaUITwkJ"><meta name="360-site-verification" content="cd75d354b11109d6f9f4ed94aff26cd6"><meta name="description" content="本文源码基于kafka 0.10.2版本  ​    每当controller发生状态变更时，都会通过调用sendRequestsToBrokers方法发送leaderAndIsrRequest请求，本文主要介绍kafka服务端处理该请求的逻辑和过程。"><meta property="og:type" content="article"><meta property="og:title" content="kafka源码学习：KafkaApis-LEADER_AND_ISR"><meta property="og:url" content="http://fxbing.github.io/2021/06/05/kafka%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%EF%BC%9AKafkaApis-LEADER-AND-ISR/index.html"><meta property="og:site_name" content="小兵的博客"><meta property="og:description" content="本文源码基于kafka 0.10.2版本  ​    每当controller发生状态变更时，都会通过调用sendRequestsToBrokers方法发送leaderAndIsrRequest请求，本文主要介绍kafka服务端处理该请求的逻辑和过程。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://fxbing.github.io/2021/06/05/kafka%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%EF%BC%9AKafkaApis-LEADER-AND-ISR/%E6%B5%81%E7%A8%8B%E5%9B%BE.png"><meta property="article:published_time" content="2021-06-05T10:00:12.000Z"><meta property="article:modified_time" content="2021-06-05T12:09:27.405Z"><meta property="article:author" content="fxbing"><meta property="article:tag" content="kafka"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http://fxbing.github.io/2021/06/05/kafka%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%EF%BC%9AKafkaApis-LEADER-AND-ISR/%E6%B5%81%E7%A8%8B%E5%9B%BE.png"><title>kafka源码学习：KafkaApis-LEADER_AND_ISR | 小兵的博客</title><link ref="canonical" href="http://fxbing.github.io/2021/06/05/kafka%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%EF%BC%9AKafkaApis-LEADER-AND-ISR/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.2"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="dns-prefetch" href="https://hm.baidu.com"><script src="https://www.googletagmanager.com/gtag/js?id=139855287" async></script><script>function gtag(){dataLayer.push(arguments)}"localhost"!==window.location.hostname&&(window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","139855287"))</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?e195e7c765ecde120b81d5afafa26e4b",e.async=!0;var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>var Stun=window.Stun||{},CONFIG={root:"/",algolia:void 0,assistSearch:void 0,fontIcon:{prompt:{success:"fas fa-check-circle",info:"fas fa-arrow-circle-right",warning:"fas fa-exclamation-circle",error:"fas fa-times-circle"},copyBtn:"fas fa-copy"},sidebar:{offsetTop:"20px",tocMaxDepth:6},header:void 0,postWidget:{endText:!0},nightMode:{enable:!0},back2top:{enable:!0},codeblock:{style:"carbon",highlight:"ocean",wordWrap:!1},reward:!1,fancybox:!1,zoomImage:{gapAside:"20px"},galleryWaterfall:void 0,lazyload:!1,pjax:void 0,externalLink:{icon:{enable:!0,name:"fas fa-external-link-alt"}},shortcuts:void 0,prompt:{copyButton:"复制",copySuccess:"复制成功",copyError:"复制失败"},sourcePath:{js:"js",css:"css",images:"images"}};window.CONFIG=CONFIG</script><meta name="generator" content="Hexo 5.4.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner header-inner--height header-inner--bgcolor"><nav class="header-nav header-nav--sticky"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">归档</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">标签</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/about/"><span class="header-nav-menu-item__icon"><i class="fas fa-user"></i></span><span class="header-nav-menu-item__text">关于</span></a></div></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">kafka源码学习：KafkaApis-LEADER_AND_ISR</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-06-05</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-06-05</span></span></div></header><div class="post-body"><blockquote><p>本文源码基于kafka 0.10.2版本</p></blockquote><p>​ 每当controller发生状态变更时，都会通过调用<code>sendRequestsToBrokers</code>方法发送<code>leaderAndIsrRequest</code>请求，本文主要介绍kafka服务端处理该请求的逻辑和过程。</p><span id="more"></span><h1 id="LEADER-AND-ISR"><a href="#LEADER-AND-ISR" class="heading-link"><i class="fas fa-link"></i></a><a href="#LEADER-AND-ISR" class="headerlink" title="LEADER_AND_ISR"></a>LEADER_AND_ISR</h1><h2 id="整体逻辑流程"><a href="#整体逻辑流程" class="heading-link"><i class="fas fa-link"></i></a><a href="#整体逻辑流程" class="headerlink" title="整体逻辑流程"></a>整体逻辑流程</h2><figure class="highlight scala"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">LEADER_AND_ISR</span> =&gt; handleLeaderAndIsrRequest(request)</span><br></pre></td></tr></table></div></figure><p>在server端收到LEADER_AND_ISR请求后，会调用<code>handleLeaderAndIsrRequest</code>方法进行处理，该方法的处理流程如图所示：</p><p><img src="%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt="流程图"></p><h2 id="源码"><a href="#源码" class="heading-link"><i class="fas fa-link"></i></a><a href="#源码" class="headerlink" title="源码"></a>源码</h2><h3 id="handleLeaderAndIsrRequest"><a href="#handleLeaderAndIsrRequest" class="heading-link"><i class="fas fa-link"></i></a><a href="#handleLeaderAndIsrRequest" class="headerlink" title="handleLeaderAndIsrRequest"></a>handleLeaderAndIsrRequest</h3><p><code>handleLeaderAndIsrRequest</code>函数的逻辑结果主要分为以下几个部分：</p><ol><li>构造callback函数<code>onLeadershipChange</code>,用来回调coordinator处理新增的leader或者follower节点</li><li>校验请求权限，如果校验成功调用<code>replicaManager.becomeLeaderOrFollower(correlationId, leaderAndIsrRequest, metadataCache, onLeadershipChange)</code>进行后续处理【此处该函数的主流程】，否则，直接返回错误码<code>Errors.CLUSTER_AUTHORIZATION_FAILED.code</code></li></ol><figure class="highlight scala"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handleLeaderAndIsrRequest</span></span>(request: <span class="type">RequestChannel</span>.<span class="type">Request</span>) &#123;</span><br><span class="line">    <span class="comment">// ensureTopicExists is only for client facing requests</span></span><br><span class="line">    <span class="comment">// We can&#x27;t have the ensureTopicExists check here since the controller sends it as an advisory to all brokers so they</span></span><br><span class="line">    <span class="comment">// stop serving data to clients for the topic being deleted</span></span><br><span class="line">    <span class="keyword">val</span> correlationId = request.header.correlationId</span><br><span class="line">    <span class="keyword">val</span> leaderAndIsrRequest = request.body.asInstanceOf[<span class="type">LeaderAndIsrRequest</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">onLeadershipChange</span></span>(updatedLeaders: <span class="type">Iterable</span>[<span class="type">Partition</span>], updatedFollowers: <span class="type">Iterable</span>[<span class="type">Partition</span>]) &#123;</span><br><span class="line">        <span class="comment">// for each new leader or follower, call coordinator to handle consumer group migration.</span></span><br><span class="line">        <span class="comment">// this callback is invoked under the replica state change lock to ensure proper order of</span></span><br><span class="line">        <span class="comment">// leadership changes</span></span><br><span class="line">        updatedLeaders.foreach &#123; partition =&gt;</span><br><span class="line">          <span class="keyword">if</span> (partition.topic == <span class="type">Topic</span>.<span class="type">GroupMetadataTopicName</span>)</span><br><span class="line">            coordinator.handleGroupImmigration(partition.partitionId)</span><br><span class="line">        &#125;</span><br><span class="line">        updatedFollowers.foreach &#123; partition =&gt;</span><br><span class="line">          <span class="keyword">if</span> (partition.topic == <span class="type">Topic</span>.<span class="type">GroupMetadataTopicName</span>)</span><br><span class="line">            coordinator.handleGroupEmigration(partition.partitionId)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">val</span> leaderAndIsrResponse =</span><br><span class="line">        <span class="keyword">if</span> (authorize(request.session, <span class="type">ClusterAction</span>, <span class="type">Resource</span>.<span class="type">ClusterResource</span>)) &#123;</span><br><span class="line">          <span class="keyword">val</span> result = replicaManager.becomeLeaderOrFollower(correlationId, leaderAndIsrRequest, metadataCache, onLeadershipChange)</span><br><span class="line">          <span class="keyword">new</span> <span class="type">LeaderAndIsrResponse</span>(result.errorCode, result.responseMap.mapValues(<span class="keyword">new</span> <span class="type">JShort</span>(_)).asJava)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">val</span> result = leaderAndIsrRequest.partitionStates.asScala.keys.map((_, <span class="keyword">new</span> <span class="type">JShort</span>(<span class="type">Errors</span>.<span class="type">CLUSTER_AUTHORIZATION_FAILED</span>.code))).toMap</span><br><span class="line">          <span class="keyword">new</span> <span class="type">LeaderAndIsrResponse</span>(<span class="type">Errors</span>.<span class="type">CLUSTER_AUTHORIZATION_FAILED</span>.code, result.asJava)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      requestChannel.sendResponse(<span class="keyword">new</span> <span class="type">Response</span>(request, leaderAndIsrResponse))</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> e: <span class="type">KafkaStorageException</span> =&gt;</span><br><span class="line">        fatal(<span class="string">&quot;Disk error during leadership change.&quot;</span>, e)</span><br><span class="line">        <span class="type">Runtime</span>.getRuntime.halt(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></div></figure><h3 id="becomeLeaderOrFollower"><a href="#becomeLeaderOrFollower" class="heading-link"><i class="fas fa-link"></i></a><a href="#becomeLeaderOrFollower" class="headerlink" title="becomeLeaderOrFollower"></a>becomeLeaderOrFollower</h3><p><code>ReplicaManager</code>的主要工作有以下几个部分，具体代码位置见中文注释：</p><ol><li>校验controller epoch是否合规，只处理比自己epoch大且本地有副本的tp的请求</li><li>调用<code>makeLeaders</code>和<code>makeFollowers</code>方法构造新增的leader partition和follower partition【此处为主要逻辑，后面小结详细介绍】</li><li>如果是第一次收到请求，启动定时更新hw的线程</li><li>停掉空的Fetcher线程</li><li>调用回调函数，coordinator处理新增的leader partition和follower partition</li></ol><figure class="highlight scala"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">becomeLeaderOrFollower</span></span>(correlationId: <span class="type">Int</span>,leaderAndISRRequest: <span class="type">LeaderAndIsrRequest</span>,</span><br><span class="line">                           metadataCache: <span class="type">MetadataCache</span>,</span><br><span class="line">                           onLeadershipChange: (<span class="type">Iterable</span>[<span class="type">Partition</span>], <span class="type">Iterable</span>[<span class="type">Partition</span>]) =&gt; <span class="type">Unit</span>): <span class="type">BecomeLeaderOrFollowerResult</span> = &#123;</span><br><span class="line">    leaderAndISRRequest.partitionStates.asScala.foreach &#123; <span class="keyword">case</span> (topicPartition, stateInfo) =&gt;</span><br><span class="line">        stateChangeLogger.trace(<span class="string">&quot;Broker %d received LeaderAndIsr request %s correlation id %d from controller %d epoch %d for partition [%s,%d]&quot;</span></span><br><span class="line">                                .format(localBrokerId, stateInfo, correlationId,</span><br><span class="line">                                        leaderAndISRRequest.controllerId, leaderAndISRRequest.controllerEpoch, topicPartition.topic, topicPartition.partition))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//主要代码，构造返回结果</span></span><br><span class="line">    replicaStateChangeLock synchronized &#123;</span><br><span class="line">        <span class="keyword">val</span> responseMap = <span class="keyword">new</span> mutable.<span class="type">HashMap</span>[<span class="type">TopicPartition</span>, <span class="type">Short</span>]</span><br><span class="line">        <span class="comment">//如果controller epoch不正确，直接返回Errors.STALE_CONTROLLER_EPOCH.code错误码</span></span><br><span class="line">        <span class="keyword">if</span> (leaderAndISRRequest.controllerEpoch &lt; controllerEpoch) &#123;</span><br><span class="line">            stateChangeLogger.warn((<span class="string">&quot;Broker %d ignoring LeaderAndIsr request from controller %d with correlation id %d since &quot;</span> +</span><br><span class="line">                                    <span class="string">&quot;its controller epoch %d is old. Latest known controller epoch is %d&quot;</span>).format(localBrokerId, leaderAndISRRequest.controllerId,</span><br><span class="line">                                                                                                                  correlationId, leaderAndISRRequest.controllerEpoch, controllerEpoch))</span><br><span class="line">            <span class="type">BecomeLeaderOrFollowerResult</span>(responseMap, <span class="type">Errors</span>.<span class="type">STALE_CONTROLLER_EPOCH</span>.code)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">val</span> controllerId = leaderAndISRRequest.controllerId</span><br><span class="line">            controllerEpoch = leaderAndISRRequest.controllerEpoch</span><br><span class="line"></span><br><span class="line">            <span class="comment">// First check partition&#x27;s leader epoch</span></span><br><span class="line">            <span class="comment">//校验所有的partition信息，分为以下3种情况：</span></span><br><span class="line">            <span class="comment">//1. 本地不包含该partition，返回Errors.UNKNOWN_TOPIC_OR_PARTITION.code</span></span><br><span class="line">            <span class="comment">//2. 本地包含该partition，controller epoch比本地epoch大，信息正确</span></span><br><span class="line">            <span class="comment">//3. controller epoch比本地epoch小，返回Errors.STALE_CONTROLLER_EPOCH.code</span></span><br><span class="line">            <span class="keyword">val</span> partitionState = <span class="keyword">new</span> mutable.<span class="type">HashMap</span>[<span class="type">Partition</span>, <span class="type">PartitionState</span>]()</span><br><span class="line">            leaderAndISRRequest.partitionStates.asScala.foreach &#123; <span class="keyword">case</span> (topicPartition, stateInfo) =&gt;</span><br><span class="line">                <span class="keyword">val</span> partition = getOrCreatePartition(topicPartition)</span><br><span class="line">                <span class="keyword">val</span> partitionLeaderEpoch = partition.getLeaderEpoch</span><br><span class="line">                <span class="comment">// If the leader epoch is valid record the epoch of the controller that made the leadership decision.</span></span><br><span class="line">                <span class="comment">// This is useful while updating the isr to maintain the decision maker controller&#x27;s epoch in the zookeeper path</span></span><br><span class="line">                <span class="keyword">if</span> (partitionLeaderEpoch &lt; stateInfo.leaderEpoch) &#123;</span><br><span class="line">                    <span class="keyword">if</span>(stateInfo.replicas.contains(localBrokerId))</span><br><span class="line">                    partitionState.put(partition, stateInfo)</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        stateChangeLogger.warn((<span class="string">&quot;Broker %d ignoring LeaderAndIsr request from controller %d with correlation id %d &quot;</span> +</span><br><span class="line">                                                <span class="string">&quot;epoch %d for partition [%s,%d] as itself is not in assigned replica list %s&quot;</span>)</span><br><span class="line">                                               .format(localBrokerId, controllerId, correlationId, leaderAndISRRequest.controllerEpoch,</span><br><span class="line">                                                       topicPartition.topic, topicPartition.partition, stateInfo.replicas.asScala.mkString(<span class="string">&quot;,&quot;</span>)))</span><br><span class="line">                        responseMap.put(topicPartition, <span class="type">Errors</span>.<span class="type">UNKNOWN_TOPIC_OR_PARTITION</span>.code)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// Otherwise record the error code in response</span></span><br><span class="line">                    stateChangeLogger.warn((<span class="string">&quot;Broker %d ignoring LeaderAndIsr request from controller %d with correlation id %d &quot;</span> +</span><br><span class="line">                                            <span class="string">&quot;epoch %d for partition [%s,%d] since its associated leader epoch %d is not higher than the current leader epoch %d&quot;</span>)</span><br><span class="line">                                           .format(localBrokerId, controllerId, correlationId, leaderAndISRRequest.controllerEpoch,</span><br><span class="line">                                                   topicPartition.topic, topicPartition.partition, stateInfo.leaderEpoch, partitionLeaderEpoch))</span><br><span class="line">                    responseMap.put(topicPartition, <span class="type">Errors</span>.<span class="type">STALE_CONTROLLER_EPOCH</span>.code)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//处理leader&amp;follower副本，构造partitionsBecomeLeader和partitionsBecomeFollower供callback处理（coordinator处理）</span></span><br><span class="line">            <span class="keyword">val</span> partitionsTobeLeader = partitionState.filter &#123; <span class="keyword">case</span> (_, stateInfo) =&gt;</span><br><span class="line">                stateInfo.leader == localBrokerId</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">val</span> partitionsToBeFollower = partitionState -- partitionsTobeLeader.keys</span><br><span class="line"></span><br><span class="line">            <span class="keyword">val</span> partitionsBecomeLeader = <span class="keyword">if</span> (partitionsTobeLeader.nonEmpty)</span><br><span class="line">            <span class="comment">// 主要调用</span></span><br><span class="line">            makeLeaders(controllerId, controllerEpoch, partitionsTobeLeader, correlationId, responseMap)</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            <span class="type">Set</span>.empty[<span class="type">Partition</span>]</span><br><span class="line">            <span class="keyword">val</span> partitionsBecomeFollower = <span class="keyword">if</span> (partitionsToBeFollower.nonEmpty)</span><br><span class="line">            <span class="comment">// 主要调用</span></span><br><span class="line">            makeFollowers(controllerId, controllerEpoch, partitionsToBeFollower, correlationId, responseMap, metadataCache)</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            <span class="type">Set</span>.empty[<span class="type">Partition</span>]</span><br><span class="line"></span><br><span class="line">            <span class="comment">// we initialize highwatermark thread after the first leaderisrrequest. This ensures that all the partitions</span></span><br><span class="line">            <span class="comment">// have been completely populated before starting the checkpointing there by avoiding weird race conditions</span></span><br><span class="line">            <span class="comment">// 在第一次收到收到请求后，就会启动Scheduler，定时更新hw checkpoint</span></span><br><span class="line">            <span class="keyword">if</span> (!hwThreadInitialized) &#123;</span><br><span class="line">                startHighWaterMarksCheckPointThread()</span><br><span class="line">                hwThreadInitialized = <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 因为上面更新了元信息，此处检查停掉不必要的Fetcher线程</span></span><br><span class="line">            replicaFetcherManager.shutdownIdleFetcherThreads()</span><br><span class="line">            <span class="comment">// 回调</span></span><br><span class="line">            onLeadershipChange(partitionsBecomeLeader, partitionsBecomeFollower)</span><br><span class="line">            <span class="type">BecomeLeaderOrFollowerResult</span>(responseMap, <span class="type">Errors</span>.<span class="type">NONE</span>.code)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><h3 id="makeLeaders"><a href="#makeLeaders" class="heading-link"><i class="fas fa-link"></i></a><a href="#makeLeaders" class="headerlink" title="makeLeaders"></a>makeLeaders</h3><p>处理新增的leader partition</p><ol><li>停止这些partition的follower线程</li><li>更新这些partition的metadata cache</li><li>构造新增leader集合</li></ol><figure class="highlight scala"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">makeLeaders</span></span>(controllerId: <span class="type">Int</span>,</span><br><span class="line">                          epoch: <span class="type">Int</span>,</span><br><span class="line">                          partitionState: <span class="type">Map</span>[<span class="type">Partition</span>, <span class="type">PartitionState</span>],</span><br><span class="line">                          correlationId: <span class="type">Int</span>,</span><br><span class="line">                          responseMap: mutable.<span class="type">Map</span>[<span class="type">TopicPartition</span>, <span class="type">Short</span>]): <span class="type">Set</span>[<span class="type">Partition</span>] = &#123;</span><br><span class="line">    <span class="comment">// 构造becomeLeaderOrFollower需要的返回结果</span></span><br><span class="line">    <span class="keyword">for</span> (partition &lt;- partitionState.keys)</span><br><span class="line">      responseMap.put(partition.topicPartition, <span class="type">Errors</span>.<span class="type">NONE</span>.code)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> partitionsToMakeLeaders: mutable.<span class="type">Set</span>[<span class="type">Partition</span>] = mutable.<span class="type">Set</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// First stop fetchers for all the partitions</span></span><br><span class="line">      <span class="comment">// 停止Fetcher线程 </span></span><br><span class="line">        replicaFetcherManager.removeFetcherForPartitions(partitionState.keySet.map(_.topicPartition))</span><br><span class="line">      <span class="comment">// Update the partition information to be the leader</span></span><br><span class="line">      <span class="comment">// 构造新增leader partition集合</span></span><br><span class="line">      partitionState.foreach&#123; <span class="keyword">case</span> (partition, partitionStateInfo) =&gt;</span><br><span class="line">        <span class="keyword">if</span> (partition.makeLeader(controllerId, partitionStateInfo, correlationId))</span><br><span class="line">          partitionsToMakeLeaders += partition</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          stateChangeLogger.info((<span class="string">&quot;Broker %d skipped the become-leader state change after marking its partition as leader with correlation id %d from &quot;</span> +</span><br><span class="line">            <span class="string">&quot;controller %d epoch %d for partition %s since it is already the leader for the partition.&quot;</span>)</span><br><span class="line">            .format(localBrokerId, correlationId, controllerId, epoch, partition.topicPartition))</span><br><span class="line">      &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> e: <span class="type">Throwable</span> =&gt;</span><br><span class="line">        partitionState.keys.foreach &#123; partition =&gt;</span><br><span class="line">          <span class="keyword">val</span> errorMsg = (<span class="string">&quot;Error on broker %d while processing LeaderAndIsr request correlationId %d received from controller %d&quot;</span> +</span><br><span class="line">            <span class="string">&quot; epoch %d for partition %s&quot;</span>).format(localBrokerId, correlationId, controllerId, epoch, partition.topicPartition)</span><br><span class="line">          stateChangeLogger.error(errorMsg, e)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Re-throw the exception for it to be caught in KafkaApis</span></span><br><span class="line">        <span class="keyword">throw</span> e</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    partitionsToMakeLeaders</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></div></figure><p><code>partition.makeLeader(controllerId, partitionStateInfo, correlationId)</code>会进行元信息的处理，并更新hw，此方法会调用<code>maybeIncrementLeaderHW</code>函数，该函数会尝试追赶hw：<strong>如果其他副本落后leader不太远，并且比之前的hw大，会延缓hw增长速度，尽可能让其他副本进队。</strong></p><figure class="highlight scala"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">makeLeader</span></span>(controllerId: <span class="type">Int</span>, partitionStateInfo: <span class="type">PartitionState</span>, correlationId: <span class="type">Int</span>): <span class="type">Boolean</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> (leaderHWIncremented, isNewLeader) = inWriteLock(leaderIsrUpdateLock) &#123;</span><br><span class="line">      <span class="keyword">val</span> allReplicas = partitionStateInfo.replicas.asScala.map(_.toInt)</span><br><span class="line">      <span class="comment">// record the epoch of the controller that made the leadership decision. This is useful while updating the isr</span></span><br><span class="line">      <span class="comment">// to maintain the decision maker controller&#x27;s epoch in the zookeeper path</span></span><br><span class="line">      controllerEpoch = partitionStateInfo.controllerEpoch</span><br><span class="line">      <span class="comment">// add replicas that are new</span></span><br><span class="line">      <span class="comment">// 构造新ISR</span></span><br><span class="line">      allReplicas.foreach(replica =&gt; getOrCreateReplica(replica))</span><br><span class="line">      <span class="keyword">val</span> newInSyncReplicas = partitionStateInfo.isr.asScala.map(r =&gt; getOrCreateReplica(r)).toSet</span><br><span class="line">      <span class="comment">// remove assigned replicas that have been removed by the controller</span></span><br><span class="line">      <span class="comment">// 移除所有不在新ISR中的副本</span></span><br><span class="line">      (assignedReplicas.map(_.brokerId) -- allReplicas).foreach(removeReplica)</span><br><span class="line">      inSyncReplicas = newInSyncReplicas</span><br><span class="line">      leaderEpoch = partitionStateInfo.leaderEpoch</span><br><span class="line">      zkVersion = partitionStateInfo.zkVersion</span><br><span class="line">      <span class="comment">//是否第一次成为该partition的leader</span></span><br><span class="line">      <span class="keyword">val</span> isNewLeader =</span><br><span class="line">        <span class="keyword">if</span> (leaderReplicaIdOpt.isDefined &amp;&amp; leaderReplicaIdOpt.get == localBrokerId) &#123;</span><br><span class="line">          <span class="literal">false</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          leaderReplicaIdOpt = <span class="type">Some</span>(localBrokerId)</span><br><span class="line">          <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">val</span> leaderReplica = getReplica().get</span><br><span class="line">      <span class="keyword">val</span> curLeaderLogEndOffset = leaderReplica.logEndOffset.messageOffset</span><br><span class="line">      <span class="keyword">val</span> curTimeMs = time.milliseconds</span><br><span class="line">      <span class="comment">// initialize lastCaughtUpTime of replicas as well as their lastFetchTimeMs and lastFetchLeaderLogEndOffset.</span></span><br><span class="line">      <span class="comment">//新leader初始化</span></span><br><span class="line">      (assignedReplicas - leaderReplica).foreach &#123; replica =&gt;</span><br><span class="line">        <span class="keyword">val</span> lastCaughtUpTimeMs = <span class="keyword">if</span> (inSyncReplicas.contains(replica)) curTimeMs <span class="keyword">else</span> <span class="number">0</span>L</span><br><span class="line">        replica.resetLastCaughtUpTime(curLeaderLogEndOffset, curTimeMs, lastCaughtUpTimeMs)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// we may need to increment high watermark since ISR could be down to 1</span></span><br><span class="line">      <span class="keyword">if</span> (isNewLeader) &#123;</span><br><span class="line">        <span class="comment">// construct the high watermark metadata for the new leader replica</span></span><br><span class="line">        leaderReplica.convertHWToLocalOffsetMetadata()</span><br><span class="line">        <span class="comment">// reset log end offset for remote replicas</span></span><br><span class="line">        assignedReplicas.filter(_.brokerId != localBrokerId).foreach(_.updateLogReadResult(<span class="type">LogReadResult</span>.<span class="type">UnknownLogReadResult</span>))</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//  尝试追赶hw,如果其他副本落后leader不太远，并且比之前的hw大，会延缓hw增长速度，尽可能让其他副本进队</span></span><br><span class="line">      (maybeIncrementLeaderHW(leaderReplica), isNewLeader)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// some delayed operations may be unblocked after HW changed</span></span><br><span class="line">    <span class="comment">//  hw更新后会处理一些request</span></span><br><span class="line">    <span class="keyword">if</span> (leaderHWIncremented)</span><br><span class="line">      tryCompleteDelayedRequests()</span><br><span class="line">    isNewLeader</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></div></figure><h3 id="makeFollowers"><a href="#makeFollowers" class="heading-link"><i class="fas fa-link"></i></a><a href="#makeFollowers" class="headerlink" title="makeFollowers"></a>makeFollowers</h3><p>处理新增的follower partition</p><ol><li>从leaderpartition集合中移除这些partition</li><li>标记为follower，阻止producer请求</li><li>移除Fetcher线程</li><li>根据hw truncate这些partition的本地日志</li><li>清理producer和fetch请求</li><li>如果没有宕机，从新的leader fetch数据</li></ol><figure class="highlight scala"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">makeFollowers</span></span>(controllerId: <span class="type">Int</span>,</span><br><span class="line">                          epoch: <span class="type">Int</span>,</span><br><span class="line">                          partitionState: <span class="type">Map</span>[<span class="type">Partition</span>, <span class="type">PartitionState</span>],</span><br><span class="line">                          correlationId: <span class="type">Int</span>,</span><br><span class="line">                          responseMap: mutable.<span class="type">Map</span>[<span class="type">TopicPartition</span>, <span class="type">Short</span>],</span><br><span class="line">                          metadataCache: <span class="type">MetadataCache</span>) : <span class="type">Set</span>[<span class="type">Partition</span>] = &#123;</span><br><span class="line">    partitionState.keys.foreach &#123; partition =&gt;</span><br><span class="line">        stateChangeLogger.trace((<span class="string">&quot;Broker %d handling LeaderAndIsr request correlationId %d from controller %d epoch %d &quot;</span> +</span><br><span class="line">                                 <span class="string">&quot;starting the become-follower transition for partition %s&quot;</span>)</span><br><span class="line">                                .format(localBrokerId, correlationId, controllerId, epoch, partition.topicPartition))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造becomeLeaderOrFollower需要的返回结果</span></span><br><span class="line">    <span class="keyword">for</span> (partition &lt;- partitionState.keys)</span><br><span class="line">    responseMap.put(partition.topicPartition, <span class="type">Errors</span>.<span class="type">NONE</span>.code)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> partitionsToMakeFollower: mutable.<span class="type">Set</span>[<span class="type">Partition</span>] = mutable.<span class="type">Set</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Delete leaders from LeaderAndIsrRequest</span></span><br><span class="line">        partitionState.foreach&#123; <span class="keyword">case</span> (partition, partitionStateInfo) =&gt;</span><br><span class="line">            <span class="keyword">val</span> newLeaderBrokerId = partitionStateInfo.leader</span><br><span class="line">            metadataCache.getAliveBrokers.find(_.id == newLeaderBrokerId) <span class="keyword">match</span> &#123;</span><br><span class="line">                <span class="comment">// Only change partition state when the leader is available</span></span><br><span class="line">                <span class="keyword">case</span> <span class="type">Some</span>(_) =&gt;</span><br><span class="line">                <span class="comment">// 构造返回结果</span></span><br><span class="line">                <span class="keyword">if</span> (partition.makeFollower(controllerId, partitionStateInfo, correlationId))</span><br><span class="line">                partitionsToMakeFollower += partition</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                stateChangeLogger.info((<span class="string">&quot;Broker %d skipped the become-follower state change after marking its partition as follower with correlation id %d from &quot;</span> +</span><br><span class="line">                                        <span class="string">&quot;controller %d epoch %d for partition %s since the new leader %d is the same as the old leader&quot;</span>)</span><br><span class="line">                                       .format(localBrokerId, correlationId, controllerId, partitionStateInfo.controllerEpoch,</span><br><span class="line">                                               partition.topicPartition, newLeaderBrokerId))</span><br><span class="line">                <span class="keyword">case</span> <span class="type">None</span> =&gt;</span><br><span class="line">                <span class="comment">// The leader broker should always be present in the metadata cache.</span></span><br><span class="line">                <span class="comment">// If not, we should record the error message and abort the transition process for this partition</span></span><br><span class="line">                stateChangeLogger.error((<span class="string">&quot;Broker %d received LeaderAndIsrRequest with correlation id %d from controller&quot;</span> +</span><br><span class="line">                                         <span class="string">&quot; %d epoch %d for partition %s but cannot become follower since the new leader %d is unavailable.&quot;</span>)</span><br><span class="line">                                        .format(localBrokerId, correlationId, controllerId, partitionStateInfo.controllerEpoch,</span><br><span class="line">                                                partition.topicPartition, newLeaderBrokerId))</span><br><span class="line">                <span class="comment">// Create the local replica even if the leader is unavailable. This is required to ensure that we include</span></span><br><span class="line">                <span class="comment">// the partition&#x27;s high watermark in the checkpoint file (see KAFKA-1647)</span></span><br><span class="line">                partition.getOrCreateReplica()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//移除Fetcher线程</span></span><br><span class="line">        replicaFetcherManager.removeFetcherForPartitions(partitionsToMakeFollower.map(_.topicPartition))</span><br><span class="line">        <span class="comment">//根据新hw进行truncate</span></span><br><span class="line">        logManager.truncateTo(partitionsToMakeFollower.map &#123; partition =&gt;</span><br><span class="line">            (partition.topicPartition, partition.getOrCreateReplica().highWatermark.messageOffset)</span><br><span class="line">        &#125;.toMap)</span><br><span class="line">        <span class="comment">//hw更新，尝试处理请求</span></span><br><span class="line">        partitionsToMakeFollower.foreach &#123; partition =&gt;</span><br><span class="line">            <span class="keyword">val</span> topicPartitionOperationKey = <span class="keyword">new</span> <span class="type">TopicPartitionOperationKey</span>(partition.topicPartition)</span><br><span class="line">            tryCompleteDelayedProduce(topicPartitionOperationKey)</span><br><span class="line">            tryCompleteDelayedFetch(topicPartitionOperationKey)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isShuttingDown.get()) &#123;</span><br><span class="line">            partitionsToMakeFollower.foreach &#123; partition =&gt;</span><br><span class="line">                stateChangeLogger.trace((<span class="string">&quot;Broker %d skipped the adding-fetcher step of the become-follower state change with correlation id %d from &quot;</span> +</span><br><span class="line">                                         <span class="string">&quot;controller %d epoch %d for partition %s since it is shutting down&quot;</span>).format(localBrokerId, correlationId,</span><br><span class="line">                                                                                                                     controllerId, epoch, partition.topicPartition))</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// we do not need to check if the leader exists again since this has been done at the beginning of this process</span></span><br><span class="line">            <span class="comment">// 重置fetch位置，加入Fetcher</span></span><br><span class="line">            <span class="keyword">val</span> partitionsToMakeFollowerWithLeaderAndOffset = partitionsToMakeFollower.map(partition =&gt;</span><br><span class="line">                                                                                           partition.topicPartition -&gt; <span class="type">BrokerAndInitialOffset</span>(</span><br><span class="line">                                                                                               metadataCache.getAliveBrokers.find(_.id == partition.leaderReplicaIdOpt.get).get.getBrokerEndPoint(config.interBrokerListenerName),</span><br><span class="line">                                                                                               partition.getReplica().get.logEndOffset.messageOffset)).toMap</span><br><span class="line">            replicaFetcherManager.addFetcherForPartitions(partitionsToMakeFollowerWithLeaderAndOffset)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> e: <span class="type">Throwable</span> =&gt;</span><br><span class="line">        <span class="keyword">val</span> errorMsg = (<span class="string">&quot;Error on broker %d while processing LeaderAndIsr request with correlationId %d received from controller %d &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;epoch %d&quot;</span>).format(localBrokerId, correlationId, controllerId, epoch)</span><br><span class="line">        stateChangeLogger.error(errorMsg, e)</span><br><span class="line">        <span class="comment">// Re-throw the exception for it to be caught in KafkaApis</span></span><br><span class="line">        <span class="keyword">throw</span> e</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    partitionsToMakeFollower</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ 本文结束，感谢您的阅读 ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">本文作者: </span><span class="copyright-author__value"><a href="http://fxbing.github.io">fxbing</a></span></div><div class="copyright-link"><span class="copyright-link__name">本文链接: </span><span class="copyright-link__value"><a href="http://fxbing.github.io/2021/06/05/kafka%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%EF%BC%9AKafkaApis-LEADER-AND-ISR/">http://fxbing.github.io/2021/06/05/kafka%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%EF%BC%9AKafkaApis-LEADER-AND-ISR/</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">版权声明: </span><span class="copyright-notice__value">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" rel="external nofollow" target="_blank">BY-NC-SA</a> 许可协议。转载请注明出处！</span></div></div><div class="post-tags"><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="http://fxbing.github.io/tags/kafka/">kafka</a></span></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/2021/08/15/%E4%BA%8C%E9%9B%B6%E4%BA%8C%E4%B8%80%E5%B9%B4%E4%B8%83%E6%9C%88%E4%B9%A6%E5%8D%95/"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">二零二一年七月书单</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/2021/05/08/%E8%AE%B0%E4%B8%80%E6%AC%A1kafka%E5%AE%95%E6%9C%BA%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/"><span class="paginator-prev__text">记一次kafka宕机问题排查</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div><div class="comments" id="comments"><div id="disqus_thread"></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">文章目录</span><span class="sidebar-nav-ov">站点概览</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#LEADER-AND-ISR"><span class="toc-number">1.</span> <span class="toc-text">LEADER_AND_ISR</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E9%80%BB%E8%BE%91%E6%B5%81%E7%A8%8B"><span class="toc-number">1.1.</span> <span class="toc-text">整体逻辑流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BA%90%E7%A0%81"><span class="toc-number">1.2.</span> <span class="toc-text">源码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#handleLeaderAndIsrRequest"><span class="toc-number">1.2.1.</span> <span class="toc-text">handleLeaderAndIsrRequest</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#becomeLeaderOrFollower"><span class="toc-number">1.2.2.</span> <span class="toc-text">becomeLeaderOrFollower</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#makeLeaders"><span class="toc-number">1.2.3.</span> <span class="toc-text">makeLeaders</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#makeFollowers"><span class="toc-number">1.2.4.</span> <span class="toc-text">makeFollowers</span></a></li></ol></li></ol></li></ol></section><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/uploads/avatar.jpg" alt="avatar"></div><p class="sidebar-ov-author__text">既然生活这么苦，那还不笑一笑让自己开心一点。</p></div><div class="sidebar-ov-social"><a class="sidebar-ov-social-item" href="https://github.com/fxbing" target="_blank" rel="noopener" data-popover="Github" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-github"></i></span></a></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">14</div><div class="sidebar-ov-state-item__name">归档</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">8</div><div class="sidebar-ov-state-item__name">标签</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="知识共享许可协议" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">你已阅读了 </span><span class="sidebar-reading-info__num">0</span><span class="sidebar-reading-info__perc">%</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2021</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>fxbing</span></div><div><span>由 <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> 强力驱动</span><span> v5.4.0</span><span class="footer__devider">|</span><span>主题 - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.6.2</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script>function loadDisqus(){var e,t,i;document.getElementById("disqus_thread")&&(window.DISQUS?DISQUS.reset({reload:!0,config:function(){this.page.url="http://fxbing.github.io/2021/06/05/kafka%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%EF%BC%9AKafkaApis-LEADER-AND-ISR/",this.page.identifier="2021/06/05/kafka源码学习：KafkaApis-LEADER-AND-ISR/",this.page.title="kafka源码学习：KafkaApis-LEADER_AND_ISR"}}):(t=(e=document).createElement("script"),i=e.createElement("script"),t.src="https://fxbingBlog.disqus.com/count.js",t.id="dsq-count-scr",t.async=!0,(e.head||e.body).appendChild(t),i.src="https://fxbingBlog.disqus.com/embed.js",(e.head||e.body).appendChild(i)))}window.addEventListener("DOMContentLoaded",loadDisqus,!1)</script><script src="/js/utils.js?v=2.6.2"></script><script src="/js/stun-boot.js?v=2.6.2"></script><script src="/js/scroll.js?v=2.6.2"></script><script src="/js/header.js?v=2.6.2"></script><script src="/js/sidebar.js?v=2.6.2"></script></body></html>