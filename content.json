{"meta":{"title":"å°å…µçš„åšå®¢","subtitle":null,"description":"æ—¢ç„¶ç”Ÿæ´»è¿™ä¹ˆè‹¦ï¼Œé‚£è¿˜ä¸ç¬‘ä¸€ç¬‘è®©è‡ªå·±å¼€å¿ƒä¸€ç‚¹ã€‚","author":"fxbing","url":"http://fxbing.github.io"},"posts":[{"title":"Kafka å’Œ Pulsar çš„ Compaction å®ç°","slug":"Kafka-å’Œ-Pulsar-çš„-Compaction-å®ç°","date":"2022-05-01T08:34:17.000Z","updated":"2022-05-01T08:42:37.253Z","comments":true,"path":"2022/05/01/Kafka-å’Œ-Pulsar-çš„-Compaction-å®ç°/","link":"","permalink":"http://fxbing.github.io/2022/05/01/Kafka-%E5%92%8C-Pulsar-%E7%9A%84-Compaction-%E5%AE%9E%E7%8E%B0/","excerpt":"\næœ¬æ–‡ä¸»è¦å¯¹ Kafka å’Œ Pulsar çš„ Log Compaction åŸç†è¿›è¡Œä»‹ç»ï¼Œå¹¶ä»¥æˆ‘çš„ç†è§£è¿›è¡Œç®€å•çš„å¯¹æ¯”è¯´æ˜ã€‚","text":"æœ¬æ–‡ä¸»è¦å¯¹ Kafka å’Œ Pulsar çš„ Log Compaction åŸç†è¿›è¡Œä»‹ç»ï¼Œå¹¶ä»¥æˆ‘çš„ç†è§£è¿›è¡Œç®€å•çš„å¯¹æ¯”è¯´æ˜ã€‚ åœ¨ Kafka å’Œ Pulsar ä¸­ï¼Œéƒ½å…·å¤‡ Log Campactionï¼ˆæ—¥å¿—æŒ¤å‹ï¼‰çš„èƒ½åŠ›ï¼ŒCompaction ä¸åŒäº Log Compressionï¼ˆæ—¥å¿—å‹ç¼©ï¼‰ï¼ŒCompaction æ˜¯æŒ‡å°† Topic å†å²æ—¥å¿—ä¸­ç›¸åŒ Key çš„æ¶ˆæ¯åªä¿ç•™æœ€æ–°çš„ä¸€æ¡ï¼Œè€Œ Compression æ˜¯æŒ‡æ¶ˆæ¯ç»´åº¦åˆ©ç”¨å„ç§å‹ç¼©ç®—æ³•ï¼ˆå¦‚ï¼šgzipã€lz4ã€zstdç­‰ï¼‰å‡å°æ¶ˆæ¯å¤§å°ä½†ä¸æ”¹å˜æ¶ˆæ¯å†…å®¹ã€‚Compaction çš„ä½¿ç”¨åœºæ™¯çš„ç‰¹ç‚¹ï¼šä¸€æ˜¯æ¶ˆæ¯æœ‰ keyï¼ŒäºŒæ˜¯ç›¸åŒ key çš„æ¶ˆæ¯åªå…³å¿ƒæœ€æ–°çš„å†…å®¹ï¼Œä¾‹å¦‚ï¼šè®°å½•æ¯æ”¯è‚¡ç¥¨ä»·æ ¼å˜åŠ¨çš„ Topicï¼Œè‚¡ç¥¨åç§°è®¾ç½®ä¸º keyï¼Œè‚¡ç¥¨ä»·æ ¼è®¾ç½®ä¸º valueï¼Œä¸€èˆ¬åªå…³å¿ƒè‚¡ç¥¨çš„æœ€æ–°ä»·æ ¼ã€‚åœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œé…ç½® Compaction å¯ä»¥è®© Topic å­˜å‚¨çš„æ•°æ®æ›´å°‘ï¼Œä»è€Œåœ¨éœ€è¦å…¨é‡è¯»å– Topic å†…å®¹æ—¶é€Ÿåº¦æ›´å¿«ã€‚ Kafka Log Compaction æœ¬æ–‡ä»‹ç»åŸºäº Kafka 2.8ï¼Œå¹¶ä¸”å¿½ç•¥äº†å¹‚ç­‰æ¶ˆæ¯ã€äº‹åŠ¡æ¶ˆæ¯çš„ç›¸å…³å¤„ç†é€»è¾‘ï¼Œå¦‚æœ‰å…´è¶£ï¼Œå¯ä»¥è‡ªè¡Œé˜…è¯»æºç äº†è§£ã€‚ åœ¨ Kafka ä¸­ï¼ŒTopic é…ç½® cleanup.policyç”¨æ¥æ§åˆ¶ Topic çš„æ•°æ®æ¸…ç†ç­–ç•¥ï¼Œè¯¥é…ç½®çš„å¯é€‰å€¼æœ‰ä¸¤ä¸ªï¼šä¸€ä¸ªæ˜¯deleteï¼Œè¡¨ç¤º Topic ä¸­æ•°æ®è¶…è¿‡ä¿ç•™æ—¶é—´æˆ–ä¿ç•™å¤§å°é™åˆ¶æ—¶ï¼Œç›´æ¥åˆ é™¤æœ€æ—§çš„æ•°æ®ï¼›å¦ä¸€ä¸ªæ˜¯compactï¼Œè¡¨ç¤ºå¯¹äº Topic ä¸­çš„æ—§æ•°æ®ï¼ˆé Active Segment ä¸­çš„æ•°æ®ï¼‰æ‰§è¡ŒæŒ¤å‹ï¼Œä¸€å®šèŒƒå›´å†…ï¼Œå¯¹äº key ç›¸åŒï¼ˆæ²¡æœ‰ key çš„æ¶ˆæ¯ä¼šè¢«åˆ é™¤ï¼‰çš„æ¶ˆæ¯ï¼Œåªä¿ç•™æœ€æ–°çš„ä¸€æ¡ã€‚å¯¹äºæ¯ä¸ª Topic å¯ä»¥é€‰æ‹©ä¸€ç§æ¸…ç†ç­–ç•¥è¿›è¡Œé…ç½®ï¼Œä¹Ÿå¯ä»¥åŒæ—¶é…ç½®ä¸¤ç§ç­–ç•¥ã€‚æœ¬æ–‡ä»‹ç»çš„æ˜¯ compactè¿™ä¸ªç­–ç•¥ï¼Œåœ¨ Kafka ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œç”¨æ¥å­˜æ”¾ commit offset ä¿¡æ¯çš„çš„å†…éƒ¨ Topic:__consumer_offsets ä¼šè¢«é…ç½®ä¸ºè¯¥ç­–ç•¥ï¼Œæ™®é€š Topic ä¸€èˆ¬å¾ˆå°‘ä½¿ç”¨ã€‚ å®ç°åŸç† å¯¹äºä¸€å° Kafka Brokerï¼Œ Log Compaction çš„ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š åˆ›å»º LogCleanerï¼Œå¯åŠ¨é…ç½®æŒ‡å®šæ•°é‡çš„ CleanerThreadï¼Œè´Ÿè´£è¯¥ Broker çš„ Log Compactionã€‚ æ¯ä¸ª CleanerThread å¾ªç¯æ‰§è¡Œæ—¥å¿—æ¸…ç†å·¥ä½œï¼Œå¾ªç¯è¿‡ç¨‹å¦‚ä¸‹ï¼š å¯»æ‰¾ä¸€ä¸ªå¾…æ¸…ç†çš„ TopicPartitionã€‚ éå†è¯¥TopicPartition ä¸­æ‰€æœ‰å¾…æ¸…ç†çš„ Segmentï¼Œæ„é€  OffsetMap è®°å½•æ¯ä¸ª key æœ€æ–°çš„ offset åŠå¯¹åº”çš„æ¶ˆæ¯æ—¶é—´ã€‚ å¯¹è¯¥TopicPartition ä¸­æ‰€æœ‰å¾…æ¸…ç†çš„ Segment è¿›è¡Œåˆ†ç»„ï¼Œä¿è¯æ¯ç»„ Segment çš„ Log æ–‡ä»¶æ€»å¤§å°å’Œ Index æ–‡ä»¶æ€»å¤§å°ä¸ä¼šè¶…è¿‡ LogConfig å…è®¸çš„èŒƒå›´å¹¶ä¸”æ¯ç»„ Segment çš„ offset æå·®ä¸ä¼šè¶…è¿‡Int.MaxValueï¼ˆKafka ä¸­ Segment å†…çš„ç›¸å¯¹ offset ä¸ºæ•´å‹ï¼Œè¿™ä¸ªæ£€æŸ¥æ˜¯ä¸ºäº†é¿å…ç›¸å¯¹ offset æº¢å‡ºï¼‰ã€‚ å°† Segment æŒ‰ç…§åˆ†å¥½çš„ç»„è¿›è¡Œæ¸…ç†ï¼Œæ¯ä¸€ç»„ Segment èšåˆä¸ºä¸€ä¸ªæ–°çš„ Segmentã€‚æ¯ç»„ Segment çš„æ¸…ç†è¿‡ç¨‹ä¸ºï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ Segmentï¼Œç„¶åæ ¹æ® OffsetMap ä¸­è®°å½•çš„ä¿¡æ¯é€‰æ‹©éœ€è¦ä¿ç•™çš„æ¶ˆæ¯ï¼Œå­˜å…¥æ–° Segmentï¼Œæœ€åä½¿ç”¨æ–° Segment è¦†ç›–è¿™ä¸€ç»„æ—§ Segmentã€‚ å¯¹äºæ‰€æœ‰å·²ç»æ‰§è¡Œå®Œæˆ Compaction æµç¨‹å¹¶ä¸”cleanup.policyé…ç½®åŒ…å«compactç­–ç•¥çš„ Log è¿›è¡Œåˆ é™¤ï¼Œæœ¬æ¬¡åˆ é™¤ä¸æ˜¯å‰é¢ç”¨ä¸€ä¸ªæ–° Segment æ›¿æ¢ä¸€ç»„æ—§ Segment ä¸­çš„åˆ é™¤ï¼Œè€Œæ˜¯è°ƒç”¨Log.deleteOldSegmentsã€‚è¯¥æ–¹æ³•ä¼šåˆ é™¤LogStartOffsetä¹‹å‰çš„æ‰€æœ‰ Segmentï¼Œå¦‚æœcleanup.policyé…ç½®åŒæ—¶è¿˜åŒ…å«deleteç­–ç•¥ï¼Œä¹Ÿä¼šåˆ é™¤è¶…è¿‡ä¿ç•™æ—¶é—´æˆ–ä¿ç•™å¤§å°é™åˆ¶çš„ Segmentã€‚ è¯¦ç»†è¯´æ˜ ä¸‹é¢ä»¥Q&amp;Açš„æ–¹å¼ä»‹ç»æ—¥å¿—æ¸…ç†çš„ç»†èŠ‚å’Œé€»è¾‘ï¼š å¤šä¸ª CleanerThread æ˜¯å¦‚ä½•ä¿è¯ Compaction è¿‡ç¨‹çº¿ç¨‹å®‰å…¨çš„? Kafka ä¸­ Log Compaction çš„å®ç°ä¸»è¦æ˜¯LogCleanerå’ŒLogCleanerManagerä¸¤ä¸ªç±»ï¼ŒLogCleaneræ˜¯ Compaction å·¥ä½œçš„ä¸»ç±»ï¼Œè´Ÿè´£æ•´ä½“çš„å·¥ä½œæµç¨‹ï¼ŒLogCleanerManagerè´Ÿè´£ Compaction çŠ¶æ€æœºçš„ç®¡ç†ã€‚æ‰€æœ‰çŠ¶æ€å¦‚ä¸‹ï¼š None ï¼šTopicPartition æœªæ¸…ç†çŠ¶æ€ã€‚ LogCleaningInProgress ï¼šæ¸…ç†æ­£åœ¨è¿›è¡Œä¸­ï¼Œå½“ TopicPartition è¢«é€‰ä¸­ä¸ºå¾…æ¸…ç† Log æ—¶ä¼šå˜ä¸ºè¯¥çŠ¶æ€ã€‚ LogCleaningAborted ï¼šæ¸…ç†ä¸­æ­¢ï¼Œè¿™æ˜¯ä¸€ä¸ªä»LogCleaningInProgressåˆ°LogCleaningPaused(1)çš„ä¸­é—´çŠ¶æ€ï¼Œåœ¨å¤–éƒ¨å‘ç”Ÿ truncateã€åç›˜ç­‰æƒ…å†µæ—¶éœ€è¦æ”¾å¼ƒç°åœ¨æ­£åœ¨çš„æ¸…ç†æ“ä½œï¼Œ ç»ˆæ­¢åè¯¥ TopicPartition ä¼šæ ‡è®°ä¸º LogCleaningAbortedã€‚ LogCleaningPaused(i)ï¼šæ¸…ç†æš‚åœï¼Œi çš„åˆå§‹å€¼ä¸º1ï¼Œè¿™æ˜¯ä¸€ä¸ªé‡å…¥çš„çŠ¶æ€ï¼Œå³ï¼šå¦‚æœå½“å‰çŠ¶æ€æ˜¯LogCleaningPaused(i)ï¼Œå†æ¬¡æš‚åœè¯¥ TopicPartition çš„è¯ï¼ŒçŠ¶æ€ä¼šå˜ä¸ºLogCleaningPaused(i+1)ï¼Œä»æš‚åœçŠ¶æ€æ¢å¤çš„è¯ï¼ŒçŠ¶æ€ä¼šå˜ä¸ºLogCleaningPaused(i-1)ï¼ˆi-1=0 æ—¶ç›´æ¥å˜ä¸ºNoneçŠ¶æ€ï¼‰ã€‚ä¼šè§¦å‘çŠ¶æ€å˜ä¸ºLogCleaningPaused(i)çš„æƒ…å†µå¦‚ä¸‹ï¼ˆä¸‹é¢çš„â€œæš‚åœâ€å’Œâ€œæš‚åœæ¢å¤â€åˆ†åˆ«ä»£è¡¨ i + 1 å’Œ i - 1ï¼‰ï¼š Topic é…ç½®cleanup.policyä¸åŒ…å«compactï¼šæš‚åœ å¤–éƒ¨å‘ç”Ÿ truncateã€åç›˜ç­‰æƒ…å†µæ—¶è¯¥ TopicPartition çŠ¶æ€ä¸ºNoneæˆ–LogCleaningPaused(i)ï¼šæš‚åœ æœ¬è½®æ¸…ç†å®Œæˆä¸”è¯¥ TopicPartition çŠ¶æ€ä¸ºLogCleaningAbortedï¼šæš‚åœ è§¦å‘æš‚åœçš„æ“ä½œå®Œæˆï¼šæš‚åœæ¢å¤ æˆ‘ç†è§£ä¸­æ­¢çŠ¶æ€å’Œæš‚åœçŠ¶æ€çš„åŒºåˆ«æ˜¯ï¼šæ˜¯å¦å¯ä»¥åœ¨æœ¬è½®æ¸…ç†ä¸­æ¢å¤ã€‚åœ¨å¤–éƒ¨å‘ç”Ÿ truncateã€åç›˜ç­‰æƒ…å†µæ—¶ï¼Œå¦‚æœä¸€ä¸ª TopicPartition æ²¡æœ‰å¤„äºæ¸…ç†è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥æ ‡è®°ä¸ºæš‚åœï¼Œåœ¨è§¦å‘æš‚åœçš„æƒ…å†µç»“æŸåï¼Œæ¢å¤æ¸…ç†æµç¨‹å°±ä¼šé‡æ–°æ‰§è¡Œæ¸…ç†æµç¨‹ã€‚ä½†æ˜¯å¦‚æœè¯¥ TopicPartition å¤„äºæ¸…ç†è¿‡ç¨‹ä¸­ï¼Œåˆ™å¿…é¡»æ ‡è®°ä¸ºç»ˆæ­¢ï¼Œåœ¨è§¦å‘æš‚åœçš„æƒ…å†µç»“æŸåï¼Œå³ä½¿æœ¬è½®æ¸…ç†æ²¡ç»“æŸï¼Œä¹Ÿå¿…é¡»è¦å…ˆæ ‡è®°ä¸ºæš‚åœï¼Œåœ¨ä¸‹è½®æ“ä½œè¿›è¡Œæ¸…ç†ã€‚è¿™æ˜¯å› ä¸ºå¦‚æœå·²ç»åœ¨æ¸…ç†è¿‡ç¨‹ä¸­äº†ï¼Œæœ¬è½®æ¸…ç†ä¼šæœ‰ä¸€äº›ä¸­é—´æ€çš„ä¿¡æ¯ï¼Œä¸å®¹æ˜“ä»ä¸­é—´æ€è¿›è¡Œæ¢å¤ã€‚ å¯¹äºæ¯ä¸ª CleanerThreadï¼Œæ¯æ¬¡éƒ½ä¼šé€šè¿‡LogCleanerManager.grabFilthiestCompactedLogæ–¹æ³•æ¥æœç´¢çŠ¶æ€ä¸ºNoneå¹¶ä¸”éœ€è¦è¢«æ¸…ç†çš„ TopicPartition è¿›è¡Œæ¸…ç†ã€‚LogCleanerManagerä¸­çš„æ‰€æœ‰çŠ¶æ€å˜æ›´éƒ½ä¼šåŠ é”ï¼Œä¿è¯çŠ¶æ€æœºæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¤šä¸ª CleanerThread é€šè¿‡è¯¥çŠ¶æ€æœºä¿è¯äº†æ‰€æœ‰ TopicPartition çš„ Compaction è¿‡ç¨‹æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ å¦‚ä½•å†³å®šå“ªäº› TopicPartition åº”è¯¥è¢«æ¸…ç†ï¼ˆLogCleanerManager.grabFilthiestCompactedLogçš„è¯¦ç»†æµç¨‹ï¼‰? å¯ä»¥æ¸…ç†çš„ TopicPartition é™åˆ¶æ¡ä»¶æœ‰ä»¥ä¸‹å‡ ä¸ªï¼š Topic é…ç½®cleanup.policyåŒ…å«compactã€‚ TopicPartition çš„çŠ¶æ€ä¸ºç©ºï¼šè¯´æ˜æ²¡æœ‰å…¶ä»– CleanerThread æ“ä½œè¯¥ TopicPartitionã€‚ è¯¥ TopicPartition æ˜¯å¯ä»¥æ¸…ç†çš„ï¼šå› ä¸ºåç›˜ç­‰é—®é¢˜æŸäº› TopicPartition ä¼šè¢«æ ‡è®°ä¸ºä¸å¯æ¸…ç†ï¼Œéœ€è¦è·³è¿‡ã€‚ ä¸éœ€è¦å»¶è¿Ÿæ¸…ç†ï¼šæ¶ˆæ¯åœ¨æ—¥å¿—ä¸­å¿…é¡»å­˜åœ¨&quot;max.compaction.lag.ms&quot;æŒ‡å®šçš„æ—¶é—´åæ‰èƒ½è¢«åˆ é™¤ï¼ˆè¯¦æƒ…å¯å‚è€ƒKIP-354ï¼‰ï¼Œåªæœ‰ç¬¬ä¸€ä¸ªæœªå‹ç¼© Segment çš„ä¼°è®¡æœ€æ—©æ¶ˆæ¯æ—¶é—´æˆ³æ—©äº&quot;max.compaction.lag.ms&quot;æ‰ä¼šå¯ä»¥è¿›è¡Œ Compactionã€‚ éœ€è¦è¢«æ¸…ç†çš„æ¶ˆæ¯æ€»å¤§å°å¤§äº0ï¼šä» LogStartOffset æˆ– CleanCheckPoint å¼€å§‹åˆ°æ»¡è¶³&quot;max.compaction.lag.ms&quot;é…ç½®è¦æ±‚çš„ offset ä¹‹é—´çš„æ¶ˆæ¯æ€»å¤§å° æ»¡è¶³æ¸…ç†é¢‘ç‡æ»¡è¶³è¦æ±‚ï¼šæœ‰å…³æ¸…ç†é¢‘ç‡çš„é…ç½®å¯ä»¥ç›´æ¥çœ‹ä¸‹é¢æºç  Doc 1234567891011121314151617181920public static final String MIN_COMPACTION_LAG_MS_CONFIG = &quot;min.compaction.lag.ms&quot;;public static final String MIN_COMPACTION_LAG_MS_DOC = &quot;The minimum time a message will remain &quot; + &quot;uncompacted in the log. Only applicable for logs that are being compacted.&quot;;public static final String MAX_COMPACTION_LAG_MS_CONFIG = &quot;max.compaction.lag.ms&quot;;public static final String MAX_COMPACTION_LAG_MS_DOC = &quot;The maximum time a message will remain &quot; + &quot;ineligible for compaction in the log. Only applicable for logs that are being compacted.&quot;;public static final String MIN_CLEANABLE_DIRTY_RATIO_CONFIG = &quot;min.cleanable.dirty.ratio&quot;;public static final String MIN_CLEANABLE_DIRTY_RATIO_DOC = &quot;This configuration controls how frequently &quot; + &quot;the log compactor will attempt to clean the log (assuming &lt;a href=\\&quot;#compaction\\&quot;&gt;log &quot; + &quot;compaction&lt;/a&gt; is enabled). By default we will avoid cleaning a log where more than &quot; + &quot;50% of the log has been compacted. This ratio bounds the maximum space wasted in &quot; + &quot;the log by duplicates (at 50% at most 50% of the log could be duplicates). A &quot; + &quot;higher ratio will mean fewer, more efficient cleanings but will mean more wasted &quot; + &quot;space in the log. If the &quot; + MAX_COMPACTION_LAG_MS_CONFIG + &quot; or the &quot; + MIN_COMPACTION_LAG_MS_CONFIG + &quot; configurations are also specified, then the log compactor considers the log to be eligible for compaction &quot; + &quot;as soon as either: (i) the dirty ratio threshold has been met and the log has had dirty (uncompacted) &quot; + &quot;records for at least the &quot; + MIN_COMPACTION_LAG_MS_CONFIG + &quot; duration, or (ii) if the log has had &quot; + &quot;dirty (uncompacted) records for at most the &quot; + MAX_COMPACTION_LAG_MS_CONFIG + &quot; period.&quot;; OffsetMap çš„å®ç°åŸç† OffsetMap çš„å®ç°ç±»æ˜¯SkimpyOffsetsMapï¼Œç”¨æ¥å­˜å‚¨ message key å’Œ offset çš„æ˜ å°„å…³ç³»ï¼Œç”¨æ¥ä¿å­˜ç›¸åŒ key ä¸‹æœ€æ–°æ¶ˆæ¯çš„ Offsetã€‚æ­¤å¤„ä¸ä»‹ç»è¯¥ç±»çš„è¯¦ç»†å®ç°ï¼ˆæ„Ÿå…´è¶£è‡ªè¡Œé˜…è¯»æºç ï¼‰ï¼Œåªåˆ—ä¸¾å…¶ç‰¹ç‚¹ï¼š åˆ›å»ºæ—¶éœ€è¦æŒ‡å®šä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯ memoryï¼Œç”¨æ¥æŒ‡å®šå­˜å‚¨ offset çš„ ByteBuffer å¤§å°ï¼Œå¦ä¸€ä¸ªæ˜¯ hashAlgorithmï¼Œç”¨æ¥ç¡®å®šè®¡ç®— key hash æ—¶ä½¿ç”¨çš„å“ˆå¸Œç®—æ³•ã€‚ åªå…è®¸å¢åŠ ï¼Œä¸å…è®¸åˆ é™¤ã€‚ åªåœ¨ ByteBuffer ä¸­å­˜å‚¨éœ€è¦è®°å½•çš„ offsetï¼Œæ¯æ¬¡ put/get éƒ½æ˜¯å…ˆå¯¹ key hash ç¡®å®š positionï¼Œç„¶åç›´æ¥ä¿®æ”¹/è¯»å– ByteBuffer ä¸­çš„å†…å®¹ã€‚ æˆ‘ç†è§£è¯¥å®ç°çš„ä¸»è¦ä¼˜ç‚¹æ˜¯é¿å…å­˜å‚¨ message keyï¼Œå‡å°‘å†…å­˜æ¶ˆè€—ã€‚ å¦‚ä½•ä»ä¸€ç»„æ—§çš„ Segment ä¸­è¿‡æ»¤å‡ºéœ€è¦ä¿ç•™çš„æ¶ˆæ¯ä»¥åŠè¿‡æ»¤ç­–ç•¥æ˜¯æ€æ ·çš„? è¿‡æ»¤æ¶ˆæ¯çš„æµç¨‹æ˜¯ï¼Œå…ˆå°†æ—§ Segment ä¸­çš„æ¶ˆæ¯è¯»å…¥MemoryRecordsï¼Œç„¶åä½¿ç”¨MemoryRecords.filterToæ–¹æ³•è¿›è¡Œè¿‡æ»¤ï¼Œè¯¥æ–¹æ³•æ”¯æŒä½¿ç”¨è‡ªå®šä¹‰å®ç°çš„ RecordFilter è¿‡æ»¤æ¶ˆæ¯ã€‚ æ¶ˆæ¯è¿‡æ»¤çš„ç­–ç•¥ï¼ˆå®é™…ä¼šæœ‰äº‹åŠ¡æ¶ˆæ¯çš„å¤„ç†ï¼‰æ˜¯ï¼šè¿‡æ»¤æ‰ç›¸åŒ key ä¸­éæœ€æ–° offset çš„æ¶ˆæ¯ä»¥åŠæ»¡è¶³åˆ é™¤æ¡ä»¶çš„å¢“ç¢‘æ¶ˆæ¯ï¼ˆkey ä¸ä¸º null ä½†æ˜¯ value ä¸º nullï¼‰ã€‚å¢“ç¢‘æ¶ˆæ¯çš„åˆ é™¤æ¡ä»¶æ˜¯æŒ‡ï¼Œè¯¥å¢“ç¢‘æ¶ˆæ¯æ‰€åœ¨çš„ Segment æœ€åä¿®æ”¹æ—¶é—´è·ç¦»æœ€æ–° Segment çš„æœ€åä¿®æ”¹æ—¶é—´è¶…è¿‡delete.retention.msé…ç½®çš„æ—¶é—´ã€‚ å¦‚æœ Compaction è¿‡ç¨‹ä¸­ Broker å´©æºƒï¼Œé‡å¯åå¦‚ä½•æ¢å¤? å®•æœºæ¢å¤çš„è€ƒè™‘åªå‘ç”Ÿåœ¨ç”¨æ–° Segmentï¼ˆæ–‡ä»¶ååç¼€æ˜¯.cleanedï¼‰ æ›¿æ¢æ—§ Segment çš„è¿‡ç¨‹ä¸­ï¼Œå…¶ä»–é˜¶æ®µå‘ç”Ÿå®•æœºçš„è¯ï¼Œæ¢å¤åé‡æ–°æ‰§è¡Œ Compaction æµç¨‹å³å¯ã€‚ Segment æ›¿æ¢æ“ä½œä½¿ç”¨replaceSegmentsæ–¹æ³•ï¼ˆæºç å¦‚ä¸‹ï¼‰å®Œæˆï¼Œæ›¿æ¢æµç¨‹æ˜¯ï¼š å°†æ–° Segment çš„æ–‡ä»¶ååç¼€ä».cleanedæ”¹ä¸º.swap åˆ é™¤æ—§ Segmentï¼šåˆ é™¤è¿‡ç¨‹æ˜¯å…ˆå°†åŒæ­¥å°†æ–‡ä»¶åç¼€æ”¹ä¸º.deletedï¼Œç„¶åè¿›è¡Œå¼‚æ­¥åˆ é™¤ å»æ‰æ–° Segment çš„æ–‡ä»¶ååç¼€ï¼Œæµç¨‹ç»“æŸ ä¸‹é¢æ˜¯å¯¹äºæ‰€æœ‰å¯èƒ½çš„é˜¶æ®µ Broker å´©æºƒåçš„æ¢å¤é€»è¾‘ï¼š æ­¥éª¤1ä¹‹å‰ï¼šå¦‚æœæ­¤æ—¶ broker å´©æºƒï¼Œåˆ™æ¸…ç†å’Œäº¤æ¢æ“ä½œå°†ä¸­æ­¢ï¼Œå¹¶ä¸”åœ¨ loadSegments() ä¸­æ¢å¤æ—¶åˆ é™¤ .cleaned æ–‡ä»¶ã€‚ æ­¥éª¤1æ‰§è¡Œè¿‡ç¨‹ä¸­å´©æºƒï¼šæ–° Segment é‡å‘½åä¸º .swapã€‚å¦‚æœä»£ç†åœ¨æ‰€æœ‰ Segment é‡å‘½åä¸º .swap ä¹‹å‰å´©æºƒï¼Œåˆ™æ¸…ç†å’Œäº¤æ¢æ“ä½œå°†ä¸­æ­¢ .cleaned ä»¥åŠ .swap æ–‡ä»¶åœ¨ loadSegments() æ¢å¤æ—¶è¢«åˆ é™¤ã€‚ .cleaned é‡å‘½åä¸º .swap æ˜¯æŒ‰ç…§æ–‡ä»¶æŒ‰åç§»é‡çš„é™åºè¿›è¡Œçš„ï¼Œæ¢å¤æ—¶ï¼Œæ‰€æœ‰åç§»é‡å¤§äºæœ€å°åç§»é‡ .cleanæ–‡ä»¶çš„.swap æ–‡ä»¶éƒ½å°†è¢«åˆ é™¤ã€‚ æ­¥éª¤1å®Œæˆåå´©æºƒï¼šå¦‚æœåœ¨æ‰€æœ‰æ–° Segment é‡å‘½åä¸º .swap åä»£ç†å´©æºƒï¼Œåˆ™æ“ä½œå®Œæˆï¼Œå‰©ä½™æ“ä½œæµç¨‹ä¼šåœ¨ Broker æ¢å¤æ—¶ç»§ç»­æ‰§è¡Œã€‚ æ­¥éª¤2æ‰§è¡Œè¿‡ç¨‹ä¸­å´©æºƒï¼šæ—§ Segment æ–‡ä»¶è¢«é‡å‘½åä¸º .deleted å¹¶å®‰æ’äº†å¼‚æ­¥åˆ é™¤ã€‚å¦‚æœ Broker å´©æºƒï¼Œä»»ä½•ç•™ä¸‹çš„ .deleted æ–‡ä»¶éƒ½ä¼šåœ¨ loadSegments() æ¢å¤æ—¶è¢«åˆ é™¤ï¼Œç„¶åè°ƒç”¨ replaceSegments() ä»¥å®Œæˆæ›¿æ¢ï¼Œå…¶ä¸­æ–° Segment ä» .swap æ–‡ä»¶é‡æ–°åˆ›å»ºï¼Œæ—§ Segment åŒ…å«åœ¨å´©æºƒå‰æœªé‡å‘½åçš„ Segmentã€‚ æ­¥éª¤3å®Œæˆåå´©æºƒï¼šæ­¤æ—¶å¯èƒ½å­˜åœ¨æœªè¢«å¼‚æ­¥åˆ é™¤å®Œæˆçš„æ—§ Segmentï¼Œä»»ä½•å¯èƒ½ç•™ä¸‹çš„ .deleted æ–‡ä»¶éƒ½ä¼šåœ¨ loadSegments() æ¢å¤æ—¶è¢«åˆ é™¤ 12345678910111213141516171819202122232425262728private[log] def replaceSegments(newSegments: Seq[LogSegment], oldSegments: Seq[LogSegment], isRecoveredSwapFile: Boolean = false): Unit = &#123; lock synchronized &#123; val sortedNewSegments = newSegments.sortBy(_.baseOffset) // Some old segments may have been removed from index and scheduled for async deletion after the caller reads segments // but before this method is executed. We want to filter out those segments to avoid calling asyncDeleteSegment() // multiple times for the same segment. val sortedOldSegments = oldSegments.filter(seg =&gt; segments.containsKey(seg.baseOffset)).sortBy(_.baseOffset) checkIfMemoryMappedBufferClosed() // need to do this in two phases to be crash safe AND do the delete asynchronously // if we crash in the middle of this we complete the swap in loadSegments() if (!isRecoveredSwapFile) sortedNewSegments.reverse.foreach(_.changeFileSuffixes(Log.CleanedFileSuffix, Log.SwapFileSuffix)) sortedNewSegments.reverse.foreach(addSegment(_)) val newSegmentBaseOffsets = sortedNewSegments.map(_.baseOffset).toSet // delete the old files sortedOldSegments.foreach &#123; seg =&gt; // remove the index entry if (seg.baseOffset != sortedNewSegments.head.baseOffset) segments.remove(seg.baseOffset) // delete segment files, but do not delete producer state for segment objects which are being replaced. deleteSegmentFiles(List(seg), asyncDelete = true, deleteProducerStateSnapshots = !newSegmentBaseOffsets.contains(seg.baseOffset)) &#125; // okay we are safe now, remove the swap suffix sortedNewSegments.foreach(_.changeFileSuffixes(Log.SwapFileSuffix, &quot;&quot;)) &#125; &#125; Pulsar Compaction Pulsar å®˜æ–¹æ–‡æ¡£ä¸­å…³äº Compaction çš„ä»‹ç»ä¹Ÿæ¯”è¾ƒè¯¦ç»†ï¼Œå…·ä½“å¯ä»¥å‚è€ƒï¼š https://pulsar.apache.org/docs/zh-CN/next/concepts-topic-compaction/#compaction https://pulsar.apache.org/docs/zh-CN/next/cookbooks-compaction/ https://github.com/ivankelly/incubator-pulsar-wiki/blob/pip-9/PIP-9:-Topic-Compaction.md åœ¨ Pulsar ä¸­ï¼ŒTopic Compaction ä¸ NonCompaction ä¸¤ä¸ªçŠ¶æ€ä¸æ˜¯ç›¸äº’å¯¹ç«‹çš„ï¼ŒCompaction æ˜¯é€šè¿‡ç±»ä¼¼äºåˆ›å»ºä¸€ä¸ªSubscription æ¥æ¶ˆè´¹ç°æœ‰ Topic çš„æ¶ˆæ¯ï¼Œç»è¿‡ Compaction å¤„ç†åï¼Œå†™å…¥æ–°çš„ Ledger å­˜å‚¨ï¼Œåœ¨ Consumer æ¶ˆè´¹æ—¶ï¼Œå¯ä»¥é€šè¿‡é…ç½®é€‰æ‹©è¯»å– Compacted æ•°æ®è¿˜æ˜¯ NonCompacted æ•°æ®ã€‚æ³¨æ„ï¼šCompact åªèƒ½å¯¹ persistent topic æ‰§è¡Œã€‚ è§¦å‘æ¡ä»¶ Pulsar ä¸­è§¦å‘ Topic Compaction çš„æ–¹å¼æœ‰ä¸¤ç§ï¼š é…ç½®CompactionThresholdï¼šå¦‚å‰é¢æ‰€è¯´ï¼ŒCompaction è¿‡ç¨‹ç›¸å½“äºå»ºç«‹ä¸€ä¸ª Subscription æ¥æ¶ˆè´¹åŸæ¥ Topic ä¸­çš„æ•°æ®å†™å…¥æ–°çš„ Ledgerï¼ŒBroker ä¼šå‘¨æœŸæ€§æ£€æŸ¥æ‰€æœ‰ Persistent Topicï¼Œå¦‚æœCompactionThresholdé…ç½®ä¸ä¸º0å¹¶ä¸”è¿™ä¸ª Subscription çš„æ¶ˆæ¯ç§¯å‹è¶…è¿‡äº†é…ç½®çš„é˜ˆå€¼ï¼Œå°±ä¼šè‡ªåŠ¨è§¦å‘ Compactionã€‚è¿™ä¸ªé…ç½®çš„ç²’åº¦å¯ä»¥æ˜¯ topicã€brokerã€namespaceï¼Œæœ€ç»ˆæ ¹æ®ä¼˜å…ˆçº§ï¼ˆtopic &gt; broker &gt; namespaceï¼‰ç¡®å®šæœ€ç»ˆé…ç½®å€¼ã€‚ å¤–éƒ¨è§¦å‘ Topic Compactionï¼šé™¤è‡ªåŠ¨è§¦å‘ Compaction å¤–ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ CLI å·¥å…·è§¦å‘ï¼Œä¸€ç§æ˜¯ AdminCliï¼Œéœ€è¦è°ƒç”¨ broker æä¾›çš„ RestAPIï¼Œå¦ä¸€ç§æ˜¯ä½¿ç”¨ä¸“ç”¨å·¥å…·ç±»ï¼Œä¸ç»è¿‡ RestAPI ç›´æ¥æŒ‡å®šã€‚ 12$ bin/pulsar-admin topics compact persistent://my-tenant/my-namespace/my-topic # AdminCli$ bin/pulsar compact-topic --topic persistent://my-tenant-namespace/my-topic # ä¸“ç”¨å·¥å…· å®ç°åŸç† å®ç°åŸç†æ€»ä½“å¯ä»¥åˆ†ä¸º Compaction çš„å¤„ç†è¿‡ç¨‹å’Œ Consumer è¯»å– Compacted æ•°æ®ä¸¤ä¸ªéƒ¨åˆ†ã€‚ Compaction å¤„ç† è§¦å‘ Compaction çš„ç»Ÿä¸€å…¥å£æ˜¯Compactor.compact(String topic)æ–¹æ³•ï¼ŒCompactoræ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œç›®å‰çš„å®ç°åªæœ‰TwoPhaseCompactorä¸€ç§ï¼Œä¸‹é¢ä»‹ç»çš„æ˜¯TwoPhaseCompactorçš„å®ç°é€»è¾‘ã€‚é¡¾åæ€ä¹‰ï¼ŒCompaction è¿‡ç¨‹åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œéå†ä¸¤æ¬¡ Topic å†…å®¹ï¼Œç¬¬ä¸€æ¬¡éå†ç”¨æ¥è·å–æ¯ä¸ª key ä¸­æœ€æ–°çš„ MessageIdï¼ˆç›¸å½“äº Kafka ä¸­çš„ offsetï¼‰ï¼Œç¬¬äºŒæ¬¡éå†æ ¹æ®ç¬¬ä¸€æ¬¡éå†å–å¾—çš„ç»“æœï¼Œåªå°†æ¯ä¸ª key çš„æœ€æ–°æ¶ˆæ¯å†™å…¥æ–°çš„ Ledger ä¸­ã€‚ è¯»å– Compacted æ•°æ® å¦‚æœ Consumer å¸Œæœ›è¯»å– Compacted æ•°æ®ï¼Œéœ€è¦åœ¨åˆå§‹åŒ–æ—¶åˆ¶å®šç›¸å…³é…ç½®ã€‚ 1234Consumer&lt;byte[]&gt; compactedTopicConsumer = client.newConsumer() .topic(&quot;some-compacted-topic&quot;) .readCompacted(true) .subscribe(); Broker åœ¨æ”¶åˆ° Consumer çš„è¯·æ±‚åï¼Œä¼šå…ˆè·å–åˆ° Topic å¯¹åº”çš„ cursor ä¿¡æ¯ï¼Œç„¶åä» cursor ä¿¡æ¯ä¸­æ‰¾åˆ° Compacted æ•°æ®å¯¹åº”çš„ LedgerIdï¼Œç„¶åè¿›è¡Œå¯¹åº”æ•°æ®çš„è¯»å–ã€‚ Compacted Leger ä¿¡æ¯å¦‚ä½•ä¼ é€’ç»™ Consumerï¼Ÿ å¦‚å‰æ–‡æ‰€è¯´ï¼Œåœ¨TwoPhaseCompactorå¤„ç†è¿‡ç¨‹ä¸­ï¼Œå®é™…æ˜¯åˆ›å»ºäº†ä¸€ä¸ª Subscription æ¥è¯»å–åŸæ¥çš„æ•°æ®ã€‚åœ¨è¯»å–æ•°æ®å®Œæˆè¿›è¡Œ Ack æ—¶ï¼Œä½¿ç”¨çš„æ¥å£æ˜¯RawReader.acknowledgeCumulativeAsync(MessageId messageId, Map&lt;String, Long&gt; properties)ï¼Œè¯¥æ¥å£å¯ä»¥åœ¨ Ack çš„åŒæ—¶ç»™ Broker è¿”å›ä¸€äº›è¯¥ Subscription çš„å…ƒä¿¡æ¯ï¼ŒBroker ä¼šå°†æ”¶åˆ°çš„å…ƒä¿¡æ¯è®°å½•åœ¨ cursor ä¿¡æ¯ä¸­ã€‚æ‰€ä»¥ï¼ŒTwoPhaseCompactoré€šè¿‡è¿™ä¸€èƒ½åŠ›ï¼Œå°†åˆ›å»ºçš„ç”¨æ¥å­˜å‚¨ Compacted æ•°æ®çš„ LedgerId è®°å½•åœ¨äº† cursor ä¿¡æ¯ä¸­ï¼Œæ–¹ä¾¿ Consumer è¯»å–æ—¶ä½¿ç”¨ã€‚ æ€»ç»“æ€è€ƒ Kafka å’Œ Pulsar ä¸­å®ç° Compaction çš„ç›®çš„æ˜¯ä¸ºäº†åœ¨ç‰¹å®šçš„åœºæ™¯ä¸‹å‡å°‘ Topic çš„æ•°æ®é‡ï¼ŒåŠ å¿«è·å– Topic ä¸­å…¨éƒ¨æ•°æ®çš„é€Ÿåº¦ï¼Œè€Œä¸æ˜¯å¸Œæœ›å®ç°ç±»ä¼¼ KV å­˜å‚¨çš„èƒ½åŠ›ã€‚ä¹‹æ‰€ä»¥è¿™æ ·è¯´ï¼Œæ˜¯å› ä¸ºï¼š Kafka å’Œ Pulsar éƒ½æ²¡æœ‰ä¿è¯æœ€æ–°æ•°æ®çš„ Compactionï¼šå¯¹äº Kafka æ¥è¯´ï¼ŒLog Compaction åªä¼šæ“ä½œ ActiveSegment ä¹‹å‰çš„æ•°æ®ï¼›å¯¹äº Pulsar æ¥è¯´ï¼ŒCompaction æ˜¯ä¸€ä¸ªå‘¨æœŸæ€§æ‰§è¡Œçš„å·¥ä½œï¼Œæ¯æ¬¡ Compaction å¼€å§‹ä¹‹å‰ï¼Œéƒ½ä¼šå…ˆè¯»å–å½“å‰ Topic ä¸­æœ€åä¸€ä¸ª MessageId ä½œä¸ºæœ¬è½® Compaction çš„ç»ˆç‚¹ï¼Œå› æ­¤åªè¦æœ‰ Producer åœ¨å‘ Topic ç”Ÿäº§æ•°æ®ã€‚å°±è‚¯å®šä¸èƒ½ä¿è¯æ‰€æœ‰æ•°æ®éƒ½è¢« Compactedã€‚ Kafka å’Œ Pulsar çš„ Compaction éƒ½æ˜¯ä¸€å®šèŒƒå›´å†…çš„ï¼Œä¸æ˜¯å…¨å±€çš„ï¼šKafka å’Œ Pulsar çš„ Compaction éƒ½æ˜¯ä»¥ä¸€ç§ç±»ä¼¼äºæ»‘åŠ¨çª—å£çš„è¿‡ç¨‹è¿›è¡Œï¼Œâ€œkey ç›¸åŒçš„æƒ…å†µä¸‹åªä¿ç•™æœ€æ–°çš„æ¶ˆæ¯â€é’ˆå¯¹çš„æ˜¯ä¸€è½® Compaction å†…ï¼Œå¦‚æœä¸¤è½® Compaction ä¸­æœ‰ç›¸åŒ key çš„æ¶ˆæ¯ï¼Œæ˜¯æ²¡æœ‰åŠæ³•åˆå¹¶çš„ã€‚ å¯¹æ¯” Kafka å’Œ Pulsar ä¸¤è€…çš„å®ç°æ¥çœ‹ï¼Œæœ€ä¸»è¦çš„åŒºåˆ«å°±æ˜¯æ˜¯å¦ä¿ç•™ Compaction å‰çš„æ•°æ®ã€‚ç›¸è¾ƒäº Kafka çš„å®ç°ï¼ŒPulsar è¿™ç§å½¢å¼ä¸€æ–¹é¢æ•´ä½“é€»è¾‘æ›´ä¸ºç®€å•ï¼Œä¸éœ€è¦è€ƒè™‘å„ç§æ–‡ä»¶æ›¿æ¢è¿‡ç¨‹ä¸­çš„å´©æºƒæ¢å¤é€»è¾‘ï¼Œå¦ä¸€æ–¹é¢ä¹Ÿå¯ä»¥ç»™ Consumer æ›´å¤šé€‰æ‹©çš„ç©ºé—´ï¼Œä½†æ˜¯è¿™æ ·ä¹Ÿä¼šå¸¦æ¥ä¸€å®šçš„å­˜å‚¨æˆæœ¬ã€‚ä¸¤è€…çš„å®ç°æ¶æ„æ˜¯ä¸åŒçš„ï¼Œå¦‚æœæƒ³è¦ Kafka ä¹Ÿåƒ Pulsar ä¸€æ ·ä¿ç•™ä¸¤ä»½æ•°æ®ï¼Œç”±äº Kafka çš„å­˜å‚¨å‰¯æœ¬æœºåˆ¶æ˜¯è‡ªå·±çš„ç®¡ç†çš„ï¼Œå¯èƒ½éœ€è¦æ¯”ç°åœ¨æ›´ä¸ºå¤æ‚çš„å®ç°æ‰èƒ½å¤Ÿæå®šï¼Œè€Œä¸èƒ½åƒ Pulsar ä¸€æ ·ç›´æ¥é€šè¿‡åˆ‡æ¢ LedgerId æ¥é€‰æ‹©æ•°æ®å°±å¯ä»¥äº†ã€‚","raw":null,"content":null,"categories":[{"name":"æºç ","slug":"æºç ","permalink":"http://fxbing.github.io/categories/%E6%BA%90%E7%A0%81/"}],"tags":[{"name":"Pulsar","slug":"Pulsar","permalink":"http://fxbing.github.io/tags/Pulsar/"},{"name":"kafka","slug":"kafka","permalink":"http://fxbing.github.io/tags/kafka/"}]},{"title":"Kafka æºç å­¦ä¹ ï¼šåŠ¨æ€é…ç½®","slug":"Kafka-æºç å­¦ä¹ ï¼šåŠ¨æ€é…ç½®","date":"2022-03-29T11:22:27.000Z","updated":"2022-04-02T07:12:46.586Z","comments":true,"path":"2022/03/29/Kafka-æºç å­¦ä¹ ï¼šåŠ¨æ€é…ç½®/","link":"","permalink":"http://fxbing.github.io/2022/03/29/Kafka-%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%EF%BC%9A%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE/","excerpt":"Kafka çš„åŠ¨æ€é…ç½®åŸºäº Zookeeper å®ç°ï¼Œæœ¬æ–‡ä¸»è¦æ¢³ç†äº† Kafkaï¼ˆversionï¼š2.8ï¼‰ ä¸­åŠ¨æ€é…ç½®çš„å®ç°é€»è¾‘ã€‚","text":"Kafka çš„åŠ¨æ€é…ç½®åŸºäº Zookeeper å®ç°ï¼Œæœ¬æ–‡ä¸»è¦æ¢³ç†äº† Kafkaï¼ˆversionï¼š2.8ï¼‰ ä¸­åŠ¨æ€é…ç½®çš„å®ç°é€»è¾‘ã€‚ èƒŒæ™¯ä¿¡æ¯ åœ¨ Kafka ä¸­ï¼ŒZookeeper å®¢æˆ·ç«¯æ²¡æœ‰ä½¿ç”¨å¸¸è§çš„å®¢æˆ·ç«¯å·¥å…·ï¼ˆå¦‚ï¼šCuratorï¼‰ï¼Œè€Œæ˜¯ç›´æ¥åŸºäºåŸç”Ÿçš„å®¢æˆ·ç«¯å®ç°äº†è‡ªå·±çš„ KafkaZkClientï¼Œå°†ä¸€äº›é€šç”¨æˆ–ç‰¹æœ‰çš„ Zookeeper æ“ä½œå°è£…åœ¨å†…ã€‚å› æ­¤ï¼Œå…³äº Zookeeper çš„ä½¿ç”¨åŠå›è°ƒç­‰é€»è¾‘ä¹Ÿå®Œå…¨æ˜¯ç‹¬ç«‹å®ç°çš„ã€‚å¦å¤–ï¼Œç”±äº Zookeeper ä¸­ä¸€ä¸ªèŠ‚ç‚¹ä¸‹çš„ Watcher é¡ºåºè§¦å‘ï¼Œå¦‚æœåŒä¸€ä¸ªèŠ‚ç‚¹ä¸‹æœ‰å¤§é‡çš„ Watcherï¼Œå°†ä¼šäº§ç”Ÿæ€§èƒ½ç“¶é¢ˆã€‚ä¸‹é¢å°†åŸºäºè¿™äº›èƒŒæ™¯ä¿¡æ¯æ¥ä»‹ç» Kafka æ˜¯å¦‚ä½•åŸºäº Zookeeper å®ç°é«˜æ•ˆçš„åŠ¨æ€é…ç½®ç®¡ç†çš„ã€‚ Kafka åŠ¨æ€é…ç½® Zookeeper ç›®å½•ç»“æ„ åœ¨å½“å‰ç‰ˆæœ¬çš„ Kafka ä¸­ï¼ŒåŠ¨æ€é…ç½®ç±»å‹æœ‰ 5 ç§ï¼štopic, client, user, broker, ipã€‚Kafka åŠ¨æ€é…ç½®çš„ç›®å½•ç»“æ„ä¸ºï¼š /config/entityType/entityName ï¼ŒentityType ä»£è¡¨é…ç½®çš„ç±»å‹ï¼ŒentityName ä»£è¡¨å…·ä½“æŸä¸ªå®ä½“ï¼Œæ¯”å¦‚ï¼šTopic ç±»å‹å¯¹åº”çš„å®ä½“å°±æ˜¯å…·ä½“æŸä¸ª Topicï¼ŒæŸä¸ªé…ç½®ç±»å‹ä¸‹æ‰€æœ‰å®ä½“çš„é»˜è®¤é…ç½®çš„ entityName ä¸º &lt;deafult&gt; (topic ç±»å‹æ²¡æœ‰ &lt;default&gt; é…ç½®ï¼Œé€šè¿‡ broker ç±»å‹æ¥ä¿®æ”¹ LogConfig çš„é»˜è®¤é…ç½®)ã€‚å…·ä½“æ¥è¯´ï¼Œæ‰€æœ‰ Topic çš„é»˜è®¤åŠ¨æ€é…ç½®ä¼šæ”¾åœ¨ /config/topic/&lt;default&gt; çš„èŠ‚ç‚¹ä¿¡æ¯ä¸­ï¼ŒTopic AAA çš„æ‰€æœ‰åŠ¨æ€é…ç½®ä¼šæ”¾åœ¨ /config/topic/AAA çš„èŠ‚ç‚¹ä¿¡æ¯ä¸­ã€‚ Listener å®ç° ä¸‹é¢ä»‹ç» Kafka ä¸­ Zookeeper Listener çš„å®ç°ã€‚æ—¢ç„¶æ˜¯åŸºäº Zookeeper å®ç°ï¼Œå¿…ç„¶å°‘ä¸äº† Zookeeper çš„ Watcher é€šçŸ¥æœºåˆ¶ï¼Œä½†æ˜¯ï¼Œå¦‚èƒŒæ™¯ä¿¡æ¯ä¸­æ‰€è¯´ï¼Œåœ¨ Watcher æ•°é‡è¿‡å¤šçš„æƒ…å†µä¸‹ï¼Œä¼šå­˜åœ¨æ€§èƒ½ç“¶é¢ˆã€‚ä»¥ Topic é…ç½®å˜æ›´ä¸ºä¾‹ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä¸€ä¸ª Topic çš„ Partition æ•°é‡å¯èƒ½å¤šè¾¾ä¸Šåƒï¼Œå¦‚æœæ¯ä¸ª Partition Leader éƒ½å»ç›‘å¬è¿™ä¸ª Topic é…ç½®ä¿¡æ¯ï¼Œé‚£ä¹ˆåœ¨ä¸€ä¸ª Kafka é›†ç¾¤å†…ï¼Œä»…ç›‘å¬ Topic é…ç½®çš„ Watcher å°±ä¼šæœ‰ä¸Šä¸‡ä¸ªç”šè‡³æ›´å¤šã€‚Kafka é€šè¿‡ç‹¬ç«‹çš„é€šçŸ¥æœºåˆ¶æ¥é¿å…äº†è¿™ä¸€é—®é¢˜ï¼Œå³ï¼šæ¯æ¬¡ AdminClient è¿›è¡Œé…ç½®å˜æ›´æ—¶ï¼Œä¼šåœ¨ /config/changes/ ç›®å½•ä¸‹åˆ›å»ºä»¥ config_change_ ä¸ºå‰ç¼€çš„é¡ºåºèŠ‚ç‚¹ï¼ŒWather åªç›‘å¬ /config/changes/ ç›®å½•çš„å­©å­èŠ‚ç‚¹å˜åŒ–ï¼Œæ‰€ä»¥å¯¹äºåŠ¨æ€é…ç½®æ¥è¯´ï¼Œæ‰€æœ‰ Broker åªç›‘å¬ /config/changes/ è¿™ä¸€ä¸ªç›®å½•ï¼Œå¤§å¤§å‡å°‘é›†ç¾¤æ•´ä½“çš„ Watcher æ•°é‡ã€‚ Kafka ä¸­åŠ¨æ€é…ç½®çš„ Zookeeper Listener çš„å®ç°åœ¨ ZkNodeChangeNotificationListener ç±»ä¸­ï¼Œè¯¥ç±»ç›‘å¬æŒ‡å®šç›®å½•ä¸‹çš„é¡ºåºèŠ‚ç‚¹æ·»åŠ åŠ¨ä½œï¼Œåœ¨æ”¶åˆ°å­èŠ‚ç‚¹å˜åŒ–é€šçŸ¥åï¼ŒZkNodeChangeNotificationListener ä¸€æ–¹é¢æ‰§è¡Œé€šçŸ¥åŠ¨ä½œï¼Œé€šçŸ¥å¯¹åº”çš„ Handler å¤„ç†é…ç½®å˜æ›´ï¼Œå¦ä¸€é¢ä¼šæ¸…é™¤æ‰€æœ‰å·²ç»å¤„ç†è¿‡çš„é…ç½®å˜æ›´ã€‚ ä¸‹é¢å¯¹ ZkNodeChangeNotificationListener ç±»çš„å®ç°è¿›è¡Œä»‹ç»ï¼Œä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š a. åˆå§‹åŒ–ï¼šæ³¨å†Œ zk è¿æ¥çŠ¶æ€å˜æ›´çš„ Handler å’Œ zk å­èŠ‚ç‚¹å˜æ›´çš„ Handlerï¼›è°ƒç”¨ä¸€æ¬¡ addChangeNotification() è§¦å‘ä¸€æ¬¡é…ç½®å˜æ›´çš„å¤„ç†ï¼Œç”¨æ¥åˆå§‹åŒ–åŠ¨æ€é…ç½®ï¼›å¯åŠ¨ç”¨æ¥å¤„ç†é…ç½®å˜æ›´äº‹ä»¶çš„çº¿ç¨‹ ChangeEventProcessThreadã€‚ b. é…ç½®å˜æ›´å¤„ç†ï¼šæ¯æ¬¡ zk çŠ¶æ€å˜æ›´æˆ–è€…åŠ¨æ€é…ç½®å˜æ›´éƒ½ä¼šå‘ queue ä¸­æ”¾å…¥ä¸€ä¸ªå¤„ç†äº‹ä»¶ï¼Œä¸æ­¤åŒæ—¶ï¼ŒChangeEventProcessThread ä¼šæŒç»­ä¸æ–­çš„ä» queue ä¸­å–å‡ºäº‹ä»¶ï¼Œæ‰§è¡Œå¯¹åº”çš„å¤„ç†åŠ¨ä½œï¼Œå³ï¼šprocessNotifications()ã€‚ c. æ¸…é™¤è¿‡æœŸé€šçŸ¥ï¼šæ¯æ¬¡æ‰§è¡Œå®Œ processNotifications()ï¼Œéƒ½ä¼šè°ƒç”¨ purgeObsoleteNotifications æ‰§è¡Œè¿‡æœŸé€šçŸ¥çš„æ¸…ç†åŠ¨ä½œï¼Œåˆ é™¤æ‰€æœ‰è¿›è¡Œæœ¬æ¬¡ processNotifications() ä¹‹å‰åˆ›å»ºçš„æ‰€æœ‰å˜æ›´é€šçŸ¥ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182class ZkNodeChangeNotificationListener(private val zkClient: KafkaZkClient, private val seqNodeRoot: String, private val seqNodePrefix: String, private val notificationHandler: NotificationHandler, private val changeExpirationMs: Long = 15 * 60 * 1000, private val time: Time = Time.SYSTEM) extends Logging &#123; private var lastExecutedChange = -1L private val queue = new LinkedBlockingQueue[ChangeNotification] private val thread = new ChangeEventProcessThread(s&quot;$seqNodeRoot-event-process-thread&quot;) private val isClosed = new AtomicBoolean(false) def init(): Unit = &#123; // ZkStateChangeHandler å’Œ ChangeNotificationHandler éƒ½æ˜¯ addChangeNotification() zkClient.registerStateChangeHandler(ZkStateChangeHandler) zkClient.registerZNodeChildChangeHandler(ChangeNotificationHandler) addChangeNotification() thread.start() &#125; def close() = &#123; Â·Â·Â· &#125; /** * Process notifications */ private def processNotifications(): Unit = &#123; try &#123; val notifications = zkClient.getChildren(seqNodeRoot).sorted if (notifications.nonEmpty) &#123; info(s&quot;Processing notification(s) to $seqNodeRoot&quot;) val now = time.milliseconds for (notification &lt;- notifications) &#123; val changeId = changeNumber(notification) // åªå¤„ç†æ›´æ–°çš„å˜æ›´ä¿¡æ¯ if (changeId &gt; lastExecutedChange) &#123; // è°ƒç”¨ notificationHandler.processNotification() è¿›è¡Œé…ç½®å˜æ›´çš„å¤„ç† processNotification(notification) lastExecutedChange = changeId &#125; &#125; purgeObsoleteNotifications(now, notifications) &#125; &#125; catch &#123; Â·Â·Â· &#125; &#125; Â·Â·Â· Â·Â·Â· private def addChangeNotification(): Unit = &#123; if (!isClosed.get &amp;&amp; queue.peek() == null) queue.put(new ChangeNotification) &#125; class ChangeNotification &#123; def process(): Unit = processNotifications() &#125; private def purgeObsoleteNotifications(now: Long, notifications: Seq[String]): Unit = &#123; for (notification &lt;- notifications.sorted) &#123; val notificationNode = seqNodeRoot + &quot;/&quot; + notification val (data, stat) = zkClient.getDataAndStat(notificationNode) if (data.isDefined) &#123; if (now - stat.getCtime &gt; changeExpirationMs) &#123; debug(s&quot;Purging change notification $notificationNode&quot;) zkClient.deletePath(notificationNode) &#125; &#125; &#125; &#125; /* get the change number from a change notification znode */ private def changeNumber(name: String): Long = name.substring(seqNodePrefix.length).toLong class ChangeEventProcessThread(name: String) extends ShutdownableThread(name = name) &#123; override def doWork(): Unit = queue.take().process() &#125; Â·Â·Â· Â·Â·Â·&#125; Handler å®ç° ä¸Šé¢ä»‹ç»äº†é…ç½®å˜æ›´é€šçŸ¥æ˜¯å¦‚ä½•æ¥æ”¶çš„ï¼Œå®é™…çš„å¤„ç†åœ¨ NotificationHandler.processNotification() ä¸­è¿›è¡Œï¼Œå¯¹äºåŠ¨æ€é…ç½®æ¥è¯´ï¼Œ NotificationHandler æ¥å£çš„å®ç°æ˜¯ç±» ConfigChangedNotificationHandler, ConfigChangedNotificationHandler çš„ processNotification ä¼šæ ¹æ®é…ç½®å˜æ›´é€šçŸ¥ç‰ˆæœ¬å¯¹é…ç½®å˜æ›´é€šçŸ¥å†…å®¹è¿›è¡Œè§£æï¼Œç„¶åè°ƒç”¨å¯¹åº”çš„ç±»å‹çš„ ConfigHandler è¿›è¡Œé…ç½®æ›´æ–°ã€‚ åœ¨å½“å‰ç‰ˆæœ¬ä¸­çš„é…ç½®å˜æ›´é€šçŸ¥åˆ†ä¸º version1 å’Œ version2 ä¸¤ä¸ªç‰ˆæœ¬ï¼Œä¸åŒç‰ˆæœ¬æ ¼å¼ä¸åŒï¼Œä»¥æŸä¸ª topic ä¸‹çš„æŸä¸ª clientId çš„åŠ¨æ€é…ç½®ä¸ºä¾‹ï¼Œversion1 çš„å†…å®¹ä¸º &#123;&quot;version&quot; : 1, &quot;entity_type&quot;:&quot;topic/client&quot;, &quot;entity_name&quot; : &quot;&lt;topic_name&gt;/&lt;client_id&gt;&quot;&#125;, version2 çš„å†…å®¹ä¸º &#123;&quot;version&quot; : 2, &quot;entity_path&quot;:&quot;topic/&lt;topic_name&gt;/client/&lt;client_id&gt;&quot;&#125; æ‰€æœ‰åŠ¨æ€é…ç½®æœ‰é»˜è®¤çš„ entity_nameï¼š &lt;default&gt;ï¼Œå½“ entity_name ä¸º &lt;default&gt; ï¼Œè¡¨ç¤ºæ‰€æœ‰ entity çš„é»˜è®¤é…ç½®ï¼Œä¾‹å¦‚ï¼š /config/topics/&lt;default&gt; ä¸­çš„é…ç½®è¡¨ç¤ºæ‰€æœ‰ topic çš„é»˜è®¤åŠ¨æ€é…ç½®ã€‚ ä¸‹é¢å¯¹ ConfigHandler çš„å®ç°ç±»è¿›è¡Œç®€å•ä»‹ç»ï¼š TopicConfigHandlerï¼š ä¸»è¦å¤„ç† 3 ç±»é…ç½®ï¼š a. LogManager ä¸­ç®¡ç†çš„ topic é…ç½® b. å‰¯æœ¬é™æµé…ç½® c. controller ä¸­åŠ¨æ€å¼€å…³é…ç½® &quot;unclean.leader.election.enable&quot; ClientIdConfigHandler å’Œ UserConfigHandlerï¼š éƒ½ç»§æ‰¿è‡ª QuotaConfigHandlerï¼Œç”¨æ¥æ›´æ–°å®¢æˆ·ç«¯ä¾§çš„é™æµé…ç½®ï¼ŒClientIdConfigHandler è´Ÿè´£ client id ç»´åº¦çš„é™æµé…ç½®æ›´æ–°ï¼Œ UserConfigHandler ç”¨æ¥è´Ÿè´£ç”¨æˆ·ç»´åº¦çš„é™æµé…ç½®æ›´æ–° IpConfigHandlerï¼š è´Ÿè´£è¿æ¥ç»´åº¦ ConnectionQuotas çš„é™æµé…ç½®æ›´æ–° BrokerConfigHandlerï¼š ä¸€æ–¹é¢è´Ÿè´£ broker ç›¸å…³çš„ quota é…ç½®ï¼Œå¦ä¸€æ–¹é¢è´Ÿè´£ broker åŠ¨æ€é…ç½®çš„æ›´æ–°ã€‚broker çš„åŠ¨æ€é…ç½®é€»è¾‘åœ¨ç±» DynamicBrokerConfig ä¸­å®ç°ï¼Œä¸»è¦é€»è¾‘æ˜¯æ ¹æ®ä»¥ä¸‹ä¼˜å…ˆçº§é¡ºåºè¿›è¡Œ broker é…ç½®çš„æ›´æ–°å’Œè¦†ç›–ï¼š a. DYNAMIC_BROKER_CONFIGï¼šå­˜å‚¨åœ¨ ZK ä¸­çš„ /configs/brokers/&#123;brokerId&#125; b. DYNAMIC_DEFAULT_BROKER_CONFIGï¼šå­˜å‚¨åœ¨ ZK ä¸­çš„ /configs/brokers/&lt;default&gt; c. STATIC_BROKER_CONFIGï¼šbroker å¯åŠ¨é…ç½®ï¼Œé€šå¸¸æ¥è‡ª server.properties æ–‡ä»¶ d. DEFAULT_CONFIGï¼šKafkaConfig ä¸­ç¡¬ç¼–ç çš„é»˜è®¤é…ç½® å…¶å®ƒè¡¥å…… åœ¨ broker åˆå§‹åŒ– partition çš„è¿‡ç¨‹ä¸­ï¼Œè¯¥ topic çš„é…ç½®å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ï¼Œä¸ºäº†é¿å…æ¼æ‰è¿™éƒ¨åˆ†é…ç½®çš„æ›´æ–°ï¼Œä¼šåœ¨ createLog è¿‡ç¨‹ä¸­è®°å½•é…ç½®å˜æ›´çš„æƒ…å†µï¼Œåœ¨ createLog ç»“æŸåå¤„ç†è¿™éƒ¨åˆ†é…ç½®çš„æ›´æ–°ï¼Œ å…·ä½“å¯ä»¥å‚è€ƒï¼šhttps://issues.apache.org/jira/browse/KAFKA-8813","raw":null,"content":null,"categories":[{"name":"æºç ","slug":"æºç ","permalink":"http://fxbing.github.io/categories/%E6%BA%90%E7%A0%81/"}],"tags":[{"name":"kafka","slug":"kafka","permalink":"http://fxbing.github.io/tags/kafka/"}]},{"title":"Kafka æºç å­¦ä¹ ï¼šæ—¥å¿—åŠ è½½ä¸æ¢å¤","slug":"Kafka-æºç å­¦ä¹ ï¼šæ—¥å¿—åŠ è½½ä¸æ¢å¤","date":"2022-02-20T08:29:48.000Z","updated":"2022-02-20T08:30:58.513Z","comments":true,"path":"2022/02/20/Kafka-æºç å­¦ä¹ ï¼šæ—¥å¿—åŠ è½½ä¸æ¢å¤/","link":"","permalink":"http://fxbing.github.io/2022/02/20/Kafka-%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%EF%BC%9A%E6%97%A5%E5%BF%97%E5%8A%A0%E8%BD%BD%E4%B8%8E%E6%81%A2%E5%A4%8D/","excerpt":"æœ¬æ–‡æ¢³ç†ä¸»è¦æ¢³ç† Kafka æ—¥å¿—åŠ è½½ä¸æ¢å¤çš„æºç ã€‚ï¼ˆKafka ç‰ˆæœ¬ï¼š2.8ï¼‰","text":"æœ¬æ–‡æ¢³ç†ä¸»è¦æ¢³ç† Kafka æ—¥å¿—åŠ è½½ä¸æ¢å¤çš„æºç ã€‚ï¼ˆKafka ç‰ˆæœ¬ï¼š2.8ï¼‰ æ—¥å¿—ç®¡ç†ï¼šLogManager LogManager æ˜¯ kafka æ—¥å¿—ç®¡ç†å­ç³»ç»Ÿçš„å…¥å£ç‚¹ã€‚è´Ÿè´£æ—¥å¿—çš„åˆ›å»ºã€æ£€ç´¢å’Œæ¸…ç†ã€‚æ‰€æœ‰è¯»å–å’Œå†™å…¥æ“ä½œéƒ½å§”æ‰˜ç»™å„ä¸ªæ—¥å¿—å®ä¾‹ã€‚LogManager åœ¨ä¸€ä¸ªæˆ–å¤šä¸ªç›®å½•ä¸­ç»´æŠ¤æ—¥å¿—ã€‚åœ¨æ—¥å¿—æœ€å°‘çš„æ•°æ®ç›®å½•ä¸­åˆ›å»ºæ–°æ—¥å¿—ã€‚äº‹åä¸ä¼šå°è¯•ç§»åŠ¨åˆ†åŒºæˆ–æ ¹æ®å¤§å°æˆ– I/O é€Ÿç‡è¿›è¡Œå¹³è¡¡ã€‚åå°çº¿ç¨‹é€šè¿‡å®šæœŸæˆªæ–­å¤šä½™çš„æ—¥å¿—æ®µæ¥å¤„ç†æ—¥å¿—ä¿ç•™ã€‚ LogManger çš„å¯åŠ¨ä¸»è¦åŒ…æ‹¬ä¸‰ä¸ªéƒ¨åˆ†ï¼š æ—¥å¿—åŠ è½½ä¸æ¢å¤ï¼Œå³ï¼šloadLogs å„ä¸ªå®šæ—¶ä»»åŠ¡å¯åŠ¨ï¼Œä¸»è¦åŒ…æ‹¬ï¼ša. cleanupLogsï¼šæ ¹æ®ä¿ç•™æ—¶é—´å’Œä¿ç•™å¤§å°è¿›è¡Œå†å² segment çš„æ¸…ç†b. flushDirtyLogsï¼šå®šæ—¶åˆ·æ–°è¿˜æ²¡æœ‰å†™åˆ°ç£ç›˜ä¸Šæ—¥å¿—c. checkpointLogRecoveryOffsetsï¼šå®šæ—¶å°†æ‰€æœ‰æ•°æ®ç›®å½•æ‰€æœ‰æ—¥å¿—çš„æ£€æŸ¥ç‚¹å†™åˆ°æ£€æŸ¥ç‚¹æ–‡ä»¶ä¸­d. checkpointLogStartOffsetsï¼šå°†æ‰€æœ‰æ—¥å¿—çš„å½“å‰æ—¥å¿—å¼€å§‹åç§»é‡å†™åˆ°æ—¥å¿—ç›®å½•ä¸­çš„æ–‡æœ¬æ–‡ä»¶ä¸­ï¼Œä»¥é¿å…æš´éœ²å·²è¢« DeleteRecordsRequest åˆ é™¤çš„æ•°æ®e. deleteLogsï¼šå®šæ—¶åˆ é™¤æ ‡è®°ä¸º delete çš„æ—¥å¿—æ–‡ä»¶ å¯åŠ¨ LogCleanerï¼Œè´Ÿè´£è¿›è¡Œæ—¥å¿— compaction æœ¬æ–‡ä¸»è¦å¯¹ç¬¬ä¸€éƒ¨åˆ†æ—¥å¿—åŠ è½½ä¸æ¢å¤è¿›è¡Œæ¢³ç†ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738// visible for testingprivate[log] def startupWithConfigOverrides(topicConfigOverrides: Map[String, LogConfig]): Unit = &#123; loadLogs(topicConfigOverrides) // this could take a while if shutdown was not clean /* Schedule the cleanup task to delete old logs */ if (scheduler != null) &#123; info(&quot;Starting log cleanup with a period of %d ms.&quot;.format(retentionCheckMs)) scheduler.schedule(&quot;kafka-log-retention&quot;, cleanupLogs _, delay = InitialTaskDelayMs, period = retentionCheckMs, TimeUnit.MILLISECONDS) info(&quot;Starting log flusher with a default period of %d ms.&quot;.format(flushCheckMs)) scheduler.schedule(&quot;kafka-log-flusher&quot;, flushDirtyLogs _, delay = InitialTaskDelayMs, period = flushCheckMs, TimeUnit.MILLISECONDS) scheduler.schedule(&quot;kafka-recovery-point-checkpoint&quot;, checkpointLogRecoveryOffsets _, delay = InitialTaskDelayMs, period = flushRecoveryOffsetCheckpointMs, TimeUnit.MILLISECONDS) scheduler.schedule(&quot;kafka-log-start-offset-checkpoint&quot;, checkpointLogStartOffsets _, delay = InitialTaskDelayMs, period = flushStartOffsetCheckpointMs, TimeUnit.MILLISECONDS) scheduler.schedule(&quot;kafka-delete-logs&quot;, // will be rescheduled after each delete logs with a dynamic period deleteLogs _, delay = InitialTaskDelayMs, unit = TimeUnit.MILLISECONDS) &#125; if (cleanerConfig.enableCleaner) &#123; _cleaner = new LogCleaner(cleanerConfig, liveLogDirs, currentLogs, logDirFailureChannel, time = time) _cleaner.startup() &#125;&#125; å…¨éƒ¨æ—¥å¿—åŠ è½½ä¸æ¢å¤ï¼šloadLogs æ‰€æœ‰æ—¥å¿—çš„åŠ è½½ä¸æ¢å¤çš„æµç¨‹ä¸»è¦åŒ…å«ä»¥ä¸‹å‡ æ­¥ï¼š åŠ è½½å¹¶è®°å½•æ—¥å¿—æ–‡ä»¶å¤¹ä¸­æ ‡å¿—çŠ¶æ€ä¿¡æ¯çš„æ–‡ä»¶ï¼ˆkafka_cleanshutdownã€recovery-point-offset-checkpointã€recovery-point-offset-checkpointï¼‰ å¹¶å‘å¯¹æ¯ä¸ª tp çš„æ—¥å¿—è¿›è¡ŒåŠ è½½ä¸æ¢å¤ï¼ˆä¸‹ä¸€å°èŠ‚è¯¦è§£ï¼‰ è®°å½•å¹¶å¼‚æ­¥å¤„ç†æœ‰é—®é¢˜çš„æ—¥å¿—æ–‡ä»¶å¤¹123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107/** * Recover and load all logs in the given data directories */private[log] def loadLogs(topicConfigOverrides: Map[String, LogConfig]): Unit = &#123; // å¯¹æ‰€æœ‰å¯ç”¨çš„æ—¥å¿—ç›®å½•ï¼ˆliveLogDirsï¼‰è¿›è¡ŒåŠ è½½ï¼Œkafka server å¯åŠ¨æ—¶å¯èƒ½é…ç½®å¤šä¸ªç£ç›˜ç›®å½•ç”¨æ¥å­˜å‚¨æ—¥å¿—æ–‡ä»¶ï¼Œä½†æ˜¯ä¸ä¸€å®šæ‰€æœ‰çš„ç£ç›˜éƒ½æ˜¯å¯ç”¨çš„ info(s&quot;Loading logs from log dirs $liveLogDirs&quot;) val startMs = time.hiResClockMs() val threadPools = ArrayBuffer.empty[ExecutorService] val offlineDirs = mutable.Set.empty[(String, IOException)] val jobs = ArrayBuffer.empty[Seq[Future[_]]] var numTotalLogs = 0 // éå†æ‰€æœ‰çš„ç£ç›˜ï¼Œè¿›è¡Œæ—¥å¿—åŠ è½½ä¸æ¢å¤ï¼Œå¦‚æœå‡ºç° IOExceptionï¼Œåˆ™å°†è¯¥ç›®å½•è®°å½•åˆ° offlineDirs ä¸­è¿›è¡Œåç»­å¤„ç† for (dir &lt;- liveLogDirs) &#123; val logDirAbsolutePath = dir.getAbsolutePath var hadCleanShutdown: Boolean = false try &#123; val pool = Executors.newFixedThreadPool(numRecoveryThreadsPerDataDir) threadPools.append(pool) // å¦‚æœ .kafka_cleanshutdown æ–‡ä»¶å­˜åœ¨ï¼Œåˆ™å°†è¯¥æ–‡ä»¶åˆ é™¤å¹¶è®°å½• hadCleanShutdown çŠ¶æ€ï¼Œåç»­ä¸éœ€è¦è¿›è¡Œæ—¥å¿—æ¢å¤çš„æµç¨‹ã€‚ val cleanShutdownFile = new File(dir, Log.CleanShutdownFile) if (cleanShutdownFile.exists) &#123; info(s&quot;Skipping recovery for all logs in $logDirAbsolutePath since clean shutdown file was found&quot;) // Cache the clean shutdown status and use that for rest of log loading workflow. Delete the CleanShutdownFile // so that if broker crashes while loading the log, it is considered hard shutdown during the next boot up. KAFKA-10471 Files.deleteIfExists(cleanShutdownFile.toPath) hadCleanShutdown = true &#125; else &#123; // log recovery itself is being performed by `Log` class during initialization info(s&quot;Attempting recovery for all logs in $logDirAbsolutePath since no clean shutdown file was found&quot;) &#125; // ä» recovery-point-offset-checkpoint æ–‡ä»¶è¯»å–æ‰€æœ‰ tp ç›®å½•çš„ recoveryPoint var recoveryPoints = Map[TopicPartition, Long]() try &#123; recoveryPoints = this.recoveryPointCheckpoints(dir).read() &#125; catch &#123; case e: Exception =&gt; warn(s&quot;Error occurred while reading recovery-point-offset-checkpoint file of directory &quot; + s&quot;$logDirAbsolutePath, resetting the recovery checkpoint to 0&quot;, e) &#125; // ä» log-start-offset-checkpoint æ–‡ä»¶è¯»å–æ‰€æœ‰ tp ç›®å½•çš„ logStartOffset var logStartOffsets = Map[TopicPartition, Long]() try &#123; logStartOffsets = this.logStartOffsetCheckpoints(dir).read() &#125; catch &#123; case e: Exception =&gt; warn(s&quot;Error occurred while reading log-start-offset-checkpoint file of directory &quot; + s&quot;$logDirAbsolutePath, resetting to the base offset of the first segment&quot;, e) &#125; // æ—¥å¿—çš„åŠ è½½ä¸æ¢å¤ä¸»æµç¨‹ï¼Œå¹¶å‘å¯¹æ‰€æœ‰ tp çš„æ—¥å¿—æ‰§è¡Œ loadLog val logsToLoad = Option(dir.listFiles).getOrElse(Array.empty).filter(logDir =&gt; logDir.isDirectory &amp;&amp; Log.parseTopicPartitionName(logDir).topic != KafkaRaftServer.MetadataTopic) val numLogsLoaded = new AtomicInteger(0) numTotalLogs += logsToLoad.length val jobsForDir = logsToLoad.map &#123; logDir =&gt; val runnable: Runnable = () =&gt; &#123; try &#123; debug(s&quot;Loading log $logDir&quot;) val logLoadStartMs = time.hiResClockMs() val log = loadLog(logDir, hadCleanShutdown, recoveryPoints, logStartOffsets, topicConfigOverrides) val logLoadDurationMs = time.hiResClockMs() - logLoadStartMs val currentNumLoaded = numLogsLoaded.incrementAndGet() info(s&quot;Completed load of $log with $&#123;log.numberOfSegments&#125; segments in $&#123;logLoadDurationMs&#125;ms &quot; + s&quot;($currentNumLoaded/$&#123;logsToLoad.length&#125; loaded in $logDirAbsolutePath)&quot;) &#125; catch &#123; case e: IOException =&gt; offlineDirs.add((logDirAbsolutePath, e)) error(s&quot;Error while loading log dir $logDirAbsolutePath&quot;, e) &#125; &#125; runnable &#125; jobs += jobsForDir.map(pool.submit) &#125; catch &#123; case e: IOException =&gt; offlineDirs.add((logDirAbsolutePath, e)) error(s&quot;Error while loading log dir $logDirAbsolutePath&quot;, e) &#125; &#125; try &#123; // ç­‰å¾…æ‰€æœ‰å¹¶å‘æ‰§è¡Œçš„æ—¥å¿—åŠ è½½æµç¨‹æ‰§è¡Œå®Œæˆ for (dirJobs &lt;- jobs) &#123; dirJobs.foreach(_.get) &#125; // è®°å½•æ‰€æœ‰æœ‰é—®é¢˜çš„çš„ç›®å½•ï¼Œåç»­è¯¥ç›®å½•ä¼šè¢« ReplicaManager æ‰§è¡Œä¸‹çº¿æ“ä½œ offlineDirs.foreach &#123; case (dir, e) =&gt; logDirFailureChannel.maybeAddOfflineLogDir(dir, s&quot;Error while loading log dir $dir&quot;, e) &#125; &#125; catch &#123; case e: ExecutionException =&gt; error(s&quot;There was an error in one of the threads during logs loading: $&#123;e.getCause&#125;&quot;) throw e.getCause &#125; finally &#123; threadPools.foreach(_.shutdown()) &#125; info(s&quot;Loaded $numTotalLogs logs in $&#123;time.hiResClockMs() - startMs&#125;ms.&quot;)&#125; å• tp æ—¥å¿—åŠ è½½ä¸æ¢å¤ å•ä¸ª tp çš„æ—¥å¿—åŠ è½½ä¸æ¢å¤æ˜¯åœ¨ Log ç±»çš„é™æ€ä»£ç å—ä¸­è¿›è¡Œçš„ã€‚å¦‚æœè¯¥ tp çš„æ–‡ä»¶å¤¹çš„åç¼€ä¸º-deleteï¼Œåˆ™è®¤ä¸ºè¯¥ tp ä¸ºå¾…åˆ é™¤çš„ï¼ŒåŠ å…¥åˆ° logsToBeDeleted é›†åˆä¸­ç­‰å¾…å®šæ—¶ä»»åŠ¡å¯¹å…¶è¿›è¡Œæ¸…ç†ã€‚Log ç±»çš„é™æ€ä»£ç å—ä¸­é€šè¿‡ loadSegments åŠ è½½æ—¥å¿— 1234567891011121314151617181920212223242526272829303132333435private def loadSegments(): Long = &#123; // æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼ˆ.delete å’Œ .clean åç¼€ï¼‰å¹¶ä¿ç•™å¯ç”¨çš„ swap æ–‡ä»¶ val swapFiles = removeTempFilesAndCollectSwapFiles() // retryOnOffsetOverflow å…œä½å¯èƒ½å‘ç”Ÿçš„ LogSegmentOffsetOverflowException å¼‚å¸¸ï¼Œå¹¶è¿›è¡Œæ—¥å¿—åˆ‡åˆ†å¤„ç†ã€‚ retryOnOffsetOverflow &#123; // åŠ è½½æ–‡ä»¶çš„ä¸­çš„æ‰€æœ‰æ–‡ä»¶å¹¶è¿›è¡Œå¿…è¦çš„å®Œæ•´æ€§æ£€æŸ¥ logSegments.foreach(_.close()) segments.clear() loadSegmentFiles() &#125; // æ ¹æ® swap æ–‡ä»¶æ¢å¤å®Œæˆæ‰€æœ‰è¢«ä¸­æ–­çš„æ“ä½œ completeSwapOperations(swapFiles) // å¦‚æœä¸æ˜¯å¾…åˆ é™¤çš„ tp æ—¥å¿—ï¼Œæ‰§è¡Œ recover æµç¨‹ if (!dir.getAbsolutePath.endsWith(Log.DeleteDirSuffix)) &#123; val nextOffset = retryOnOffsetOverflow &#123; recoverLog() &#125; // reset the index size of the currently active log segment to allow more entries activeSegment.resizeIndexes(config.maxIndexSize) nextOffset &#125; else &#123; if (logSegments.isEmpty) &#123; addSegment(LogSegment.open(dir = dir, baseOffset = 0, config, time = time, initFileSize = this.initFileSize)) &#125; 0 &#125;&#125; recoverLog çš„æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132// if we have the clean shutdown marker, skip recovery// åªæœ‰æœªè¿›è¡Œ cleanshutdown çš„æƒ…å†µä¸‹æ‰éœ€è¦ recoveryif (!hadCleanShutdown) &#123; // å–å‡º recoveryPoint ä¹‹åçš„æ‰€æœ‰ segmentï¼ˆæ­£å¸¸æƒ…å†µä¸‹åªæœ‰ä¸€ä¸ªï¼‰ val unflushed = logSegments(this.recoveryPoint, Long.MaxValue).iterator var truncated = false while (unflushed.hasNext &amp;&amp; !truncated) &#123; val segment = unflushed.next() info(s&quot;Recovering unflushed segment $&#123;segment.baseOffset&#125;&quot;) val truncatedBytes = try &#123; // æ¸…ç©º segment å¯¹åº”çš„ indexï¼Œé€ä¸ª batch è¯»å–æ ¡éªŒæ•°æ®ï¼Œå¹¶é‡æ–°æ„é€ index recoverSegment(segment, leaderEpochCache) &#125; catch &#123; case _: InvalidOffsetException =&gt; val startOffset = segment.baseOffset warn(&quot;Found invalid offset during recovery. Deleting the corrupt segment and &quot; + s&quot;creating an empty one with starting offset $startOffset&quot;) segment.truncateTo(startOffset) &#125; if (truncatedBytes &gt; 0) &#123; // å¦‚æœå‰ä¸€ä¸ª segment æ‰§è¡Œäº† truncateï¼Œ åˆ™ä¹‹åçš„æ‰€æœ‰ segment ç›´æ¥åˆ é™¤ // unflushed ä¸ºè¿­ä»£å™¨ï¼Œæ‰€ä»¥ unflushed.toList ä»£è¡¨çš„æ˜¯æ‰€æœ‰æœªéå†åˆ°çš„ segmentï¼Œè€Œä¸æ˜¯å…¨éƒ¨ segment warn(s&quot;Corruption found in segment $&#123;segment.baseOffset&#125;, truncating to offset $&#123;segment.readNextOffset&#125;&quot;) removeAndDeleteSegments(unflushed.toList, asyncDelete = true, reason = LogRecovery) truncated = true &#125; &#125;&#125;","raw":null,"content":null,"categories":[{"name":"æºç ","slug":"æºç ","permalink":"http://fxbing.github.io/categories/%E6%BA%90%E7%A0%81/"}],"tags":[{"name":"kafka","slug":"kafka","permalink":"http://fxbing.github.io/tags/kafka/"}]},{"title":"äºŒé›¶äºŒä¸€å¹´åäºŒæœˆä¹¦å•","slug":"äºŒé›¶äºŒä¸€å¹´åäºŒæœˆä¹¦å•","date":"2021-12-25T09:38:05.000Z","updated":"2021-12-25T08:49:53.626Z","comments":true,"path":"2021/12/25/äºŒé›¶äºŒä¸€å¹´åäºŒæœˆä¹¦å•/","link":"","permalink":"http://fxbing.github.io/2021/12/25/%E4%BA%8C%E9%9B%B6%E4%BA%8C%E4%B8%80%E5%B9%B4%E5%8D%81%E4%BA%8C%E6%9C%88%E4%B9%A6%E5%8D%95/","excerpt":"ä¸€å¹´å³å°†è¿‡å»ï¼Œä»ä¸ƒæœˆä»½è®°å½•ä»¥æ¥ï¼Œè¯»äº† 28 æœ¬ä¹¦ï¼ŒæŒ‰ç…§è¿™ä¸ªé€Ÿåº¦ï¼Œæ˜å¹´çš„æœ€ä½ç›®æ ‡å¾—æ˜¯ 50 æœ¬ï¼ŒåŠ æ²¹åŠ æ²¹ï¼ğŸ’ªğŸ»ğŸ’ªğŸ»ğŸ’ªğŸ»","text":"ä¸€å¹´å³å°†è¿‡å»ï¼Œä»ä¸ƒæœˆä»½è®°å½•ä»¥æ¥ï¼Œè¯»äº† 28 æœ¬ä¹¦ï¼ŒæŒ‰ç…§è¿™ä¸ªé€Ÿåº¦ï¼Œæ˜å¹´çš„æœ€ä½ç›®æ ‡å¾—æ˜¯ 50 æœ¬ï¼ŒåŠ æ²¹åŠ æ²¹ï¼ğŸ’ªğŸ»ğŸ’ªğŸ»ğŸ’ªğŸ» ğŸ“šä»¥ä¸‹ä¹¦ç±å‡ºç°çš„é¡ºåºä»£è¡¨æˆ‘å¯¹è¿™äº›ä¹¦çš„è¯„åˆ†æ’åºã€‚ ã€Šæ·±å…¥ç†è§£Kafkaï¼šæ ¸å¿ƒè®¾è®¡ä¸å®è·µåŸç†ã€‹ï¼šæ·±å…¥è®²è§£ Kafka åŸç†ä½†æ²¡æœ‰ç®€å•ç½—åˆ—æºç  â€‹ ä½œè€…æœ±å°å®å†™çš„è¿™æœ¬åŸç†è§£æçš„ä¹¦ç¡®å®ä¸é”™ï¼Œç›¸æ¯”ä¸å…¶ä»–ä»‹ç»ç»„ä»¶çš„ä¹¦ç±ï¼Œæ—¢æ²¡æœ‰å†—é•¿çš„åŸºæœ¬æ“ä½œçš„ç½—åˆ—ï¼Œä¹Ÿæ²¡æœ‰è¯¦ç»†åˆ°æ¯ä¸€æ®µä»£ç çš„æºç è§£æã€‚å¯¹äºåŸºç¡€éƒ¨åˆ†ï¼Œä½œè€…ä»‹ç»äº† Kafka ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„åŸºæœ¬ä½¿ç”¨æ–¹å¼ï¼Œä»¥åŠå¦‚ä½•çµæ´»åœ°ä½¿ç”¨æ‹¦æˆªå™¨ã€å¦‚ä½•åšåˆ°ä¸ä¸¢å¤±æ•°æ®ä¸é‡å¤æ¶ˆè´¹ç­‰ï¼Œå¯¹äºé«˜çº§éƒ¨åˆ†ï¼Œä»åŸç†å±‚é¢ä»‹ç»äº† Kafka ä¸­å‡ ä¸ªä¸»è¦çš„é€»è¾‘ï¼Œæ²¡æœ‰æºç è§£æï¼Œä½†æ˜¯åŒ…å«äº†ä¸å°‘ä½œè€…è‡ªå·±çš„æ€è€ƒï¼Œå€¼å¾—å­¦ä¹ ã€‚ ã€Šé»‘ç®±ã€‹ï¼šç°å®ä¸­çš„è¢«æ€§ä¾µè€…æ¯”ç”µå½±æ•…äº‹ä¸­çš„æ›´å—äººåŒæƒ… â€‹ è¿™æ˜¯ä¸€æœ¬é­é‡æ€§ä¾µå¥³å­©çš„è‡ªè¿°ï¼Œè¿™ä¸ªæ—¥æœ¬å¥³å­©è®²è¿°äº†è‡ªå·±æ˜¯å¦‚ä½•é­é‡æ€§ä¾µçš„ã€è­¦å¯Ÿæ˜¯å¦‚ä½•ä¸è´Ÿè´£ä»»çš„ä»¥åŠå¥¹æœ€ç»ˆé€šè¿‡æ‚å¿—å’Œå‘å¸ƒä¼šè®²å‡ºè¿™ä»¶äº‹çš„åŸå› ã€‚åœ¨æ—¥æœ¬è¿™ä¸ªç”·æƒç¤¾ä¼šä¸­ï¼Œå—æ€§ä¾µè€…ç»´æŠ¤è‡ªå·±çš„æƒåˆ©ååˆ†å›°éš¾ï¼Œå› ä¸ºè­¦å¯Ÿéƒ½è®¤ä¸ºè¿™æ˜¯ä¸€ä»¶æ­£å¸¸çš„äº‹ï¼Œè­¦å¯Ÿéƒ½ä¼šå€¾å‘è®©å—å®³äººç§äº†ã€‚å¹¶ä¸”åœ¨ä½œè€…å°±åŒ»ä»¥åŠæ¥å—è­¦å¯Ÿé—®è¯¢çš„è¿‡ç¨‹ä¸­ï¼ŒçœŸåˆ‡æ„Ÿå—åˆ°äº†ä»€ä¹ˆå«åšâ€œäºŒæ¬¡æ€§ä¾µâ€ï¼Œè®©å—å®³è€…ä¸æ–­æ­å¼€è‡ªå·±çš„ä¼¤ç–¤ç”šè‡³æ¯”ç¬¬ä¸€æ¬¡é­é‡ä¼¤å®³è¿˜è¦æ®‹å¿ã€‚ä½œè€…æ˜¯å‹‡æ•¢çš„ï¼Œå¥¹çš„è¡¨è¾¾å¸¦åŠ¨æ›´å¤šçš„äººåŠ å…¥åˆ°äº†#MeTooè¿åŠ¨ä¸­ï¼Œä¹Ÿè®©æˆ‘ä»¬å¯ä»¥æ›´æ·±åœ°äº†è§£åˆ°è¿™ç±»äº‹ä»¶çš„çœŸç›¸ã€‚ ã€ŠæŠ±ä½æ£’æ£’çš„è‡ªå·±ã€‹ï¼šçŸ­å°å´æœ‰æ„ä¹‰çš„å¿ƒç†æ¡ˆä¾‹åˆé›† â€‹ è¿™æœ¬ä¹¦çœ‹åå­—æœ‰ç‚¹æ— è¥å…»ç•…é”€ä¹¦çš„æ„Ÿè§‰ï¼Œå®é™…è¯»èµ·æ¥åˆ™ä¸ç„¶ã€‚è¿™æœ¬ä¹¦å‡ºè‡ªå¾æ…¢æ…¢å…¬ä¼—å·ï¼Œé€šè¿‡ä¸€ä¸ªè™šæ‹Ÿäººç‰©ï¼Œä»¥æ¼«ç”»çš„å½¢å¼åˆ»ç”»äº†è®¸å¤šæˆ‘ä»¬åœ¨ç”Ÿæ´»ä¸­ä¼šé‡åˆ°çš„åœºæ™¯ï¼Œé€šè¿‡æµ…æ˜¾çš„æ–¹å¼è®²å‡ºäº†è®¸å¤šé“ç†ï¼š å…³äºæ¥çº³è‡ªå·±ï¼šå½“ä¸€ä¸ªäººä¸è¢«é€¼è¿«ã€ä¸è¢«è®¾é™ï¼Œè€Œæ˜¯è¢«æ— æ¡ä»¶åœ°æ¥çº³æ—¶ï¼Œä»–è‡ªç„¶èƒ½æ„ŸçŸ¥åˆ°æ¥çº³èƒŒåçš„çˆ±å’ŒæœŸå¾…ã€‚ å…³äºè‡ªæˆ‘æ‰¹åˆ¤ï¼šæˆ‘ä»¬æœ‰æ„è¯†åœ°å‹æŠ‘æ¶ˆææƒ…ç»ªã€è‡ªæˆ‘æ‰¹åˆ¤ï¼Œåªä¼šè®©æƒ…ç»ªæ›´åŠ å¼ºåŒ–ã€‚è‡ªæˆ‘æ‰¹åˆ¤çš„äººå…¶å®æ›´å®¹æ˜“è®¤è¾“æ”¾å¼ƒã€‚ å…³äºå¸®åŠ©åˆ«äººï¼šæ¯”ä¸€åˆ‡å¸®åŠ©æ›´ä¸ºåŸºæœ¬çš„å¸®åŠ©ï¼Œæ˜¯è®©äººä»¬æ„è¯†åˆ°ï¼Œä»–ä»¬æ€»æ¯”è‡ªå·±ä»¥ä¸ºçš„æ›´æœ‰åŠæ³•ã€‚ å…³äºè‡ªæˆ‘è¦æ±‚ï¼šæ€»æƒ³æ­£ç¡®åœ°æ´»ç€ï¼Œå…¶å®æ˜¯ä¸€ç§è™šå¼±ã€‚ä¸è¦å‡¡äº‹éƒ½å»æƒ³å¯¹é”™ã€‚ ã€Šå…¬æ­£ï¼šè¯¥å¦‚ä½•æ˜¯å¥½ï¼Ÿã€‹ï¼šå¦‚ä½•è¾©è¯åœ°çœ‹å¾…å…¬æ­£è¿™ä¸ªé—®é¢˜ â€‹ æœ€æœ‰åçš„å“ˆä½›å…¬å¼€è¯¾ï¼Œä½œè€…é€šè¿‡ä¸€ä¸ªä¸ªæœ‰å…³å…¬æ­£çš„æ•…äº‹ï¼Œå¼•å…¥äº†å¢æ¢­ã€è¾¹æ²ã€åº·å¾·ç­‰äººçš„å­¦è¯´ï¼Œè§£é‡Šäº†ä»–ä»¬çš„è§‚ç‚¹ï¼Œåˆæ¨ç¿»äº†ä»–ä»¬çš„è§‚ç‚¹ã€‚è¿™æœ¬ä¹¦é‡è¦çš„ä¸æ˜¯å‘Šè¯‰æˆ‘ä»¬åˆ°åº•ä»€ä¹ˆæ‰æ˜¯å…¬æ­£ï¼Œè€Œæ˜¯æ•™ä¼šæˆ‘ä»¬è¾©è¯åœ°æ€è€ƒå…¬æ­£è¿™ä»¶äº‹æƒ…ï¼Œå‡¡äº‹æ— ç»å¯¹ï¼Œè¾©è¯æ€è€ƒæ‰èƒ½è·³å‡ºæ€æƒ³æŸç¼šã€‚ ã€Šæˆ¿ä»·çš„é€»è¾‘ã€‹ï¼šé€šè¿‡æ•°æ®è§£é‡Šäº†ä¸ºä»€ä¹ˆé‚£äº›å…³äºæˆ¿ä»·çš„æµè¨€ä¸æ­£ç¡® â€‹ ä¸ºä»€ä¹ˆæˆ¿ä»·ä¸ä¼šè·Œï¼Ÿä¸ºä»€ä¹ˆè¯´æˆ¿åœ°äº§ä¸æ˜¯æ³¡æ²«ï¼Ÿä½œè€…é€šè¿‡ä¸å…¨çƒèŒƒå›´å†…çš„å¤§åŸå¸‚ï¼ˆä¸œäº¬ã€çº½çº¦ã€ä¼¦æ•¦ç­‰ï¼‰å¯¹æ¯”ï¼Œç”¨æ•°æ®å¯¹å…³äºä¹°æˆ¿çš„ç§ç§æµè¨€è¿›è¡Œåé©³ã€‚æ€»ç»“èµ·æ¥å°±æ˜¯ï¼šä¸è®ºæ˜¯ç”Ÿè‚²ç‡ä¸‹é™è¿˜æ˜¯æ”¿åºœçš„ä¸¥æ ¼ç®¡æ§ï¼Œéƒ½ä¸ä¼šæ”¹å˜å¤§åŸå¸‚æˆ¿ä»·ä¸Šæ¶¨çš„è¶‹åŠ¿ï¼Œå› ä¸ºä¼˜ç§€çš„äººæ‰æ°¸è¿œéƒ½ä¼šå‘å¥½çš„åœ°æ–¹æµåŠ¨ï¼Œå¥½çš„åœ°æ–¹éƒ½æ˜¯æˆ¿å­ä¾›ç»™ä¸è¶³ã€‚è¯´æ˜ä¾›æ±‚å…³ç³»çš„æœ€ç®€å•é€»è¾‘å°±æ˜¯ï¼šâ€œå‡è®¾æˆ¿å­é™ä»·ï¼Œä½ ä¼šä¸ä¼šä¸Šè½¦ï¼Ÿâ€ ã€Šæ²¸è…¾æ–°åå¹´ã€‹ï¼šä¸€æœ¬äº’è”ç½‘ç§‘æŠ€å² â€‹ è¿™æœ¬ä¹¦ä¸Šä¸‹ä¸¤å†Œï¼Œ60 å¤šä¸‡å­—ï¼Œä»‹ç»äº†ä» 2010 å¹´åˆ° 2020 å¹´åå¹´é—´äº’è”ç½‘ä¸­é‡è¦çš„å†å²ï¼Œå†…å®¹ç›¸å½“å…¨é¢ï¼Œå¯ä»¥çœ‹åˆ°äº’è”ç½‘ä¸­æ¯ä¸ªå°é¢†åŸŸçš„å˜åŒ–ï¼Œä¹Ÿå¯ä»¥çœ‹åˆ°å„ä¸ªå¤§å‚çš„èµ·èµ·ä¼ä¼ã€‚ä½†æ˜¯æ¶‰åŠåˆ°çš„äººç‰©ç¡®å®æœ‰ç‚¹å¤šï¼Œçœ‹å®Œåªèƒ½çŸ¥é“å¤§æ¦‚çš„äº‹ä»¶ï¼Œå´è®°ä¸å¾—æœ‰å“ªäº›äººã€‚ä¸»è¦è¿˜æ˜¯ä¸€äº›å®¢è§‚äº‹å®çš„æè¿°ï¼Œä¸»è§‚çš„è§£è¯»è¿˜æ˜¯è¦é è‡ªå·±çš„æ€è€ƒã€‚","raw":null,"content":null,"categories":[{"name":"è¯»ä¹¦","slug":"è¯»ä¹¦","permalink":"http://fxbing.github.io/categories/%E8%AF%BB%E4%B9%A6/"}],"tags":[{"name":"2021ä¹¦å•","slug":"2021ä¹¦å•","permalink":"http://fxbing.github.io/tags/2021%E4%B9%A6%E5%8D%95/"}]},{"title":"äºŒé›¶äºŒä¸€å¹´åä¸€æœˆä¹¦å•","slug":"äºŒé›¶äºŒä¸€å¹´åä¸€æœˆä¹¦å•","date":"2021-12-04T09:34:54.000Z","updated":"2021-12-04T11:30:05.958Z","comments":true,"path":"2021/12/04/äºŒé›¶äºŒä¸€å¹´åä¸€æœˆä¹¦å•/","link":"","permalink":"http://fxbing.github.io/2021/12/04/%E4%BA%8C%E9%9B%B6%E4%BA%8C%E4%B8%80%E5%B9%B4%E5%8D%81%E4%B8%80%E6%9C%88%E4%B9%A6%E5%8D%95/","excerpt":"æœ‰ç‚¹è¿Ÿåˆ°ï¼Œå†²å†²å†²ï¼","text":"æœ‰ç‚¹è¿Ÿåˆ°ï¼Œå†²å†²å†²ï¼ ğŸ“šä»¥ä¸‹ä¹¦ç±å‡ºç°çš„é¡ºåºä»£è¡¨æˆ‘å¯¹è¿™äº›ä¹¦çš„è¯„åˆ†æ’åºã€‚ ã€Šæ²‰é»˜çš„å¤§å¤šæ•°ã€‹ï¼šç›¸å½“æœ‰æ„æ€åæ§½ â€‹ æ­£å¦‚è¿™æœ¬ä¹¦çš„åå­—æ‰€è¨€ï¼Œå¤šæ•°äººå¯¹äºå„ç§äº‹æƒ…ä¼šæœ‰ä¸æ»¡ï¼Œä½†æ˜¯ä¼šé€‰æ‹©æ²‰é»˜ï¼Œç‹å°æ³¢å°±åƒæ˜¯ä¸ºè¿™äº›â€œæ²‰é»˜çš„å¤§å¤šæ•°â€ä»£è¨€ï¼Œè¯´å‡ºäº†ä¸€äº›æˆ‘æ·±æœ‰åŒæ„Ÿå´æƒ³ä¸èµ·æ¥è¦è¯´ã€ä¹Ÿæ²¡è¿™ä¹ˆä¼šè¯´çš„æƒ³æ³•ï¼ˆpsï¼šçœ‹åˆ°ä»–å¼ºæ¨ã€Šä¹¡æ‘ç»æµã€‹æ—¶è¿˜æ˜¯å¾ˆå¼€å¿ƒçš„ï¼‰ã€‚ç‹å°æ³¢çš„è¡¨è¾¾å¤ªæœ‰æ„æ€äº†ï¼Œåƒä¸€ä¸ªâ€œæ„¤é’â€ã€åƒä¸€ä¸ªâ€œåæ§½æ€ªâ€ï¼Œè¯»èµ·æ¥å¾ˆæ˜¯èˆ’æœã€‚è™½ç„¶æ²¡æœ‰å¯¹è¿™æœ¬ä¹¦å…·ä½“å†…å®¹çš„æ€»ç»“ï¼Œä½†æ˜¯ä¸å½±å“æˆ‘å¯¹è¿™æœ¬ä¹¦çš„è¯„ä»·ã€‚ ã€Šå¹¸ç¦ä¹‹è·¯ã€‹ï¼šä»å„ä¸ªè§’åº¦è®ºè¿°å¦‚ä½•æ›´å¹¸ç¦ â€‹ ç½—ç´ çš„å¹¸ç¦è§‚ï¼Œä»å„ä¸ªè§’åº¦è®²è¿°å¦‚ä½•è®©è‡ªå·±å˜å¾—æ›´å¹¸ç¦ï¼Œä¸‹é¢æ˜¯ä¸€äº›è¯»ä¹¦ç¬”è®°ï¼Œæ€»ç»“äº†æˆ‘çš„ç†è§£ï¼š è®ºç«äº‰:ç«äº‰è®©äººä»¬å¿˜è®°äº†äº‹æƒ…çš„æœ¬è´¨ï¼Œå¿˜è®°äº†äº«å—ç”Ÿæ´»ï¼ŒåªçŸ¥é“å»å’Œåˆ«äººæ¯”è¾ƒã€‚ è®ºçƒ¦é—·ä¸å…´å¥‹:å…´å¥‹å°±åƒé•‡é™å‰‚ï¼Œè¿‡å°‘ä¼šè®©ç”Ÿæ´»è¿‡äºå¹³æ·¡ï¼Œå¯¼è‡´çƒ¦é—·ï¼Œä½†æ˜¯è¿‡å¤šå°±æˆäº†æ¯’å“ã€‚çœŸæ­£çš„å¿«ä¹åº”è¯¥æ¥è‡ªäºè¿œå¤§ç¨³å®šçš„ç›®æ ‡è¿™ç§é•¿ä¹…çš„ä¸œè¥¿ï¼Œè€Œä¸æ˜¯å¸æ¯’è¿™ç§çŸ­æš‚çš„ä¸œè¥¿ï¼Œå› ä¸ºçŸ­æš‚çš„å…´å¥‹è¿‡åï¼Œä¼šæ˜¯æ›´å¤§çš„çƒ¦é—·ä¸å¤±è½ï¼Œè€Œé•¿ä¹…çš„ç›®æ ‡ï¼Œæ‰èƒ½è®©æˆ‘ä»¬å¿«ä¹æ°¸é©»ã€‚ç”¨ç½—ç´ çš„è¯è¯´ï¼Œé•¿ä¹…å¹³é™çš„å¿«ä¹ä¸çŸ­æš‚çš„å…´å¥‹ç›¸æ¯”ï¼Œå°±åƒæ˜¯æœ‰çˆ±æƒ…çš„æ€§ç”Ÿæ´»ä¸æ²¡æœ‰çˆ±æƒ…çš„æ€§ç”Ÿæ´»ã€‚å¹¸ç¦çš„ç”Ÿæ´»åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šä¸€å®šæ˜¯ä¸€ç§å¹³é™çš„ç”Ÿæ´»ï¼Œå› ä¸ºçœŸæ­£çš„å¿«ä¹åªèƒ½å¸¸é©»åœ¨å¹³é™çš„ç¯å¢ƒé‡Œã€‚ è®ºç–²åŠ³:ç°ä»£çš„ç–²åŠ³å¤§å¤šæ˜¯ç²¾ç¥ä¸Šçš„ç–²åŠ³è€Œä¸æ˜¯è‚Œè‚‰ä¸Šçš„ã€‚ä¸€æ–¹é¢æ˜¯å› ä¸ºææƒ§ä½•ç§æœ€åçš„æƒ…å†µï¼Œå¦ä¸€æ–¹é¢æ˜¯å› ä¸ºå–œæ¬¢å…´å¥‹ï¼Œå…´å¥‹æ¶ˆè€—äº†å¤§é‡çš„ç²¾åŠ›ã€‚ è®ºå«‰å¦’ï¼šä¸ä¼šä»è‡ªå·±æ‹¥æœ‰çš„ä¸œè¥¿å¯»æ‰¾å¿«ä¹ï¼Œè€Œä¼šä»å…¶ä»–äººæ‹¥æœ‰çš„ä¸œè¥¿å¯»æ‰¾ç—›è‹¦ã€‚ç°ä»£äººçš„å«‰å¦’å˜å¤šäº†ï¼Œå› ä¸ºä»–ä»¬ä»ä»¥å‰åªäº†è§£å«‰å¦’è‡ªå·±çš„é‚»å±…ï¼Œå˜æˆäº†å¯ä»¥äº†è§£æ›´å¤šçš„ä¸œè¥¿ã€‚â€œå¸Œæœ›ä»ç»æœ›ä¸­æ‰¾åˆ°æ­£ç¡®é“è·¯çš„æ–‡æ˜äººä¸€å®šè¦åƒæ‹“å±•è‡ªå·±çš„æ€ç»´é‚£æ ·æ—·è¾¾è‡ªå·±çš„å¿ƒèƒ¸ï¼Œä¸€å®šè¦å­¦ä¼šè¶…è¶Šè‡ªæˆ‘ï¼Œä»è€Œè·å¾—å®‡å®™èˆ¬æ— é™çš„è‡ªç”±å¿ƒçµâ€ã€‚ è®ºçŠ¯ç½ªæ„Ÿï¼šçŠ¯ç½ªæ„Ÿå¤§å¤šæ¥è‡ªäºæˆ‘ä»¬ä»å°è¢«çŒè¾“çš„ä¸ä¸€å®šæ­£ç¡®çš„é“å¾·è§‚ï¼Œå½“æ„Ÿè§‰åˆ°çŠ¯ç½ªæ„Ÿæ—¶ï¼Œéœ€è¦ç”¨ç†æ€§å»è¯„ä¼°æ˜¯å¦çœŸçš„é”™è¯¯ï¼Œè¦ä»¥ç†æ€§çš„åˆ¤æ–­ä¸ºå‡†ã€‚ è®ºè¢«è™ç‹‚ï¼šç¬¬ä¸€ï¼Œè¦è®°ä½ï¼Œä½ çš„åŠ¨æœºå¹¶ä¸æ€»åƒä½ æƒ³çš„é‚£æ ·æ— ç§ï¼›ç¬¬äºŒï¼Œä¸è¦è¿‡é«˜ä¼°è®¡ä½ çš„ä»·å€¼ï¼›ç¬¬ä¸‰ï¼Œä¸è¦æŒ‡æœ›åˆ«äººä¹Ÿåƒä½ ä¸€æ ·é‚£ä¹ˆçœ‹é‡ä½ ï¼›ç¬¬å››ï¼Œä¸è¦å¹»æƒ³ç€å¤§å¤šæ•°äººæ€»æ˜¯åœ¨æƒ³ç€æ€ä¹ˆå®³ä½ ã€‚ è®ºèˆ†è®ºå‹åŠ›ï¼šä¸è¦è¿‡åº¦åœ¨æ„åˆ«äººçš„çœ‹æ³•ï¼Œå› ä¸ºå¤§éƒ¨åˆ†äººçš„çœ‹æ³•éƒ½æ˜¯åè§ï¼Œå¦‚æœæœ‰å¯èƒ½ï¼Œå»ä¸€ä¸ªè‡ªå·±å–œæ¬¢çš„ç¯å¢ƒï¼Œåœ¨è¿™é‡Œåˆ«äººå¯¹ä½ çš„çœ‹æ³•å°±åˆæ˜¯å¦ä¸€ç§ã€‚ä½†æ˜¯ï¼Œè¦å¬å–è¡Œä¸šä¸“å®¶çš„æ„è§ã€‚ è¿˜å¯ä»¥å¿«ä¹å—ï¼šå¹¸ç¦çš„ç§˜è¯€åœ¨äºï¼šå…´è¶£è¦å°½å¯èƒ½çš„å¹¿ï¼Œå°½å¯èƒ½å–„æ„çš„è€Œä¸æ˜¯æ•Œæ„çš„å¯¹å¾…ä½ æ„Ÿå…´è¶£çš„äººå’Œç‰©ã€‚ è®ºæƒ…è¶£ï¼šæƒ…è¶£æ˜¯å¹¸ç¦ã€å®‰åº·çš„ç§˜è¯€ï¼Œä½†æ˜¯å¿…é¡»è¦è®©å®ƒä»¬ä¸å¥åº·ã€ä¸æˆ‘ä»¬æ‰€çˆ±çš„äººçš„æƒ…æ„Ÿã€ä¸æˆ‘ä»¬ç”Ÿæ´»ç€çš„ç¤¾ä¼šæ‰€å°Šé‡çš„ä¸œè¥¿åè°ƒä¸€è‡´ã€‚ä¸è¦è¿‡åº¦æ”¾çºµå¯»æ±‚é—å¿˜ï¼Œä¹Ÿä¸è¦è¿‡äºå—æ–‡æ˜ç¤¾ä¼šçš„çº¦æŸè€Œå¤„å¤„ä¸æ•¢ã€‚ è®ºçˆ±ï¼šæœ€å¥½çš„æ˜¯å¯ä»¥äº’æƒ çš„çˆ±ï¼Œå„è‡ªå¯ä»¥æ„‰å¿«åœ°æ¥å—çˆ±ï¼Œè‡ªç„¶åœ°ç»™äºˆçˆ±ï¼Œæ¯ä¸€æ–¹éƒ½ä¼šå› ä¸ºè¿™ç§äº’æƒ çš„å¿«ä¹çš„å­˜åœ¨è€Œè§‰å¾—è¿™ä¸ªä¸–ç•Œæ›´æœ‰æ„æ€äº†ã€‚ è®ºå®¶åº­ï¼šçˆ¶æ¯ä¸å­©å­ä¹‹é—´çš„æ„Ÿæƒ…æ¯”ä»»ä½•æƒ…æ„Ÿéƒ½æ›´åŠ ç‰¢å›ºï¼Œä½†æ˜¯ä¸èƒ½å¯¹å­©å­æœ‰è¿‡å¤šçš„å æœ‰æ¬²ï¼Œæˆ–è€…å¼ºè¿«å­©å­å¿…é¡»æŒ‰ç…§è‡ªå·±çš„æ„å¿—æˆé•¿ï¼Œæ•™è‚²ä¹Ÿå¯ä»¥äº¤ç»™æ›´ä¸“ä¸šçš„äººåšï¼Œå¹¶ä¸”ä¼šåšå¾—æ›´å¥½ã€‚ è®ºå·¥ä½œï¼šæ˜æ™ºåœ°åº¦è¿‡é—²æš‡æ—¶å…‰çš„èƒ½åŠ›æ˜¯æ–‡æ˜çš„ç»ˆæäº§ç‰©ï¼›æœ‰æ„æ€çš„å·¥ä½œä¸»è¦å…·å¤‡ä¸¤ä¸ªè¦ç´ ï¼šå¯ä»¥è¿ç”¨æŠ€èƒ½ï¼›å…·æœ‰å»ºè®¾æ€§ã€‚ è®ºé—²æƒ…é€¸è‡´ï¼šæˆ‘ä»¬åªæ˜¯å®‡å®™ä¸­å¾ˆå°çš„ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬é­é‡çš„ç—›è‹¦ã€æ‚²ä¼¤ä¹Ÿæ˜¯å¾®ä¸è¶³é“çš„ï¼Œå› æ­¤ï¼Œä¸è¦æ²‰æµ¸äºç—›è‹¦ä¸èƒ½è‡ªæ‹”ï¼Œåº”è¯¥ç§¯æçš„é€šè¿‡è½¬ç§»ç›®æ ‡æ–¹å¼è®©è‡ªå·±æ‘†è„±ç—›è‹¦ã€‚ è®ºåŠªåŠ›ä¸æ”¾å¼ƒï¼šä¸è¦è®©æ— æ‰€è°“çš„å°äº‹å½±å“äº†è‡ªå·±ã€‚å°½äººäº‹ï¼Œå¬å¤©å‘½ï¼Œä¸è¦æ„Ÿæƒ…ç”¨äº‹ã€‚ ã€Šè®ºäººç±»ä¸å¹³ç­‰çš„èµ·æºå’ŒåŸºç¡€ã€‹ï¼šç¤¾ä¼šäº§ç”Ÿä¹‹åä¸å¹³ç­‰å°±å¼€å§‹äº† â€‹ è¯»ä¹¦æ‘˜æŠ„ï¼š å¦‚æœæˆ‘ä»¬ä»è¿™äº›ä¸åŒçš„å˜é©ä¸­å»å¯»æ‰¾ä¸å¹³ç­‰å‘å±•çš„è¶³è¿¹ï¼Œæˆ‘ä»¬ä¼šå‘ç°æ³•å¾‹å’Œç§æœ‰è´¢äº§æƒçš„å½¢æˆæ˜¯ä¸å¹³ç­‰å½¢æˆçš„ç¬¬ä¸€é˜¶æ®µï¼›æ³•å®˜çš„è®¾ç«‹æ˜¯ç¬¬äºŒé˜¶æ®µï¼›è€Œç¬¬ä¸‰ä¸ªä¹Ÿæ˜¯æœ€åä¸€ä¸ªé˜¶æ®µï¼Œåˆ™æ˜¯åˆæ³•æƒåˆ©å‘ä¸“åˆ¶æƒåŠ›çš„è½¬å˜ã€‚å› æ­¤ï¼Œç¬¬ä¸€ä¸ªé˜¶æ®µå‚¬ç”Ÿçš„æ˜¯è´«å¯Œçš„å·®è·ï¼Œç¬¬äºŒä¸ªé˜¶æ®µé€ å°±çš„æ˜¯å¼ºå¼±çš„æ‚¬æ®Šï¼Œè€Œç¬¬ä¸‰ä¸ªé˜¶æ®µè¯ç”Ÿçš„åˆ™æ˜¯ä¸»äººä¸å¥´éš¶çš„å¯¹ç«‹ã€‚ä¸»äººä¸å¥´éš¶çš„å¯¹ç«‹æ­£æ˜¯ä¸å¹³ç­‰çš„æœ€åé˜¶æ®µï¼Œæ˜¯æ‰€æœ‰å…¶ä»–ä¸å¹³ç­‰ç»ˆå°†æŠµè¾¾çš„å½¼å²¸ã€‚è¿™ä¸€é˜¶æ®µå°†ä¸€ç›´æŒç»­ï¼Œç›´åˆ°æ–°çš„é©å‘½å°†æ”¿åºœå½»åº•ç“¦è§£æˆ–è€…ä½¿å…¶å‘åˆæ³•åˆ¶åº¦é æ‹¢ä¸ºæ­¢ã€‚ å¦‚æœæ‰€æœ‰æœªç»å •è½ä¸å˜è´¨çš„æ”¿åºœéƒ½èƒ½åšåˆ°ä¸å¿˜åˆå¿ƒï¼Œä¸¥æ ¼æŒ‰ç…§æˆç«‹ä¹‹åˆçš„ç›®çš„è¡Œäº‹ï¼Œé‚£ä¹ˆï¼Œè¿™ä¸ªæ”¿åºœçš„æˆç«‹é€šå¸¸å°±ä¸æ˜¯å¿…éœ€çš„ï¼›åœ¨ä¸€ä¸ªå›½å®¶é‡Œï¼Œå¦‚æœæ²¡æœ‰ä»»ä½•äººè§„é¿æ³•å¾‹ã€æ»¥ç”¨å¸æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªå›½å®¶æ˜¯æ—¢ä¸éœ€è¦æ³•å®˜ä¹Ÿä¸éœ€è¦æ³•å¾‹çš„ã€‚ ç¤¾ä¼šçš„äº§ç”Ÿæ˜¯äººç±»ä¹‹é—´äº’ç›¸è”ç³»çš„å¢åŠ ï¼Œè”ç³»æ›´åŠ ç´§å¯†ä¹‹åå°±é¿å…ä¸äº†å¯¹æ¯”ä¸ç«äº‰å¯¹æ‰‹æœ‰å¯¹æ¯”å’Œç«äº‰å°±ä¼šæœ‰ä¸å…¬å¹³ã€‚ç›¸åï¼ŒåŸå§‹äººåè€Œæ˜¯å­¤ç‹¬è€Œå¹³ç­‰çš„ã€‚ å¯Œäººä¸ºäº†è®©ç©·äººä»å¥´éš¶èº«ä»½è§£æ”¾å‡ºæ¥ï¼Œåˆ›å»ºäº†æ”¿åºœï¼Œä½†å…¶å®ï¼Œå¯Œäººåªæ˜¯ä¸ºäº†é˜²æ­¢å¥´éš¶å› ä¸ºä¸å¹³ç­‰è€ŒåæŠ—ï¼Œæ‰€ä»¥æ‰€è°“æ°‘ä¸»æ”¿åºœçš„å»ºç«‹å¹¶éå¹³ç­‰ã€‚ ã€Šåç‰©æ¬²æ—¶ä»£çš„æ¥ä¸´ã€‹ï¼šäººä»¬æ˜¯å¦‚ä½•æ‰è¿›æ¶ˆè´¹ä¸»ä¹‰é™·é˜±çš„ åœ¨æˆ‘çœ‹æ¥ï¼Œè¿™æœ¬ä¹¦ä¸»è¦æ˜¯å¯¹â€œæ¶ˆè´¹ä¸»ä¹‰é™·é˜±â€çš„è¯ é‡Šã€‚æˆ‘æ˜¯åœ¨çœ‹è´¹å­é€šå¤§ä½¬çš„ã€Šæ±Ÿæ‘ç»æµã€‹æ—¶ï¼Œåœ¨ä¹¦åºä¸­å‘ç°çš„è¿™æœ¬ä¹¦ï¼Œæ„Ÿè§‰è®©æˆ‘çœ¼å‰ä¸€äº®çš„å¹²è´§æ²¡æœ‰å¾ˆå¤šï¼Œå”¯ä¸€è®°ä½çš„ä¸€æ®µæœ‰æ„æ€çš„è§‚ç‚¹æ˜¯ï¼šâ€œé²æ›¼ï¼šè¿™ä¸€ç¤¾ä¼šçš„ç²¾ç¥ç‰¹è´¨å®£å‘Š:å‡å¦‚ä½ å¿ƒæƒ…ä½è½ï¼Œé‚£å°±åƒã€‚è¿™é‡Œå‘ç”Ÿäº†ä¸€ä¸ªæ‚–è®ºï¼šå› ä¸ºæ¸©é¥±çš„è§£å†³ï¼Œå‘ç”Ÿäº†ç©ºè™šå’Œæ— èŠçš„é—®é¢˜;æˆ‘ä»¬å´åœ¨è§£å†³æ¸©é¥±ä¸Šé¢åŠ å¤§ç ç ï¼Œæ¥åº”å¯¹ç©ºè™šå’Œæ— èŠçš„é—®é¢˜ã€‚â€","raw":null,"content":null,"categories":[{"name":"è¯»ä¹¦","slug":"è¯»ä¹¦","permalink":"http://fxbing.github.io/categories/%E8%AF%BB%E4%B9%A6/"}],"tags":[{"name":"2021ä¹¦å•","slug":"2021ä¹¦å•","permalink":"http://fxbing.github.io/tags/2021%E4%B9%A6%E5%8D%95/"}]},{"title":"äºŒé›¶äºŒä¸€å¹´åæœˆä¹¦å•","slug":"äºŒé›¶äºŒä¸€å¹´åæœˆä¹¦å•","date":"2021-10-31T07:23:11.000Z","updated":"2021-12-04T09:42:27.537Z","comments":true,"path":"2021/10/31/äºŒé›¶äºŒä¸€å¹´åæœˆä¹¦å•/","link":"","permalink":"http://fxbing.github.io/2021/10/31/%E4%BA%8C%E9%9B%B6%E4%BA%8C%E4%B8%80%E5%B9%B4%E5%8D%81%E6%9C%88%E4%B9%A6%E5%8D%95/","excerpt":"åä¸€é•¿å‡åŠ ä¼‘å‡çš„ä¸€ä¸ªæœˆï¼Œè¯»ä¹¦é‡å˜å°‘äº†ğŸ¶ã€‚","text":"åä¸€é•¿å‡åŠ ä¼‘å‡çš„ä¸€ä¸ªæœˆï¼Œè¯»ä¹¦é‡å˜å°‘äº†ğŸ¶ã€‚ ğŸ“šä»¥ä¸‹ä¹¦ç±å‡ºç°çš„é¡ºåºä»£è¡¨æˆ‘å¯¹è¿™äº›ä¹¦çš„è¯„åˆ†æ’åºã€‚ ã€Šè¢«è®¨åŒçš„å‹‡æ°”ã€‹ï¼šå˜æ¸…è‡ªå·±çš„è¯¾é¢˜å¹¶åšå¥½å®ƒ â€‹ è¿™æœ¬ä¹¦é€šè¿‡é•¿è€…ä¸é’å¹´å¯¹è¯çš„å½¢å¼ï¼Œå¯¹é˜¿å¾·å‹’å¿ƒç†å­¦è¿›è¡Œäº†é€šä¿—å¹¶æ·±åˆ»çš„è§£é‡Šï¼Œæ€»ç»“èµ·æ¥ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š äººç”Ÿç›®æ ‡ï¼šäººç”Ÿä¸æ˜¯ä¸ä»–äººæ¯”èµ›ï¼Œä¸è¦æœ‰å’Œä»–äººçš„ç«äº‰æ„è¯†ï¼Œåªéœ€è¦ä¸ç†æƒ³çš„è‡ªå·±æ¯”è¾ƒå°±å¯ä»¥äº†ã€‚å¥å…¨çš„è‡ªå‘æ„Ÿä¹Ÿä¸æ˜¯æ¥è‡ªäºå’Œä»–äººçš„æ¯”è¾ƒï¼Œè€Œæ˜¯æ¥è‡ªäºç†æƒ³çš„è‡ªå·±çš„æ¯”è¾ƒã€‚ç«äº‰æ„è¯†ä¸ä»…ä¼šè®©æˆ‘ä»¬æ‹˜æ³¥äºèƒœè´Ÿè€Œæ— æ³•åšå‡ºæ­£ç¡®çš„é€‰æ‹©ï¼Œè€Œä¸”è¿˜ä¼šè®©æˆ‘ä»¬å¢åŠ å¾ˆå¤šä¸æ­£å¸¸çš„è‡ªå‘æˆ–è€…è‡ªå¤§çš„æ„Ÿè§‰ã€‚ äººé™…å…³ç³»ï¼šåŸºæœ¬ä¸Šï¼Œä¸€åˆ‡äººé™…å…³ç³»çŸ›ç›¾éƒ½èµ·å› äºå¯¹åˆ«äººçš„è¯¾é¢˜å¦„åŠ å¹²æ¶‰æˆ–è€…è‡ªå·±çš„è¯¾é¢˜è¢«åˆ«äººå¦„åŠ å¹²æ¶‰ã€‚å¤„ç†äººé™…å…³ç³»çš„ç¬¬ä¸€æ­¥ï¼Œè¦è€ƒè™‘â€œè¿™æ˜¯è°çš„è¯¾é¢˜â€ï¼Œå¦‚æœæ˜¯è‡ªå·±çš„ï¼Œä¸è¦å› ä¸ºåˆ«äººçš„çœ‹æ³•æ¥å½±å“è‡ªå·±çš„å†³æ–­ï¼Œå¦‚æœæ˜¯åˆ«äººçš„ï¼Œä¸è¦å¯¹åˆ«äººçš„è¯¾é¢˜è¿‡åº¦å¹²æ¶‰ã€‚ä¾èµ–æˆ–è€…å¹²æ¶‰åˆ«äººéƒ½æ˜¯æ²¡æœ‰å°†å½¼æ­¤æ”¾åœ¨åŒä¸€æ°´å¹³çš„è¡¨ç°ï¼Œæ˜¯åœ¨æ½œæ„è¯†ä¸­è®¤ä¸ºåˆ«äººæ¯”è‡ªå·±é«˜ä¸€ç­‰æˆ–è€…è‡ªå·±æ¯”è¾ƒåˆ«äººé«˜ä¸€ç­‰ã€‚ä½†å…¶å®äººä¸äººä¹‹é—´æ˜¯å¹³ç­‰çš„ï¼Œå¯èƒ½æœ‰ç¤¾ä¼šå±‚é¢çš„é•¿å¹¼å°Šå‘ï¼Œè€Œä½œä¸ºäººï¼Œæ˜¯ä¸å­˜åœ¨ç­‰çº§å·®åˆ«çš„ã€‚è¿™ä¸ªé“ç†ä¸ä»…é™äºæœ‹å‹ä¹‹é—´ï¼Œä¹ŸåŒ…æ‹¬å®¶äººä¹‹é—´ç”šè‡³çˆ¶æ¯å’Œå­å¥³ä¹‹é—´ï¼Œæ¯”å¦‚ï¼šçˆ¶æ¯å¯ä»¥åœ¨å­å¥³éœ€è¦æ—¶æä¾›å¸®åŠ©ï¼Œä½†æ˜¯ä¸èƒ½å¤Ÿå¹²æ¶‰å­å¥³çš„é€‰æ‹©ï¼Œå¹¶ä¸”ä¸è®ºæ˜¯å¤¸å¥–è¿˜æ˜¯æ‰¹è¯„ï¼Œéƒ½æ˜¯ä¸€ç§å¿ƒç†ä¸Šæ¯”å­å¥³é«˜ä¸€ç­‰è¡¨ç°ã€‚ è‡ªæˆ‘å®šä½ï¼šè‡ªå·±æ°¸è¿œæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ä¸ªä½“ï¼Œä¸åº”è¯¥ä¾é™„äºä»»ä½•äººï¼Œä¹Ÿä¸æ¯”ä»»ä½•äººæ›´é«˜çº§ï¼Œè¦è®©è‡ªå·±åœ¨è‡ªç«‹çš„å‰æä¸‹ä¸ç¤¾ä¼šå’Œè°ç›¸å¤„ã€‚ä¸åˆ«äººæ¯”è¾ƒã€æŒ‰ç…§åˆ«äººçš„çœ‹æ³•ç”Ÿæ´»ç¡®å®ä¼šæ¯”æ˜ç¡®è‡ªå·±çš„ç›®æ ‡æ›´ä¸ºç®€å•ï¼Œä½†è¿™ç§æ‡’æƒ°æ˜¯ä¸€ç§ä¸æ­£å¸¸çš„å¿ƒç†ã€‚å¦å¤–ï¼Œæ‹¼å‘½å¯»æ±‚è®¤å¯ä¹Ÿæ˜¯ä»¥è‡ªå·±ä¸ºä¸­å¿ƒçš„ä¸æ­£ç¡®è¡¨ç°ï¼Œä¸è‡ªå¤§ä¸€æ ·ï¼Œéƒ½æ˜¯æƒ³è¦è¿‡åº¦å¼ºè°ƒè‡ªå·±åœ¨é›†ä½“ä¸­çš„åœ°ä½ã€‚ äººç”Ÿæ„ä¹‰ï¼šâ€œæˆ‘â€æ˜¯è‡ªå·±äººç”Ÿçš„ä¸»äººå…¬ï¼ŒåŒæ—¶ä¹Ÿæ˜¯å…±åŒä½“çš„ä¸€å‘˜ï¼Œæ˜¯æ•´ä½“çš„ä¸€éƒ¨åˆ†ã€‚è¿™é‡Œçš„â€œå…±åŒä½“â€ï¼Œä¸æ˜¯ä¸€ä¸ªå®¶åº­ã€ä¸€ä¸ªå­¦æ ¡ã€ä¸€ä¸ªå…¬å¸è¿™æ ·çš„å°å›¢ä½“ï¼Œè€Œæ˜¯å…¨äººç±»ã€æ•´ä¸ªå®‡å®™ç”šè‡³åŒ…å«ä¸€è‰ä¸€æœ¨ã€‚å½“æŠŠè‡ªå·±ä½œä¸ºè‡ªå·±äººç”Ÿçš„ä¸»äººå…¬æ—¶ï¼Œå°±ä¸ä¼šå› ä¸ºåˆ«äººå¯¹è‡ªå·±çš„è¯„ä»·å’Œçœ‹æ³•å¯¹è‡ªå·±çš„å¿ƒç†å’Œå†³ç­–äº§ç”Ÿå¹²æ‰°ã€‚å½“æŠŠè‡ªå·±ä½œä¸ºå…±åŒä½“ä¸­æ™®é€šçš„ä¸€å‘˜æ—¶ï¼Œè‡ªå·±æ‰ä¸ä¼šå› ä¸ºè‡ªå·±çš„ç»é‡Œè€Œè‡ªå‘æˆ–è‡ªå¤§ï¼Œæ‰ä¸ä¼šå»è¿‡åº¦å¹²æ¶‰åˆ«äººçš„è¯¾é¢˜ã€‚è¦è®°ä½ï¼Œäººç”Ÿåªå–å†³äºå½“ä¸‹ï¼Œæ— è®ºä¹‹å‰å‘ç”Ÿè¿‡ä»€ä¹ˆï¼ˆæˆåŠŸæˆ–è‹¦éš¾ï¼‰ï¼Œéƒ½å¯¹ä»Šåçš„äººç”Ÿå¦‚ä½•åº¦è¿‡æ²¡æœ‰å½±å“ã€‚ ã€Šä¸€å¥é¡¶ä¸€ä¸‡å¥ã€‹ï¼šå¹³å‡¡çç¢ç”Ÿæ´»ä¸­æœ‰æ·±åˆ»çš„æ„Ÿæ‚Ÿ â€‹ è¿™æœ¬åˆ˜éœ‡äº‘çš„å°è¯´ï¼Œè¢«ç§°ä¸ºâ€œä¸­å›½ç‰ˆçš„ã€Šç™¾å¹´å­¤ç‹¬ã€‹â€ï¼Œå°±åƒæ˜¯é‚»å±…å” å®¶å¸¸ï¼Œè®²è¿°è°å®¶è°è°è°æ€ä¹ˆæ€ä¹ˆæ ·äº†ï¼Œä½†æ˜¯ç®€å•çš„ç”Ÿæ´»ä¸­å´åˆåŒ…å«ç€è®¸å¤šçš„æ„Ÿæ‚Ÿã€‚è¿™æœ¬ä¸­æœ€æ ¸å¿ƒçš„è§‚ç‚¹ï¼Œå°±æ˜¯äººä¸äººä¹‹é—´æ˜¯ä¸æ˜¯å¯ä»¥â€œè¯´åˆ°ä¸€èµ·å»â€ï¼Œæœ‹å‹ä¹‹é—´èƒ½ä¸èƒ½â€œè¯´åˆ°ä¸€èµ·å»â€å¯ä»¥å†³å®šèƒ½ä¸èƒ½ä¸€ç›´æˆä¸ºæœ‹å‹ï¼Œå¤«å¦»ä¹‹é—´èƒ½ä¸èƒ½â€œè¯´åˆ°ä¸€èµ·å»â€å¯ä»¥å†³å®šç”Ÿæ´»ä¼šä¸ä¼šå¹¸ç¦ã€‚å¯èƒ½ä¸€è·¯èµ°æ¥ï¼Œä¼šå‘ç°èƒ½å¤Ÿä¸€ç›´â€œè¯´åˆ°ä¸€èµ·å»â€çš„äººå°‘ä¹‹åˆå°‘ï¼Œä½†æ˜¯â€œæ—¥å­è¿‡çš„æ˜¯å¾€åï¼Œä¸æ˜¯ä»å‰ã€‚â€","raw":null,"content":null,"categories":[{"name":"è¯»ä¹¦","slug":"è¯»ä¹¦","permalink":"http://fxbing.github.io/categories/%E8%AF%BB%E4%B9%A6/"}],"tags":[{"name":"2021ä¹¦å•","slug":"2021ä¹¦å•","permalink":"http://fxbing.github.io/tags/2021%E4%B9%A6%E5%8D%95/"}]},{"title":"äºŒé›¶äºŒä¸€å¹´ä¹æœˆä¹¦å•","slug":"äºŒé›¶äºŒä¸€å¹´ä¹æœˆä¹¦å•","date":"2021-10-03T10:15:48.000Z","updated":"2021-10-03T10:18:21.518Z","comments":true,"path":"2021/10/03/äºŒé›¶äºŒä¸€å¹´ä¹æœˆä¹¦å•/","link":"","permalink":"http://fxbing.github.io/2021/10/03/%E4%BA%8C%E9%9B%B6%E4%BA%8C%E4%B8%80%E5%B9%B4%E4%B9%9D%E6%9C%88%E4%B9%A6%E5%8D%95/","excerpt":"å›½åº†å‡æœŸè¡¥ä¸Šäº†ç¬¬ä¸‰ç¯‡ä¹¦å•ã€‚","text":"å›½åº†å‡æœŸè¡¥ä¸Šäº†ç¬¬ä¸‰ç¯‡ä¹¦å•ã€‚ ğŸ“šä»¥ä¸‹ä¹¦ç±å‡ºç°çš„é¡ºåºä»£è¡¨æˆ‘å¯¹è¿™äº›ä¹¦çš„è¯„åˆ†æ’åºã€‚ ã€Šä¹¡åœŸä¸­å›½ã€‹ â€‹ è´¹å­é€šç»å…¸ä½œå“ã€‚ä¸€æœ¬ç¤¾ä¼šå­¦çš„ä¹¦ï¼Œå¯¹æˆ‘æ¥è¯´ï¼Œæ›´é‡è¦çš„å¼•å‘è¾©è¯çš„æ€è€ƒï¼šä¹¡åœŸæ–‡åŒ–å¹¶ä¸æ˜¯å°å»ºå®ˆæ—§ï¼Œè€Œæ˜¯åœ¨å®‰åœŸé‡è¿çš„æ€æƒ³ä¸‹ä¸‹äº§ç”Ÿçš„ç¤¾ä¼šæ–‡åŒ–ï¼Œä¹¡åœŸæ–‡åŒ–åœ¨ä¸å˜çš„ç¤¾ä¼šä¸­æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æ˜¯åœ¨ç°ä»£ç¤¾ä¼šï¼Œå·²ç»ä¸åŒäºåŸæ¥çš„ç¤¾ä¼šæ¨¡å¼ï¼Œæ‰€ä»¥ä¹Ÿè¦é€‚å½“çš„æ€è€ƒä¹¡åœŸæ–‡åŒ–ä¸­çš„å“ªäº›å†…å®¹åº”å½“äºˆä»¥æ”¹å˜æˆ–æ‘’å¼ƒã€‚ ã€Šæ±Ÿæ‘ç»æµã€‹ â€‹ è¿™æœ¬ä¹Ÿæ˜¯è´¹è€çš„ä¹¦ï¼Œè´¹è€ç”¨ä¸¤ä¸ªæœˆçš„æ—¶é—´è°ƒæŸ¥å¼€å¼¦å¼“æ‘ï¼Œå®Œæˆäº†è¿™ç¯‡è‘—ä½œã€‚ä»‹ç»ä¸Šè¯´å¯¹ä¸­å›½ç¤¾ä¼šå­¦çš„å‘å±•å…·æœ‰é‡è¦æ„ä¹‰ï¼Œä¹Ÿåªèƒ½ä»é—¨å¤–æ±‰è‡ªå·±çš„è§’åº¦è¯´ä¸€è¯´æ„Ÿå—ï¼š è™½ç„¶è°ƒæŸ¥åªæœ‰ä¸¤ä¸ªæœˆï¼Œä½†æ˜¯ä»æè¿°ä¸Šå¯ä»¥çœ‹å‡ºï¼Œè°ƒæŸ¥ç›¸å½“ç¿”å®ï¼Œå¹¶ä¸”æ–‡ç¬”ä¸Šæ²¡æœ‰å†—ä½™çš„æ–‡å­—ï¼Œè™½ç„¶æè¿°ä¸å¤šï¼Œä½†æ˜¯å¯ä»¥æ¸…æ¥šåœ°æ„Ÿå—åˆ°è´¹è€æƒ³è¦å±•ç°çš„å†…å®¹ã€‚ è¿™æœ¬ä¹¦è¯¦ç»†æè¿°çš„ä¸€ä¸ªä¹¡æ‘æ–‡åŒ–ã€ç»æµã€æ”¿æ²»ç­‰å„ä¸ªæ–¹é¢å†…å®¹ï¼Œæ˜¯ä¸€ç§ååˆ†è¯¦ç»†çš„å°å»ºå†œæ‘ç”Ÿæ´»çš„çœŸå®å†™ç…§ï¼Œæ¯”å°è¯´ä¹‹ç±»çœ‹å¾—æ›´ä¸ºæœ‰ç”»é¢ã€‚ è¯»å®Œä¸Šé¢ä¸¤æœ¬ä¹¦çš„æ„Ÿå—æ˜¯ï¼Œä¸è®ºæ˜¯å°å»ºä¼ ç»Ÿçš„æ€æƒ³è¿˜æ˜¯å‰å«ç°ä»£çš„æ€æƒ³ï¼Œéƒ½æœ‰å…¶äº§ç”Ÿçš„æ ¹æºï¼Œä¸èƒ½å•çº¯çš„è¯´å“ªä¸€ä¸ªæ›´ä¸ºæ­£ç¡®ï¼Œè€Œæ˜¯è¦å®¢è§‚åœ°è®¤è¯†å…¶äº§ç”Ÿçš„åŸå› ï¼Œä»¥åŠè¿™ç§æ–‡åŒ–åœ¨å½“å‰æƒ…å†µä¸‹é€‚åˆæˆ–è€…ä¸å†é€‚åˆçš„åŸå› ã€‚ ã€Šäººç”Ÿæµ·æµ·ã€‹ â€‹ éº¦å®¶ä½œå“ï¼Œå‰åå°çš®çš„æè¿°è¶³ä»¥æ¦‚æ‹¬è¿™æœ¬å°è¯´çš„å†…å®¹ã€‚ äººç”Ÿæµ·æµ·ï¼Œæ½®è½ä¹‹åæ˜¯æ½®èµ·ï¼Œä½ è¯´é‚£æ˜¯æ¶ˆç£¨ã€ç¬‘æŸ„ã€ç½ªè¿‡ï¼Œåˆ°é‚£å°±æ˜¯æˆ‘çš„è‹±é›„ä¸»ä¹‰ã€‚ ä»–æ˜¯å…¨æ‘æœ€å‡ºå¥‡å¤æ€ªçš„äººï¼Œå¤æ€ªçš„åç›®è¦æ‰³ç€æŒ‡å¤´ä¸ªä¸ªæ•° ç¬¬ä¸€ï¼Œä»–å½“è¿‡å›½æ°‘å…šå†›é˜Ÿçš„ä¸Šæ ¡ï¼Œæ˜¯é©å‘½ç¾¤ä¼—è¦äº‰çš„å¯¹è±¡ã€‚ä½†å¤§å®¶ä¸€è¾¹æ–—äº‰ä»–ï¼Œä¸€è¾¹åˆå·´ç»“è®¨å¥½ä»–ï¼Œå®¶é‡Œå‡ºä»€ä¹ˆäº‹éƒ½å»æˆ‘ä»–æ‹¿ä¸»æ„ã€‚ ç¬¬äºŒï¼Œè¯´ä»–æ˜¯å¤ªç›‘ï¼Œå¯æˆ‘ä»¬å°å­©å­ç»å¸¸å·çœ‹ä»–é‚£ä¸ªåœ°æ–¹å¥½åƒè¿˜æ˜¯æ»¡å½“å½“çš„ï¼Œæœ‰æ¨¡æœ‰æ ·çš„ã€‚ ç¬¬ä¸‰ï¼Œä»–å‘æ¥ä¸å‡ºå·¥ï¼Œä¸å¹²å†œæ´»ï¼Œå¤©å¤©ç©ºåœ¨å®¶é‡Œçœ‹æŠ¥çº¸ç“œå­å¯æ—¥å­è¿‡å¾—æ¯”è°å®¶éƒ½èˆ’å¦ã€‚è¿˜åƒå…»å­©å­ä¸€æ ·å…»ç€ä¸€å¯¹çŒ«ï¼Œå®è´å¾—ä¸å¾—äº†ï¼Œç®€ç›´ç¥ç»ç—…ï¼ ã€Šäººç”Ÿæµ·æµ·ã€‹è®²è¿°äº†ä¸€ä¸ªäººåœ¨æ—¶ä»£ä¸­ç©¿è¡Œç¼ æ–—çš„ä¸€ç”Ÿï¼Œç¦»å¥‡çš„æ•…äº‹é‡Œè—ç€è®©äººå¹æ¯çš„äººç”Ÿå†µå‘³ï¼Œæ—¢æœ‰æ—¥å¸¸æ»‹ç”Ÿçš„æ®‹é…·ï¼Œä¹Ÿæœ‰æ—¶é—´å¸¦æ¥çš„ä»æ…ˆã€‚ ã€Šæ´»å‡ºç”Ÿå‘½çš„æ„ä¹‰ã€‹ â€‹ è¿™æœ¬ä¹¦åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œç¬¬ä¸€éƒ¨åˆ†æ˜¯ä½œè€…åœ¨å¥¥æ–¯ç»´è¾›é›†ä¸­è¥ä¸­ç»å†çš„æå†™ï¼Œä»¥åŠä¸€äº›æ„Ÿæ‚Ÿï¼Œç¬¬äºŒéƒ¨åˆ†åˆ™æ˜¯çº¯å¿ƒç†å­¦æ–¹é¢çš„è®²è¿°ã€‚ â€‹ â€œç”±äºç”Ÿå‘½ä¸­æ¯ä¸€ç§æƒ…å†µå¯¹äººæ¥è¯´éƒ½æ˜¯ä¸€ç§æŒ‘æˆ˜ï¼Œéƒ½ä¼šæå‡ºéœ€è¦ä½ å»è§£å†³çš„é—®é¢˜ï¼Œæ‰€ä»¥ç”Ÿå‘½ä¹‹æ„ä¹‰çš„é—®é¢˜å®é™…ä¸Šè¢«é¢ å€’äº†ã€‚äººä¸åº”è¯¥é—®ä»–çš„ç”Ÿå‘½ä¹‹æ„ä¹‰æ˜¯ä»€ä¹ˆï¼Œè€Œå¿…é¡»æ‰¿è®¤æ˜¯ç”Ÿå‘½å‘ä»–æå‡ºäº†é—´é¢˜ã€‚ç®€å•åœ°è¯´ï¼Œç”Ÿå‘½å¯¹æ¯ä¸ªäººéƒ½æå‡ºäº†é—®é¢˜ï¼Œä»–å¿…é¡»é€šè¿‡å¯¹è‡ªå·±ç”Ÿå‘½çš„ç†è§£æ¥å›ç­”ç”Ÿå‘½çš„æé—®ã€‚å¯¹å¾…ç”Ÿå‘½ï¼Œä»–åªèƒ½æ‹…å½“èµ·è‡ªå·±çš„è´£ä»»ã€‚â€è´Ÿè´£ä»»ï¼Œå°±æ˜¯è‡ªå·±ç”Ÿå‘½çš„æ„ä¹‰ã€‚ ã€Šè‡ªç§çš„åŸºå› ã€‹ æœ¬ä»¥ä¸ºæ˜¯ä¸€æœ¬å¿ƒç†å­¦çš„ä¹¦ï¼Œå®é™…ä¸Šæ›´åƒæ˜¯ä¸€æœ¬ç”Ÿç‰©å­¦çš„ç§‘æ™®ä¹¦ç±ï¼Œå¹¶ä¸æ˜¯å¾ˆæ„Ÿå…´è¶£ã€‚ä½œè€…å°†åŸºå› å®šä¹‰ä¸ºè¿›åŒ–çš„åŸºæœ¬å•ä½ï¼Œç»“åˆåšå¼ˆè®ºï¼Œä»å„ä¸ªæ–¹é¢è®²è¿°äº†åŸºå› æ˜¯å¦‚ä½•ä¿è¯ç‰©ç§ç¨³å®šçš„ã€‚","raw":null,"content":null,"categories":[{"name":"è¯»ä¹¦","slug":"è¯»ä¹¦","permalink":"http://fxbing.github.io/categories/%E8%AF%BB%E4%B9%A6/"}],"tags":[{"name":"2021ä¹¦å•","slug":"2021ä¹¦å•","permalink":"http://fxbing.github.io/tags/2021%E4%B9%A6%E5%8D%95/"}]},{"title":"äºŒé›¶äºŒä¸€å¹´å…«æœˆä¹¦å•","slug":"äºŒé›¶äºŒä¸€å¹´å…«æœˆä¹¦å•","date":"2021-08-28T10:07:53.000Z","updated":"2021-08-28T10:18:47.760Z","comments":true,"path":"2021/08/28/äºŒé›¶äºŒä¸€å¹´å…«æœˆä¹¦å•/","link":"","permalink":"http://fxbing.github.io/2021/08/28/%E4%BA%8C%E9%9B%B6%E4%BA%8C%E4%B8%80%E5%B9%B4%E5%85%AB%E6%9C%88%E4%B9%A6%E5%8D%95/","excerpt":"ç¬¬äºŒç¯‡ä¹¦å•å¦‚æœŸè€Œè‡³ã€‚","text":"ç¬¬äºŒç¯‡ä¹¦å•å¦‚æœŸè€Œè‡³ã€‚ ğŸ“šä»¥ä¸‹ä¹¦ç±å‡ºç°çš„é¡ºåºä»£è¡¨æˆ‘å¯¹è¿™äº›ä¹¦çš„è¯„åˆ†æ’åºã€‚ ã€Šè›¤èŸ†å…ˆç”Ÿå»çœ‹å¿ƒç†åŒ»ç”Ÿã€‹ â€‹ ä¸€æœ¬ä»¥å¯“è¨€æ•…äº‹çš„å½¢å¼è®²å¿ƒç†å­¦çš„ä¹¦ï¼Œè¿™ä¸ªå¯“è¨€æ•…äº‹å¹¶ä¸æ˜¯è®²ç»™å­©å­çš„ï¼Œè€Œæ˜¯è®²ç»™å¤§äººçš„ã€‚ä¹¦ä¸­æåˆ°äº†ä¸€ç»„å¾ˆæœ‰æ„æ€çš„æ¦‚å¿µï¼š å„¿ç«¥è‡ªæˆ‘çŠ¶æ€ï¼šâ€œå­©å­æ˜¯æˆå¹´äººçš„çˆ¶äº²â€ï¼Œå…¶å®äººä»¬æˆå¹´åçš„å¾ˆå¤šæ€ç»´æ–¹å¼å’Œè¡Œä¸ºæ–¹å¼éƒ½æ˜¯å­©å­æ—¶çš„å†™ç…§ã€‚ çˆ¶æ¯è‡ªæˆ‘çŠ¶æ€ï¼šæˆå¹´åçš„æ€ç»´æ–¹å¼å’Œè¡Œä¸ºæ–¹å¼ä»¥æ¨¡ä»¿è‡ªå·±çš„çˆ¶æ¯è¿›è¡Œã€‚ æˆäººè‡ªæˆ‘çŠ¶æ€ï¼šæŒ‡æˆ‘ä»¬ç”¨ç†æ€§è€Œä¸æ˜¯æƒ…ç»ªåŒ–çš„æ–¹å¼è¡Œäº‹ã€‚ â€‹ åæ€è‡ªå·±å’Œå‘¨å›´çš„äººï¼Œä¼šå‘ç°ç¡®å®ä¼šæœ‰å¤„äºå„¿ç«¥çŠ¶æ€ï¼Œæˆ–è€…çˆ¶æ¯çŠ¶æ€çš„æƒ…å†µï¼Œæ¯•ç«Ÿä¸€æ–¹é¢æ— æ³•æŠ›å¼ƒè‡ªå·±çš„è¿‡å¾€ï¼Œå¦ä¸€æ–¹é¢çˆ¶æ¯åˆæ˜¯å­©å­çš„è€å¸ˆã€‚ä¹‹æ‰€ä»¥å¤„äºè¿™ä¸¤ç§çŠ¶æ€ï¼Œæ˜¯å› ä¸ºå„¿ç«¥å’Œçˆ¶æ¯çŠ¶æ€æ˜¯ä¸éœ€è¦æ€è€ƒçš„ï¼Œè‡ªå·±çš„æ€ç»´æˆ–è€…è¡Œä¸ºå°±åƒæ˜¯è¡¨æ¼”ï¼Œè¡¨æ¼”è‡ªå·±æ‰€ç†Ÿæ‚‰çš„ä¸œè¥¿ã€‚ä½†åŒæ—¶ï¼Œè¿™ä¸¤ç§çŠ¶æ€åˆæ˜¯æœ€å·®çš„ï¼Œå› ä¸ºæ²¡æœ‰æ€è€ƒå°±ä¸ä¼šå­¦ä¹ ã€‚åªæœ‰å¤„äºæˆäººçŠ¶æ€ä¸‹ï¼Œæˆ‘ä»¬æ‰èƒ½å¤Ÿè¿›è¡Œå­¦ä¹ ï¼Œæ‰èƒ½åº”å¯¹æ­¤æ—¶æ­£åœ¨å‘ç”Ÿçš„ç°å®çŠ¶å†µã€‚ â€‹ æˆ‘ä»¬ç”Ÿæ´»çš„æ ·å­å°±æ˜¯æˆ‘ä»¬è‡ªå·±æƒ³æˆä¸ºçš„æ ·å­ï¼Œè€Œä¸æ˜¯åˆ«äººé€ å°±äº†æˆ‘ä»¬çš„ç”Ÿæ´»ã€‚è¦æƒ³æ›´å¹¸ç¦ï¼Œå°±éœ€è¦æœ‰è¶³å¤Ÿçš„æƒ…å•†ã€‚æƒ…å•†çœŸæ­£çš„æ„æ€æ˜¯ï¼šäº†è§£ä½ å†…å¿ƒçš„æƒ…æ„Ÿä¸–ç•Œå¹¶ä¸”è¿˜èƒ½æŒæ§å®ƒã€‚ ã€Šç‰§ç¾Šå°‘å¹´çš„å¥‡å¹»ä¹‹æ—…ã€‹ â€‹ ä¸€æœ¬å¥‡å¹»çš„ä¹¦ï¼Œæ­¤å¤„å€Ÿç”¨è±†ç“£ç½‘å‹Big Bençš„çŸ­è¯„ï¼šâ€œã€Šå°ç‹å­ã€‹æ•™ä½ æ”¾ä¸‹æ‰§å¿µï¼Œè€Œã€Šç‰§ç¾Šå°‘å¹´å¥‡å¹»ä¹‹æ—…ã€‹æ˜¯æ•™ä½ å¯»æ‰¾æ‰§å¿µï¼›ä¸¤ç§ä¸åŒçš„æ–¹æ³•ï¼Œç¡®æœ‰ç€ç›¸åŒçš„ç›®çš„ã€‚é‡ç‚¹ä¸æ˜¯ä½ åœ¨è¿™ä¸ªä¸–ç•Œä¸Šå¯»æ‰¾ä»€ä¹ˆï¼Œè€Œæ˜¯åœ¨è¿‡ç¨‹ä¸­æ˜ç™½ä»€ä¹ˆæ˜¯ä¸å¯ä¸¢å¼ƒçš„ï¼Œé‚£å°†æ˜¯ä½ ç”Ÿå‘½çš„æ„ä¹‰æ‰€åœ¨ï¼Œè¶…è¶Šä¸€åˆ‡ï¼Œä¸€æ—¦äº†ç™½äºå¿ƒï¼Œå°±å°†äºæ°¸æ’åŒåœ¨ã€‚â€ â€‹ ä¸è¦æ”¾å¼ƒè‡ªå·±çš„â€œæ‰§å¿µâ€ï¼Œéœ€è¦å‘å…¶å‰è¿›ã€‚ç°åœ¨çš„ç”Ÿæ´»ä¸­ï¼Œåœ¨ä¸€æ— æ‰€æœ‰æ—¶ï¼Œå¯èƒ½ä¼šæ€€ç€æœ‰é’±ä¹‹åå‘¨æ¸¸ä¸–ç•Œçš„æ¢¦æƒ³ï¼Œä½†æ˜¯åœ¨è¶³å¤Ÿå¯Œæœ‰ä¹‹åï¼Œå› ä¸ºä¼šæ¸´æœ›æ›´åŠ å¯Œæœ‰ï¼Œæˆ–è€…å› ä¸ºå®³æ€•é£é™©ï¼Œåªé€‰æ‹©ç›¸æ¯”å‘¨æ¸¸ä¸–ç•Œæ›´åŠ å¹³ç¨³çš„äº«å—å½“ä¸‹çš„å¹¸ç¦ã€‚å‰è¿›çš„è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šæœ‰å¾ˆå¤šçš„æ”¶è·ï¼Œç”šè‡³åˆ°è¾¾å¤§ä¼—æ‰€è°“çš„æˆåŠŸï¼Œä½†æ˜¯è¿™æœ¬ä¹¦è¦è¯´çš„ä¸æ˜¯å‰è¿›è¿‡ç¨‹ä¸­çš„æ”¶è·ï¼Œè€Œæ˜¯æ”¶è·åˆ°è¿™äº›é™„åŠ ä¸œè¥¿ä¹‹åï¼Œä»ç„¶ä¸è¦å¿˜è®°è‡ªå·±çš„â€œæ‰§å¿µâ€ï¼Œä¸ºäº†ä¸è®©è‡ªå·±åœ¨çœ‹ä¼¼ä¼˜æ¸¥çš„ç”Ÿæ´»ä¸­ç•™ä¸‹é—æ†¾ï¼Œä¹Ÿä¸ºäº†â€œæ‰§å¿µâ€å®ç°ä¹‹åæ„ä¹‰ã€‚ â€‹ ç”¨ä¹¦ä¸­ä¸æ–­é‡å¤çš„ä¸€ä¸ªé˜¿æ‹‰ä¼¯è¯­æ¥æ€»ç»“å’Œæ€è€ƒï¼šâ€œé©¬å…‹å›¾å¸ƒâ€ï¼Œå¯ä»¥ç†è§£ä¸ºï¼šå‘½ä¸­æ³¨å®šã€‚ ã€Šå¿ƒæµã€‹ â€‹ è¿™æœ¬ä¹¦çš„åºè¨€ç¡®å®æŒºé•¿çš„ï¼Œä¸åˆ°400é¡µçš„ä¹¦ï¼Œåºè¨€å°±æœ‰50å¤šé¡µğŸ¶ã€‚â€œå¿ƒæµâ€æ˜¯ç§¯æå¿ƒç†å­¦ä¸­çš„é‡è¦æ¦‚å¿µï¼Œæ˜¯æŒ‡æˆ‘ä»¬åœ¨åšæŸäº›äº‹æƒ…æ—¶ï¼Œé‚£ç§å…¨ç¥è´¯æ³¨ã€æŠ•å…¥å¿˜æˆ‘çš„çŠ¶æ€â€”â€”è¿™ç§çŠ¶æ€ä¸‹ï¼Œä½ ç”šè‡³æ„Ÿè§‰ä¸åˆ°æ—¶é—´çš„å­˜åœ¨ï¼Œåœ¨è¿™ä»¶äº‹æƒ…å®Œæˆä¹‹åæˆ‘ä»¬ä¼šæœ‰ä¸€ç§å……æ»¡èƒ½é‡å¹¶ä¸”éå¸¸æ»¡è¶³çš„æ„Ÿå—ã€‚åœ¨æˆ‘ä»¬çš„æ­£å¸¸ç”Ÿæ´»ä¸­ï¼Œæ¯ä¸ªäººéƒ½ä¼šæœ‰å¿ƒæµä½“éªŒï¼Œåªæ˜¯å¤šä¸å°‘çš„åŒºåˆ«ï¼Œæ¯”å¦‚ï¼šä¸­å­¦ä¸Šç”µè„‘è¯¾ç©æ¸¸æˆæ—¶ğŸ¶ã€æ²¡æœ‰æ‚äº‹å¹²æ‰°åªæœ‰è‡ªå·±ä¸€ä¸ªäººä¸“å¿ƒå†™ä»£ç æ—¶ğŸ¶ã€‚è¿™æœ¬ä¹¦è®²çš„æ˜¯å¦‚ä½•è®©è‡ªå·±å°½å¯èƒ½å¤šå¾—ä½“éªŒå¿ƒæµï¼Œä¸‹é¢æ˜¯ä¸€äº›ä¹¦ä¸­è§‚ç‚¹çš„ç¬”è®°ï¼š å¤§éƒ¨åˆ†äººçš„å¿ƒæµä½“éªŒæ¥è‡ªäºå·¥ä½œè€Œéä¼‘æ¯ã€‚ äº«ä¹ä¸ä¹è¶£ä¸åŒï¼Œäº«ä¹ä¸éœ€è¦æ¶ˆè€—ç²¾ç¥èƒ½é‡ï¼Œè€Œä¹è¶£éœ€è¦ã€‚ ç«äº‰åªæœ‰åœ¨å®ƒä»¥ä½¿ä¸ªäººæŠ€å·§è‡»äºå®Œç¾ä¸ºç›®æ ‡æ—¶ï¼Œæ‰æœ‰ä¹è¶£ï¼›å½“å®ƒæœ¬èº«æˆä¸ºç›®çš„æ—¶ï¼Œå°±ä¸å†æœ‰ä¹è¶£äº†ã€‚ è®°å¿†çš„é‡è¦æ€§ï¼šè®°å¿†è¶³å¤Ÿå……è¶³çš„äººï¼Œå¯ä»¥ä¸éœ€è¦å¤–ç•Œåˆºæ¿€è€Œä¿æŒå¿ƒæµã€‚ æœªæ¥ä¸ä»…å±äºå—è¿‡æ•™è‚²çš„äººï¼Œæ›´å±äºé‚£äº›æ‡‚å¾—å–„ç”¨é—²æš‡çš„äººã€‚ åŸ¹å…»è‡ªå¾—å…¶ä¹çš„æ€§æ ¼ï¼šç¡®ç«‹ç›®æ ‡ã€å…¨ç¥è´¯æ³¨ã€é¿å…è¿‡äºè‡ªæˆ‘ã€ä»å½“å‰ä½“éªŒä¸­å¯»æ‰¾ä¹è¶£ã€‚ ã€Šæ”¿æ²»æ˜¯ä»€ä¹ˆï¼Ÿã€‹ â€‹ è¿™æ˜¯ä¸€æœ¬å°æ¹¾äººå†™çš„æ”¿æ²»æ™®åŠä¹¦ç±ã€‚è¿™æœ¬ä¹¦å¯¹æ”¿æ²»ä¸­çš„å„ç§æ¦‚å¿µè¿›è¡Œä»‹ç»ï¼Œå¹¶ä¸”ä»ä½œè€…çš„è§’åº¦ï¼Œç»“åˆå„ç§è§‚ç‚¹è¿›è¡Œäº†å®¢è§‚çš„åˆ†æã€‚ä½œè€…çš„è¡¨è¾¾ä¸­ä¸ä¼šå¸¦ç€å¯¹å“ªç§æ”¿æ²»åˆ¶åº¦çš„åè§ï¼Œè¯»è¿™æœ¬ä¹¦çš„è¿‡ç¨‹ç¡®å®å¯ä»¥å¼•å‘è‡ªå·±ä¸€äº›å…³äºæ”¿æ²»çŸ¥è¯†çš„æ€è€ƒï¼Œä½†æ˜¯å´æ„Ÿè§‰ç¼ºä¹ä¸»çº¿ã€‚ä¸‹é¢åªåˆ—ä¸¾ä¸€äº›æˆ‘åœ¨è¯»ä¹¦è¿‡ç¨‹ä¸­æ€è€ƒè®°å½•çš„æƒ³æ³•ï¼š æ”¿æ²»æ˜¯å¯ä»¥åœ¨è¿èƒŒä»–äººæ„æ„¿çš„æƒ…å†µä¸‹å®ç°è‡ªå·±ç›®çš„çš„å¯èƒ½æ€§ï¼Œåˆ†ä¸ºâ€œå¼ºåˆ¶æ€§æƒåŠ›â€ï¼ˆä¾‹å¦‚ï¼šæ­¦åŠ›ï¼‰å’Œâ€œè±¡å¾æ€§æƒåŠ›â€ï¼ˆä¾‹å¦‚ï¼šä¿¡ä»°ï¼‰ï¼Œç›¸æ¯”å¼ºåˆ¶æ€§æƒåŠ›ï¼Œè±¡å¾æ€§æƒåŠ›æ›´ä¼šè®©äººä»¬æ½œæ„è¯†æœä»ï¼Œæ›´ä¸å®¹æ˜“åæŠ—æ¨ç¿»ã€‚ æ„è¯†å½¢æ€å¯ä»¥å†³å®šäººä»¬æ˜¯å¦æ¥å—ä½ æˆä¸ºé¢†è¢–ï¼Œè€Œèƒ½å¦çœŸæ­£æ»¡è¶³äººä»¬çš„éœ€æ±‚æ‰æ˜¯å†³å®šä½ æ˜¯å¦å¯ä»¥ä¸€ç›´æˆä¸ºé¢†è¢–çš„å› ç´ ã€‚å› æ­¤ï¼Œç¨³å›ºçš„æ”¿æ²»ä¸ä»…éœ€è¦ä¸€ä¸ªå¥½çš„æ„è¯†å½¢æ€ï¼ˆå€Ÿå£ï¼‰ï¼Œè¿˜éœ€è¦è®©äººä»¬æ„Ÿå—åˆ°è‡ªå·±éœ€æ±‚å¾—åˆ°æ»¡è¶³ã€‚ å›½å®¶å¹¶ä¸èƒ½ç§°ä¸ºå®ä½“ï¼Œç”šè‡³æ˜¯ä¸€ä¸ªæ¨¡ç³Šçš„æ¦‚å¿µï¼Œæ¯”å¦‚å¤ä»£å„ä¸ªå›½å®¶ä¹‹é—´å¹¶æ²¡æœ‰ç»å¯¹æ˜ç¡®çš„åœ°ç†åˆ’åˆ†ï¼Œä¹Ÿä¸éœ€è¦ç­¾è¯ã€‚ä¹‹æ‰€ä»¥ç°åœ¨è¿™ä¸€åˆ‡å˜å¾—å¤æ‚ï¼Œæ˜¯å› ä¸ºå„ä¸ªå›½å®¶ä¹‹é—´çš„äº¤æµè¿‡äºç´§å¯†ï¼Œå¦‚æœæ²¡æœ‰æ˜ç¡®çš„è¾¹ç•Œæ„Ÿï¼Œå°±ä¼šäº§ç”Ÿäº‰ç«¯ï¼Œä¸ºäº†æ˜ç¡®è¾¹ç•Œæ„Ÿï¼Œä¸€ä¸ªå›½å®¶éœ€è¦æ‹¥æœ‰è¢«å…¶ä»–å›½å®¶æ‰¿è®¤çš„â€œä¸»æƒâ€ï¼Œå¦‚ï¼šä¸€ä¸ªå›½å®¶çš„å±…æ°‘å¿…é¡»è¦æœ‰æˆ·å£ç­‰ã€‚ä¸ºä»€ä¹ˆäººä¸éœ€è¦è¯´æˆ‘æ‰¿è®¤ä½ æ˜¯äººï¼Œä½ æ‰æ˜¯äººï¼Ÿè€Œå›½å®¶å¿…é¡»è¦æ‹¥æœ‰è¢«å…¶ä»–å›½å®¶æ‰¿è®¤çš„ä¸»æƒæ‰æ˜¯å›½å®¶ï¼Ÿå› ä¸ºäººæœ¬æ¥å°±æ˜¯ä¸€ä¸ªå®ä½“ï¼Œæœ‰æ˜ç¡®çš„è¾¹ç•Œæ„Ÿï¼Œè€Œå›½å®¶æœ¬èº«å¹¶éå®ä½“ï¼Œè€Œæ˜¯ä¸€ç§æ¦‚å¿µï¼Œå¿…é¡»æœ‰å„ç§æ¡æ¡æ¡†æ¡†æ‰èƒ½è¢«ç†è§£ä¸ºå®ä½“ã€‚ ã€Šä»€ä¹ˆæ˜¯æ°‘ç²¹ä¸»ä¹‰ï¼Ÿã€‹ â€‹ è¿™æœ¬ä¹¦æ„Ÿè§‰åƒæ˜¯ä¸€æœ¬è¡¨è¾¾ä½œè€…æœ¬äººæ”¿æ²»è§‚ç‚¹çš„ä¹¦ç±ï¼Œå¯èƒ½ç”±äºæˆ‘æ”¿æ²»çŸ¥è¯†ä¸å¤Ÿï¼Œå¹¶æ²¡æœ‰å…´è¶£è¯»å®Œæ•´æœ¬ä¹¦ï¼Œåªèƒ½ä¾ç…§è‡ªå·±çš„æ„Ÿè§‰æè¿°ä¸€ä¸‹å¯¹è¿™æœ¬ä¹¦çš„ç†è§£ã€‚ â€‹ æ ¹æ®ç»´åŸºç™¾ç§‘çš„è§£é‡Šï¼Œæ°‘ç²¹ä¸»ä¹‰é€šå¸¸æ˜¯ç²¾è‹±ä¸»ä¹‰çš„åä¹‰è¯ã€‚åœ¨å¤å¸Œè…ŠåŸé‚¦å‘æ˜æ°‘ä¸»åˆ¶åº¦ä¹‹åï¼Œå¯¹äºåº”ç”±ç²¾è‹±ã€è´µæ—è¿˜æ˜¯ä¸€èˆ¬å¤§ä¼—æ¥æŒæ¡æ”¿æ²»ï¼Œå‡ºç°äº†äº‰è®ºã€‚æ”¯æŒæ°‘ç²¹ä¸»ä¹‰è€…åˆ™è¯‰æ±‚ç›´æ¥æ°‘ä¸»ä¸åŸºå±‚æ°‘ä¸»ï¼Œè®¤ä¸ºæ”¿æ²»ç²¾è‹±ï¼ˆå½“ä¸‹æˆ–æœªæ¥ï¼‰åªè¿½æ±‚è‡ªèº«åˆ©ç›Šï¼Œè…åŒ–ä¸”ä¸å¯ç›¸ä¿¡ï¼Œå¸Œæœ›ç”±äººæ°‘ç›´æ¥å†³å®šæ”¿æ²»äº‹åŠ¡ã€‚ â€‹ è¿™æœ¬ä¹¦ä½œè€…è®¤ä¸ºï¼Œæ°‘ç²¹ä¸»ä¹‰è€…çš„æœ¬è´¨ä¸æ˜¯åç²¾è‹±ã€åå¤šå…ƒåŒ–ã€åå»ºåˆ¶ç­‰ç­‰ï¼Œè€Œæ˜¯å¯¹â€œäººæ°‘â€çš„å®šä¹‰ï¼Œæ°‘ç²¹ä¸»ä¹‰è€…ä»¬ä¸€æ–¹é¢è®¤ä¸ºåªæœ‰ä»–ä»¬æ‰èƒ½ä»£è¡¨äººæ°‘çš„åˆ©ç›Šï¼Œå¦ä¸€æ–¹é¢åˆè®¤ä¸ºåªæœ‰æ”¯æŒä»–ä»¬çš„äººæ‰ç®—åšâ€œäººæ°‘â€ï¼Œå¯è°“æ˜¯å‡æ°‘ä¸»ã€çœŸåè§ã€‚ â€‹ ä»ã€Šä½ å½“åƒé¸Ÿé£å¾€ä½ çš„å±±ã€‹ã€ã€Šè›¤èŸ†å…ˆç”Ÿå»çœ‹å¿ƒç†åŒ»ç”Ÿã€‹å’Œã€Šå¿ƒæµã€‹ä¸‰æœ¬ä¹¦ä¸­éƒ½å¯ä»¥çœ‹åˆ°æŒæ¡è‡ªå·±çš„é‡è¦æ€§ã€‚äº†è§£è‡ªå·±ï¼Œæ¥çº³ä»–äººï¼Œå¯ä»¥æ§åˆ¶è‡ªå·±çš„æƒ…æ„Ÿå’Œæ€ç»´ä¸è¢«å¤–ç•Œå¹²æ‰°ï¼ŒåŒæ—¶åˆå¯ä»¥å®Œå…¨å¹³å’Œåœ°æ¥çº³ä»–äººçš„è§‚ç‚¹ï¼Œè¿™æ˜¯ä¸€ç§å¾ˆå¼ºå¤§çš„èƒ½åŠ›ï¼Œæ„Ÿè§‰è‡ªå·±ç°åœ¨è¿œè¿œä¸åŠï¼Œä¹Ÿæ˜¯è‡ªå·±å¿ƒç†ä¸ŠåŠªåŠ›çš„æ–¹å‘ã€‚","raw":null,"content":null,"categories":[{"name":"è¯»ä¹¦","slug":"è¯»ä¹¦","permalink":"http://fxbing.github.io/categories/%E8%AF%BB%E4%B9%A6/"}],"tags":[{"name":"2021ä¹¦å•","slug":"2021ä¹¦å•","permalink":"http://fxbing.github.io/tags/2021%E4%B9%A6%E5%8D%95/"}]},{"title":"kafkaæ—¥å¿—æ¸…ç†å¼•å‘çš„core dumpé—®é¢˜","slug":"kafkaæ—¥å¿—æ¸…ç†å¼•å‘çš„core-dumpé—®é¢˜","date":"2021-08-15T09:55:46.000Z","updated":"2021-08-15T10:44:07.168Z","comments":true,"path":"2021/08/15/kafkaæ—¥å¿—æ¸…ç†å¼•å‘çš„core-dumpé—®é¢˜/","link":"","permalink":"http://fxbing.github.io/2021/08/15/kafka%E6%97%A5%E5%BF%97%E6%B8%85%E7%90%86%E5%BC%95%E5%8F%91%E7%9A%84core-dump%E9%97%AE%E9%A2%98/","excerpt":"â€‹    å›¢é˜Ÿå¼€å‘äº†kafka on hdfsçš„åŠŸèƒ½ï¼Œç”¨ä»¥å°†kafkaæ•°æ®å­˜å‚¨åœ¨hdfsä¸Šï¼Œä½†æ˜¯åœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­å‘ç°ï¼Œæœ‰æœºå™¨å‡ºç°core dumpç°è±¡ã€‚","text":"â€‹ å›¢é˜Ÿå¼€å‘äº†kafka on hdfsçš„åŠŸèƒ½ï¼Œç”¨ä»¥å°†kafkaæ•°æ®å­˜å‚¨åœ¨hdfsä¸Šï¼Œä½†æ˜¯åœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­å‘ç°ï¼Œæœ‰æœºå™¨å‡ºç°core dumpç°è±¡ã€‚ æœ¬æ–‡åŸºäºkafkaç‰ˆæœ¬0.10.2 æ’æŸ¥è¿‡ç¨‹ ä¸€ã€æ’æŸ¥core dumpæ–‡ä»¶ ç”±äºå‡ºç°äº†å¤šæ¬¡core dumpé—®é¢˜ï¼Œæ‰€ä»¥é¦–å…ˆéœ€è¦ä»core dumpæ–‡ä»¶ä¸­è¿›è¡Œåˆ†æã€‚ä»core dumpæ–‡ä»¶å¯ä»¥çœ‹å‡ºï¼Œä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š æŒ‚æ‰çš„çº¿ç¨‹åç§°éƒ½æ˜¯hdfsç›¸å…³çš„ï¼Œæ‰€ä»¥æ¨æµ‹ä¸hdfsç›¸å…³åŠŸèƒ½æœ‰å…³ æŒ‚æ‰çš„ä»£ç ä½ç½®éƒ½ä¸indexè¯»å–é€»è¾‘æœ‰å…³ï¼Œæ‰€ä»¥æ¨æµ‹å’Œindexæ¸…ç†é€»è¾‘æœ‰å…³ äºŒã€åˆ†æä»£ç  â€‹ åˆ†ækafkaæœ¬åœ°æ—¥å¿—åˆ é™¤çš„ä»£ç å‘ç°ï¼Œæœ¬åœ°æ—¥å¿—åˆ é™¤é€šè¿‡asyncDeleteSegmentè¿›è¡Œï¼ŒasyncDeleteSegmentè¿›è¡Œåˆ é™¤æ—¶é¦–å…ˆä¼šrenameæœ¬åœ°æ—¥å¿—æ–‡ä»¶å’Œç´¢å¼•æ–‡ä»¶ï¼Œç„¶åå»¶è¿Ÿä¸€å®šæ—¶é—´è¿›è¡Œåˆ é™¤ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940/** a file that is scheduled to be deleted */ val DeletedFileSuffix = &quot;.deleted&quot;/** * Perform an asynchronous delete on the given file if it exists (otherwise do nothing) * * @throws KafkaStorageException if the file can&#x27;t be renamed and still exists */ private def asyncDeleteSegment(segment: LogSegment) &#123; segment.changeFileSuffixes(&quot;&quot;, Log.DeletedFileSuffix) def deleteSeg() &#123; info(&quot;Deleting segment %d from log %s.&quot;.format(segment.baseOffset, name)) segment.delete() &#125; scheduler.schedule(&quot;delete-file&quot;, deleteSeg, delay = config.fileDeleteDelayMs) &#125;/** * Change the suffix for the index and log file for this log segment */ def changeFileSuffixes(oldSuffix: String, newSuffix: String) &#123; def kafkaStorageException(fileType: String, e: IOException) = new KafkaStorageException(s&quot;Failed to change the $fileType file suffix from $oldSuffix to $newSuffix for log segment $baseOffset&quot;, e) try log.renameTo(new File(CoreUtils.replaceSuffix(log.file.getPath, oldSuffix, newSuffix))) catch &#123; case e: IOException =&gt; throw kafkaStorageException(&quot;log&quot;, e) &#125; try index.renameTo(new File(CoreUtils.replaceSuffix(index.file.getPath, oldSuffix, newSuffix))) catch &#123; case e: IOException =&gt; throw kafkaStorageException(&quot;index&quot;, e) &#125; try timeIndex.renameTo(new File(CoreUtils.replaceSuffix(timeIndex.file.getPath, oldSuffix, newSuffix))) catch &#123; case e: IOException =&gt; throw kafkaStorageException(&quot;timeindex&quot;, e) &#125; &#125; â€‹ ä½†æ˜¯åœ¨hdfsç›¸å…³çš„æ¸…ç†åŠŸèƒ½ä¸­ï¼Œç›´æ¥è¿›è¡Œçš„æ—¥å¿—æ¸…ç†è€Œæ²¡æœ‰renameå’Œdelayæ“ä½œï¼Œæ‰€ä»¥æ¨æµ‹æ¸…ç†æ—¥å¿—å’Œç´¢å¼•æ—¶ï¼Œå¦‚æœæ–‡ä»¶ä»è¢«è¯»å–ï¼Œå¼ºè¡Œåˆ é™¤ä¼šå¯¼è‡´core dumpã€‚ ä¸‰ã€æµ‹è¯•ç»“è®º ç¼–å†™å•æµ‹ï¼Œæœ¬åœ°ç´¢å¼•lookupè¿‡ç¨‹ä¸­å¼ºè¡Œåˆ é™¤ç´¢å¼•æ–‡ä»¶ï¼Œç¡®å®å‡ºç°äº†core dumpç°è±¡ã€‚ è§£å†³æ–¹æ¡ˆ ä»¿ç…§æœ¬åœ°æ—¥å¿—çš„æ¸…ç†ç­–ç•¥ï¼Œåœ¨hdfsç›¸å…³çš„é€»è¾‘ä¸­ï¼Œä¸ç›´æ¥åˆ é™¤æ–‡ä»¶ï¼Œè€Œæ˜¯å…ˆrenameæ–‡ä»¶ï¼Œç„¶åå†å»¶è¿Ÿä¸€å®šæ—¶é—´è¿›è¡Œåˆ é™¤ã€‚ æ€»ç»“ æœ¬æ¬¡é—®é¢˜çš„å‡ºç°å±äºå¶å‘ç°è±¡ï¼Œåªæœ‰åœ¨kafka consumeræ¶ˆè´¹lagï¼Œè¯»å–å³å°†è¢«åˆ é™¤çš„æ—¥å¿—æ—¶æ‰æœ‰å¯èƒ½ä¼šå‘ç”Ÿã€‚ core dumpé—®é¢˜åˆ†æçš„è¿‡ç¨‹ä¸­éœ€è¦é€šè¿‡å¤šä¸ªcaseçš„ç›¸ä¼¼ç‚¹æ¥åˆ†æé—®é¢˜ã€‚","raw":null,"content":null,"categories":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://fxbing.github.io/categories/%E6%8A%80%E6%9C%AF/"}],"tags":[{"name":"kafka","slug":"kafka","permalink":"http://fxbing.github.io/tags/kafka/"},{"name":"é—®é¢˜æ’æŸ¥","slug":"é—®é¢˜æ’æŸ¥","permalink":"http://fxbing.github.io/tags/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/"}]},{"title":"äºŒé›¶äºŒä¸€å¹´ä¸ƒæœˆä¹¦å•","slug":"äºŒé›¶äºŒä¸€å¹´ä¸ƒæœˆä¹¦å•","date":"2021-08-15T08:58:12.000Z","updated":"2021-08-15T09:08:39.753Z","comments":true,"path":"2021/08/15/äºŒé›¶äºŒä¸€å¹´ä¸ƒæœˆä¹¦å•/","link":"","permalink":"http://fxbing.github.io/2021/08/15/%E4%BA%8C%E9%9B%B6%E4%BA%8C%E4%B8%80%E5%B9%B4%E4%B8%83%E6%9C%88%E4%B9%A6%E5%8D%95/","excerpt":"â€‹    è¿™æ˜¯æˆ‘çš„ç¬¬ä¸€æ¬¡ä¹¦å•æ€»ç»“ï¼Œå¸Œæœ›ä»¥åæ¯ä¸ªæœˆéƒ½èƒ½æœ‰ä¸€æ¬¡ä¹¦å•æ€»ç»“å°†è‡ªå·±è¯»è¿‡çš„ä¹¦è®°å½•ä¸‹æ¥ã€‚","text":"â€‹ è¿™æ˜¯æˆ‘çš„ç¬¬ä¸€æ¬¡ä¹¦å•æ€»ç»“ï¼Œå¸Œæœ›ä»¥åæ¯ä¸ªæœˆéƒ½èƒ½æœ‰ä¸€æ¬¡ä¹¦å•æ€»ç»“å°†è‡ªå·±è¯»è¿‡çš„ä¹¦è®°å½•ä¸‹æ¥ã€‚ ğŸ“šä»¥ä¸‹ä¹¦ç±å‡ºç°çš„é¡ºåºä»£è¡¨æˆ‘å¯¹è¿™äº›ä¹¦çš„è¯„åˆ†æ’åºã€‚ ã€Šæœé—»é“ã€‹ ç›¸æ¯”äºä»â€œä¸çŸ¥é“â€åˆ°â€œçŸ¥é“â€ï¼Œä»â€œä¸çŸ¥é“è‡ªå·±ä¸çŸ¥é“â€åˆ°â€œçŸ¥é“è‡ªå·±ä¸çŸ¥é“â€ä¹‹é—´çš„è·¯æ›´é•¿ â€‹ å®‡å®™æ’é™©è€…çš„èŒè´£æ˜¯è´Ÿè´£æ’é™¤å®‡å®™ä¸­å­˜åœ¨çš„çŸ¥è¯†çš„å·¨å¤§å‘å±•ï¼Œå› ä¸ºå½“äººä»¬è·å–åˆ°æ›´å¤šçš„å®‡å®™å¥¥ç§˜æ—¶ï¼Œå¯¹å®‡å®™ä¹Ÿæ›´åŠ å±é™©ã€‚äººç±»ç¬¬ä¸€æ¬¡è§¦å‘æ’é™©è€…æŠ¥è­¦æ˜¯å› ä¸ºåŸå§‹äººç±»ç¬¬ä¸€æ¬¡ä»°æœ›æ˜Ÿç©ºï¼Œå› ä¸ºï¼Œâ€œå½“ç”Ÿå‘½æ„è¯†åˆ°å®‡å®™å¥¥ç§˜çš„å­˜åœ¨æ—¶ï¼Œè·å®ƒæœ€ç»ˆè§£å¼€è¿™ä¸ªå¥¥ç§˜åªæœ‰ä¸€æ­¥ä¹‹é¥ã€‚â€ â€œæœé—»é“å¤•æ­»å¯çŸ£â€ â€‹ è¿™æ˜¯ä¸€å¥è®ºè¯­ä¸­çš„è¯ï¼Œè€åˆ˜ä»ç§‘å¹»çš„è§’åº¦è¿›è¡Œäº†è§£é‡Šã€‚å®‡å®™æ’é™©è€…çš„å·¥ä½œæ˜¯é˜»æ­¢äººä»¬è·å–å®‡å®™çš„å¥¥ç§˜ï¼Œé˜²æ­¢å®‡å®™è¢«ç ´åã€‚å®‡å®™æ’é™©è€…çŸ¥é“å®‡å®™çš„å¥¥ç§˜ï¼Œå´ä¸èƒ½å‘Šè¯‰äººç±»ã€‚ä¸ä»ªæƒ³åˆ°äº†å¯ä»¥æ—¢èƒ½å¾—åˆ°å®‡å®™çš„ç»ˆæå¥¥ç§˜ï¼Œåˆä¸è¿åå®‡å®™æ’é™©è€…çš„èŒè´£çš„æ–¹æ³•ï¼šâ€œæŠŠå®‡å®™çš„ç»ˆæå¥¥ç§˜å‘Šè¯‰æˆ‘ï¼Œç„¶åå†æ¯ç­æˆ‘ã€‚â€ä¹‹åä¾¿æœ‰å¤§é‡çš„é¡¶çº§å­¦è€…å‰èµ´åç»§åœ°é€‰æ‹©å¾—åˆ°å®‡å®™çš„å¥¥ç§˜ç„¶åæ­»å»ã€‚ â€‹ åœ¨æˆ‘çœ‹æ¥ï¼Œæ™®é€šäººä¸ä¼šå‚ä¸ã€é€‰æ‹©â€œæœé—»é“å¤•æ­»â€ï¼Œæ˜¯å› ä¸ºè¶Šæ˜¯æœ‰çŸ¥è¯†çš„äººï¼Œæ‰ä¼šçŸ¥é“è‡ªå·±ä¸çŸ¥é“ä»€ä¹ˆï¼Œäººä»¬çš„å­¦ä¹ è¿‡ç¨‹ï¼Œä¸æ˜¯ä¸€ä¸ªä»â€œä¸çŸ¥é“â€åˆ°â€œçŸ¥é“â€çš„è¿‡ç¨‹ï¼Œè€Œæ˜¯ä¸€ä¸ªâ€œä¸çŸ¥é“è‡ªå·±ä¸çŸ¥é“â€åˆ°â€œçŸ¥é“è‡ªå·±ä¸çŸ¥é“â€çš„è¿‡ç¨‹ï¼Œæ™®é€šäººâ€œçŸ¥é“è‡ªå·±ä¸çŸ¥é“â€çš„ä¸œè¥¿ï¼Œè¿˜è¿œåˆ°ä¸äº†éœ€è¦å®‡å®™æ’é™©è€…æ¥è§£ç­”çš„ç¨‹åº¦ã€‚ â€‹ ä½†æ˜¯ï¼Œå¦‚æœæˆä¸ºäº†é¡¶çº§å­¦è€…ï¼Œæ˜¯å¦åˆçœŸçš„èƒ½é€‰æ‹©â€œæœé—»é“å¤•æ­»å¯çŸ£â€ï¼Ÿ ã€Šä½ å½“åƒé¸Ÿé£å¾€ä½ çš„å±±ã€‹ â€‹ è¿™æœ¬ä¹¦è®²è¿°äº†ä¸€ä¸ªå¥³å­©å…³äºåŸç”Ÿå®¶åº­çš„è‡ªè¿°ï¼Œåœ¨å¥¹çš„å®¶é‡Œæœ‰æš´åŠ›ç‹‚çš„å“¥å“¥ã€ä¸è®©å­©å­å—æ•™è‚²çš„çˆ¶äº²ã€åªä¼šå¬ä»çˆ¶äº²è¯çš„æ¯äº²ï¼Œåä¸ƒå²å‰ä»æœªä¸Šè¿‡å­¦ï¼Œç°åœ¨å´æˆä¸ºäº†å‰‘æ¡¥å¤§å­¦çš„åšå£«ã€‚è™½ç„¶ä¸»è¦æ˜¯ä½œè€…è‡ªèº«ç»å†çš„æå†™ï¼Œä½†æ˜¯ä½œè€…å¿ƒè·¯å†ç¨‹çš„å˜åŒ–æ¸…æ™°å¯è§ã€‚ä»ä½œè€…å¿ƒè·¯å†ç¨‹çš„å˜åŒ–ä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°è®¸å¤šå…³äºåŸç”Ÿå®¶åº­çš„é“ç†ï¼Œè¿™äº›é“ç†åœ¨åŸç”Ÿå®¶åº­ä¸ç°å®ä¸–ç•Œçš„å†²çªæ²¡æœ‰é‚£ä¹ˆä¸¥é‡æ—¶æ˜¯ä¸å®¹æ˜“è§¦åŠçš„ã€‚ åŸç”Ÿå®¶åº­çš„å½±å“å¾ˆéš¾æ”¹å˜ â€‹ ä½œè€…çš„æˆé•¿è¿‡ç¨‹ä¸­ï¼Œå³ä¾¿è¯»ä¹¦ä½¿å¥¹è§åˆ°äº†æ›´åŠ å¹¿é˜”çš„ä¸–ç•Œï¼Œè®¤è¯†åˆ°çˆ¶äº²é‚£äº›é¡½å›ºçš„è§‚ç‚¹ï¼ˆè¯»ä¹¦ä¸å¥½ï¼Œæ”¿åºœä¸å¥½ï¼ŒåŒ»é™¢é‡Œçš„åŒ»ç”Ÿéƒ½æ˜¯æ¶é­”ç­‰ï¼‰ä¸æ˜¯æ­£ç¡®çš„ï¼Œä½†æ˜¯ä¾æ—§ä¼šå¯¹å½“ä¸‹çš„ç”Ÿæ´»æŒæœ‰æ€€ç–‘ï¼Œæ€€ç–‘ç°åœ¨çš„ä¸–ç•Œæ˜¯å¦çœŸçš„å¦‚çˆ¶äº²æ‰€è®²ã€‚ ä¸€ä¸ªäººä»ä¸å¥½çš„åŸç”Ÿå®¶åº­ä¸­èµ°å‡ºåæ€»æ˜¯ä¼šæƒ³ç€å¸®åŠ©å®¶äººæ”¹å˜ â€‹ å½“ä½œè€…ç¦»å¼€åŸç”Ÿå®¶åº­ï¼Œå¤–å‡ºè¯»ä¹¦ï¼ŒçŸ¥é“äº†ç”Ÿç—…å°±åº”è¯¥å»åŒ»é™¢ï¼ŒçŸ¥é“åˆ°äº†æŒ‡å®šå¹´é¾„å°±åº”è¯¥å»è¯»ä¹¦ã€‚è™½ç„¶å¯¹åŸç”Ÿå®¶åº­æ€€æœ‰æ¨æ„ï¼Œä½†æ˜¯ä»ç„¶å¾ˆæƒ³å¸®åŠ©ä»–ä»¬ï¼Œè®©ä»–ä»¬çŸ¥é“ä»€ä¹ˆæ˜¯å¯¹çš„ï¼Œä»€ä¹ˆæ˜¯ä¸å¯¹çš„ï¼Œæƒ³è®©å¦¹å¦¹å»ä¸Šå­¦ï¼Œæƒ³è®©æ¯äº²ä¸è¿·æ‹è‰è¯å»ç›¸ä¿¡åŒ»é™¢ã€‚ ç›¸æ¯”äºå¤–ç•Œçš„è®¤å¯ï¼Œè‡ªæˆ‘è®¤å¯æ‰æ›´ä¸ºé‡è¦ â€‹ é€ƒç¦»åŸç”Ÿå®¶åº­çš„è¿‡ç¨‹ä¸­é¢ä¸´ç€ç§ç§å›°éš¾ï¼Œæ¥åˆ°å¤–é¢çš„ä¸–ç•Œåï¼Œä½œè€…ä¼šæœ‰å„ç§ä¸é€‚åº”ï¼Œè‡ªå‘ï¼Œæ ¼æ ¼ä¸å…¥çš„æ„Ÿè§‰ï¼Œè®¤ä¸ºåˆ«äººå¬åˆ°å¥¹çš„äººç”Ÿç»å†ä¼šä¸ç†è§£ï¼Œçœ‹ä¸èµ·å¥¹ã€‚å…¶å®ä¸ç„¶ï¼ŒçœŸæ­£çš„å›°éš¾ä»æ¥ä¸æ˜¯æ¥è‡ªäºå¤–ç•Œï¼Œè€Œæ˜¯è‡ªå·±ï¼Œè‡ªå·±éƒ½æ— æ³•è®¤å¯è‡ªå·±æ—¶æ€ä¹ˆèƒ½åˆ°åˆ°å¤–ç•Œçš„è®¤å¯ï¼Œåä¹‹ï¼Œå½“è‡ªå·±å¯ä»¥è®¤å¯è‡ªå·±æ—¶ï¼Œå¤–ç•Œçš„è®¤å¯ä¹Ÿä¾¿ä¸å†é‚£ä¹ˆé‡è¦ã€‚ ã€Šéæš´åŠ›æ²Ÿé€šã€‹ â€‹ è¿™æœ¬ä¹¦ä»‹ç»äº†ä¸€ç§æ²Ÿé€šæ¨¡å¼ï¼Œä¸è®ºæ˜¯è¡¨è¾¾è‡ªå·±è¿˜æ˜¯å€¾å¬ä»–äººï¼Œéƒ½è¦éµå¾ªä»¥ä¸‹å››ä¸ªæ­¥éª¤ï¼šè§‚å¯Ÿã€æ„Ÿå—ã€éœ€è¦ã€è¯·æ±‚ã€‚éœ€è¦åœ¨å¹³æ—¶çš„æ²Ÿé€šä¸­æé†’è‡ªå·±ï¼ŒæŒ‰ç…§ä¸‹é¢çš„æ¨¡å¼è¿›è¡Œã€‚ è¯šå®åœ°è¡¨è¾¾è‡ªå·±ï¼Œè€Œä¸æ‰¹è¯„ã€æŒ‡è´£ è§‚å¯Ÿæˆ‘æ‰€è§‚å¯Ÿï¼ˆçœ‹ã€å¬ã€å›å¿†ã€æƒ³ï¼‰åˆ°çš„æœ‰åŠ©äºï¼ˆæˆ–æ— åŠ©äºï¼‰æˆ‘çš„ç¦ç¥‰çš„å…·ä½“è¡Œä¸ºï¼šâ€œå½“æˆ‘ï¼ˆçœ‹ã€å¬ã€æƒ³åˆ°æˆ‘çœ‹åˆ°çš„/å¬åˆ°çš„ï¼‰â€¦â€¦â€ æ„Ÿå—å¯¹äºè¿™äº›è¡Œä¸ºï¼Œæˆ‘æœ‰ä»€ä¹ˆæ ·çš„æ„Ÿå—ï¼ˆæƒ…æ„Ÿè€Œéæ€æƒ³ï¼‰ï¼šâ€œæˆ‘æ„Ÿåˆ°â€¦â€¦â€ éœ€è¦ä»€ä¹ˆæ ·çš„éœ€è¦æˆ–ä»·å€¼ï¼ˆè€Œéåå¥½æˆ–æŸç§å…·ä½“çš„è¡Œä¸ºï¼‰å¯¼è‡´æˆ‘é‚£æ ·çš„æ„Ÿå—ï¼šâ€œå› ä¸ºæˆ‘éœ€è¦/çœ‹é‡â€¦â€¦â€ è¯·æ±‚æ¸…æ¥šåœ°è¯·æ±‚ï¼ˆè€Œéå‘½ä»¤ï¼‰é‚£äº›èƒ½ä¸°å¯Œæˆ‘ç”Ÿå‘½çš„å…·ä½“è¡Œä¸ºï¼Œâ€œä½ æ˜¯å¦æ„¿æ„â€¦â€¦ï¼Ÿâ€ å…³åˆ‡åœ°å€¾å¬ä»–äººï¼Œè€Œä¸è§£è¯»ä¸ºæ‰¹è¯„æˆ–æŒ‡è´£ è§‚å¯Ÿä½ æ‰€è§‚å¯Ÿï¼ˆçœ‹ã€å¬ã€å›å¿†ã€æƒ³ï¼‰åˆ°çš„æœ‰åŠ©äºï¼ˆæˆ–æ— åŠ©äºï¼‰ä½ çš„ç¦ç¥‰çš„å…·ä½“è¡Œä¸ºï¼šâ€œå½“ä½ ï¼ˆçœ‹ã€å¬ã€æƒ³åˆ°ä½ çœ‹åˆ°çš„/å¬åˆ°çš„ï¼‰â€¦â€¦â€ æ„Ÿå—å¯¹äºè¿™äº›è¡Œä¸ºï¼Œä½ æœ‰ä»€ä¹ˆæ ·çš„æ„Ÿå—ï¼ˆæ˜¯æƒ…æ„Ÿè€Œéæ€æƒ³ï¼‰ï¼šâ€œä½ æ„Ÿåˆ°â€¦â€¦å—ï¼Ÿâ€ éœ€è¦ä»€ä¹ˆæ ·çš„éœ€è¦æˆ–ä»·å€¼ï¼ˆè€Œéåå¥½æˆ–æŸç§å…·ä½“çš„è¡Œä¸ºï¼‰å¯¼è‡´ä½ é‚£æ ·çš„æ„Ÿå—ï¼šâ€œå› ä¸ºä½ éœ€è¦/çœ‹é‡â€¦â€¦â€ è¯·æ±‚å…³åˆ‡åœ°å€¾å¬é‚£äº›èƒ½ä¸°å¯Œä½ ç”Ÿå‘½çš„å…·ä½“è¯·æ±‚ï¼Œè€Œä¸è§£è¯»ä¸ºå‘½ä»¤ï¼šâ€œæ‰€ä»¥ï¼Œä½ æƒ³â€¦â€¦â€ ã€Šä»£ç æ•´æ´ä¹‹é“ã€‹ â€‹ ä»å‘½åè§„èŒƒã€æ³¨é‡Šã€ä»£ç è§„èŒƒç­‰å„ä¸ªæ–¹é¢ä»‹ç»äº†å¦‚æœå†™å‡ºä¸€ä»½å¥½çš„ä»£ç ï¼Œå…¶ä¸­æœ‰è®¸å¤šå†…å®¹å…¶å®åœ¨å®é™…ç¼–ç è¿‡ç¨‹ä¸­å·²ç»éµå®ˆï¼Œåªä¸è¿‡è‡ªå·±æ²¡æœ‰æ„è¯†åˆ°ï¼Œæ²¡æœ‰ç³»ç»ŸåŒ–çš„æ¢³ç†ï¼Œä½†æ˜¯ä¹Ÿå­˜åœ¨éœ€è¦è‡ªå·±æ²¡æœ‰æ„è¯†åˆ°çš„äº‹æƒ…ï¼Œæ¯”å¦‚ï¼šå°½é‡é¿å…åœ¨å‡½æ•°å‚æ•°ä¸­ä½¿ç”¨å¸ƒå°”å‹å˜é‡æ¥åŒºåˆ†ä¸åŒåŠŸèƒ½ï¼Œè€Œæ˜¯è¦å†™æˆä¸¤ä¸ªåç§°ä¸åŒçš„å‡½æ•°ã€‚ä»£ç ä¸åªæ˜¯å†™ç»™è‡ªå·±çš„ï¼Œé™¤äº†åŠŸèƒ½æ­£ç¡®å¤–ï¼Œå¯è¯»æ€§å¼ºä¹Ÿæ˜¯å¥½ä»£ç çš„æ ‡å‡†ï¼ŒæŒ‰ç…§ä¹¦ä¸Šçš„æ€»ç»“è¿›è¡Œæ‰§è¡Œï¼Œè®©è‡ªå·±çš„ä»£ç æ›´å¥½ã€‚ ã€ŠæŒ‡æ•°åŸºé‡‘æŠ•èµ„æŒ‡å—ã€‹ â€‹ è¿™æœ¬ä¹¦å¯ä»¥ç®—ä¸€ä¸ªæŒ‡æ•°åŸºé‡‘çš„ç§‘æ™®æ‰‹å†Œï¼Œé€šè¿‡è¿™æœ¬ä¹¦å¯ä»¥äº†è§£å¤§éƒ¨åˆ†ä¸»è¦çš„æŒ‡æ•°åŸºé‡‘ç±»å‹çš„åŸºæœ¬çŸ¥è¯†ï¼Œå¹¶ä¸”ç»™å‡ºä¸€äº›æŠ•èµ„æ–¹é¢çš„å»ºè®®ã€‚æŒ‡æ•°åŸºé‡‘çš„æŠ•èµ„ï¼Œå…³é”®è¿˜æ˜¯è¦ç¨³å®šæŠ•èµ„ï¼Œé•¿æœŸæŒæœ‰ã€‚ ã€Šæˆ‘çš„ç¬¬ä¸€æœ¬äººç”Ÿè§„åˆ’æ‰‹å†Œã€‹ â€‹ è¿™æœ¬ä¹¦æ›´åƒæ˜¯ä¸€ä¸ªå…¬ä¼—å·æ–‡ç« çš„åˆé›†ï¼Œå®ƒä¼šå‘Šè¯‰ä½ è¦èµšé’±ï¼Œè¦è§„åˆ’ï¼Œä¼šå‘Šè¯‰ä½ ä»€ä¹ˆæ ·çš„ç›®æ ‡åœ¨æ¯ä¸ªé˜¶æ®µåº”è¯¥èµšå¾—å¤šå°‘é’±ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰ä»€ä¹ˆå®è´¨æ€§çš„å»ºè®®ï¼Œæ¯ä¸ªäººçš„å®é™…æƒ…å†µå¹¶ä¸ç›¸åŒï¼Œæ¯ä¸ªäººéœ€è¦è€ƒè™‘ã€é€‰æ‹©ã€åŠªåŠ›çš„äº‹æƒ…ä¹Ÿå¹¶ä¸ç›¸åŒï¼Œé‡è¦è¿˜æ˜¯è‡ªå·±è®¤çœŸçš„æ€è€ƒï¼Œç„¶åè„šè¸å®åœ°å¥½å¥½åŠªåŠ›ã€‚","raw":null,"content":null,"categories":[{"name":"è¯»ä¹¦","slug":"è¯»ä¹¦","permalink":"http://fxbing.github.io/categories/%E8%AF%BB%E4%B9%A6/"}],"tags":[{"name":"2021ä¹¦å•","slug":"2021ä¹¦å•","permalink":"http://fxbing.github.io/tags/2021%E4%B9%A6%E5%8D%95/"}]},{"title":"kafkaæºç å­¦ä¹ ï¼šKafkaApis-LEADER_AND_ISR","slug":"kafkaæºç å­¦ä¹ ï¼šKafkaApis-LEADER-AND-ISR","date":"2021-06-05T10:00:12.000Z","updated":"2021-06-05T12:09:27.405Z","comments":true,"path":"2021/06/05/kafkaæºç å­¦ä¹ ï¼šKafkaApis-LEADER-AND-ISR/","link":"","permalink":"http://fxbing.github.io/2021/06/05/kafka%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%EF%BC%9AKafkaApis-LEADER-AND-ISR/","excerpt":"\næœ¬æ–‡æºç åŸºäºkafka 0.10.2ç‰ˆæœ¬\n\nâ€‹    æ¯å½“controllerå‘ç”ŸçŠ¶æ€å˜æ›´æ—¶ï¼Œéƒ½ä¼šé€šè¿‡è°ƒç”¨sendRequestsToBrokersæ–¹æ³•å‘é€leaderAndIsrRequestè¯·æ±‚ï¼Œæœ¬æ–‡ä¸»è¦ä»‹ç»kafkaæœåŠ¡ç«¯å¤„ç†è¯¥è¯·æ±‚çš„é€»è¾‘å’Œè¿‡ç¨‹ã€‚","text":"æœ¬æ–‡æºç åŸºäºkafka 0.10.2ç‰ˆæœ¬ â€‹ æ¯å½“controllerå‘ç”ŸçŠ¶æ€å˜æ›´æ—¶ï¼Œéƒ½ä¼šé€šè¿‡è°ƒç”¨sendRequestsToBrokersæ–¹æ³•å‘é€leaderAndIsrRequestè¯·æ±‚ï¼Œæœ¬æ–‡ä¸»è¦ä»‹ç»kafkaæœåŠ¡ç«¯å¤„ç†è¯¥è¯·æ±‚çš„é€»è¾‘å’Œè¿‡ç¨‹ã€‚ LEADER_AND_ISR æ•´ä½“é€»è¾‘æµç¨‹ 1case ApiKeys.LEADER_AND_ISR =&gt; handleLeaderAndIsrRequest(request) åœ¨serverç«¯æ”¶åˆ°LEADER_AND_ISRè¯·æ±‚åï¼Œä¼šè°ƒç”¨handleLeaderAndIsrRequestæ–¹æ³•è¿›è¡Œå¤„ç†ï¼Œè¯¥æ–¹æ³•çš„å¤„ç†æµç¨‹å¦‚å›¾æ‰€ç¤ºï¼š æºç  handleLeaderAndIsrRequest handleLeaderAndIsrRequestå‡½æ•°çš„é€»è¾‘ç»“æœä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š æ„é€ callbackå‡½æ•°onLeadershipChange,ç”¨æ¥å›è°ƒcoordinatorå¤„ç†æ–°å¢çš„leaderæˆ–è€…followerèŠ‚ç‚¹ æ ¡éªŒè¯·æ±‚æƒé™ï¼Œå¦‚æœæ ¡éªŒæˆåŠŸè°ƒç”¨replicaManager.becomeLeaderOrFollower(correlationId, leaderAndIsrRequest, metadataCache, onLeadershipChange)è¿›è¡Œåç»­å¤„ç†ã€æ­¤å¤„è¯¥å‡½æ•°çš„ä¸»æµç¨‹ã€‘ï¼Œå¦åˆ™ï¼Œç›´æ¥è¿”å›é”™è¯¯ç Errors.CLUSTER_AUTHORIZATION_FAILED.code 1234567891011121314151617181920212223242526272829303132333435363738def handleLeaderAndIsrRequest(request: RequestChannel.Request) &#123; // ensureTopicExists is only for client facing requests // We can&#x27;t have the ensureTopicExists check here since the controller sends it as an advisory to all brokers so they // stop serving data to clients for the topic being deleted val correlationId = request.header.correlationId val leaderAndIsrRequest = request.body.asInstanceOf[LeaderAndIsrRequest] try &#123; def onLeadershipChange(updatedLeaders: Iterable[Partition], updatedFollowers: Iterable[Partition]) &#123; // for each new leader or follower, call coordinator to handle consumer group migration. // this callback is invoked under the replica state change lock to ensure proper order of // leadership changes updatedLeaders.foreach &#123; partition =&gt; if (partition.topic == Topic.GroupMetadataTopicName) coordinator.handleGroupImmigration(partition.partitionId) &#125; updatedFollowers.foreach &#123; partition =&gt; if (partition.topic == Topic.GroupMetadataTopicName) coordinator.handleGroupEmigration(partition.partitionId) &#125; &#125; val leaderAndIsrResponse = if (authorize(request.session, ClusterAction, Resource.ClusterResource)) &#123; val result = replicaManager.becomeLeaderOrFollower(correlationId, leaderAndIsrRequest, metadataCache, onLeadershipChange) new LeaderAndIsrResponse(result.errorCode, result.responseMap.mapValues(new JShort(_)).asJava) &#125; else &#123; val result = leaderAndIsrRequest.partitionStates.asScala.keys.map((_, new JShort(Errors.CLUSTER_AUTHORIZATION_FAILED.code))).toMap new LeaderAndIsrResponse(Errors.CLUSTER_AUTHORIZATION_FAILED.code, result.asJava) &#125; requestChannel.sendResponse(new Response(request, leaderAndIsrResponse)) &#125; catch &#123; case e: KafkaStorageException =&gt; fatal(&quot;Disk error during leadership change.&quot;, e) Runtime.getRuntime.halt(1) &#125; &#125; becomeLeaderOrFollower ReplicaManagerçš„ä¸»è¦å·¥ä½œæœ‰ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼Œå…·ä½“ä»£ç ä½ç½®è§ä¸­æ–‡æ³¨é‡Šï¼š æ ¡éªŒcontroller epochæ˜¯å¦åˆè§„ï¼Œåªå¤„ç†æ¯”è‡ªå·±epochå¤§ä¸”æœ¬åœ°æœ‰å‰¯æœ¬çš„tpçš„è¯·æ±‚ è°ƒç”¨makeLeaderså’ŒmakeFollowersæ–¹æ³•æ„é€ æ–°å¢çš„leader partitionå’Œfollower partitionã€æ­¤å¤„ä¸ºä¸»è¦é€»è¾‘ï¼Œåé¢å°ç»“è¯¦ç»†ä»‹ç»ã€‘ å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æ”¶åˆ°è¯·æ±‚ï¼Œå¯åŠ¨å®šæ—¶æ›´æ–°hwçš„çº¿ç¨‹ åœæ‰ç©ºçš„Fetcherçº¿ç¨‹ è°ƒç”¨å›è°ƒå‡½æ•°ï¼Œcoordinatorå¤„ç†æ–°å¢çš„leader partitionå’Œfollower partition 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283def becomeLeaderOrFollower(correlationId: Int,leaderAndISRRequest: LeaderAndIsrRequest, metadataCache: MetadataCache, onLeadershipChange: (Iterable[Partition], Iterable[Partition]) =&gt; Unit): BecomeLeaderOrFollowerResult = &#123; leaderAndISRRequest.partitionStates.asScala.foreach &#123; case (topicPartition, stateInfo) =&gt; stateChangeLogger.trace(&quot;Broker %d received LeaderAndIsr request %s correlation id %d from controller %d epoch %d for partition [%s,%d]&quot; .format(localBrokerId, stateInfo, correlationId, leaderAndISRRequest.controllerId, leaderAndISRRequest.controllerEpoch, topicPartition.topic, topicPartition.partition)) &#125; //ä¸»è¦ä»£ç ï¼Œæ„é€ è¿”å›ç»“æœ replicaStateChangeLock synchronized &#123; val responseMap = new mutable.HashMap[TopicPartition, Short] //å¦‚æœcontroller epochä¸æ­£ç¡®ï¼Œç›´æ¥è¿”å›Errors.STALE_CONTROLLER_EPOCH.codeé”™è¯¯ç  if (leaderAndISRRequest.controllerEpoch &lt; controllerEpoch) &#123; stateChangeLogger.warn((&quot;Broker %d ignoring LeaderAndIsr request from controller %d with correlation id %d since &quot; + &quot;its controller epoch %d is old. Latest known controller epoch is %d&quot;).format(localBrokerId, leaderAndISRRequest.controllerId, correlationId, leaderAndISRRequest.controllerEpoch, controllerEpoch)) BecomeLeaderOrFollowerResult(responseMap, Errors.STALE_CONTROLLER_EPOCH.code) &#125; else &#123; val controllerId = leaderAndISRRequest.controllerId controllerEpoch = leaderAndISRRequest.controllerEpoch // First check partition&#x27;s leader epoch //æ ¡éªŒæ‰€æœ‰çš„partitionä¿¡æ¯ï¼Œåˆ†ä¸ºä»¥ä¸‹3ç§æƒ…å†µï¼š //1. æœ¬åœ°ä¸åŒ…å«è¯¥partitionï¼Œè¿”å›Errors.UNKNOWN_TOPIC_OR_PARTITION.code //2. æœ¬åœ°åŒ…å«è¯¥partitionï¼Œcontroller epochæ¯”æœ¬åœ°epochå¤§ï¼Œä¿¡æ¯æ­£ç¡® //3. controller epochæ¯”æœ¬åœ°epochå°ï¼Œè¿”å›Errors.STALE_CONTROLLER_EPOCH.code val partitionState = new mutable.HashMap[Partition, PartitionState]() leaderAndISRRequest.partitionStates.asScala.foreach &#123; case (topicPartition, stateInfo) =&gt; val partition = getOrCreatePartition(topicPartition) val partitionLeaderEpoch = partition.getLeaderEpoch // If the leader epoch is valid record the epoch of the controller that made the leadership decision. // This is useful while updating the isr to maintain the decision maker controller&#x27;s epoch in the zookeeper path if (partitionLeaderEpoch &lt; stateInfo.leaderEpoch) &#123; if(stateInfo.replicas.contains(localBrokerId)) partitionState.put(partition, stateInfo) else &#123; stateChangeLogger.warn((&quot;Broker %d ignoring LeaderAndIsr request from controller %d with correlation id %d &quot; + &quot;epoch %d for partition [%s,%d] as itself is not in assigned replica list %s&quot;) .format(localBrokerId, controllerId, correlationId, leaderAndISRRequest.controllerEpoch, topicPartition.topic, topicPartition.partition, stateInfo.replicas.asScala.mkString(&quot;,&quot;))) responseMap.put(topicPartition, Errors.UNKNOWN_TOPIC_OR_PARTITION.code) &#125; &#125; else &#123; // Otherwise record the error code in response stateChangeLogger.warn((&quot;Broker %d ignoring LeaderAndIsr request from controller %d with correlation id %d &quot; + &quot;epoch %d for partition [%s,%d] since its associated leader epoch %d is not higher than the current leader epoch %d&quot;) .format(localBrokerId, controllerId, correlationId, leaderAndISRRequest.controllerEpoch, topicPartition.topic, topicPartition.partition, stateInfo.leaderEpoch, partitionLeaderEpoch)) responseMap.put(topicPartition, Errors.STALE_CONTROLLER_EPOCH.code) &#125; &#125; //å¤„ç†leader&amp;followerå‰¯æœ¬ï¼Œæ„é€ partitionsBecomeLeaderå’ŒpartitionsBecomeFollowerä¾›callbackå¤„ç†ï¼ˆcoordinatorå¤„ç†ï¼‰ val partitionsTobeLeader = partitionState.filter &#123; case (_, stateInfo) =&gt; stateInfo.leader == localBrokerId &#125; val partitionsToBeFollower = partitionState -- partitionsTobeLeader.keys val partitionsBecomeLeader = if (partitionsTobeLeader.nonEmpty) // ä¸»è¦è°ƒç”¨ makeLeaders(controllerId, controllerEpoch, partitionsTobeLeader, correlationId, responseMap) else Set.empty[Partition] val partitionsBecomeFollower = if (partitionsToBeFollower.nonEmpty) // ä¸»è¦è°ƒç”¨ makeFollowers(controllerId, controllerEpoch, partitionsToBeFollower, correlationId, responseMap, metadataCache) else Set.empty[Partition] // we initialize highwatermark thread after the first leaderisrrequest. This ensures that all the partitions // have been completely populated before starting the checkpointing there by avoiding weird race conditions // åœ¨ç¬¬ä¸€æ¬¡æ”¶åˆ°æ”¶åˆ°è¯·æ±‚åï¼Œå°±ä¼šå¯åŠ¨Schedulerï¼Œå®šæ—¶æ›´æ–°hw checkpoint if (!hwThreadInitialized) &#123; startHighWaterMarksCheckPointThread() hwThreadInitialized = true &#125; // å› ä¸ºä¸Šé¢æ›´æ–°äº†å…ƒä¿¡æ¯ï¼Œæ­¤å¤„æ£€æŸ¥åœæ‰ä¸å¿…è¦çš„Fetcherçº¿ç¨‹ replicaFetcherManager.shutdownIdleFetcherThreads() // å›è°ƒ onLeadershipChange(partitionsBecomeLeader, partitionsBecomeFollower) BecomeLeaderOrFollowerResult(responseMap, Errors.NONE.code) &#125; &#125;&#125; makeLeaders å¤„ç†æ–°å¢çš„leader partition åœæ­¢è¿™äº›partitionçš„followerçº¿ç¨‹ æ›´æ–°è¿™äº›partitionçš„metadata cache æ„é€ æ–°å¢leaderé›†åˆ 123456789101112131415161718192021222324252627282930313233343536373839private def makeLeaders(controllerId: Int, epoch: Int, partitionState: Map[Partition, PartitionState], correlationId: Int, responseMap: mutable.Map[TopicPartition, Short]): Set[Partition] = &#123; // æ„é€ becomeLeaderOrFolloweréœ€è¦çš„è¿”å›ç»“æœ for (partition &lt;- partitionState.keys) responseMap.put(partition.topicPartition, Errors.NONE.code) val partitionsToMakeLeaders: mutable.Set[Partition] = mutable.Set() try &#123; // First stop fetchers for all the partitions // åœæ­¢Fetcherçº¿ç¨‹ replicaFetcherManager.removeFetcherForPartitions(partitionState.keySet.map(_.topicPartition)) // Update the partition information to be the leader // æ„é€ æ–°å¢leader partitioné›†åˆ partitionState.foreach&#123; case (partition, partitionStateInfo) =&gt; if (partition.makeLeader(controllerId, partitionStateInfo, correlationId)) partitionsToMakeLeaders += partition else stateChangeLogger.info((&quot;Broker %d skipped the become-leader state change after marking its partition as leader with correlation id %d from &quot; + &quot;controller %d epoch %d for partition %s since it is already the leader for the partition.&quot;) .format(localBrokerId, correlationId, controllerId, epoch, partition.topicPartition)) &#125; &#125; &#125; catch &#123; case e: Throwable =&gt; partitionState.keys.foreach &#123; partition =&gt; val errorMsg = (&quot;Error on broker %d while processing LeaderAndIsr request correlationId %d received from controller %d&quot; + &quot; epoch %d for partition %s&quot;).format(localBrokerId, correlationId, controllerId, epoch, partition.topicPartition) stateChangeLogger.error(errorMsg, e) &#125; // Re-throw the exception for it to be caught in KafkaApis throw e &#125; partitionsToMakeLeaders &#125; partition.makeLeader(controllerId, partitionStateInfo, correlationId)ä¼šè¿›è¡Œå…ƒä¿¡æ¯çš„å¤„ç†ï¼Œå¹¶æ›´æ–°hwï¼Œæ­¤æ–¹æ³•ä¼šè°ƒç”¨maybeIncrementLeaderHWå‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šå°è¯•è¿½èµ¶hwï¼šå¦‚æœå…¶ä»–å‰¯æœ¬è½åleaderä¸å¤ªè¿œï¼Œå¹¶ä¸”æ¯”ä¹‹å‰çš„hwå¤§ï¼Œä¼šå»¶ç¼“hwå¢é•¿é€Ÿåº¦ï¼Œå°½å¯èƒ½è®©å…¶ä»–å‰¯æœ¬è¿›é˜Ÿã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849def makeLeader(controllerId: Int, partitionStateInfo: PartitionState, correlationId: Int): Boolean = &#123; val (leaderHWIncremented, isNewLeader) = inWriteLock(leaderIsrUpdateLock) &#123; val allReplicas = partitionStateInfo.replicas.asScala.map(_.toInt) // record the epoch of the controller that made the leadership decision. This is useful while updating the isr // to maintain the decision maker controller&#x27;s epoch in the zookeeper path controllerEpoch = partitionStateInfo.controllerEpoch // add replicas that are new // æ„é€ æ–°ISR allReplicas.foreach(replica =&gt; getOrCreateReplica(replica)) val newInSyncReplicas = partitionStateInfo.isr.asScala.map(r =&gt; getOrCreateReplica(r)).toSet // remove assigned replicas that have been removed by the controller // ç§»é™¤æ‰€æœ‰ä¸åœ¨æ–°ISRä¸­çš„å‰¯æœ¬ (assignedReplicas.map(_.brokerId) -- allReplicas).foreach(removeReplica) inSyncReplicas = newInSyncReplicas leaderEpoch = partitionStateInfo.leaderEpoch zkVersion = partitionStateInfo.zkVersion //æ˜¯å¦ç¬¬ä¸€æ¬¡æˆä¸ºè¯¥partitionçš„leader val isNewLeader = if (leaderReplicaIdOpt.isDefined &amp;&amp; leaderReplicaIdOpt.get == localBrokerId) &#123; false &#125; else &#123; leaderReplicaIdOpt = Some(localBrokerId) true &#125; val leaderReplica = getReplica().get val curLeaderLogEndOffset = leaderReplica.logEndOffset.messageOffset val curTimeMs = time.milliseconds // initialize lastCaughtUpTime of replicas as well as their lastFetchTimeMs and lastFetchLeaderLogEndOffset. //æ–°leaderåˆå§‹åŒ– (assignedReplicas - leaderReplica).foreach &#123; replica =&gt; val lastCaughtUpTimeMs = if (inSyncReplicas.contains(replica)) curTimeMs else 0L replica.resetLastCaughtUpTime(curLeaderLogEndOffset, curTimeMs, lastCaughtUpTimeMs) &#125; // we may need to increment high watermark since ISR could be down to 1 if (isNewLeader) &#123; // construct the high watermark metadata for the new leader replica leaderReplica.convertHWToLocalOffsetMetadata() // reset log end offset for remote replicas assignedReplicas.filter(_.brokerId != localBrokerId).foreach(_.updateLogReadResult(LogReadResult.UnknownLogReadResult)) &#125; // å°è¯•è¿½èµ¶hw,å¦‚æœå…¶ä»–å‰¯æœ¬è½åleaderä¸å¤ªè¿œï¼Œå¹¶ä¸”æ¯”ä¹‹å‰çš„hwå¤§ï¼Œä¼šå»¶ç¼“hwå¢é•¿é€Ÿåº¦ï¼Œå°½å¯èƒ½è®©å…¶ä»–å‰¯æœ¬è¿›é˜Ÿ (maybeIncrementLeaderHW(leaderReplica), isNewLeader) &#125; // some delayed operations may be unblocked after HW changed // hwæ›´æ–°åä¼šå¤„ç†ä¸€äº›request if (leaderHWIncremented) tryCompleteDelayedRequests() isNewLeader &#125; makeFollowers å¤„ç†æ–°å¢çš„follower partition ä»leaderpartitioné›†åˆä¸­ç§»é™¤è¿™äº›partition æ ‡è®°ä¸ºfollowerï¼Œé˜»æ­¢producerè¯·æ±‚ ç§»é™¤Fetcherçº¿ç¨‹ æ ¹æ®hw truncateè¿™äº›partitionçš„æœ¬åœ°æ—¥å¿— æ¸…ç†producerå’Œfetchè¯·æ±‚ å¦‚æœæ²¡æœ‰å®•æœºï¼Œä»æ–°çš„leader fetchæ•°æ® 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586private def makeFollowers(controllerId: Int, epoch: Int, partitionState: Map[Partition, PartitionState], correlationId: Int, responseMap: mutable.Map[TopicPartition, Short], metadataCache: MetadataCache) : Set[Partition] = &#123; partitionState.keys.foreach &#123; partition =&gt; stateChangeLogger.trace((&quot;Broker %d handling LeaderAndIsr request correlationId %d from controller %d epoch %d &quot; + &quot;starting the become-follower transition for partition %s&quot;) .format(localBrokerId, correlationId, controllerId, epoch, partition.topicPartition)) &#125; // æ„é€ becomeLeaderOrFolloweréœ€è¦çš„è¿”å›ç»“æœ for (partition &lt;- partitionState.keys) responseMap.put(partition.topicPartition, Errors.NONE.code) val partitionsToMakeFollower: mutable.Set[Partition] = mutable.Set() try &#123; // TODO: Delete leaders from LeaderAndIsrRequest partitionState.foreach&#123; case (partition, partitionStateInfo) =&gt; val newLeaderBrokerId = partitionStateInfo.leader metadataCache.getAliveBrokers.find(_.id == newLeaderBrokerId) match &#123; // Only change partition state when the leader is available case Some(_) =&gt; // æ„é€ è¿”å›ç»“æœ if (partition.makeFollower(controllerId, partitionStateInfo, correlationId)) partitionsToMakeFollower += partition else stateChangeLogger.info((&quot;Broker %d skipped the become-follower state change after marking its partition as follower with correlation id %d from &quot; + &quot;controller %d epoch %d for partition %s since the new leader %d is the same as the old leader&quot;) .format(localBrokerId, correlationId, controllerId, partitionStateInfo.controllerEpoch, partition.topicPartition, newLeaderBrokerId)) case None =&gt; // The leader broker should always be present in the metadata cache. // If not, we should record the error message and abort the transition process for this partition stateChangeLogger.error((&quot;Broker %d received LeaderAndIsrRequest with correlation id %d from controller&quot; + &quot; %d epoch %d for partition %s but cannot become follower since the new leader %d is unavailable.&quot;) .format(localBrokerId, correlationId, controllerId, partitionStateInfo.controllerEpoch, partition.topicPartition, newLeaderBrokerId)) // Create the local replica even if the leader is unavailable. This is required to ensure that we include // the partition&#x27;s high watermark in the checkpoint file (see KAFKA-1647) partition.getOrCreateReplica() &#125; &#125;//ç§»é™¤Fetcherçº¿ç¨‹ replicaFetcherManager.removeFetcherForPartitions(partitionsToMakeFollower.map(_.topicPartition)) //æ ¹æ®æ–°hwè¿›è¡Œtruncate logManager.truncateTo(partitionsToMakeFollower.map &#123; partition =&gt; (partition.topicPartition, partition.getOrCreateReplica().highWatermark.messageOffset) &#125;.toMap) //hwæ›´æ–°ï¼Œå°è¯•å¤„ç†è¯·æ±‚ partitionsToMakeFollower.foreach &#123; partition =&gt; val topicPartitionOperationKey = new TopicPartitionOperationKey(partition.topicPartition) tryCompleteDelayedProduce(topicPartitionOperationKey) tryCompleteDelayedFetch(topicPartitionOperationKey) &#125; if (isShuttingDown.get()) &#123; partitionsToMakeFollower.foreach &#123; partition =&gt; stateChangeLogger.trace((&quot;Broker %d skipped the adding-fetcher step of the become-follower state change with correlation id %d from &quot; + &quot;controller %d epoch %d for partition %s since it is shutting down&quot;).format(localBrokerId, correlationId, controllerId, epoch, partition.topicPartition)) &#125; &#125; else &#123; // we do not need to check if the leader exists again since this has been done at the beginning of this process // é‡ç½®fetchä½ç½®ï¼ŒåŠ å…¥Fetcher val partitionsToMakeFollowerWithLeaderAndOffset = partitionsToMakeFollower.map(partition =&gt; partition.topicPartition -&gt; BrokerAndInitialOffset( metadataCache.getAliveBrokers.find(_.id == partition.leaderReplicaIdOpt.get).get.getBrokerEndPoint(config.interBrokerListenerName), partition.getReplica().get.logEndOffset.messageOffset)).toMap replicaFetcherManager.addFetcherForPartitions(partitionsToMakeFollowerWithLeaderAndOffset) &#125; &#125; catch &#123; case e: Throwable =&gt; val errorMsg = (&quot;Error on broker %d while processing LeaderAndIsr request with correlationId %d received from controller %d &quot; + &quot;epoch %d&quot;).format(localBrokerId, correlationId, controllerId, epoch) stateChangeLogger.error(errorMsg, e) // Re-throw the exception for it to be caught in KafkaApis throw e &#125; partitionsToMakeFollower&#125;","raw":null,"content":null,"categories":[{"name":"æºç ","slug":"æºç ","permalink":"http://fxbing.github.io/categories/%E6%BA%90%E7%A0%81/"}],"tags":[{"name":"kafka","slug":"kafka","permalink":"http://fxbing.github.io/tags/kafka/"}]},{"title":"è®°ä¸€æ¬¡kafkaå®•æœºé—®é¢˜æ’æŸ¥","slug":"è®°ä¸€æ¬¡kafkaå®•æœºé—®é¢˜æ’æŸ¥","date":"2021-05-08T10:22:32.000Z","updated":"2021-05-08T11:51:09.075Z","comments":true,"path":"2021/05/08/è®°ä¸€æ¬¡kafkaå®•æœºé—®é¢˜æ’æŸ¥/","link":"","permalink":"http://fxbing.github.io/2021/05/08/%E8%AE%B0%E4%B8%80%E6%AC%A1kafka%E5%AE%95%E6%9C%BA%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/","excerpt":"kafkaé›†ç¾¤å‡ºç°å®•æœºæŠ¥è­¦ï¼Œè‡ªåŠ¨æ›¿æ¢æ–°brokerä¸€ç›´æ— æ³•æˆåŠŸã€‚","text":"kafkaé›†ç¾¤å‡ºç°å®•æœºæŠ¥è­¦ï¼Œè‡ªåŠ¨æ›¿æ¢æ–°brokerä¸€ç›´æ— æ³•æˆåŠŸã€‚ æ’æŸ¥è¿‡ç¨‹ kafkaé›†ç¾¤æœ‰ä¸€ä¸ªbrokerå®•æœºï¼Œè‡ªåŠ¨æ›¿æ¢æœºå™¨ä¸€ç›´æ— æ³•æˆåŠŸï¼Œæ‰‹åŠ¨é‡å¯æ—¶å‘ç°è¯¥brokerå¯¹åº”çš„zookeeperä¸Šçš„/brokers/idsç›®å½•ä¸€ç›´è¢«åˆ é™¤å¯¼è‡´ã€‚ å®šä½zkç›®å½•ä¸€ç›´è¢«åˆ é™¤çš„åŸå› ï¼šå‚ç…§Zookeeperæ—¥å¿—æ–‡ä»¶&amp;äº‹åŠ¡æ—¥å¿—&amp;æ•°æ®å¿«ç…§æŸ¥çœ‹zkäº‹åŠ¡æ—¥å¿— é¦–å…ˆæŸ¥çœ‹zkäº‹åŠ¡æ—¥å¿—æ‰€åœ¨çš„ç›®å½•: 123$ cd zookeeper/conf$ grep dataLogDir *zoo.cfg:dataLogDir=/home/var/lib/zookeeper/ é€šè¿‡java -classpath .:lib/slf4j-api-1.6.1.jar:zookeeper-3.4.6.jar org.apache.zookeeper.server.LogFormatter /home/var/lib/zookeeper/version-2/log.10263212a| grep brokers/idsæŸ¥çœ‹äº‹åŠ¡æ—¥å¿—ï¼Œå‘ç°/brokers/ids/9984ç¡®å®åœ¨åˆšåˆšåˆ›å»ºæ—¶å°±è¢«ç«‹åˆ»åˆ é™¤äº†ï¼Œå¹¶ä¸”å¯ä»¥æ‰¾åˆ°zkçš„session id ä»»ä¸€æ‰¾åˆ°ä¸€ä¸ªåˆ é™¤è¯¥zkèŠ‚ç‚¹çš„session idï¼ŒæŸ¥æ‰¾zkæ—¥å¿—ï¼Œç¡®å®šåˆ é™¤æ“ä½œçš„å®¢æˆ·ç«¯ æ’æŸ¥è¿‡ç¨‹ä¸­å‘ç°ï¼Œå¥½å¤šsession idåœ¨zkæ—¥å¿—ä¸­æ‰¾ä¸åˆ°ï¼Œåé¢ç»åŒå­¦æç¤ºæ‰å‘ç°åŸå› æ˜¯zkæœ‰5ä¸ªèŠ‚ç‚¹ï¼Œäº‹åŠ¡æ—¥å¿—åœ¨æ‰€æœ‰èŠ‚ç‚¹æ—¶ç›¸åŒçš„ï¼Œä½†æ˜¯æ™®é€šæ—¥å¿—åªåŒ…å«è¿æ¥æœ¬èŠ‚ç‚¹çš„session idï¼Œæ‰€ä»¥éœ€è¦åœ¨æ‰€æœ‰zkèŠ‚ç‚¹çš„æ™®é€šæ—¥å¿—ä¸­è¿›è¡ŒæŸ¥æ‰¾ã€‚ session closedæ—¶æ‰ä¼šæ‰“å°å®¢æˆ·ç«¯ip é—®é¢˜ç¡®å®šï¼šåŸæ¥æ˜¯åˆ é™¤æ“ä½œçš„brokerä¸æ–°å¯åŠ¨çš„broker idç›¸åŒï¼Œéƒ½ä¸º9884ï¼Œä½†æ˜¯ç”±äºæ‰§è¡Œåˆ é™¤æ“ä½œçš„æœºå™¨æœ‰é—®é¢˜ï¼Œä¸€ç›´åœ¨é‡å¯ï¼Œæ¯æ¬¡å¯åŠ¨æ—¶å‰éƒ½ä¼šå…ˆåˆ é™¤/brokers/ids/9984è¿™ä¸ªzkèŠ‚ç‚¹ ç»éªŒæ€»ç»“ zkäº‹åŠ¡æ—¥å¿—çš„æŸ¥çœ‹æ–¹å¼ï¼šZookeeperæ—¥å¿—æ–‡ä»¶&amp;äº‹åŠ¡æ—¥å¿—&amp;æ•°æ®å¿«ç…§ zkæ‰€æœ‰èŠ‚ç‚¹çš„äº‹åŠ¡æ—¥å¿—æ˜¯ç›¸åŒçš„ï¼Œä½†æ˜¯æ™®é€šæ—¥å¿—ä¸­åªæœ‰ä¸å½“å‰èŠ‚ç‚¹è¿æ¥çš„sessionä¿¡æ¯","raw":null,"content":null,"categories":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://fxbing.github.io/categories/%E6%8A%80%E6%9C%AF/"}],"tags":[{"name":"kafka","slug":"kafka","permalink":"http://fxbing.github.io/tags/kafka/"},{"name":"zookeeper","slug":"zookeeper","permalink":"http://fxbing.github.io/tags/zookeeper/"},{"name":"é—®é¢˜æ’æŸ¥","slug":"é—®é¢˜æ’æŸ¥","permalink":"http://fxbing.github.io/tags/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/"}]},{"title":"è®°ä¸€æ¬¡çº¿ä¸ŠæœåŠ¡Full GCé—®é¢˜æ’æŸ¥","slug":"è®°ä¸€æ¬¡çº¿ä¸ŠæœåŠ¡å†…å­˜æ³„æ¼é—®é¢˜æ’æŸ¥","date":"2021-05-05T16:00:00.000Z","updated":"2021-05-09T08:12:09.092Z","comments":true,"path":"2021/05/06/è®°ä¸€æ¬¡çº¿ä¸ŠæœåŠ¡å†…å­˜æ³„æ¼é—®é¢˜æ’æŸ¥/","link":"","permalink":"http://fxbing.github.io/2021/05/06/%E8%AE%B0%E4%B8%80%E6%AC%A1%E7%BA%BF%E4%B8%8A%E6%9C%8D%E5%8A%A1%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/","excerpt":"æœ‰ä¸€ä¸ªçº¿ä¸ŠæœåŠ¡å¤šä¸ªé›†ç¾¤å‡ºç°FGCï¼Œé™ä½é›†ç¾¤å‹åŠ›ä¹‹åå¹¶æ²¡æœ‰æ”¹å–„ã€‚","text":"æœ‰ä¸€ä¸ªçº¿ä¸ŠæœåŠ¡å¤šä¸ªé›†ç¾¤å‡ºç°FGCï¼Œé™ä½é›†ç¾¤å‹åŠ›ä¹‹åå¹¶æ²¡æœ‰æ”¹å–„ã€‚ èƒŒæ™¯ è¿™æ˜¯ä¸€ä¸ªkafka mirroræœåŠ¡ï¼Œç”¨æ¥åœ¨å¤šä¸ªkafkaé›†ç¾¤ä¹‹é—´è¿›è¡Œæ•°æ®åŒæ­¥ã€‚ mirroræœåŠ¡æ˜¯æ— çŠ¶æ€çš„ï¼Œå› æ­¤ä¸€èˆ¬æƒ…å†µä¸‹FGCä¸ä¼šå¯¹ç³»ç»Ÿäº§ç”Ÿä¸¥é‡å½±å“ï¼Œä½†æ˜¯ä»ç„¶å­˜åœ¨è¾ƒå¤§é£é™©ã€‚ æ’æŸ¥è¿‡ç¨‹ ä¸€. ç¼©å°èŒƒå›´ â€‹ FGCæ˜¯ä»äº”ä¸€é•¿å‡æœŸé—´å¼€å§‹å‘ç”Ÿçš„ï¼Œå¹¶ä¸”åœ¨FGCå‘ç”Ÿä¹‹å‰ï¼Œåœ¨ä¸¤ä¸ªFGCé›†ç¾¤ä¸­å¢åŠ è¿‡ä»»åŠ¡ï¼Œå› æ­¤æ¨æµ‹å¯èƒ½ä¸é›†ç¾¤å‹åŠ›è¾ƒå¤§æœ‰å…³ç³»ï¼Œä¸ºäº†ç¡®å®šè¿™ä¸€æ¨æµ‹ï¼Œåœ¨äº”ä¸€é•¿å‡ç»“æŸä¹‹åï¼Œå°†æ–°å¢åŠ çš„ä»»åŠ¡å…¨éƒ¨è¿ç§»è‡³åŒä¸€ä¸ªmirroré›†ç¾¤Aï¼Œä½¿å¦ä¸€ä¸ªmirroré›†ç¾¤BçŠ¶æ€ä¸å‡ºç°FGCä¹‹å‰å®Œå…¨ç›¸åŒï¼Œä½†æ˜¯ï¼Œäº‹ä¸æ„¿è¿ï¼Œé›†ç¾¤Bçš„FGCæ²¡æœ‰æ¢å¤ï¼Œä»ç„¶å­˜åœ¨é—®é¢˜ã€‚ â€‹ å› æ­¤ï¼ŒåŸºæœ¬å¯ä»¥ç¡®è®¤æœ¬æ¬¡FGCä¸äº”ä¸€é•¿å‡æœŸé—´é›†ç¾¤å‹åŠ›å¢åŠ æ²¡æœ‰å…³ç³»ï¼Œéœ€è¦å…·ä½“åˆ†æFGCçš„åŸå› ï¼Œç¡®è®¤æ˜¯å¦å­˜åœ¨å†…å­˜æ³„æ¼çš„æƒ…å†µã€‚ äºŒ. å…·ä½“åˆ†æ é¦–å…ˆé€šè¿‡jmapæŸ¥çœ‹å†…å­˜çš„å ç”¨æƒ…å†µï¼š 1$ jmap -histo $&#123;PID&#125; å¯ä»¥å‘ç°ï¼Œcom.mysql.cj.jdbc.ByteArrayRowè¿™ä¸ªå¯¹è±¡å äº†4Gå¤šçš„å†…å­˜ï¼ˆæ€»å†…å­˜32Gï¼‰ï¼Œè™½ç„¶ä»£ç ä¸­æœ‰æŸ¥è¯¢mysqlä»£ç ï¼Œä½†æ˜¯æŸ¥è¯¢ç»“æœéƒ½å·²ç»è§£æå­˜æ”¾åœ¨äº†Mapã€Listç­‰å¯¹è±¡ä¸­ã€‚ ä¸ºäº†ç¡®è®¤è¯¥mysqlå¯¹è±¡æ˜¯ä¸æ˜¯æŸ¥è¯¢çš„ä¸´æ—¶å˜é‡ï¼Œä¼šä¸ä¼šè¢«FGCæ¸…ç†ï¼Œä¸»åŠ¨æ‰¾ä¸€å°æœºå™¨æ‰§è¡ŒFGCï¼Œ 1$ jmap -histo:live $&#123;PID&#125; å‘ç°mysqlå¯¹è±¡å ç”¨çš„å¤§å°å¹¶æœªå‡å°‘ä¸”ä»åœ¨å¢åŠ ï¼Œæ¨æµ‹è¿™ä¸ªmysqlå¯¹è±¡åº”è¯¥æ˜¯å¼•èµ·FGCçš„åŸå› ã€‚ æŸ¥çœ‹ä»£ç å‘ç°ï¼Œé™¤äº†ä¸€å¤„å®šæœŸæ‰§è¡Œçš„SQLæŸ¥è¯¢å¤–ï¼Œåœ¨ä»»åŠ¡ä¸å˜çš„æƒ…å†µä¸‹ï¼Œå…¶ä»–ä»£ç åœ¨ç³»ç»Ÿå¯åŠ¨åéƒ½ä¸ä¼šè¿›è¡ŒSQLæŸ¥è¯¢ã€‚å¹¶ä¸”ï¼Œè¿™æ¡å®šæœŸæ‰§è¡Œçš„SQLæ‰§è¡Œå‘¨æœŸåœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­å¹¶æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œä¸€ç›´æ˜¯2åˆ†é’Ÿä¸€æ¬¡ã€‚ 12345kafkaScheduler.schedule(&quot;update-Maps-Task&quot;, updateMapsTask, 20000, 120000, TimeUnit.MILLISECONDS)def updateMapsTask() &#123; mysqlUtil.updateTopicMap(&quot;SELECT * FROM table2&quot;) &#125; éªŒè¯com.mysql.cj.jdbc.ByteArrayRowå¯¹è±¡çš„å†…å­˜å ç”¨æ˜¯å¦ä¸ä¸Šè¿°Scheduleræœ‰å…³ï¼š æ‰¾ä¸€å°æœºå™¨æ¯2åˆ†é’ŸæŸ¥è¯¢ä¸€æ¬¡com.mysql.cj.jdbc.ByteArrayRowå¯¹è±¡å¤§å°ï¼Œå‘ç°æ¯ä¸¤æ¬¡æŸ¥è¯¢åˆ°çš„å¯¹è±¡å¤§å°ä¹‹é—´çš„å·®å€¼å‡ç›¸åŒï¼Œä¸º395360 æ ¹æ®æœåŠ¡å¯åŠ¨æ—¶é—´ï¼ŒæŒ‰ç…§æ¯ä¸¤åˆ†é’Ÿå¢é•¿395360Bçš„é€Ÿåº¦è¿›è¡Œè®¡ç®—ï¼Œå¾—åˆ°com.mysql.cj.jdbc.ByteArrayRowå¯¹è±¡å¤§å°ä¸º4GBï¼Œè¯¥ä¼°ç®—å€¼ä¸å½“å‰é€šè¿‡jmapçœ‹åˆ°çš„å¯¹è±¡å¤§å°ä¸€è‡´ åŸºæœ¬å¯ä»¥ç¡®è®¤æ˜¯è¿™ä¸ªå®šæ—¶æŸ¥è¯¢å¯¼è‡´çš„ã€‚ è¿›ä¸€æ­¥éªŒè¯ï¼š é‡å¯æœåŠ¡ï¼Œå‘ç°com.mysql.cj.jdbc.ByteArrayRowå¯¹è±¡ç‰¹åˆ«å°ï¼› å°†å®šæ—¶ä»»åŠ¡å‘¨æœŸä»2åˆ†é’Ÿæ”¹ä¸º3ç§’ï¼Œå‘ç°com.mysql.cj.jdbc.ByteArrayRowå¯¹è±¡3åˆ†é’Ÿå†…å¢é•¿äº†15MBï¼Œä¸”ä¸ä¼°ç®—å€¼ä¸€è‡´ã€‚ é—®é¢˜ä¿®å¤ï¼š é€šè¿‡æŸ¥çœ‹ä»£ç å’ŒGoogleå‘ç°ï¼Œéœ€è¦æ˜¾å¼å…³é—­mysqlæŸ¥è¯¢ä½¿ç”¨çš„Statementå¯¹è±¡å’ŒResultSetå¯¹è±¡ï¼Œ https://stackoverflow.com/questions/4507440/must-jdbc-resultsets-and-statements-be-closed-separately-although-the-connection/15728512 ä¿®å¤éªŒè¯ï¼š JVMå†…å­˜è®¾ç½®ä¸º50MBï¼Œå®šæ—¶ä»»åŠ¡å‘¨æœŸè®¾ç½®ä¸º3ç§’ã€‚ ä¿®å¤å‰ï¼Œmysqlå†…å­˜ä¸æ–­å¢åŠ ï¼Œå‡ºç°å‡ æ¬¡FGCï¼Œç›´åˆ°OOM ã€‚ ä¿®å¤åï¼Œæœªå‡ºç°FGCï¼Œæœ‰YGCï¼ŒYGCä¹‹åmysqlå†…å­˜è¢«å›æ”¶ ã€‚ æ€»ç»“ æ—§ç‰ˆæœ¬ä»£ç è™½ç„¶ä¹Ÿæ˜¯2åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡æŸ¥è¯¢ï¼Œä½†æ˜¯æŸ¥è¯¢æ•°æ®è¡¨ä¸åŒï¼Œæ—§ç‰ˆæœ¬æ•°æ®è¡¨ä¸­åªæœ‰2æ¡æ•°æ®ï¼Œæ–°ç‰ˆæœ¬æ•°æ®è¡¨ä¸­æœ‰7000+æ•°æ®ï¼Œå†…å­˜ç§¯ç´¯å¾ˆæ…¢ï¼Œæ‰€ä»¥æ—§ç‰ˆæœ¬ä¸€è‡´æ²¡æœ‰å‘ç°é—®é¢˜ã€‚ æŸ¥è¯¢mysqlæ—¶éœ€è¦åŠæ—¶å…³é—­Statementå¯¹è±¡å’ŒResultSetå¯¹è±¡ï¼Œå¦åˆ™ä¼šå› ä¸ºå¯¹è±¡ä¸€ç›´è¢«å¼•ç”¨è€Œæ— æ³•è‡ªåŠ¨è¿›è¡Œåƒåœ¾å›æ”¶ã€‚ åˆ†æFGCé—®é¢˜æ—¶éœ€è¦ä¸»åŠ¨ä½¿ç”¨jmapç­‰å·¥å…·ï¼Œå°½æ—©å‘ç°é—®é¢˜ã€‚","raw":null,"content":null,"categories":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://fxbing.github.io/categories/%E6%8A%80%E6%9C%AF/"}],"tags":[{"name":"é—®é¢˜æ’æŸ¥","slug":"é—®é¢˜æ’æŸ¥","permalink":"http://fxbing.github.io/tags/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/"},{"name":"JVM","slug":"JVM","permalink":"http://fxbing.github.io/tags/JVM/"}]},{"title":"CompletableFuture æ€»ç»“","slug":"2019-08-18-CompletableFuture","date":"2019-08-17T16:00:00.000Z","updated":"2019-08-17T16:00:00.000Z","comments":true,"path":"2019/08/18/2019-08-18-CompletableFuture/","link":"","permalink":"http://fxbing.github.io/2019/08/18/2019-08-18-CompletableFuture/","excerpt":"CompletableFuture æ˜¯Java8 ä¸­æ–°å¢çš„ç”¨æ¥è¿›è¡Œå‡½æ•°å¼å¼‚æ­¥ç¼–ç¨‹çš„å·¥å…·ç±»ã€‚\næœ€è¿‘å­¦ä¹ æºç çš„è¿‡ç¨‹ä¸­çœ‹åˆ°æœ‰å¾ˆå¤š CompletableFuture çš„ä½¿ç”¨ï¼Œæ„Ÿè§‰è‡ªå·±å¯¹è¿™ä¸ªç±»ä¸­çš„å„ä¸ªæ–¹æ³•çš„ä½¿ç”¨åœºæ™¯å’Œæ–¹æ³•ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œé‚å‚è€ƒäº†ä¸‹é¢å‡ ç¯‡åšå®¢è¿›è¡Œå­¦ä¹ ï¼ˆæœ¬æ–‡å¤§éƒ¨åˆ†å†…å®¹ä¹Ÿéƒ½æ¥è‡ªä¸‹é¢å‡ ç¯‡åšå®¢ï¼‰ï¼š\nJava CompletableFuture è¯¦è§£\nJava8æ–°çš„å¼‚æ­¥ç¼–ç¨‹æ–¹å¼ CompletableFuture(ä¸€)\nJava8æ–°çš„å¼‚æ­¥ç¼–ç¨‹æ–¹å¼ CompletableFuture(äºŒ)\nJava8æ–°çš„å¼‚æ­¥ç¼–ç¨‹æ–¹å¼ CompletableFuture(ä¸‰)\nä¸Šé¢çš„åšå®¢ä»‹ç»çš„æ¯”è¾ƒè¯¦ç»†ï¼Œä¸ºäº†è‡ªå·±æŸ¥é˜…å›çœ‹çš„æ–¹ä¾¿ï¼Œè¿™é‡Œå¯¹è¿™äº›æ–¹æ³•è¿›è¡Œä¸€ä¸‹æ€»ç»“ï¼ˆè¿™é‡Œåªæ€»ç»“ä¸ä¸¾ä¾‹ï¼Œå…·ä½“ä½¿ç”¨éœ€è¦çœ‹ä¸Šé¢çš„åšå®¢ï¼‰ã€‚","text":"CompletableFuture æ˜¯Java8 ä¸­æ–°å¢çš„ç”¨æ¥è¿›è¡Œå‡½æ•°å¼å¼‚æ­¥ç¼–ç¨‹çš„å·¥å…·ç±»ã€‚ æœ€è¿‘å­¦ä¹ æºç çš„è¿‡ç¨‹ä¸­çœ‹åˆ°æœ‰å¾ˆå¤š CompletableFuture çš„ä½¿ç”¨ï¼Œæ„Ÿè§‰è‡ªå·±å¯¹è¿™ä¸ªç±»ä¸­çš„å„ä¸ªæ–¹æ³•çš„ä½¿ç”¨åœºæ™¯å’Œæ–¹æ³•ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œé‚å‚è€ƒäº†ä¸‹é¢å‡ ç¯‡åšå®¢è¿›è¡Œå­¦ä¹ ï¼ˆæœ¬æ–‡å¤§éƒ¨åˆ†å†…å®¹ä¹Ÿéƒ½æ¥è‡ªä¸‹é¢å‡ ç¯‡åšå®¢ï¼‰ï¼š Java CompletableFuture è¯¦è§£ Java8æ–°çš„å¼‚æ­¥ç¼–ç¨‹æ–¹å¼ CompletableFuture(ä¸€) Java8æ–°çš„å¼‚æ­¥ç¼–ç¨‹æ–¹å¼ CompletableFuture(äºŒ) Java8æ–°çš„å¼‚æ­¥ç¼–ç¨‹æ–¹å¼ CompletableFuture(ä¸‰) ä¸Šé¢çš„åšå®¢ä»‹ç»çš„æ¯”è¾ƒè¯¦ç»†ï¼Œä¸ºäº†è‡ªå·±æŸ¥é˜…å›çœ‹çš„æ–¹ä¾¿ï¼Œè¿™é‡Œå¯¹è¿™äº›æ–¹æ³•è¿›è¡Œä¸€ä¸‹æ€»ç»“ï¼ˆè¿™é‡Œåªæ€»ç»“ä¸ä¸¾ä¾‹ï¼Œå…·ä½“ä½¿ç”¨éœ€è¦çœ‹ä¸Šé¢çš„åšå®¢ï¼‰ã€‚ Futureæ¥å£ Feture æ¥å£åŒ…å«äº”ä¸ªæ–¹æ³•ï¼Œä»‹ç»å¦‚ä¸‹ï¼š boolean cancel (boolean mayInterruptIfRunning) å–æ¶ˆä»»åŠ¡çš„æ‰§è¡Œã€‚å‚æ•°æŒ‡å®šæ˜¯å¦ç«‹å³ä¸­æ–­ä»»åŠ¡æ‰§è¡Œï¼Œæˆ–è€…ç­‰ç­‰ä»»åŠ¡ç»“æŸ boolean isCancelled () ä»»åŠ¡æ˜¯å¦å·²ç»å–æ¶ˆï¼Œä»»åŠ¡æ­£å¸¸å®Œæˆå‰å°†å…¶å–æ¶ˆï¼Œåˆ™è¿”å› true boolean isDone () ä»»åŠ¡æ˜¯å¦å·²ç»å®Œæˆã€‚éœ€è¦æ³¨æ„çš„æ˜¯å¦‚æœä»»åŠ¡æ­£å¸¸ç»ˆæ­¢ã€å¼‚å¸¸æˆ–å–æ¶ˆï¼Œéƒ½å°†è¿”å›true V get () throws InterruptedException, ExecutionException ç­‰å¾…ä»»åŠ¡æ‰§è¡Œç»“æŸï¼Œç„¶åè·å¾—Vç±»å‹çš„ç»“æœã€‚InterruptedException çº¿ç¨‹è¢«ä¸­æ–­å¼‚å¸¸ï¼Œ ExecutionExceptionä»»åŠ¡æ‰§è¡Œå¼‚å¸¸ï¼Œå¦‚æœä»»åŠ¡è¢«å–æ¶ˆï¼Œè¿˜ä¼šæŠ›å‡ºCancellationException V get (long timeout, TimeUnit unit) throws InterruptedException, ExecutionException, TimeoutException åŒä¸Šé¢çš„getåŠŸèƒ½ä¸€æ ·ï¼Œå¤šäº†è®¾ç½®è¶…æ—¶æ—¶é—´ã€‚å‚æ•°timeoutæŒ‡å®šè¶…æ—¶æ—¶é—´ï¼ŒuintæŒ‡å®šæ—¶é—´çš„å•ä½ï¼Œåœ¨æšä¸¾ç±»TimeUnitä¸­æœ‰ç›¸å…³çš„å®šä¹‰ã€‚å¦‚æœè®¡ ç®—è¶…æ—¶ï¼Œå°†æŠ›å‡ºTimeoutException ä¸»åŠ¨å®Œæˆè®¡ç®— CompletableFutureå®ç°äº†CompletionStageå’ŒFutureä¸¤ä¸ªæ¥å£ã€‚ é€šè¿‡é˜»å¡æˆ–è€…è½®è¯¢è·å¾—ç»“æœ æ–¹æ³•å æè¿° public T get() Futureæ¥å£å®ç° public T get(long timeout, TimeUnit unit) Futureæ¥å£å®ç° public T getNow(T valueIfAbsent) å¦‚æœç»“æœå·²ç»è®¡ç®—å®Œåˆ™è¿”å›ç»“æœæˆ–è€…æŠ›å‡ºå¼‚å¸¸ï¼Œå¦åˆ™è¿”å›ç»™å®šçš„valueIfAbsentå€¼ã€‚ public T join() è¿”å›è®¡ç®—çš„ç»“æœæˆ–è€…æŠ›å‡ºä¸€ä¸ªuncheckedå¼‚å¸¸(CompletionException) join()å’Œget()çš„åŒºåˆ«æ˜¯ï¼Œjoin()åªä¼šæŠ›å‡ºæœªæ£€æŸ¥å¼‚å¸¸ï¼ˆä¸éœ€è¦ä½¿ç”¨try...catch..è¿›è¡Œå¤„ç†ï¼‰ï¼Œè€Œget()ä¼šæŠ›å‡ºæ£€æŸ¥å¼‚å¸¸ã€‚ å¼‚æ­¥è·å–ç»“æœ ä¸‹é¢ä¸¤ä¸ªå‡½æ•°çš„è°ƒç”¨ä¼šç«‹å³æ‰§è¡Œï¼Œå¹¶ä¸”åªèƒ½æ‰§è¡Œä¸€æ¬¡ã€‚ å¦‚æœè¯¥ä»»åŠ¡å·²ç»æ‰§è¡Œå®Œæˆï¼Œé‚£ä¹ˆä¸‹é¢ä¸¤ä¸ªè°ƒç”¨ä¼šæ— æ•ˆï¼Œåªèƒ½è·å–æ‰§è¡Œå®Œæˆçš„ç»“æœã€‚å…¶å®å°±æ˜¯ä½¿ä»»åŠ¡ç«‹å³ç»“æŸï¼ˆè¿”å›æŒ‡å®šç»“æœæˆ–è€…æŒ‡å®šæŠ›å‡ºå¼‚å¸¸ï¼‰ã€‚ æ¯”è¾ƒé€‚åˆéœ€è¦è¿”å›CompletableFutureçš„æ–¹æ³•ï¼Œå…ˆåˆ›å»ºä¸€ä¸ªç©ºçš„CompletableFutureï¼Œä¹‹åé€šè¿‡ä¸‹é¢ä¸¤ä¸ªå‡½æ•°æŒ‡å®šå‰é¢åˆ›å»ºçš„CompletableFutureçš„è¿”å›å€¼ã€‚ æ–¹æ³•å æè¿° complete(T t) å®Œæˆå¼‚æ­¥æ‰§è¡Œï¼Œå¹¶è¿”å›futureçš„ç»“æœ completeExceptionally(Throwable ex) å¼‚æ­¥æ‰§è¡Œä¸æ­£å¸¸çš„ç»“æŸ é™æ€å·¥å‚æ–¹æ³• run å’Œ supply çš„ä¸»è¦åŒºåˆ«æ˜¯å¼‚æ­¥æ“ä½œæ˜¯å¦æœ‰è¿”å›å€¼ï¼ˆä¸‹é¢åˆ—å‡ºçš„æ‰€æœ‰æ–¹æ³•ä¹ŸåŸºæœ¬éƒ½æ˜¯æŒ‰ç…§æ˜¯å¦æœ‰è¿”å›å€¼åˆ†ä¸ºä¸¤ç±»ï¼‰ã€‚ æ–¹æ³•å æè¿° runAsync(Runnable runnable) ä½¿ç”¨ForkJoinPool.commonPool()ä½œä¸ºå®ƒçš„çº¿ç¨‹æ± æ‰§è¡Œå¼‚æ­¥ä»£ç ã€‚ runAsync(Runnable runnable, Executor executor) ä½¿ç”¨æŒ‡å®šçš„thread poolæ‰§è¡Œå¼‚æ­¥ä»£ç ã€‚ supplyAsync(Supplier&lt;U&gt; supplier) ä½¿ç”¨ForkJoinPool.commonPool()ä½œä¸ºå®ƒçš„çº¿ç¨‹æ± æ‰§è¡Œå¼‚æ­¥ä»£ç ï¼Œå¼‚æ­¥æ“ä½œæœ‰è¿”å›å€¼ã€‚ supplyAsync(Supplier&lt;U&gt; supplier, Executor executor) ä½¿ç”¨æŒ‡å®šçš„thread poolæ‰§è¡Œå¼‚æ­¥ä»£ç ï¼Œå¼‚æ­¥æ“ä½œæœ‰è¿”å›å€¼ã€‚ ä¸‹é¢å‡ ä¹æ‰€æœ‰çš„æ–¹æ³•éƒ½æ˜¯ä¸€å¼ä¸‰ä»½ï¼Œä¸‰ç§æ–¹æ³•çš„åŒºåˆ«æ˜¯ ç›´æ¥åœ¨å½“å‰çº¿ç¨‹æ‰§è¡Œ æ¢å¦ä¸€ä¸ªçº¿ç¨‹ï¼ˆä½†æ˜¯ä¸æŒ‡å®šçº¿ç¨‹ï¼‰å¼‚æ­¥æ‰§è¡Œ æŒ‡å®šçº¿ç¨‹æ‰§è¡Œ è½¬æ¢ ç›¸å½“äº map æ“ä½œ æ–¹æ³•å æè¿° thenApply(Function&lt;? super T,? extends U&gt; fn) æ¥å—ä¸€ä¸ªFunction&lt;? super T,? extends U&gt;å‚æ•°ç”¨æ¥è½¬æ¢CompletableFuture thenApplyAsync(Function&lt;? super T,? extends U&gt; fn) æ¥å—ä¸€ä¸ªFunction&lt;? super T,? extends U&gt;å‚æ•°ç”¨æ¥è½¬æ¢CompletableFutureï¼Œä½¿ç”¨ForkJoinPool thenApplyAsync(Function&lt;? super T,? extends U&gt; fn, Executor executor) æ¥å—ä¸€ä¸ªFunction&lt;? super T,? extends U&gt;å‚æ•°ç”¨æ¥è½¬æ¢CompletableFutureï¼Œä½¿ç”¨æŒ‡å®šçš„çº¿ç¨‹æ±  ç›¸å½“äº flatMap æ“ä½œ æ–¹æ³•å æè¿° thenCompose(Function&lt;? super T, ? extends CompletionStage&lt;U&gt;&gt; fn) åœ¨å¼‚æ­¥æ“ä½œå®Œæˆçš„æ—¶å€™å¯¹å¼‚æ­¥æ“ä½œçš„ç»“æœè¿›è¡Œä¸€äº›æ“ä½œï¼Œå¹¶ä¸”ä»ç„¶è¿”å›CompletableFutureç±»å‹ã€‚ thenComposeAsync(Function&lt;? super T, ? extends CompletionStage&lt;U&gt;&gt; fn) åœ¨å¼‚æ­¥æ“ä½œå®Œæˆçš„æ—¶å€™å¯¹å¼‚æ­¥æ“ä½œçš„ç»“æœè¿›è¡Œä¸€äº›æ“ä½œï¼Œå¹¶ä¸”ä»ç„¶è¿”å›CompletableFutureç±»å‹ã€‚ä½¿ç”¨ForkJoinPoolã€‚ thenComposeAsync(Function&lt;? super T, ? extends CompletionStage&lt;U&gt;&gt; fn,Executor executor) åœ¨å¼‚æ­¥æ“ä½œå®Œæˆçš„æ—¶å€™å¯¹å¼‚æ­¥æ“ä½œçš„ç»“æœè¿›è¡Œä¸€äº›æ“ä½œï¼Œå¹¶ä¸”ä»ç„¶è¿”å›CompletableFutureç±»å‹ã€‚ä½¿ç”¨æŒ‡å®šçš„çº¿ç¨‹æ± ã€‚ ç»„åˆ æ–¹æ³•å æè¿° thenCombine(CompletionStage&lt;? extends U&gt; other, BiFunction&lt;? super T,? super U,? extends V&gt; fn) å½“ä¸¤ä¸ªCompletableFutureéƒ½æ­£å¸¸å®Œæˆåï¼Œæ‰§è¡Œæä¾›çš„fnï¼Œç”¨å®ƒæ¥ç»„åˆå¦å¤–ä¸€ä¸ªCompletableFutureçš„ç»“æœã€‚ thenCombineAsync(CompletionStage&lt;? extends U&gt; other, BiFunction&lt;? super T,? super U,? extends V&gt; fn) å½“ä¸¤ä¸ªCompletableFutureéƒ½æ­£å¸¸å®Œæˆåï¼Œæ‰§è¡Œæä¾›çš„fnï¼Œç”¨å®ƒæ¥ç»„åˆå¦å¤–ä¸€ä¸ªCompletableFutureçš„ç»“æœã€‚ä½¿ç”¨ForkJoinPoolã€‚ thenCombineAsync(CompletionStage&lt;? extends U&gt; other, BiFunction&lt;? super T,? super U,? extends V&gt; fn, Executor executor) å½“ä¸¤ä¸ªCompletableFutureéƒ½æ­£å¸¸å®Œæˆåï¼Œæ‰§è¡Œæä¾›çš„fnï¼Œç”¨å®ƒæ¥ç»„åˆå¦å¤–ä¸€ä¸ªCompletableFutureçš„ç»“æœã€‚ä½¿ç”¨æŒ‡å®šçš„çº¿ç¨‹æ± ã€‚ thenAcceptBothè·ŸthenCombineç±»ä¼¼ï¼Œä½†æ˜¯è¿”å›CompletableFutureç±»å‹ã€‚ æ–¹æ³•å æè¿° thenAcceptBoth(CompletionStage&lt;? extends U&gt; other, BiFunction&lt;? super T,? super U,? extends V&gt; action) å½“ä¸¤ä¸ªCompletableFutureéƒ½æ­£å¸¸å®Œæˆåï¼Œæ‰§è¡Œæä¾›çš„actionï¼Œç”¨å®ƒæ¥ç»„åˆå¦å¤–ä¸€ä¸ªCompletableFutureçš„ç»“æœã€‚ thenAcceptBothAsync(CompletionStage&lt;? extends U&gt; other, BiFunction&lt;? super T,? super U,? extends V&gt; action) å½“ä¸¤ä¸ªCompletableFutureéƒ½æ­£å¸¸å®Œæˆåï¼Œæ‰§è¡Œæä¾›çš„actionï¼Œç”¨å®ƒæ¥ç»„åˆå¦å¤–ä¸€ä¸ªCompletableFutureçš„ç»“æœã€‚ä½¿ç”¨ForkJoinPoolã€‚ thenAcceptBothAsync(CompletionStage&lt;? extends U&gt; other, BiFunction&lt;? super T,? super U,? extends V&gt; action, Executor executor) å½“ä¸¤ä¸ªCompletableFutureéƒ½æ­£å¸¸å®Œæˆåï¼Œæ‰§è¡Œæä¾›çš„actionï¼Œç”¨å®ƒæ¥ç»„åˆå¦å¤–ä¸€ä¸ªCompletableFutureçš„ç»“æœã€‚ä½¿ç”¨æŒ‡å®šçš„çº¿ç¨‹æ± ã€‚ è®¡ç®—ç»“æœå®Œæˆæ—¶çš„å¤„ç† Actionçš„ç±»å‹æ˜¯BiConsumer&lt;? super T,? super Throwable&gt;ï¼Œå®ƒå¯ä»¥å¤„ç†æ­£å¸¸çš„è®¡ç®—ç»“æœï¼Œæˆ–è€…å¼‚å¸¸æƒ…å†µã€‚ æ–¹æ³•ä¸ä»¥Asyncç»“å°¾ï¼Œæ„å‘³ç€Actionä½¿ç”¨ç›¸åŒçš„çº¿ç¨‹æ‰§è¡Œï¼Œè€ŒAsyncå¯èƒ½ä¼šä½¿ç”¨å…¶å®ƒçš„çº¿ç¨‹å»æ‰§è¡Œ(å¦‚æœä½¿ç”¨ç›¸åŒçš„çº¿ç¨‹æ± ï¼Œä¹Ÿå¯èƒ½ä¼šè¢«åŒä¸€ä¸ªçº¿ç¨‹é€‰ä¸­æ‰§è¡Œ æ–¹æ³•å æè¿° whenComplete(BiConsumer&lt;? super T,? super Throwable&gt; action) å½“CompletableFutureå®Œæˆè®¡ç®—ç»“æœæ—¶å¯¹ç»“æœè¿›è¡Œå¤„ç†ï¼Œæˆ–è€…å½“CompletableFutureäº§ç”Ÿå¼‚å¸¸çš„æ—¶å€™å¯¹å¼‚å¸¸è¿›è¡Œå¤„ç†ã€‚ whenCompleteAsync(BiConsumer&lt;? super T,? super Throwable&gt; action) å½“CompletableFutureå®Œæˆè®¡ç®—ç»“æœæ—¶å¯¹ç»“æœè¿›è¡Œå¤„ç†ï¼Œæˆ–è€…å½“CompletableFutureäº§ç”Ÿå¼‚å¸¸çš„æ—¶å€™å¯¹å¼‚å¸¸è¿›è¡Œå¤„ç†ã€‚ä½¿ç”¨ForkJoinPoolã€‚ whenCompleteAsync(BiConsumer&lt;? super T,? super Throwable&gt; action, Executor executor) å½“CompletableFutureå®Œæˆè®¡ç®—ç»“æœæ—¶å¯¹ç»“æœè¿›è¡Œå¤„ç†ï¼Œæˆ–è€…å½“CompletableFutureäº§ç”Ÿå¼‚å¸¸çš„æ—¶å€™å¯¹å¼‚å¸¸è¿›è¡Œå¤„ç†ã€‚ä½¿ç”¨æŒ‡å®šçš„çº¿ç¨‹æ± ã€‚ handle()ç›¸å½“äºwhenComplete()+è½¬æ¢ã€‚ handle()ä¹Ÿå¯ä»¥ç†è§£ä¸ºå’ŒthenApply()çš„å«ä¹‰æ›´ä¸ºç›¸ä¼¼ï¼Œä½†æ˜¯æ¯”thenApply()å¢åŠ å¼‚å¸¸å¤„ç†çš„åŠŸèƒ½ã€‚ æ–¹æ³•å æè¿° handle(BiFunction&lt;? super T, Throwable, ? extends U&gt; fn) å½“CompletableFutureå®Œæˆè®¡ç®—ç»“æœæˆ–è€…æŠ›å‡ºå¼‚å¸¸çš„æ—¶å€™ï¼Œæ‰§è¡Œæä¾›çš„fn handleAsync(BiFunction&lt;? super T, Throwable, ? extends U&gt; fn) å½“CompletableFutureå®Œæˆè®¡ç®—ç»“æœæˆ–è€…æŠ›å‡ºå¼‚å¸¸çš„æ—¶å€™ï¼Œæ‰§è¡Œæä¾›çš„fnï¼Œä½¿ç”¨ForkJoinPoolã€‚ handleAsync(BiFunction&lt;? super T, Throwable, ? extends U&gt; fn, Executor executor) å½“CompletableFutureå®Œæˆè®¡ç®—ç»“æœæˆ–è€…æŠ›å‡ºå¼‚å¸¸çš„æ—¶å€™ï¼Œæ‰§è¡Œæä¾›çš„fnï¼Œä½¿ç”¨æŒ‡å®šçš„çº¿ç¨‹æ± ã€‚ æ–¹æ³•å æè¿° exceptionally(Function fn) åªæœ‰å½“CompletableFutureæŠ›å‡ºå¼‚å¸¸çš„æ—¶å€™ï¼Œæ‰ä¼šè§¦å‘è¿™ä¸ªexceptionallyçš„è®¡ç®—ï¼Œè°ƒç”¨functionè®¡ç®—å€¼ã€‚ çº¯æ¶ˆè´¹ æ–¹æ³•å æè¿° thenAccept(Consumer&lt;? super T&gt; action) å½“CompletableFutureå®Œæˆè®¡ç®—ç»“æœï¼Œåªå¯¹ç»“æœæ‰§è¡ŒActionï¼Œè€Œä¸è¿”å›æ–°çš„è®¡ç®—å€¼ thenAcceptAsync(Consumer&lt;? super T&gt; action) å½“CompletableFutureå®Œæˆè®¡ç®—ç»“æœï¼Œåªå¯¹ç»“æœæ‰§è¡ŒActionï¼Œè€Œä¸è¿”å›æ–°çš„è®¡ç®—å€¼ï¼Œä½¿ç”¨ForkJoinPoolã€‚ thenAcceptAsync(Consumer&lt;? super T&gt; action, Executor executor) å½“CompletableFutureå®Œæˆè®¡ç®—ç»“æœï¼Œåªå¯¹ç»“æœæ‰§è¡ŒActionï¼Œè€Œä¸è¿”å›æ–°çš„è®¡ç®—å€¼ Either Either è¡¨ç¤ºçš„æ˜¯ä¸¤ä¸ªCompletableFutureï¼Œå½“å…¶ä¸­ä»»æ„ä¸€ä¸ªCompletableFutureè®¡ç®—å®Œæˆçš„æ—¶å€™å°±ä¼šæ‰§è¡Œã€‚ æ–¹æ³•å æè¿° acceptEither(CompletionStage&lt;? extends T&gt; other, Consumer&lt;? super T&gt; action) å½“ä»»æ„ä¸€ä¸ªCompletableFutureå®Œæˆçš„æ—¶å€™ï¼Œactionè¿™ä¸ªæ¶ˆè´¹è€…å°±ä¼šè¢«æ‰§è¡Œã€‚ acceptEitherAsync(CompletionStage&lt;? extends T&gt; other, Consumer&lt;? super T&gt; action) å½“ä»»æ„ä¸€ä¸ªCompletableFutureå®Œæˆçš„æ—¶å€™ï¼Œactionè¿™ä¸ªæ¶ˆè´¹è€…å°±ä¼šè¢«æ‰§è¡Œã€‚ä½¿ç”¨ForkJoinPool acceptEitherAsync(CompletionStage&lt;? extends T&gt; other, Consumer&lt;? super T&gt; action, Executor executor) å½“ä»»æ„ä¸€ä¸ªCompletableFutureå®Œæˆçš„æ—¶å€™ï¼Œactionè¿™ä¸ªæ¶ˆè´¹è€…å°±ä¼šè¢«æ‰§è¡Œã€‚ä½¿ç”¨æŒ‡å®šçš„çº¿ç¨‹æ±  applyToEither() æ˜¯acceptEither()çš„å“¥å“¥. å½“ä¸¤ä¸ªfutureå…¶ä¸­ä¸€ä¸ªå®Œæˆåï¼Œåè€…ç”¨äºåªæ˜¯ç®€å•åœ°è°ƒç”¨ä¸€äº›ä»£ç ï¼ŒapplyToEither()ä¼šè¿”å›ä¸€ä¸ªæ–°çš„future. è¿™ä¸ªfutureæ˜¯åœ¨å‰é¢ä¸¤ä¸ªfutureå…¶ä¸­ä¸€ä¸ªå®Œæˆåè¿›è¡Œæ‰§è¡Œå®Œæˆã€‚ æ–¹æ³•å æè¿° applyToEither(CompletionStage&lt;? extends T&gt; other, Function&lt;? super T,U&gt; fn) å½“ä»»æ„ä¸€ä¸ªCompletableFutureå®Œæˆçš„æ—¶å€™ï¼Œfnä¼šè¢«æ‰§è¡Œï¼Œå®ƒçš„è¿”å›å€¼ä¼šå½“ä½œæ–°çš„CompletableFutureçš„è®¡ç®—ç»“æœã€‚ applyToEitherAsync(CompletionStage&lt;? extends T&gt; other, Function&lt;? super T,U&gt; fn) å½“ä»»æ„ä¸€ä¸ªCompletableFutureå®Œæˆçš„æ—¶å€™ï¼Œfnä¼šè¢«æ‰§è¡Œï¼Œå®ƒçš„è¿”å›å€¼ä¼šå½“ä½œæ–°çš„CompletableFutureçš„è®¡ç®—ç»“æœã€‚ä½¿ç”¨ForkJoinPool applyToEitherAsync(CompletionStage&lt;? extends T&gt; other, Function&lt;? super T,U&gt; fn, Executor executor) å½“ä»»æ„ä¸€ä¸ªCompletableFutureå®Œæˆçš„æ—¶å€™ï¼Œfnä¼šè¢«æ‰§è¡Œï¼Œå®ƒçš„è¿”å›å€¼ä¼šå½“ä½œæ–°çš„CompletableFutureçš„è®¡ç®—ç»“æœã€‚ä½¿ç”¨æŒ‡å®šçš„çº¿ç¨‹æ±  å…¶ä»–æ–¹æ³• æ–¹æ³•å æè¿° allOf(CompletableFuture&lt;?&gt;... cfs) åœ¨æ‰€æœ‰Futureå¯¹è±¡å®Œæˆåç»“æŸï¼Œå¹¶è¿”å›ä¸€ä¸ªfutureã€‚ anyOf(CompletableFuture&lt;?&gt;... cfs) åœ¨ä»»ä½•ä¸€ä¸ªFutureå¯¹è±¡ç»“æŸåç»“æŸï¼Œå¹¶è¿”å›ä¸€ä¸ªfutureã€‚","raw":null,"content":null,"categories":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://fxbing.github.io/categories/%E6%8A%80%E6%9C%AF/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://fxbing.github.io/tags/Java/"}]},{"title":"Pulsar æºç é˜…è¯»ï¼š Backlog","slug":"2019-08-06-Pulsar Backlog","date":"2019-08-05T16:00:00.000Z","updated":"2019-08-09T16:00:00.000Z","comments":true,"path":"2019/08/06/2019-08-06-Pulsar Backlog/","link":"","permalink":"http://fxbing.github.io/2019/08/06/2019-08-06-Pulsar%20Backlog/","excerpt":"å¯¹äºå·²ç»æ¶ˆè´¹ä½†æ˜¯æ²¡æœ‰ç¡®è®¤çš„æ¶ˆæ¯ï¼ŒPulsar å¯ä»¥é€šè¿‡é…ç½® BacklogQuota å†³å®šä¿ç•™å¤§å°åŠä¸¢å¼ƒç­–ç•¥ã€‚\nå…·ä½“å‚è§å®˜æ–¹æ–‡æ¡£ï¼šMessage retention and expiry\nå½“ Backlog å¤§å°æœªè¾¾åˆ°é™é¢æ—¶ï¼Œä¸éœ€è¦å¤„ç†ï¼Œå½“ Backlog å¤§å°è¶…é™æ—¶ï¼Œæ ¹æ®ä¸¢å¼ƒç­–ç•¥è¿›è¡Œå¤„ç†ã€‚\nBacklogQuota çš„ä¸¢å¼ƒç­–ç•¥ä¸€å…±æœ‰ä¸‰ç§ï¼š\n\nproducer_request_holdï¼šâ‘  æ–­å¼€æ‰€æœ‰çš„ Producer â‘¡ åœ¨æ–°å»º Producer æ—¶è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœè¶…å‡º BacklogQuotaï¼Œåˆ™æ‹’ç»æ–°å»ºè¯·æ±‚å¹¶ç­‰å¾…è¶…æ—¶ï¼ˆå¼‚æ­¥è¿”å›ç»“æœè°ƒç”¨get()æ—¶æ‰æŠ›å‡ºå¼‚å¸¸ï¼‰\nproducer_exceptionï¼šâ‘  æ–­å¼€æ‰€æœ‰çš„ Producer â‘¡ åœ¨æ–°å»º Producer æ—¶è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœè¶…å‡º BacklogQuotaï¼Œåˆ™æ‹’ç»æ–°å»ºè¯·æ±‚å¹¶æŠ›å‡ºå¼‚å¸¸\nconsumer_backlog_evictionï¼šä¸¢å¼ƒæœ€æ—©çš„ Backlog\n","text":"å¯¹äºå·²ç»æ¶ˆè´¹ä½†æ˜¯æ²¡æœ‰ç¡®è®¤çš„æ¶ˆæ¯ï¼ŒPulsar å¯ä»¥é€šè¿‡é…ç½® BacklogQuota å†³å®šä¿ç•™å¤§å°åŠä¸¢å¼ƒç­–ç•¥ã€‚ å…·ä½“å‚è§å®˜æ–¹æ–‡æ¡£ï¼šMessage retention and expiry å½“ Backlog å¤§å°æœªè¾¾åˆ°é™é¢æ—¶ï¼Œä¸éœ€è¦å¤„ç†ï¼Œå½“ Backlog å¤§å°è¶…é™æ—¶ï¼Œæ ¹æ®ä¸¢å¼ƒç­–ç•¥è¿›è¡Œå¤„ç†ã€‚ BacklogQuota çš„ä¸¢å¼ƒç­–ç•¥ä¸€å…±æœ‰ä¸‰ç§ï¼š producer_request_holdï¼šâ‘  æ–­å¼€æ‰€æœ‰çš„ Producer â‘¡ åœ¨æ–°å»º Producer æ—¶è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœè¶…å‡º BacklogQuotaï¼Œåˆ™æ‹’ç»æ–°å»ºè¯·æ±‚å¹¶ç­‰å¾…è¶…æ—¶ï¼ˆå¼‚æ­¥è¿”å›ç»“æœè°ƒç”¨get()æ—¶æ‰æŠ›å‡ºå¼‚å¸¸ï¼‰ producer_exceptionï¼šâ‘  æ–­å¼€æ‰€æœ‰çš„ Producer â‘¡ åœ¨æ–°å»º Producer æ—¶è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœè¶…å‡º BacklogQuotaï¼Œåˆ™æ‹’ç»æ–°å»ºè¯·æ±‚å¹¶æŠ›å‡ºå¼‚å¸¸ consumer_backlog_evictionï¼šä¸¢å¼ƒæœ€æ—©çš„ Backlog BacklogQuotaManager Pulsar ä¸­æœ‰BacklogQuotaManagerç”¨æ¥è¿›è¡Œ Backlog å¤„ç†ï¼Œæœ‰ä¸‹é¢å‡ ä¸ªå…³é”®å‡½æ•°ã€‚ handleExceededBacklogQuota è¯¥å‡½æ•°ç”¨æ¥å¤„ç† Backlog è¶…é™çš„æƒ…å†µï¼Œå¯¹äºconsumer_backlog_evictionç­–ç•¥ï¼Œè°ƒç”¨dropBacklog(persistentTopic, quota);ï¼›å¯¹äºproducer_exceptionå’Œproducer_request_holdä¸¤ç§ç­–ç•¥ï¼Œè°ƒç”¨disconnectProducers(persistentTopic); 1234567891011121314151617181920public void handleExceededBacklogQuota(PersistentTopic persistentTopic) &#123; TopicName topicName = TopicName.get(persistentTopic.getName()); String namespace = topicName.getNamespace(); String policyPath = AdminResource.path(POLICIES, namespace); BacklogQuota quota = getBacklogQuota(namespace, policyPath); log.info(&quot;Backlog quota exceeded for topic [&#123;&#125;]. Applying [&#123;&#125;] policy&quot;, persistentTopic.getName(), quota.getPolicy()); switch (quota.getPolicy()) &#123; case consumer_backlog_eviction: dropBacklog(persistentTopic, quota); break; case producer_exception: case producer_request_hold: disconnectProducers(persistentTopic); break; default: break; &#125; &#125; ä¸‹é¢ä»‹ç»dropBacklog(persistentTopic, quota);å’ŒdisconnectProducers(persistentTopic);ä¸¤ä¸ªå‡½æ•°ã€‚ dropBacklog(persistentTopic, quota) dropBacklog(persistentTopic, quota);å‡½æ•°è´Ÿè´£åœ¨ Backlog è¶…é™ä¹‹åå¯¹ Backlog ä¸­æœ€æ—©çš„æ¶ˆæ¯è¿›è¡Œä¸¢å¼ƒï¼Œè¿™é‡Œçš„ä¸¢å¼ƒå®é™…æ˜¯æŒ‡å‘åç§»åŠ¨æœªç¡®è®¤æ¶ˆæ¯çš„èµ·å§‹æ ‡è®°ï¼ˆè¯¥ Topic ä¸Šæœ€æ…¢çš„ Consumer çš„ä½ç½®ï¼‰ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142private void dropBacklog(PersistentTopic persistentTopic, BacklogQuota quota) &#123; // è®¾ç½®ä¸¢å¼ƒæ¯”ä¾‹ä¸º 0.9 ï¼Œå³ä¸¢å¼ƒä»»åŠ¡å®Œæˆä¹‹å Backlog å¤§å°å˜ä¸º Backlog é™é¢çš„ 90% double reductionFactor = 0.9; double targetSize = reductionFactor * quota.getLimit(); // è·å– Backlog å¤§å°çš„ä¼°è®¡å€¼ï¼Œè¿™é‡Œä¸ç›´æ¥ä½¿ç”¨ Ledger çš„å®é™…å¤§å°æ˜¯å› ä¸º Ledger ä¸ä¸€å®šä¼šè¢«åŠæ—¶æ¸…ç†ï¼Œå®é™…å¤§å°ä¼šå¤§äº Backlog çš„å¤§å° ManagedLedgerImpl mLedger = (ManagedLedgerImpl) persistentTopic.getManagedLedger(); long backlogSize = mLedger.getEstimatedBacklogSize(); //è¿™ä¸ªå‡½æ•°åé¢ä»‹ç» ManagedCursor previousSlowestConsumer = null; while (backlogSize &gt; targetSize) &#123; // æœ€æ…¢çš„ Consumer ManagedCursor slowestConsumer = mLedger.getSlowestConsumer(); if (slowestConsumer == null) &#123; break; &#125; // éœ€è¦è·³è¿‡çš„æ¯”ä¾‹ double messageSkipFactor = ((backlogSize - targetSize) / backlogSize); // Cursor æ²¡æœ‰ç§»åŠ¨ï¼Œä¸éœ€è¦æ‰§è¡Œæ¸…ç† if (slowestConsumer == previousSlowestConsumer) &#123; break; &#125; // è®¡ç®—éœ€è¦ç§»åŠ¨çš„è·ç¦» long entriesInBacklog = slowestConsumer.getNumberOfEntriesInBacklog(); int messagesToSkip = (int) (messageSkipFactor * entriesInBacklog); try &#123; if (messagesToSkip == 0) &#123; break; &#125; // ç§»åŠ¨ slowestConsumer ä½ç½® slowestConsumer.skipEntries(messagesToSkip, IndividualDeletedEntries.Include); &#125; catch (Exception e) &#123; log.error(&quot;Error skipping [&#123;&#125;] messages from slowest consumer : [&#123;&#125;]&quot;, messagesToSkip, slowestConsumer.getName()); &#125; // ç§»åŠ¨å®Œæˆä¹‹åæ›´æ–° backlogSizeï¼Œå†æ¬¡æ‰§è¡Œä¸Šé¢çš„æµç¨‹ï¼Œç¡®ä¿ç§»åŠ¨ä¹‹å Backlog æ²¡æœ‰å†æ¬¡è¶…é™ backlogSize = mLedger.getEstimatedBacklogSize(); previousSlowestConsumer = slowestConsumer; &#125; &#125; è¿™é‡Œç”¨åˆ°äº†ä¸€ä¸ªManagedLedgerImplç±»ä¸­çš„ä¸€ä¸ªå‡½æ•°getEstimatedBacklogSize()ï¼Œç”¨æ¥ä¼°è®¡ Backlogçš„å¤§å°ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344public long getEstimatedBacklogSize() &#123; // æœªç¡®è®¤æ¶ˆæ¯çš„èµ·å§‹æ ‡è®° PositionImpl pos = getMarkDeletePositionOfSlowestConsumer(); while (true) &#123; if (pos == null) &#123; return 0; &#125; long size = 0; // Backlog å¤§å° final long slowestConsumerLedgerId = pos.getLedgerId(); synchronized (this) &#123; // è·å–æ‰€æœ‰ Ledger æ€»å¤§å° size = getTotalSize(); // å‡å»æ²¡æœ‰åŠæ—¶æ¸…ç†çš„ Ledger çš„å¤§å° size -= ledgers.values().stream().filter(li -&gt; li.getLedgerId() &lt; slowestConsumerLedgerId) .mapToLong(li -&gt; li.getSize()).sum(); &#125; LedgerInfo ledgerInfo = null; synchronized (this) &#123; ledgerInfo = ledgers.get(pos.getLedgerId()); &#125; if (ledgerInfo == null) &#123; // å¦‚æœ pos æŒ‡å‘çš„ Ledger å·²ç»è¢«åˆ é™¤ï¼Œä½†æ˜¯åˆ é™¤æ ‡è®°è¿˜æ²¡æœ‰æ›´æ–°ï¼ˆæ¯æ¬¡å¯åŠ¨æ–°çš„ manageLedger æ—¶æ‰ä¼šæ›´æ–°ï¼‰ï¼Œå°±ç›´æ¥è¿”å›ç»“æœ if (pos.compareTo(getMarkDeletePositionOfSlowestConsumer()) == 0) &#123; return size; &#125; // å¦‚æœåˆ é™¤æ ‡è®°å·²ç»æ›´æ–°ï¼Œè¯´æ˜å½“å‰ pos æŒ‡å‘çš„ Ledger å·²ç»è¢«å®Œå…¨æ¸…ç†ï¼Œåˆ™éœ€è¦æ›´æ–° pos è¿›è¡Œé‡è¯• pos = getMarkDeletePositionOfSlowestConsumer(); continue; &#125; long numEntries = pos.getEntryId(); // consumedLedgerSize()ç¬¬ä¸‰ä¸ªå‚æ•°éœ€è¦ä½œä¸ºé™¤æ•°ï¼Œä¸èƒ½ä¸º 0 if (ledgerInfo.getEntries() == 0) &#123; size -= consumedLedgerSize(currentLedgerSize, currentLedgerEntries, numEntries); return size; &#125; else &#123; size -= consumedLedgerSize(ledgerInfo.getSize(), ledgerInfo.getEntries(), numEntries); return size; &#125; &#125; &#125; 123456789private long consumedLedgerSize(long ledgerSize, long ledgerEntries, long consumedEntries) &#123; if (ledgerEntries &lt;= 0) &#123; return 0; &#125; // è®¡ç®—å¹³å‡ Entry å¤§å° long averageSize = ledgerSize / ledgerEntries; // Entry Id çš„èµ·å§‹ç¼–å·ä¸º -1ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦ +1 return consumedEntries &gt;= 0 ? (consumedEntries + 1) * averageSize : 0; &#125; disconnectProducers(persistentTopic) disconnectProducers(persistentTopic);å‡½æ•°è´Ÿè´£åœ¨producer_request_holdå’Œproducer_exceptionä¸¤ç§æ¨¡å¼ä¸‹ Backlog è¶…é™æ—¶æ–­å¼€ä¸ Producer çš„é“¾æ¥ã€‚ 12345678910111213141516private void disconnectProducers(PersistentTopic persistentTopic) &#123; List&lt;CompletableFuture&lt;Void&gt;&gt; futures = Lists.newArrayList(); ConcurrentOpenHashSet&lt;Producer&gt; producers = persistentTopic.getProducers(); producers.forEach(producer -&gt; &#123; futures.add(producer.disconnect()); &#125;); FutureUtil.waitForAll(futures).thenRun(() -&gt; &#123; log.info(&quot;All producers on topic [&#123;&#125;] are disconnected&quot;, persistentTopic.getName()); &#125;).exceptionally(exception -&gt; &#123; log.error(&quot;Error in disconnecting producers on topic [&#123;&#125;] [&#123;&#125;]&quot;, persistentTopic.getName(), exception); return null; &#125;); &#125; BacklogQuota æ£€æŸ¥ BacklogQuota æœ‰ä¸¤ç§å½¢å¼çš„æ£€æŸ¥ï¼Œä¸€ç§æ˜¯å‘¨æœŸæ€§æ£€æŸ¥ï¼Œå¦ä¸€ç§æ˜¯åˆ›å»º Producer ä¹‹å‰æ£€æŸ¥ã€‚ å‘¨æœŸæ€§æ£€æŸ¥ åœ¨BrokerServiceå¯åŠ¨æ—¶ï¼Œä¼šå¯åŠ¨startBacklogQuotaChecker();ï¼ŒstartBacklogQuotaChecker();è´Ÿè´£å‘¨æœŸæ€§æ‰§è¡ŒmonitorBacklogQuota() ï¼Œå¯¹äº Backlog è¶…é™çš„æƒ…å†µï¼Œä¼šé€šè¿‡BacklogQuotaManagerè¿›è¡Œå¤„ç†ã€‚ 1234567891011121314public void monitorBacklogQuota() &#123; forEachTopic(topic -&gt; &#123; if (topic instanceof PersistentTopic) &#123; PersistentTopic persistentTopic = (PersistentTopic) topic; if (isBacklogExceeded(persistentTopic)) &#123; getBacklogQuotaManager().handleExceededBacklogQuota(persistentTopic); &#125; else &#123; if (log.isDebugEnabled()) &#123; log.debug(&quot;quota not exceeded for [&#123;&#125;]&quot;, topic.getName()); &#125; &#125; &#125; &#125;); &#125; åˆ›å»º Producer ä¹‹å‰æ£€æŸ¥ åœ¨ Broker ä¸ Client å¯¹æ¥çš„æœåŠ¡ç«¯ServerCnxä¸Šï¼Œæ”¶åˆ°å»ºç«‹ Producer çš„è§¦å‘ä¹‹åï¼Œåœ¨åˆ›å»º Producer ä¹‹å‰ï¼Œä¼šè¿›è¡Œ BacklogQuota æ£€æŸ¥ã€‚ 1234567891011121314151617if (topic.isBacklogQuotaExceeded(producerName)) &#123; IllegalStateException illegalStateException = new IllegalStateException( &quot;Cannot create producer on topic with backlog quota exceeded&quot;); BacklogQuota.RetentionPolicy retentionPolicy = topic.getBacklogQuota().getPolicy(); if (retentionPolicy == BacklogQuota.RetentionPolicy.producer_request_hold) &#123; // è¿”å› Error ctx.writeAndFlush( Commands.newError(requestId, ServerError.ProducerBlockedQuotaExceededError, illegalStateException.getMessage())); &#125; else if (retentionPolicy == BacklogQuota.RetentionPolicy.producer_exception) &#123; // è¿”å› Exception ctx.writeAndFlush(Commands.newError(requestId, ServerError.ProducerBlockedQuotaExceededException, illegalStateException.getMessage())); &#125; producerFuture.completeExceptionally(illegalStateException); producers.remove(producerId, producerFuture); return;&#125; è¿™é‡Œåªè¿›è¡Œproducer_request_holdå’Œproducer_exceptionä¸¤ç§ç­–ç•¥çš„å¤„ç†ï¼Œconsumer_backlog_evictionåªåœ¨å‘¨æœŸæ€§æ£€æŸ¥æ—¶è¿›è¡Œå¤„ç†ã€‚ å¯¹äºproducer_request_holdç­–ç•¥ï¼Œè¿”å› Error ï¼ŒClientCnxåœ¨æ”¶åˆ° Error ä¹‹åï¼Œä¸ä¼šç›´æ¥ç»“æŸè¯·æ±‚ï¼Œä¼šåœ¨ Future ä»»åŠ¡è¶…æ—¶æˆ–è€…è°ƒç”¨get()æ—¶æŠ›å‡ºProducerBlockedQuotaExceededErrorå¼‚å¸¸ã€‚ 12345678910111213141516protected void handleError(CommandError error) &#123; checkArgument(state == State.Ready); log.warn(&quot;&#123;&#125; Received error from server: &#123;&#125;&quot;, ctx.channel(), error.getMessage()); long requestId = error.getRequestId(); if (error.getError() == ServerError.ProducerBlockedQuotaExceededError) &#123; log.warn(&quot;&#123;&#125; Producer creation has been blocked because backlog quota exceeded for producer topic&quot;, ctx.channel()); &#125; CompletableFuture&lt;ProducerResponse&gt; requestFuture = pendingRequests.remove(requestId); if (requestFuture != null) &#123; requestFuture.completeExceptionally(getPulsarClientException(error.getError(), error.getMessage())); &#125; else &#123; log.warn(&quot;&#123;&#125; Received unknown request id from server: &#123;&#125;&quot;, ctx.channel(), error.getRequestId()); &#125; &#125; å¯¹äºproducer_exceptionç­–ç•¥ï¼Œç›´æ¥è¿”å›ProducerBlockedQuotaExceededExceptionå¼‚å¸¸ã€‚ ä»¥ä¸Šå°±æ˜¯å¯¹ Pulsar ä»£ç ä¸­ BacklogQuota æœºåˆ¶çš„å®ç°ã€‚","raw":null,"content":null,"categories":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://fxbing.github.io/categories/%E6%8A%80%E6%9C%AF/"}],"tags":[{"name":"Pulsar","slug":"Pulsar","permalink":"http://fxbing.github.io/tags/Pulsar/"}]},{"title":"ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹ç¬”è®°","slug":"2019-07-28-æ·±å…¥ç†è§£JAVAè™šæ‹Ÿæœºç¬”è®°","date":"2019-07-27T16:00:00.000Z","updated":"2019-07-27T16:00:00.000Z","comments":true,"path":"2019/07/28/2019-07-28-æ·±å…¥ç†è§£JAVAè™šæ‹Ÿæœºç¬”è®°/","link":"","permalink":"http://fxbing.github.io/2019/07/28/2019-07-28-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3JAVA%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%AC%94%E8%AE%B0/","excerpt":"é˜…è¯»äº†ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹çš„éƒ¨åˆ†ç« èŠ‚ï¼Œå¹¶åšäº†ä¸€äº›ç®€å•çš„ç¬”è®°ï¼Œä¸æ˜¯å¾ˆè¯¦ç»†ï¼Œä½†æ˜¯å¯ä»¥æ–¹ä¾¿è‡ªå·±æŸ¥é˜…ã€‚","text":"é˜…è¯»äº†ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹çš„éƒ¨åˆ†ç« èŠ‚ï¼Œå¹¶åšäº†ä¸€äº›ç®€å•çš„ç¬”è®°ï¼Œä¸æ˜¯å¾ˆè¯¦ç»†ï¼Œä½†æ˜¯å¯ä»¥æ–¹ä¾¿è‡ªå·±æŸ¥é˜…ã€‚ ç¬¬ä¸‰ç«  åƒåœ¾æ”¶é›†å™¨ä¸å†…å­˜åˆ†é…ç­–ç•¥ 1. å¯¹è±¡æ˜¯å¦å­˜æ´» å¼•ç”¨è®¡æ•°æ³•ï¼š å¾ˆéš¾è§£å†³å¯¹è±¡é—´çš„å¾ªç¯å¼•ç”¨ å¯è¾¾æ€§åˆ†æ å¯ä»¥ä½œä¸ºGC Rootsçš„å¯¹è±¡ï¼š è™šæ‹Ÿæœºæ ˆä¸­å¼•ç”¨çš„å¯¹è±¡ æ–¹æ³•åŒºä¸­ç±»é™æ€å±æ€§å¼•ç”¨çš„å¯¹è±¡ æ–¹æ³•åŒºä¸­å¸¸é‡å¼•ç”¨çš„å¯¹è±¡ æœ¬åœ°æ–¹æ³•æ ˆä¸­JNIï¼ˆNativeæ–¹æ³•ï¼‰å¼•ç”¨çš„å¯¹è±¡ 2. å¼•ç”¨åˆ†ç±»ï¼ˆJDK1.2å®ç°ï¼‰ å¼ºå¼•ç”¨ï¼šæ°¸è¿œä¸å›æ”¶ è½¯å¼•ç”¨SoftReferenceï¼ˆæœ‰ç”¨ä½†éå¿…é¡»ï¼‰ï¼šå†…å­˜æº¢å‡ºä¹‹å‰å›æ”¶ å¼±å¼•ç”¨WeakReferenceï¼ˆéå¿…é¡»ï¼‰ï¼šGCæ—¶å›æ”¶ è™šå¼•ç”¨PhantomReferenceï¼ˆå¹½çµå¼•ç”¨/å¹»å½±å¼•ç”¨ï¼‰ï¼šç›®çš„æ˜¯èƒ½åœ¨è¿™ä¸ªå¯¹è±¡è¢«æ”¶é›†å™¨å›æ”¶æ—¶æ”¶åˆ°ä¸€ä¸ªç³»ç»Ÿé€šçŸ¥ 3. finalize()ï¼ˆä¸å»ºè®®ä½¿ç”¨ï¼‰ åˆ¤æ–­å¯¹è±¡æ˜¯å¦æ­»äº¡ä¼šç»å†ä¸¤æ¬¡æ ‡è®°è¿‡ç¨‹ï¼šâ‘ åˆ¤æ–­æ˜¯å¦ä¸GC Rootsç›¸è¿ï¼›â‘¡æ‰§è¡Œfinalize()ï¼ˆå¯¹è±¡æ²¡æœ‰è¦†ç›–finalize()æˆ–finalize()å·²ç»è¢«è°ƒç”¨è¿‡ä¸€æ¬¡æ—¶ï¼Œè™šæ‹Ÿæœºè®¤ä¸ºæ²¡å¿…è¦æ‰§è¡Œfinalize()ï¼Œä¸ä¼šè¿›è¡Œç¬¬äºŒæ¬¡æ ‡è®°ï¼‰ã€‚ è¢«è°ƒç”¨æ—¶ä¼šæ”¾åœ¨ç”±è™šæ‹Ÿæœºè‡ªåŠ¨åˆ›å»ºçš„ã€ä½ä¼˜å…ˆçº§çš„é˜Ÿåˆ—F-Queueä¸­ finalize()æ˜¯å¯¹è±¡å”¯ä¸€çš„è‡ªæ•‘æœºä¼šï¼Œä¾‹å¦‚ï¼šåœ¨finalize()ä¸­å°†thisèµ‹å€¼ç»™æŸä¸ªç±»å˜é‡æˆ–è€…å¯¹è±¡çš„æˆå‘˜å˜é‡ è¿è¡Œä»£ä»·é«˜æ˜‚ï¼Œä¸ç¡®å®šæ€§å¤§ã€æ— æ³•ä¿è¯å„ä¸ªå¯¹è±¡çš„è°ƒç”¨é¡ºåº finalize()èƒ½åšçš„æ‰€æœ‰å·¥ä½œä½¿ç”¨try-finallyæˆ–è€…å…¶ä»–æ–¹å¼å¯ä»¥åšå¾—æ›´å¥½ã€æ›´åŠæ—¶ 4. å›æ”¶æ–¹æ³•åŒº åºŸå¼ƒå¸¸é‡ ä¸Javaå †çš„å›æ”¶é€»è¾‘ç±»ä¼¼ æ— ç”¨çš„ç±» è¯¥ç±»çš„æ‰€æœ‰å®ä¾‹å·²ç»è¢«å›æ”¶ åŠ è½½è¯¥ç±»çš„ClassLoaderå·²ç»è¢«å›æ”¶ è¯¥ç±»å¯¹åº”çš„java.lang.Classå¯¹è±¡æ²¡æœ‰åœ¨ä»»ä½•åœ°æ–¹è¢«å¼•ç”¨ï¼Œæ— æ³•åœ¨ä»»ä½•åœ°æ–¹é€šè¿‡åå°„è®¿é—®è¯¥ç±»çš„æ–¹æ³•ã€‚ 5. åƒåœ¾æ”¶é›†ç®—æ³• ï¼ˆ1ï¼‰æ ‡è®°æ¸…é™¤ç®—æ³• æ•ˆç‡ä¸é«˜ ä¼šå¤§é‡ä¸è¿ç»­å†…å­˜ç¢ç‰‡ ï¼ˆ2ï¼‰å¤åˆ¶ç®—æ³• å†…å­˜ç¼©å°ä¸ºåŸæ¥çš„ä¸€åŠ HotSpoté»˜è®¤çš„Edenä¸Survivorçš„å¤§å°æ¯”ä¾‹ä¸º8:1 æ²¡æœ‰åŠæ³•ä¿è¯æ¯æ¬¡å›æ”¶éƒ½åªæœ‰ä¸å¤šäº10%çš„å¯¹è±¡å­˜æ´»ã€‚å½“Survivorç©ºé—´ä¸å¤Ÿç”¨æ—¶ï¼Œéœ€è¦ä¾èµ–è€å¹´ä»£è¿›è¡Œåˆ†é…æ‹…ä¿ã€‚ åˆ†é…æ‹…ä¿ï¼šå½“Survivorç©ºé—´ä¸èƒ½æ”¾ä¸‹ä¸Šä¸€æ¬¡ YGC ä¹‹åå­˜æ´»çš„å¯¹è±¡æ—¶ï¼Œè¿™äº›å¯¹è±¡ç›´æ¥é€šè¿‡åˆ†é…æ‹…ä¿æœºåˆ¶è¿›å…¥è€å¹´ä»£ã€‚ ï¼ˆ3ï¼‰æ ‡è®°æ•´ç†ç®—æ³• ï¼ˆ4ï¼‰åˆ†ä»£æ”¶é›†ç®—æ³• æ–°ç”Ÿä»£æ¯æ¬¡åƒåœ¾æ”¶é›†éƒ½ä¼šæœ‰å¤§é‡å¯¹è±¡æ­»å»ï¼Œå°‘é‡å­˜æ´»ï¼Œæ‰€ä»¥é‡‡ç”¨å¤åˆ¶ç®—æ³•ã€‚è€å¹´ä»£å¯¹è±¡å­˜æ´»ç‡é«˜ã€æ²¡æœ‰é¢å¤–çš„ç©ºé—´å¯¹å®ƒè¿›è¡Œæ‹…ä¿ï¼Œå¿…é¡»ä½¿ç”¨â€œæ ‡è®°-æ¸…ç†â€æˆ–è€…â€œæ ‡è®°-æ•´ç†â€ç®—æ³•ã€‚ 6. HotSpotç®—æ³•å®ç° ï¼ˆ1ï¼‰æšä¸¾æ ¹èŠ‚ç‚¹ Javaè™šæ‹Ÿæœºä½¿ç”¨å‡†ç¡®å¼GCï¼ˆå¿…é¡»ç¡®å®šä¸€ä¸ªå˜é‡æ˜¯å¼•ç”¨è¿˜æ˜¯çœŸæ­£çš„æ•°æ®ï¼‰ è™šæ‹Ÿæœºåœé¡¿ä¹‹åä¸éœ€è¦æ£€æŸ¥æ‰€æœ‰çš„æ‰§è¡Œä¸Šä¸‹æ–‡å’Œå…¨å±€çš„å¼•ç”¨ä½ç½®ã€‚ ç±»åŠ è½½å®Œæˆæ—¶è®¡ç®—å‡ºä»€ä¹ˆåç§»é‡ä¸Šæ˜¯ä»€ä¹ˆç±»å‹çš„æ•°æ®ï¼ŒJITç¼–è¯‘æ—¶åœ¨ç‰¹å®šä½ç½®ï¼ˆå®‰å…¨ç‚¹ï¼‰è®°å½•OopMapæ•°æ®ç»“æ„ï¼ˆæŒ‡æ˜æ ˆå’Œå¯„å­˜å™¨å“ªäº›ä½ç½®æ˜¯å¼•ç”¨ï¼‰ ï¼ˆ2ï¼‰å®‰å…¨ç‚¹ï¼ˆSafePointï¼‰ ç¨‹åºæ‰§è¡Œæ—¶å¹¶éåœ¨æ‰€æœ‰åœ°æ–¹éƒ½èƒ½åœé¡¿ä¸‹æ¥å¼€å§‹GCï¼Œåªæœ‰åˆ°è¾¾å®‰å…¨ç‚¹æ—¶æ‰èƒ½æš‚åœã€‚ å®‰å…¨ç‚¹é€‰å®šåŸåˆ™ï¼šæ˜¯å¦å…·æœ‰è®©ç¨‹åºé•¿æ—¶é—´æ‰§è¡Œçš„ç‰¹å¾ é•¿æ—¶é—´æ‰§è¡Œï¼šæŒ‡ä»¤åºåˆ—å¤ç”¨ï¼ˆå¦‚ï¼šæ–¹æ³•è°ƒç”¨ã€å¾ªç¯è·³è½¬ã€å¼‚å¸¸è·³è½¬ï¼‰ æŠ¢å…ˆå¼ä¸­æ–­ï¼ˆå·²ç»è¢«å¼ƒç”¨ï¼‰ï¼šæ‰€æœ‰çº¿ç¨‹ä¸­æ–­ï¼Œä¸åœ¨å®‰å…¨ç‚¹çš„çº¿ç¨‹æ¢å¤æ‰§è¡Œã€‚ ä¸»åŠ¨å¼ä¸­æ–­ï¼šåœ¨å®‰å…¨ç‚¹è®¾ç½®ä¸­æ–­æ ‡å¿—ï¼Œç¨‹åºæ‰§è¡Œåˆ°å®‰å…¨ç‚¹æ—¶ä¸»åŠ¨è½®è¯¢è¿™ä¸ªæ ‡å¿—ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œä¸­æ–­ã€‚ ï¼ˆ3ï¼‰å®‰å…¨åŒºåŸŸï¼ˆSafe Regionï¼‰ å®šä¹‰ï¼šä¸€æ®µä»£ç ä¸­ï¼Œå¼•ç”¨å…³ç³»ä¸ä¼šå‘ç”Ÿå˜åŒ–ã€‚ï¼ˆçº¿ç¨‹å¤„äºSleepæˆ–BlockedçŠ¶æ€ï¼‰ çº¿ç¨‹æ‰§è¡Œåˆ°Safe Regionæ—¶ï¼Œæ ‡è¯†è‡ªå·±è¿›å…¥Safe RegionçŠ¶æ€ï¼›JVM GCæ—¶ä¸ç®¡Safe RegionçŠ¶æ€çš„çº¿ç¨‹ï¼›å½“çº¿ç¨‹ç¦»å¼€Safe RegionçŠ¶æ€æ—¶ï¼Œæ£€æŸ¥ç³»ç»Ÿæ˜¯å¦å®Œæˆäº†æ ¹èŠ‚ç‚¹æšä¸¾æˆ–æ•´ä¸ªGCè¿‡ç¨‹ï¼›å¦‚æœå®Œæˆäº†ï¼Œé‚£çº¿ç¨‹ç»§ç»­æ‰§è¡Œï¼Œå¦åˆ™ï¼Œå¿…é¡»ç­‰å¾…æ”¶åˆ°å¯ä»¥å®‰å…¨ç¦»å¼€Safe Regionçš„ä¿¡å·ä¸ºæ­¢ã€‚ 7. åƒåœ¾æ”¶é›†å™¨ è¿çº¿ä»£è¡¨å¯ä»¥ç»„åˆä½¿ç”¨ã€‚ ï¼ˆ1ï¼‰Serialæ”¶é›†å™¨ï¼ˆClientæ¨¡å¼ä¸‹æ–°ç”Ÿä»£åƒåœ¾æ¸…ç†é¦–é€‰ï¼‰ è¿›è¡Œåƒåœ¾æ”¶é›†æ—¶ï¼Œå¿…é¡»æš‚åœå…¶ä»–æ‰€æœ‰çš„å·¥ä½œçº¿ç¨‹ï¼Œç›´åˆ°å®ƒæ”¶é›†ç»“æŸã€‚ Serial/Serial Oldæ”¶é›†å™¨åœ¨æ–°ç”Ÿä»£é‡‡ç”¨å¤åˆ¶ç®—æ³•ï¼Œè€å¹´ä»£é‡‡ç”¨æ ‡è®°-æ•´ç†ç®—æ³•ã€‚ ï¼ˆ2ï¼‰ParNewæ”¶é›†å™¨ï¼ˆServeræ¨¡å¼ä¸‹æ–°ç”Ÿä»£åƒåœ¾æ¸…ç†é¦–é€‰ï¼‰ å¤šçº¿ç¨‹ç‰ˆæœ¬çš„Serialæ”¶é›†å™¨ ç¬¬ä¸€æ¬¾çœŸæ­£æ„ä¹‰ä¸Šçš„å¹¶å‘æ”¶é›†å™¨ é»˜è®¤å¼€å¯çš„æ”¶é›†çº¿ç¨‹æ•°ä¸CPUçš„æ•°é‡ç›¸åŒ ï¼ˆ3ï¼‰Parallel Scavengeæ”¶é›†å™¨ ç›®æ ‡ï¼šè¾¾åˆ°ä¸€ä¸ªå¯æ§åˆ¶çš„ååé‡ã€‚ï¼ˆååé‡ = è¿è¡Œç”¨æˆ·ä»£ç æ—¶é—´ / (è¿è¡Œç”¨æˆ·ä»£ç æ—¶é—´ + åƒåœ¾æ”¶é›†æ—¶é—´)ï¼‰ é€‚åˆåœ¨åå°è¿ç®—è€Œä¸éœ€è¦å¤ªå¤šäº¤äº’çš„ä»»åŠ¡ å¯ä»¥è®¾ç½®æœ€å¤§åƒåœ¾æ”¶é›†åœæ®µæ—¶é—´ï¼ˆ-XX:MaxGCPauseMillisï¼‰å’Œååé‡å¤§å°ï¼ˆ-XX:GCTimeRatioï¼‰ å¯ä»¥å¼€å¯-XX:UseAdaptiveSizePolicyï¼Œä¹‹åè™šæ‹Ÿæœºæ ¹æ®ç³»ç»Ÿè¿è¡ŒçŠ¶å†µè‡ªåŠ¨è®¾ç½®æ–°ç”Ÿä»£å¤§å°ã€Edenä¸Survivoræ¯”ä¾‹ã€æ™‹å‡è€å¹´ä»£å¯¹è±¡å¤§å°ç­‰ç»†èŠ‚å‚æ•°ã€‚ï¼ˆGCè‡ªé€‚åº”çš„è°ƒèŠ‚ç­–ç•¥ï¼‰ ï¼ˆ4ï¼‰Serial Oldæ”¶é›†å™¨ ï¼ˆ5ï¼‰Parallel Oldæ”¶é›†å™¨ ï¼ˆ6ï¼‰CMSæ”¶é›†å™¨ å››ä¸ªæ­¥éª¤ï¼ša: åˆå§‹æ ‡è®°ï¼ˆåœé¡¿ï¼‰ï¼šè®°å½•ä¸GC Rootsç›´æ¥ç›¸è¿çš„å¯¹è±¡b: å¹¶å‘æ ‡è®°ï¼šGC Roots Tracingc: é‡æ–°æ ‡è®°ï¼ˆåœé¡¿æ›´é•¿ï¼‰ï¼šä¿®æ­£å¹¶å‘æ ‡è®°æœŸé—´å› ç”¨æˆ·ç¨‹åºç»§ç»­è¿ä½œè€Œå¯¼è‡´çš„æ ‡è®°äº§ç”Ÿå˜åŠ¨çš„è®°å½•d: å¹¶å‘æ¸…é™¤ å¯¹ CPU èµ„æºæ•æ„Ÿ æ— æ³•å¤„ç†æµ®åŠ¨åƒåœ¾ï¼ˆå¹¶å‘æ¸…é™¤é˜¶æ®µç”¨æˆ·ç¨‹åºäº§ç”Ÿçš„æ–°çš„åƒåœ¾ï¼Œéœ€è¦ç­‰ä¸‹æ¬¡GCæ—¶å†è¿›è¡Œæ¸…ç†ï¼‰ï¼Œå¯èƒ½å‡ºç°â€œConcurrent Mode Failureâ€å¤±è´¥è€Œå¯¼è‡´å¦ä¸€æ¬¡Full GCçš„äº§ç”Ÿã€‚ï¼ˆä¸èƒ½ç­‰è€å¹´ä»£è¢«å¡«æ»¡ä¹‹åè¿›è¡Œæ¸…ç†ï¼Œéœ€è¦ä¸ºå¹¶å‘æ¸…é™¤æœŸé—´ç”¨æˆ·ç¨‹åºçš„æ‰§è¡Œé¢„ç•™ç©ºé—´ï¼‰ ç©ºé—´ç¢ç‰‡è¿‡å¤š ï¼ˆ7ï¼‰G1æ”¶é›†å™¨ï¼ˆJDK1.7ï¼‰ å¹¶è¡Œä¸å¹¶å‘ åˆ†ä»£æ”¶é›† ç©ºé—´æ•´åˆï¼šä»æ•´ä½“ä¸Šçœ‹æ˜¯åŸºäºâ€œæ ‡è®°-æ•´ç†â€ç®—æ³•å®ç°çš„æ”¶é›†å™¨ï¼Œä»å±€éƒ¨ï¼ˆä¸¤ä¸ªRegionä¹‹é—´ï¼‰ä¸Šæ¥çœ‹æ˜¯åŸºäºâ€œå¤åˆ¶â€œç®—æ³•å®ç°çš„ã€‚ å¯é¢„æµ‹çš„åœé¡¿ï¼šä½¿ç”¨è€…å¯ä»¥æŒ‡å®šåƒåœ¾æ”¶é›†ä¸Šæ¶ˆè€—çš„æ—¶é—´ä¸å¾—è¶…è¿‡ M æ¯«ç§’ã€‚ åˆ†é…çš„å¯¹è±¡ä¼šè®°å½•åœ¨ Remembered Set ä¸­ï¼Œå†…å­˜å›æ”¶æ—¶å†GCæ ¹èŠ‚ç‚¹çš„æšä¸¾èŒƒå›´ä¸­åŠ å…¥ Remembered Set ï¼Œç¡®ä¿ä¸å¯¹å…¨å †æ‰«æä¹Ÿä¸ä¼šæœ‰æ³„éœ²ã€‚ ä¸è®¡ç®—ç»´æŠ¤ Remembered Set çš„è¿‡ç¨‹ï¼Œå¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼ša: åˆå§‹æ ‡è®°b: å¹¶å‘æ ‡è®°c: æœ€ç»ˆæ ‡è®°ï¼šå¹¶å‘æ ‡è®°æœŸé—´å¯¹è±¡å˜åŒ–è®°å½•åœ¨çº¿ç¨‹ Remembered Set Logs ä¸­ï¼Œè¯¥é˜¶æ®µå°† Remembered Set Logs æ•´åˆåˆ° Remembered Set ä¸­ã€‚d: ç­›é€‰å›æ”¶ï¼šæ ¹æ®ç”¨æˆ·æœŸæœ›çš„ GC åœé¡¿æ—¶é—´åˆ¶å®šå›æ”¶è®¡åˆ’ã€‚ 8. å†…å­˜åˆ†é…ä¸å›æ”¶ç­–ç•¥ å¯¹è±¡ä¼˜å…ˆåœ¨Edenåˆ†é… æ–°ç”Ÿä»£ GC ï¼ˆMinor GCï¼‰ï¼šéå¸¸é¢‘ç¹ï¼Œå›æ”¶é€Ÿåº¦ä¹Ÿæ¯”è¾ƒå—ã€‚è€å¹´ä»£ GC ï¼ˆMajor GC / Full GCï¼‰ï¼šä¼´éšè‡³å°‘ä¸€æ¬¡çš„ Minor GC ï¼Œ æ¯” Minor GC æ…¢10å€ä»¥ä¸Šã€‚ å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£ é•¿æœŸå­˜æ´»çš„å¯¹è±¡å°†è¿›å…¥è€å¹´ä»£ï¼ˆå¯ä»¥é€šè¿‡ -XX:MaxTenuringThreshold å‚æ•°è¿›è¡Œè®¾ç½®ï¼Œé»˜è®¤æ‰§è¡Œå®Œ15æ¬¡ Minor GCï¼‰ åŠ¨æ€å¯¹è±¡å¹´é¾„åˆ¤æ–­ï¼šå¦‚æœåœ¨ Survivor ç©ºé—´ä¸­ç›¸åŒå¹´é¾„æ‰€æœ‰å¯¹è±¡å¤§å°æ€»å’Œå¤§äº Survivor ç©ºé—´çš„ä¸€åŠï¼Œå¹´é¾„å¤§äºæˆ–ç­‰äºè¯¥å¹´é¾„çš„å¯¹è±¡å°±å¯ä»¥ç›´æ¥è¿›å…¥è€å¹´ä»£ï¼Œæ— éœ€ç­‰åˆ° MaxTenuringThreshold ä¸­è¦æ±‚çš„å¹´é¾„ã€‚ ç©ºé—´åˆ†é…æ‹…ä¿ï¼šåœ¨è¿›è¡Œ Minor GC ä¹‹å‰ä¼šæ‰§è¡Œä¸‹é¢çš„æµç¨‹ï¼Œa: æ£€æŸ¥è€å¹´ä»£æœ€å¤§è¿ç»­å¯ç”¨ç©ºé—´æ˜¯å¦å¤§äºæ–°ç”Ÿä»£æ‰€æœ‰å¯¹è±¡æ€»ç©ºé—´ï¼Œå¦‚æœæ˜¯ Minor GC å¯ä»¥ç¡®ä¿å®‰å…¨ï¼Œå¦åˆ™ï¼Œ æ‰§è¡Œbï¼›b: æŸ¥çœ‹ HandlePromotionFailure è®¾ç½®çš„å€¼æ˜¯å¦å…è®¸æ‹…ä¿å¤±è´¥ï¼Œå¦‚æœæ˜¯ï¼Œæ‰§è¡Œcï¼Œå¦åˆ™ï¼Œæ‰§è¡Œ Full GCï¼›c: æ£€æŸ¥è€å¹´ä»£æœ€å¤§å¯ç”¨è¿ç»­ç©ºé—´æ˜¯å¦å¤§äºå†æ¬¡æ™‹å‡åˆ°è€å¹´ä»£å¯¹è±¡çš„å¹³å‡å¤§å°ï¼Œå¦‚æœæ˜¯ï¼Œå°è¯•ä¸€æ¬¡ Minor GC ï¼ˆå¯èƒ½å­˜åœ¨é£é™©ï¼‰ï¼Œå¦åˆ™ï¼Œå°† HandlePromotionFailure è®¾ç½®ä¸ºä¸å…è®¸å†’é™©ï¼Œæ”¹ä¸ºè¿›è¡Œä¸€æ¬¡ Full GCã€‚ ç¬¬ä¸ƒç«  è™šæ‹Ÿæœºç±»åŠ è½½æœºåˆ¶ 1. ç±»çš„åŠ è½½è¿‡ç¨‹ æŒ‰é¡ºåºæŒ‰éƒ¨å°±ç­çš„å¼€å§‹ï¼ˆä¸æ˜¯ç»“æŸï¼Œä¸€ä¸ªé˜¶æ®µä¸­è°ƒç”¨æ¿€æ´»å¦ä¸€ä¸ªé˜¶æ®µï¼‰ï¼Œè§£æé˜¶æ®µå¯ä»¥åœ¨åˆå§‹åŒ–ä¹‹åå†å¼€å§‹ï¼ˆåŠ¨æ€ç»‘å®šï¼‰ Javaè™šæ‹Ÿæœºè§„å®šçš„å¿…é¡»è¿›è¡Œåˆå§‹åŒ–çš„5ç§æƒ…å†µï¼šï¼ˆ1ï¼‰ é‡åˆ° newã€getstaticã€putstaticã€invokestaticè¿™4æ¡å­—èŠ‚ç æŒ‡ä»¤ï¼ˆå¯¹åº”ä½¿ç”¨ new å…³é”®å­—å®ä¾‹åŒ–å¯¹è±¡ã€è¯»å–æˆ–è®¾ç½®ç±»çš„é™æ€å­—æ®µï¼ˆè¢« final ä¿®é¥°ã€å·²åœ¨ç¼–è¯‘æœŸæŠŠç»“æœæ”¾å…¥å¸¸é‡æ± çš„é™æ€å­—æ®µé™¤å¤–ï¼‰ä»¥åŠè°ƒç”¨ä¸€ä¸ªç±»çš„é™æ€æ–¹æ³•å‡ ç§æƒ…å†µï¼‰ï¼ˆ2ï¼‰ åå°„è°ƒç”¨ã€‚ï¼ˆ3ï¼‰ åˆå§‹åŒ–ä¸€ä¸ªç±»æ—¶ï¼Œå¦‚æœçˆ¶ç±»æ²¡æœ‰è¿›è¡Œè¿‡åˆå§‹åŒ–ï¼Œéœ€è¦å…ˆè§¦å‘çˆ¶ç±»åˆå§‹åŒ–ã€‚ï¼ˆ4ï¼‰ è™šæ‹Ÿæœºå¯åŠ¨æ—¶ï¼Œç”¨æˆ·éœ€è¦æŒ‡å®šä¸€ä¸ªè¦æ‰§è¡Œçš„ä¸»ç±»ï¼ˆåŒ…å«main()æ–¹æ³•çš„ç±»ï¼‰ï¼Œè™šæ‹Ÿæœºä¼šå…ˆåˆå§‹åŒ–ä¸»ç±»ã€‚ï¼ˆ5ï¼‰ ä½†æ˜¯ç”¨åŠ¨æ€è¯­è¨€æ”¯æŒæ—¶ï¼Œå¦‚æœä¸€ä¸ªjava.lang.invoke.MethodHandleå®ä¾‹åè§£æç»“æœ REF_putStatic , REF_getStatic , REF_invokeStatic çš„æ–¹æ³•å¥æŸ„æ—¶ï¼Œå½“æ”¹æ–¹æ³•å¥æŸ„å¯¹åº”çš„ç±»æ²¡æœ‰åˆå§‹åŒ–æ—¶ï¼Œéœ€è¦åˆå§‹åŒ–è¯¥ç±»ã€‚ æ¥å£åˆå§‹åŒ–æ—¶å¹¶ä¸è¦æ±‚å…¶çˆ¶ç±»æ¥å£å…¨éƒ¨éƒ½åˆå§‹åŒ–å®Œæˆï¼Œåªæœ‰åœ¨çœŸæ­£ä½¿ç”¨åˆ°çˆ¶ç±»æ¥å£æ—¶æ‰ä¼šåˆå§‹åŒ–ã€‚ æœ‰ä¸”ä»…æœ‰ä¸Šé¢äº”ç§æƒ…å†µä¼šè§¦å‘åˆå§‹åŒ–ï¼Œæˆä¸ºä¸»åŠ¨å¼•ç”¨ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œå…¶ä»–æ‰€æœ‰æ–¹å¼éƒ½ä¸ä¼šè§¦å‘åˆå§‹åŒ–ï¼Œç§°ä¸ºè¢«åŠ¨å¼•ç”¨ã€‚ è¢«åŠ¨å¼•ç”¨ä¸¾ä¾‹ï¼š é€šè¿‡å­ç±»å¼•ç”¨çˆ¶ç±»çš„é™æ€å­—æ®µï¼Œä¸ä¼šå¯¼è‡´å­ç±»çš„åˆå§‹åŒ–ã€‚ é€šè¿‡æ•°ç»„å®šä¹‰æ¥å¼•ç”¨ç±»ï¼Œä¸ä¼šè§¦å‘æ­¤ç±»çš„åˆå§‹åŒ–ã€‚ å¸¸é‡åœ¨ç¼–è¯‘é˜¶æ®µä¼šå­˜å…¥è°ƒç”¨ç±»çš„å¸¸é‡æ± ä¸­ï¼Œæœ¬è´¨ä¸Šå¹¶æ²¡æœ‰ç›´æ¥å¼•ç”¨åˆ°å®šä¹‰å¸¸é‡çš„ç±»ï¼Œå› æ­¤ä¸ä¼šè§¦å‘å®šä¹‰å¸¸é‡çš„ç±»çš„åˆå§‹åŒ–ã€‚ 1.1 åŠ è½½ é€šè¿‡ä¸€ä¸ªç±»çš„å…¨é™å®šåæ¥è·å–å®šä¹‰æ­¤ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµ è·å–é€”å¾„ï¼šZIPåŒ…ï¼ˆJARã€EARã€WARï¼‰ã€ç½‘ç»œï¼ˆAppletï¼‰ã€è¿è¡Œæ—¶è®¡ç®—ç”Ÿæˆï¼ˆåŠ¨æ€ä»£ç†ï¼‰ã€å…¶ä»–æ–‡ä»¶ï¼ˆJSPåº”ç”¨ï¼‰ã€æ•°æ®åº“ å°†è¿™ä¸ªå­—èŠ‚æµæ‰€ä»£è¡¨çš„é™æ€å­˜å‚¨ç»“æ„è½¬åŒ–ä¸ºæ–¹æ³•åŒºçš„è¿è¡Œæ—¶æ•°æ®ç»“æ„ åœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¿™ä¸ªç±»çš„ java.lang.Class å¯¹è±¡ï¼Œä½œä¸ºæ–¹æ³•åŒºè¿™ä¸ªç±»çš„å„ç§æ•°æ®çš„è®¿é—®å…¥å£ éæ•°ç»„ç±»å‹ä½¿ç”¨å¼•å¯¼ç±»åŠ è½½å™¨æˆ–è€…ç”¨æˆ·è‡ªå®šä¹‰ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½ æ•°ç»„çš„ç»„ä»¶ç±»å‹ï¼ˆå»æ‰ä¸€ä¸ªç»´åº¦ä¹‹åçš„ç±»å‹ï¼‰æ˜¯å¼•ç”¨ç±»å‹ï¼Œåˆ™æŒ‰ç…§æ™®é€šç±»åŠ è½½è¿‡ç¨‹åŠ è½½ï¼›ä¸æ˜¯å¼•ç”¨ç±»å‹ï¼Œæ ‡è®°ä¸ºä¸å¼•å¯¼ç±»åŠ è½½å™¨å…³è”ã€‚ æ•°ç»„ç±»å¯è§æ€§ä¸ç»„ä»¶ç±»å‹å¯è§æ€§ä¸€è‡´ã€‚å¦‚æœç»„ä»¶ç±»å‹ä¸æ˜¯å¼•ç”¨ç±»å‹ï¼Œå¯è§æ€§é»˜è®¤ä¸º public ã€‚ 1.2 éªŒè¯ï¼ˆéå¸¸é‡è¦ä½†ä¸ä¸€å®šå¿…è¦ï¼‰ æ–‡ä»¶æ ¼å¼éªŒè¯ï¼šä¿è¯è¾“å…¥çš„å­—èŠ‚æµèƒ½æ­£ç¡®åœ°è§£æå¹¶å­˜å‚¨äºæ–¹æ³•åŒºä¹‹å†…ï¼Œæ ¼å¼ä¸Šç¬¦åˆæè¿°ä¸€ä¸ªJavaç±»å‹ä¿¡æ¯çš„è¦æ±‚ã€‚ ç»è¿‡æ­¤éªŒè¯ä¹‹åå­—èŠ‚æµæ‰ä¼šè¿›å…¥å†…å­˜æ–¹æ³•åŒºï¼Œåé¢3ä¸ªéªŒè¯é˜¶æ®µéƒ½æ˜¯åŸºäºæ–¹æ³•åŒºä¸­çš„å­˜å‚¨ç»“æ„ å…ƒæ•°æ®éªŒè¯ï¼ˆè¯­ä¹‰åˆ†æï¼‰ï¼šä¿è¯ä¸å­˜åœ¨ä¸ç¬¦åˆè¯­è¨€è§„èŒƒçš„å…ƒæ•°æ®ä¿¡æ¯ã€‚ å­—èŠ‚ç éªŒè¯ï¼ˆå¹¶ä¸èƒ½å®Œå…¨ä¿è¯å®‰å…¨ï¼‰ï¼šå¯¹ç±»çš„æ–¹æ³•ä½“è¿›è¡Œæ ¡éªŒåˆ†æï¼Œä¿è¯è¢«æ ¡éªŒç±»çš„æ–¹æ³•åœ¨è¿è¡Œæ—¶ä¸ä¼šåšå‡ºå±å®³è™šæ‹Ÿæœºå®‰å…¨çš„äº‹ä»¶ã€‚ ç¬¦å·å¼•ç”¨éªŒè¯ï¼šå‘ç”Ÿåœ¨è™šæ‹Ÿæœºå°†ç¬¦å·å¼•ç”¨è½¬åŒ–ä¸ºç›´æ¥å¼•ç”¨é˜¶æ®µï¼Œç¡®ä¿è§£æåŠ¨ä½œå¯ä»¥æ­£å¸¸æ‰§è¡Œã€‚ 1.3 å‡†å¤‡ ä¸ºç±»å˜é‡ï¼ˆè¢« static ä¿®é¥°çš„å˜é‡ï¼Œä¸åŒ…æ‹¬å®ä¾‹å˜é‡ï¼‰åˆ†é…å†…å­˜å¹¶è®¾ç½®ç±»å˜é‡åˆå§‹å€¼ï¼ˆä¸€èˆ¬æ˜¯é›¶å€¼ï¼‰ã€‚ é€šå¸¸æƒ…å†µä¸‹åˆå§‹åŒ–é›¶å€¼ï¼Œå¦‚æœå­˜åœ¨ ConstantValue å±æ€§ï¼Œåˆ™æŒ‡å®šä¸º ConstantValue å±æ€§çš„å€¼ã€‚public static int value = 123;æ­¤ä»£ç  value å‡†å¤‡é˜¶æ®µä¹‹åçš„ç»“æœä¸º0ï¼›public static final int value = 123;æ­¤ä»£ç  value å‡†å¤‡é˜¶æ®µä¹‹åçš„ç»“æœä¸º123ã€‚ 1.4 è§£æ å°†å¸¸é‡æ± ä¸­çš„ç¬¦å·å¼•ç”¨æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨ã€‚ é™¤invokeddynamicæŒ‡ä»¤ï¼Œå…¶ä½™éœ€è¦è¿›è¡Œè§£æçš„å­—èŠ‚ç æŒ‡ä»¤éƒ½ä¼šå¯¹ç¬¬ä¸€æ¬¡è§£æç»“æœè¿›è¡Œç¼“å­˜ã€‚è§£æåŠ¨ä½œä¸»è¦é’ˆå¯¹ç±»æˆ–æ¥å£ã€å­—æ®µã€ç±»æ–¹æ³•ã€æ¥å£æ–¹æ³•ã€æ–¹æ³•ç±»å‹ã€æ–¹æ³•å¥æŸ„å’Œè°ƒç”¨ç‚¹é™å®šç¬¦ä¸ƒç±»ç¬¦å·å¼•ç”¨è¿›è¡Œã€‚ 1.5 åˆå§‹åŒ– æ‰§è¡Œç±»æ„é€ å™¨&lt;clinit&gt;()æ–¹æ³•ã€‚ é™æ€è¯­å¥å—ä¸­åªèƒ½è®¿é—®åˆ°å®šä¹‰åœ¨é™æ€è¯­å¥å—ä¹‹å‰çš„å˜é‡ï¼Œå®šä¹‰åœ¨å®ƒä¹‹åçš„å˜é‡ï¼Œåœ¨å‰é¢çš„é™æ€è¯­å¥å—å¯ä»¥èµ‹å€¼ï¼Œä½†ä¸èƒ½è®¿é—®ã€‚ &lt;clinit&gt;()ä¸éœ€è¦æ˜¾ç¤ºè°ƒç”¨çˆ¶ç±»çš„&lt;clinit&gt;()ï¼Œç”±è™šæ‹Ÿæœºä¿è¯çˆ¶ç±»&lt;clinit&gt;()æ‰§è¡Œã€‚ç¬¬ä¸€ä¸ªè¢«æ‰§è¡Œçš„&lt;clinit&gt;()æ–¹æ³•çš„ç±»è‚¯å®šæ˜¯java.lang.Objectã€‚ çˆ¶ç±»ä¸­å®šä¹‰çš„é™æ€è¯­å¥å—ä¼˜äºå­ç±»å˜é‡çš„å¤åˆ¶æ“ä½œã€‚ &lt;clinit&gt;()æ˜¯éå¿…éœ€çš„ï¼ˆæ²¡æœ‰é™æ€è¯­å¥å—å’Œå˜é‡èµ‹å€¼æ“ä½œï¼‰ æ¥å£ä¸èƒ½ä½¿ç”¨é™æ€è¯­å¥å—ï¼Œä½†æ˜¯å¯ä»¥å¯¹å˜é‡èµ‹å€¼ã€‚åªæœ‰çˆ¶æ¥å£ä¸­å®šä¹‰çš„å˜é‡ä½¿ç”¨æ—¶ï¼Œçˆ¶æ¥å£æ‰ä¼šåˆå§‹åŒ–ã€‚ è™šæ‹Ÿæœºä¿è¯ä¸€ä¸ªç±»çš„&lt;clinit&gt;()æ–¹æ³•åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹è¢«æ­£ç¡®çš„åŠ é”ã€åŒæ­¥ã€‚ 2. ç±»åŠ è½½å™¨ 2.1 åˆ¤æ–­ä¸¤ä¸ªç±»ç›¸ç­‰ ä½¿ç”¨ç›¸åŒç±»åŠ è½½å™¨ å…¨é™å®šåç›¸åŒ 2.2 åŒäº²å§”æ´¾æ¨¡å‹ åŒäº²å§”æ´¾æ¨¡å‹å·¥ä½œè¿‡ç¨‹ï¼š å¦‚æœä¸€ä¸ªç±»åŠ è½½å™¨æ”¶åˆ°ç±»åŠ è½½çš„è¯·æ±‚ï¼Œå®ƒé¦–å…ˆä¸ä¼šè‡ªå·±å»å°è¯•åŠ è½½è¿™ä¸ªç±»ï¼Œè€Œæ˜¯æŠŠè¿™ä¸ªè¯·æ±‚å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨å®Œæˆã€‚æ¯ä¸ªç±»åŠ è½½å™¨éƒ½æ˜¯å¦‚æ­¤ï¼Œåªæœ‰å½“çˆ¶åŠ è½½å™¨åœ¨è‡ªå·±çš„æœç´¢èŒƒå›´å†…æ‰¾ä¸åˆ°æŒ‡å®šçš„ç±»æ—¶ï¼ˆå³ClassNotFoundExceptionï¼‰ï¼Œå­åŠ è½½å™¨æ‰ä¼šå°è¯•è‡ªå·±å»åŠ è½½ã€‚ ç±»åŠ è½½å™¨ä¹‹é—´çš„çˆ¶å­å…³ç³»ä¸ä¼šä»¥ç»§æ‰¿å®ç°ï¼Œè€Œæ˜¯ä½¿ç”¨ç»„åˆçš„æ–¹å¼ã€‚ åŒäº²å§”æ´¾æ¨¡å‹çš„ä¸‰æ¬¡ç ´å ç¬¬ä¸€æ¬¡ç ´åæ˜¯åœ¨jdk 1.2ä¹‹å‰ï¼Œç”¨æˆ·è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨éƒ½æ˜¯é‡å†™Classloaderä¸­çš„loadClassæ–¹æ³•,è¿™æ ·å°±å¯¼è‡´æ¯ä¸ªè‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨å…¶å®æ˜¯åœ¨ä½¿ç”¨è‡ªå·±çš„loadClassæ–¹æ³•ä¸­çš„åŠ è½½æœºåˆ¶æ¥è¿›è¡ŒåŠ è½½,è¿™ç§æ¨¡å¼å½“ç„¶æ˜¯ä¸ç¬¦åˆåŒäº²å§”æ´¾æœºåˆ¶çš„ï¼Œä¹Ÿæ˜¯æ— æ³•ä¿è¯åŒä¸€ä¸ªç±»åœ¨jvmä¸­çš„å”¯ä¸€æ€§çš„ã€‚ä¸ºäº†å‘å‰å…¼å®¹ï¼Œjavaå®˜æ–¹åœ¨Classloaderä¸­æ·»åŠ äº†findClassæ–¹æ³•,ç”¨æˆ·åªéœ€è¦é‡æ–°è¿™ä¸ªfindClassæ–¹æ³•ï¼Œåœ¨loadClassæ–¹æ³•çš„é€»è¾‘é‡Œï¼Œå¦‚æœçˆ¶ç±»åŠ è½½å¤±è´¥çš„æ—¶å€™ï¼Œæ‰ä¼šè°ƒç”¨è‡ªå·±çš„findClassæ–¹æ³•æ¥å®Œæˆç±»åŠ è½½ï¼Œè¿™æ ·å°±ä¿è¯äº†å†™å‡ºçš„ç±»åŠ è½½å™¨æ˜¯ç¬¦åˆåŒäº²å§”æ´¾æœºåˆ¶çš„ã€‚ ç¬¬äºŒæ¬¡çš„ç ´åæ˜¯ç”±æ¨¡å‹æœ¬èº«çš„ç¼ºé™·å¯¼è‡´çš„ï¼Œæ ¹ç±»åŠ è½½å™¨åŠ è½½äº†åŸºç¡€ä»£ç ï¼Œä½†æ˜¯åŸºç¡€ä»£ç ä¸­æœ‰å¯èƒ½è°ƒç”¨äº†ç”¨æˆ·çš„ä»£ç ï¼Œä½†æ˜¯å¯¹äºæ ¹ç±»åŠ è½½å™¨è€Œè¨€æ˜¯ä¸è®¤è¯†ç”¨æˆ·çš„ä»£ç çš„ã€‚ é‚£ä¹ˆè¿™æ—¶å€™javaå›¢é˜Ÿä½¿ç”¨äº†ä¸€ä¸ªä¸å¤ªä¼˜é›…çš„è®¾è®¡ï¼šçº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ã€‚è¿™ä¸ªç±»åŠ è½½å™¨å¯ä»¥é€šè¿‡Threadç±»çš„setContextClassLoaderæ–¹æ³•è¿›è¡Œè®¾ç½®,å¦‚æœåˆ›å»ºçº¿ç¨‹æ—¶è¿˜æœªè®¾ç½®ï¼Œå®ƒå°±ä»çˆ¶çº¿ç¨‹ç»§æ‰¿ä¸€ä¸ªï¼Œå¦‚æœåœ¨åº”ç”¨å…¨å±€èŒƒå›´å†…éƒ½æ²¡æœ‰è®¾ç½®è¿‡çš„è¯ï¼Œé‚£è¿™ä¸ªç±»åŠ è½½å™¨é»˜è®¤å°±æ˜¯åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ã€‚ åˆ©ç”¨è¿™ä¸ªçº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨å‚…ï¼Œçˆ¶ç±»åŠ è½½å™¨è¯·æ±‚å­ç±»åŠ è½½å™¨å»åŠ è½½æŸäº›è‡ªå·±è¯†åˆ«ä¸äº†çš„ç±»ã€‚ javaä¸­åŸºæœ¬æ‰€æœ‰æ¶‰åŠspiçš„åŠ è½½åŠ¨ä½œåŸºæœ¬ä¸Šéƒ½é‡‡ç”¨äº†è¿™ç§æ–¹å¼ï¼Œä¾‹å¦‚jndiï¼Œjdbcç­‰ã€‚ ç¬¬ä¸‰æ¬¡çš„ç ´åæ˜¯å› ä¸ºç”¨æˆ·å¯¹äºç¨‹åºçš„åŠ¨æ€æ€§è¿½æ±‚ï¼Œè¯¸å¦‚ï¼šä»£ç çƒ­æ›¿æ¢ï¼Œæ¨¡å—çƒ­éƒ¨ç½²ã€‚ç›®å‰ä¸šç•ŒJavaæ¨¡å—åŒ–çš„æ ‡å‡†æ˜¯OSGIã€‚è€ŒOSGIå®ç°æ¨¡å—çƒ­éƒ¨ç½²çš„å…³é”®æ˜¯ä»–è‡ªå·±çš„ç±»åŠ è½½æœºåˆ¶ï¼šæ¯ä¸ªç¨‹åºæ¨¡å—(bundle)éƒ½æœ‰è‡ªå·±çš„ç±»åŠ è½½å™¨ï¼Œéœ€è¦æ›´æ¢ç¨‹åº(bundle)çš„æ—¶å€™ï¼Œè¿åŒç±»åŠ è½½å™¨ä¸€èµ·æ›¿æ¢ï¼Œä»¥å®ç°ä»£ç çš„çƒ­éƒ¨ç½²ã€‚ ç¬¬å…«ç«  è™šæ‹Ÿæœºå­—èŠ‚ç æ‰§è¡Œå¼•æ“ 1. è¿è¡Œæ—¶æ ˆå¸§ç»“æ„ åŒ…å«å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€åŠ¨æ€è¿æ¥å’Œæ–¹æ³•è¿”å›åœ°å€ç­‰ä¿¡æ¯ã€‚ ç¼–è¯‘æ—¶ç¡®å®šæ ˆå¸§ä¸­çš„å±€éƒ¨å˜é‡è¡¨å¤§å°ã€‚ ä¸€ä¸ªæ ˆå¸§éœ€è¦åˆ†é…å¤šå°‘å†…å­˜ä¸ä¼šå—åˆ°ç¨‹åºè¿è¡ŒæœŸå˜é‡æ•°æ®çš„å½±å“ï¼Œè€Œä»…ä»…å–å†³äºå…·ä½“çš„è™šæ‹Ÿæœºå®ç°ã€‚ åªæœ‰ä½äºæ ˆé¡¶çš„æ ˆå¸§ï¼ˆå½“å‰æ ˆå¸§ï¼‰æ‰æ˜¯æœ‰æ•ˆçš„ã€‚ 1.1 å±€éƒ¨å˜é‡è¡¨ ä»¥å®¹é‡æ§½ï¼ˆSlotï¼‰ä¸ºæœ€å°å•ä½ æ¯ä¸ªSlotéƒ½åº”è¯¥èƒ½å¤Ÿå­˜æ”¾ä¸€ä¸ªbooleanã€byteã€charã€shortã€intã€floatã€referenceæˆ–returnAddressç±»å‹æ•°æ®ã€‚ å¦‚æœä¸€ä¸ªå±€éƒ¨å˜é‡å®šä¹‰äº†ä½†æ˜¯æ²¡æœ‰èµ‹åˆå§‹å€¼æ˜¯ä¸èƒ½ä½¿ç”¨çš„ 1.2 æ“ä½œæ•°æ ˆ Java è™šæ‹Ÿæœºçš„è§£é‡Šæ‰§è¡Œå¼•æ“ç§°ä¸ºâ€œåŸºäºæ ˆçš„æ‰§è¡Œå¼•æ“â€ï¼Œå…¶ä¸­æ‰€æŒ‡çš„â€œæ ˆâ€å°±æ˜¯æ“ä½œæ•°æ ˆ 1.3 åŠ¨æ€è¿æ¥ æŒ‡å‘è¿è¡Œæ—¶å¸¸é‡æ± ä¸­è¯¥æ ˆå¸§æ‰€å±æ–¹æ³•çš„å¼•ç”¨ã€‚é™æ€è§£æï¼šç¬¦å·å¼•ç”¨åœ¨ç±»åŠ è½½é˜¶æ®µæˆ–ç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶è½¬åŒ–ä¸ºç›´æ¥å¼•ç”¨ã€‚åŠ¨æ€è¿æ¥ï¼šç¬¦å·å¼•ç”¨åœ¨æ¯ä¸€æ¬¡è¿è¡ŒæœŸé—´è½¬åŒ–ä¸ºç›´æ¥å¼•ç”¨ã€‚ 1.4 æ–¹æ³•è¿”å›åœ°å€ æ–¹æ³•æ­£å¸¸é€€å‡ºæ—¶ï¼Œè°ƒç”¨è€…çš„PCè®¡æ•°å™¨çš„å€¼å¯ä»¥ä½œä¸ºè¿”å›åœ°å€ï¼Œæ ˆå¸§ä¸­å¾ˆå¯èƒ½ä¼šä¿å­˜è¿™ä¸ªè®¡æ•°å™¨çš„å€¼ã€‚æ–¹æ³•å¼‚å¸¸é€€å‡ºæ—¶ï¼Œè¿”å›åœ°å€é€šè¿‡å¼‚å¸¸å¤„ç†å™¨è¡¨æ¥ç¡®å®šï¼Œæ ˆå¸§ä¸­ä¸€èˆ¬ä¸ä¼šä¿å­˜è¿™éƒ¨åˆ†ä¿¡æ¯ã€‚æ–¹æ³•é€€å‡ºè¿‡ç¨‹ï¼š æ¢å¤ä¸Šå±‚æ–¹æ³•çš„å±€éƒ¨å˜é‡è¡¨å’Œæ“ä½œæ•°æ ˆ æŠŠè¿”å›å€¼å‹å…¥è°ƒç”¨è€…æ ˆå¸§çš„æ“ä½œæ•°æ ˆ è°ƒæ•´PCè®¡æ•°å™¨çš„å€¼ä»¥æŒ‡å‘æ–¹æ³•è°ƒç”¨æŒ‡ä»¤åé¢çš„ä¸€æ¡æŒ‡ä»¤ 2. æ–¹æ³•è°ƒç”¨ 2.1 è§£æ åªè¦èƒ½è¢« invokestatic å’Œ invokespecial æŒ‡ä»¤è°ƒç”¨çš„æ–¹æ³•éƒ½å¯ä»¥åœ¨è§£æé˜¶æ®µç¡®å®šå”¯ä¸€çš„è°ƒç”¨ç‰ˆæœ¬ã€‚ ç¬¦åˆä¸Šè¿°æ¡ä»¶çš„çš„æœ‰é™æ€æ–¹æ³•ã€ç§æœ‰æ–¹æ³•ã€å®ä¾‹æ„é€ å™¨ã€çˆ¶ç±»æ–¹æ³• 4 ç§ã€‚éƒ½ç§°ä¸ºéè™šæ–¹æ³•ã€‚å…¶ä½™æ–¹æ³•ä¸ºè™šæ–¹æ³•ã€‚ final æ–¹æ³•ä¹Ÿæ˜¯éè™šæ–¹æ³•ã€‚ 2.2 åˆ†æ´¾ï¼ˆä¸å¤šæ€ç‰¹æ€§æœ‰å…³ï¼‰ é™æ€åˆ†æ´¾ åŠ¨æ€åˆ†æ´¾ ç¼–è¯‘é˜¶æ®µ è¿è¡Œé˜¶æ®µ é‡è½½ é‡å†™ å¤šåˆ†æ´¾ï¼ˆå…³å¿ƒé™æ€ç±»å‹ä¸æ–¹æ³•å‚æ•°ä¸¤ä¸ªå› ç´ ï¼‰ å•åˆ†æ´¾ï¼ˆåªå…³å¿ƒæ–¹æ³•æ¥æ”¶è€…ï¼‰ ï¼ˆ1ï¼‰é™æ€åˆ†æ´¾ï¼ˆé‡è½½ï¼‰ æ‰€æœ‰é€šè¿‡é™æ€ç±»å‹æ¥å®šä½æ–¹æ³•æ‰§è¡Œç‰ˆæœ¬çš„åˆ†æ´¾åŠ¨ä½œç§°ä¸ºé™æ€åˆ†æ´¾ã€‚ æ–¹æ³•é‡è½½æ˜¯é™æ€åˆ†æ´¾çš„å…¸å‹åº”ç”¨ é™æ€åˆ†æ´¾å‘ç”Ÿåœ¨ç¼–è¯‘é˜¶æ®µ Human man = new Man();Humanä¸ºå˜é‡çš„é™æ€ç±»å‹ï¼Œé™æ€ç±»å‹çš„å˜åŒ–ä»…ä»…åœ¨ä½¿ç”¨æ—¶å‘ç”Ÿï¼Œå˜é‡æœ¬èº«çš„é™æ€ç±»å‹ä¸ä¼šè¢«æ”¹å˜ï¼Œå¹¶ä¸”æœ€ç»ˆçš„é™æ€ç±»å‹æ˜¯åœ¨ç¼–è¯‘æœŸå¯çŸ¥çš„ï¼›Manä¸ºå˜é‡çš„å®é™…ç±»å‹ï¼Œå®é™…ç±»å‹çš„å˜åŒ–ç»“æœåœ¨è¿è¡ŒæœŸæ‰å¯ä»¥ç¡®å®šï¼Œç¼–è¯‘æœŸé—´ä¸çŸ¥é“å¯¹è±¡çš„å®é™…ç±»å‹ã€‚é‡è½½é€šè¿‡å‚æ•°çš„é™æ€ç±»å‹è€Œä¸æ˜¯å®é™…ç±»å‹ä½œä¸ºåˆ¤å®šä¾æ®ã€‚ ï¼ˆ2ï¼‰åŠ¨æ€åˆ†æ´¾ï¼ˆé‡å†™ï¼‰ è¿è¡ŒæœŸæ ¹æ®å®é™…ç±»å‹ç¡®å®šæ–¹æ³•æ‰§è¡Œç‰ˆæœ¬çš„åˆ†æ´¾è¿‡ç¨‹ç§°ä¸ºåŠ¨æ€åˆ†æ´¾ã€‚ æ ¹æ®æ“ä½œæ•°æ ˆä¸­çš„ä¿¡æ¯ç¡®å®šæ¥å—è€…çš„å®é™…ç±»å‹ ï¼ˆ3ï¼‰å•åˆ†æ´¾ä¸å¤šåˆ†æ´¾ æ–¹æ³•çš„æ¥æ”¶è€…ä¸æ–¹æ³•çš„å‚æ•°ç»Ÿç§°ä¸ºæ–¹æ³•çš„å®—é‡ã€‚å•åˆ†æ´¾æ˜¯æ ¹æ®ä¸€ä¸ªå®—é‡å¯¹ç›®æ ‡æ–¹æ³•è¿›è¡Œé€‰æ‹©ï¼Œå¤šåˆ†æ´¾åˆ™æ˜¯æ ¹æ®å¤šä¸ªå®—é‡å¯¹ç›®æ ‡æ–¹æ³•è¿›è¡Œé€‰æ‹©ã€‚é™æ€åˆ†æ´¾å±äºå¤šåˆ†æ´¾ï¼ŒåŠ¨æ€åˆ†æ´¾å±äºå•åˆ†æ´¾ã€‚ ï¼ˆ4ï¼‰å¤šåˆ†æ´¾çš„å®ç° ä¸ºç±»åœ¨æ–¹æ³•åŒºä¸­å»ºç«‹è™šæ–¹æ³•è¡¨ï¼Œå­˜æ”¾å„ä¸ªæ–¹æ³•çš„å®é™…å…¥å£åœ°å€ã€‚å¦‚æœå­ç±»é‡å†™äº†çˆ¶ç±»å‡½æ•°ï¼Œè™šæ–¹æ³•è¡¨ä¸­å­˜æ”¾æŒ‡å‘å­ç±»å®ç°ç‰ˆæœ¬çš„å…¥å£åœ°å€ï¼›å¦åˆ™ï¼Œä¸çˆ¶ç±»ç›¸åŒæ–¹æ³•çš„å…¥å£åœ°å€ä¸€è‡´ã€‚ ç¬¬åäºŒç«  Javaå†…å­˜æ¨¡å‹ä¸çº¿ç¨‹ 1. Javaå†…å­˜æ¨¡å‹ å·¥ä½œå†…å­˜ ä¸»å†…å­˜ çº¿ç¨‹å¯¹å˜é‡è¯»å–ã€èµ‹å€¼ç­‰æ“ä½œ çº¿ç¨‹é—´å˜é‡å€¼çš„ä¼ é€’ è™šæ‹Ÿæœºæ ˆä¸­çš„éƒ¨åˆ†åŒºåŸŸ Javaå †ä¸­çš„å¯¹è±¡å®ä¾‹æ•°æ®éƒ¨åˆ† 1.1 å†…å­˜é—´çš„äº¤äº’æ“ä½œ **lock(é”å®š)**ï¼šä½œç”¨äºä¸»å†…å­˜çš„å˜é‡ï¼ŒæŠŠä¸€ä¸ªå˜é‡æ ‡è®°ä¸ºä¸€æ¡çº¿ç¨‹ç‹¬å çŠ¶æ€ **unlock(è§£é”)**ï¼šä½œç”¨äºä¸»å†…å­˜çš„å˜é‡ï¼ŒæŠŠä¸€ä¸ªå¤„äºé”å®šçŠ¶æ€çš„å˜é‡é‡Šæ”¾å‡ºæ¥ï¼Œé‡Šæ”¾åçš„å˜é‡æ‰å¯ä»¥è¢«å…¶ä»–çº¿ç¨‹é”å®š **read(è¯»å–)**ï¼šä½œç”¨äºä¸»å†…å­˜çš„å˜é‡ï¼ŒæŠŠä¸€ä¸ªå˜é‡å€¼ä»ä¸»å†…å­˜ä¼ è¾“åˆ°çº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­ï¼Œä»¥ä¾¿éšåçš„loadåŠ¨ä½œä½¿ç”¨ **load(è½½å…¥)**ï¼šä½œç”¨äºå·¥ä½œå†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠreadæ“ä½œä»ä¸»å†…å­˜ä¸­å¾—åˆ°çš„å˜é‡å€¼æ”¾å…¥å·¥ä½œå†…å­˜çš„å˜é‡å‰¯æœ¬ä¸­ **use(ä½¿ç”¨)**ï¼šä½œç”¨äºå·¥ä½œå†…å­˜çš„å˜é‡ï¼ŒæŠŠå·¥ä½œå†…å­˜ä¸­çš„ä¸€ä¸ªå˜é‡å€¼ä¼ é€’ç»™æ‰§è¡Œå¼•æ“ **assign(èµ‹å€¼)**ï¼šä½œç”¨äºå·¥ä½œå†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠä¸€ä¸ªä»æ‰§è¡Œå¼•æ“æ¥æ”¶åˆ°çš„å€¼èµ‹ç»™å·¥ä½œå†…å­˜çš„å˜é‡ **store(å­˜å‚¨)**ï¼šä½œç”¨äºå·¥ä½œå†…å­˜çš„å˜é‡ï¼ŒæŠŠå·¥ä½œå†…å­˜ä¸­çš„ä¸€ä¸ªå˜é‡çš„å€¼ä¼ é€åˆ°ä¸»å†…å­˜ä¸­ï¼Œä»¥ä¾¿éšåçš„writeçš„æ“ä½œ **write(å†™å…¥)**ï¼šä½œç”¨äºå·¥ä½œå†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠstoreæ“ä½œä»å·¥ä½œå†…å­˜ä¸­çš„ä¸€ä¸ªå˜é‡çš„å€¼ä¼ é€åˆ°ä¸»å†…å­˜çš„å˜é‡ä¸­ åŒæ­¥è§„åˆ™åˆ†æï¼š ä¸å…è®¸readå’Œloadã€storeå’Œwriteæ“ä½œä¹‹ä¸€å•ç‹¬å‡ºç°ï¼Œä»¥ä¸Šä¸¤ä¸ªæ“ä½œå¿…é¡»æŒ‰é¡ºåºæ‰§è¡Œï¼Œä½†æ²¡æœ‰ä¿è¯å¿…é¡»è¿ç»­æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œreadä¸loadä¹‹é—´ã€storeä¸writeä¹‹é—´æ˜¯å¯æ’å…¥å…¶ä»–æŒ‡ä»¤çš„ã€‚ ä¸å…è®¸ä¸€ä¸ªçº¿ç¨‹ä¸¢å¼ƒå®ƒçš„æœ€è¿‘çš„assignæ“ä½œï¼Œå³å˜é‡åœ¨å·¥ä½œå†…å­˜ä¸­æ”¹å˜äº†ä¹‹åå¿…é¡»æŠŠè¯¥å˜åŒ–åŒæ­¥å›ä¸»å†…å­˜ã€‚ ä¸å…è®¸ä¸€ä¸ªçº¿ç¨‹æ— åŸå› åœ°ï¼ˆæ²¡æœ‰å‘ç”Ÿè¿‡ä»»ä½•assignæ“ä½œï¼‰æŠŠæ•°æ®ä»å·¥ä½œå†…å­˜åŒæ­¥ä¼šä¸»å†…å­˜ä¸­ ä¸€ä¸ªæ–°çš„å˜é‡åªèƒ½åœ¨ä¸»å†…å­˜ä¸­è¯ç”Ÿï¼Œä¸å…è®¸åœ¨å·¥ä½œå†…å­˜ä¸­ç›´æ¥ä½¿ç”¨ä¸€ä¸ªæœªè¢«åˆå§‹åŒ–ï¼ˆloadæˆ–è€…assignï¼‰çš„å˜é‡ã€‚å³å°±æ˜¯å¯¹ä¸€ä¸ªå˜é‡å®æ–½useå’Œstoreæ“ä½œä¹‹å‰ï¼Œå¿…é¡»å…ˆè‡ªè¡Œassignå’Œloadæ“ä½œã€‚ ä¸€ä¸ªå˜é‡åœ¨åŒä¸€æ—¶åˆ»åªå…è®¸ä¸€æ¡çº¿ç¨‹å¯¹å…¶è¿›è¡Œlockæ“ä½œï¼Œä½†lockæ“ä½œå¯ä»¥è¢«åŒä¸€çº¿ç¨‹é‡å¤æ‰§è¡Œå¤šæ¬¡ï¼Œå¤šæ¬¡æ‰§è¡Œlockåï¼Œåªæœ‰æ‰§è¡Œç›¸åŒæ¬¡æ•°çš„unlockæ“ä½œï¼Œå˜é‡æ‰ä¼šè¢«è§£é”ã€‚lockå’Œunlockå¿…é¡»æˆå¯¹å‡ºç°ã€‚ å¦‚æœå¯¹ä¸€ä¸ªå˜é‡æ‰§è¡Œlockæ“ä½œï¼Œå°†ä¼šæ¸…ç©ºå·¥ä½œå†…å­˜ä¸­æ­¤å˜é‡çš„å€¼ï¼Œåœ¨æ‰§è¡Œå¼•æ“ä½¿ç”¨è¿™ä¸ªå˜é‡ä¹‹å‰éœ€è¦é‡æ–°æ‰§è¡Œloadæˆ–assignæ“ä½œåˆå§‹åŒ–å˜é‡çš„å€¼ã€‚ å¦‚æœä¸€ä¸ªå˜é‡äº‹å…ˆæ²¡æœ‰è¢«lockæ“ä½œé”å®šï¼Œåˆ™ä¸å…è®¸å¯¹å®ƒæ‰§è¡Œunlockæ“ä½œï¼›ä¹Ÿä¸å…è®¸å»unlockä¸€ä¸ªè¢«å…¶ä»–çº¿ç¨‹é”å®šçš„å˜é‡ã€‚ å¯¹ä¸€ä¸ªå˜é‡æ‰§è¡Œunlockæ“ä½œä¹‹å‰ï¼Œå¿…é¡»å…ˆæŠŠæ­¤å˜é‡åŒæ­¥åˆ°ä¸»å†…å­˜ä¸­ï¼ˆæ‰§è¡Œstoreå’Œwriteæ“ä½œï¼‰ 2.3 volatile 1. ä¿è¯å¯è§æ€§ï¼Œreadä¸loadã€aggsinä¸storeä¸¤ä¸¤ä¸åˆ†å¼€ã€‚ 2. ç¦æ­¢æŒ‡ä»¤é‡æ’åºä¼˜åŒ–ï¼Œå†…å­˜å±éšœ 2.4 longä¸doubleå‹å˜é‡çš„ç‰¹æ®Šè§„åˆ™ è™šæ‹Ÿæœºä¸ä¿è¯64ä½æ•°æ®ç±»å‹çš„loadã€storeã€readå’Œwriteè¿™å››ä¸ªæ“ä½œçš„åŸå­æ€§ã€‚ ç›®å‰çš„å•†ç”¨è™šæ‹Ÿæœºä¿è¯äº†64ä½æ•°æ®çš„ç±»å‹è¯»å†™æ“ä½œçš„åŸå­æ€§ 2.5 åŸå­æ€§ã€å¯è§æ€§ä¸æœ‰åºæ€§ ï¼ˆ1ï¼‰åŸå­æ€§ åŸºæœ¬æ•°æ®ç±»å‹å…·å¤‡åŸå­æ€§ sychronized å…³é”®å­—ä¿è¯æ›´å¤§èŒƒå›´å†…çš„åŸå­æ€§ ï¼ˆ2ï¼‰å¯è§æ€§ volatileã€sychronizedå’Œfinalä¸‰ä¸ªå…³é”®å­—å®ç°å¯è§æ€§ã€‚ finalå…³é”®å­—çš„å¯è§æ€§ï¼šè¢« final ä¿®é¥°çš„å­—æ®µåœ¨æ„é€ å™¨ä¸­ä¸€æ—¦åˆå§‹åŒ–å®Œæˆï¼Œå¹¶ä¸”æ„é€ å™¨æ²¡æœ‰æŠŠthisçš„å¼•ç”¨ä¼ é€’å‡ºå»ï¼Œé‚£åœ¨å…¶ä»–çº¿ç¨‹ä¸­å°±èƒ½çœ‹åˆ° final å­—æ®µçš„å€¼ã€‚ ï¼ˆ3ï¼‰æœ‰åºæ€§ volatileå’Œsychronizedä¸¤ä¸ªå…³é”®å­—å®ç°æœ‰åºæ€§ã€‚ å¦‚æœåœ¨æœ¬çº¿ç¨‹å†…è§‚å¯Ÿï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯æœ‰åºçš„ï¼›å¦‚æœåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­è§‚å¯Ÿå¦ä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯æ— åºçš„ã€‚ 2.6 å…ˆè¡Œå‘ç”ŸåŸåˆ™ï¼ˆhappens-beforeï¼‰ ï¼ˆ1ï¼‰å®šä¹‰ å¦‚æœä¸€ä¸ªæ“ä½œhappens-beforeå¦ä¸€ä¸ªæ“ä½œï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªæ“ä½œçš„æ‰§è¡Œç»“æœå°†å¯¹ç¬¬äºŒä¸ªæ“ä½œå¯è§ï¼Œè€Œä¸”ç¬¬ä¸€ä¸ªæ“ä½œçš„æ‰§è¡Œé¡ºåºæ’åœ¨ç¬¬äºŒä¸ªæ“ä½œä¹‹å‰ã€‚ ä¸¤ä¸ªæ“ä½œä¹‹é—´å­˜åœ¨happens-beforeå…³ç³»ï¼Œå¹¶ä¸æ„å‘³ç€Javaå¹³å°çš„å…·ä½“å®ç°å¿…é¡»è¦æŒ‰ç…§happens-beforeå…³ç³»æŒ‡å®šçš„é¡ºåºæ¥æ‰§è¡Œã€‚å¦‚æœé‡æ’åºä¹‹åçš„æ‰§è¡Œç»“æœï¼Œä¸æŒ‰happens-beforeå…³ç³»æ¥æ‰§è¡Œçš„ç»“æœä¸€è‡´ï¼Œé‚£ä¹ˆè¿™ç§é‡æ’åºå¹¶ä¸éæ³•ï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼ŒJMMå…è®¸è¿™ç§é‡æ’åºï¼‰ã€‚ ï¼ˆ2ï¼‰å…·ä½“è§„åˆ™ ç¨‹åºé¡ºåºè§„åˆ™ï¼šä¸€ä¸ªçº¿ç¨‹ä¸­çš„æ¯ä¸ªæ“ä½œï¼Œhappens-beforeäºè¯¥çº¿ç¨‹ä¸­çš„ä»»æ„åç»­æ“ä½œã€‚ ç›‘è§†å™¨é”è§„åˆ™ï¼šå¯¹ä¸€ä¸ªé”çš„è§£é”ï¼Œhappens-beforeäºéšåå¯¹è¿™ä¸ªé”çš„åŠ é”ã€‚ volatileå˜é‡è§„åˆ™ï¼šå¯¹ä¸€ä¸ªvolatileåŸŸçš„å†™ï¼Œhappens-beforeäºä»»æ„åç»­å¯¹è¿™ä¸ªvolatileåŸŸçš„è¯»ã€‚ ä¼ é€’æ€§ï¼šå¦‚æœA happens-before Bï¼Œä¸”B happens-before Cï¼Œé‚£ä¹ˆA happens-before Cã€‚ start()è§„åˆ™ï¼šå¦‚æœçº¿ç¨‹Aæ‰§è¡Œæ“ä½œThreadB.start()ï¼ˆå¯åŠ¨çº¿ç¨‹Bï¼‰ï¼Œé‚£ä¹ˆAçº¿ç¨‹çš„ThreadB.start()æ“ä½œhappens-beforeäºçº¿ç¨‹Bä¸­çš„ä»»æ„æ“ä½œã€‚ join()è§„åˆ™ï¼šå¦‚æœçº¿ç¨‹Aæ‰§è¡Œæ“ä½œThreadB.join()å¹¶æˆåŠŸè¿”å›ï¼Œé‚£ä¹ˆçº¿ç¨‹Bä¸­çš„ä»»æ„æ“ä½œhappens-beforeäºçº¿ç¨‹Aä»ThreadB.join()æ“ä½œæˆåŠŸè¿”å›ã€‚ ç¨‹åºä¸­æ–­è§„åˆ™ï¼šå¯¹çº¿ç¨‹interrupted()æ–¹æ³•çš„è°ƒç”¨å…ˆè¡Œäºè¢«ä¸­æ–­çº¿ç¨‹çš„ä»£ç æ£€æµ‹åˆ°ä¸­æ–­æ—¶é—´çš„å‘ç”Ÿã€‚ å¯¹è±¡finalizeè§„åˆ™ï¼šä¸€ä¸ªå¯¹è±¡çš„åˆå§‹åŒ–å®Œæˆï¼ˆæ„é€ å‡½æ•°æ‰§è¡Œç»“æŸï¼‰å…ˆè¡Œäºå‘ç”Ÿå®ƒçš„finalize()æ–¹æ³•çš„å¼€å§‹ã€‚ Javaä¸çº¿ç¨‹ åœ¨Javaä¸­ï¼ŒJDK1.2ä¹‹å‰ç”±ç”¨æˆ·çº¿ç¨‹å®ç°ï¼ŒJDK1.2ä¹‹åä½¿ç”¨åŸºäºæ“ä½œç³»ç»ŸåŸç”Ÿçº¿ç¨‹æ¨¡å‹å®ç°ï¼Œwinå’Œlinuxéƒ½æ˜¯ç”¨çš„ä¸€å¯¹ä¸€çš„çº¿ç¨‹æ¨¡å‹ï¼ˆä¸€æ¡Javaçº¿ç¨‹æ˜ å°„åˆ°ä¸€æ¡è½»é‡çº§è¿›ç¨‹ä¸­ï¼‰ã€‚ 1. çº¿ç¨‹çš„å®ç° 1.1 ä½¿ç”¨å†…æ ¸çº¿ç¨‹å®ç° ä¸ç›´æ¥ä½¿ç”¨å†…æ ¸çº¿ç¨‹ï¼Œè€Œæ˜¯ä½¿ç”¨å†…æ ¸çº¿ç¨‹çš„é«˜çº§æ¥å£ï¼šè½»é‡çº§è¿›ç¨‹ã€‚ è½»é‡çº§è¿›ç¨‹ä¸å†…æ ¸çº¿ç¨‹çš„æ•°é‡æ¯”ä¸º 1 ï¼š1ã€‚ è½»é‡çº§è¿›ç¨‹æ¶ˆè€—å†…æ ¸èµ„æºï¼Œä¸€ä¸ªç³»ç»Ÿæ”¯æŒçš„è½»é‡çº§è¿›ç¨‹çš„æ•°é‡æ˜¯æœ‰é™çš„ã€‚ 1.2 ä½¿ç”¨ç”¨æˆ·çº¿ç¨‹å®ç°ï¼ˆå®ç°å¤æ‚ï¼Œæ²¡æœ‰ä½¿ç”¨ï¼‰ è¿›ç¨‹ä¸ç”¨æˆ·çº¿ç¨‹ä¹‹é—´æ˜¯ 1 ï¼šN çš„å…³ç³» 1.3 ä½¿ç”¨ç”¨æˆ·çº¿ç¨‹åŠ è½»é‡çº§è¿›ç¨‹æ··åˆå®ç° ç”¨æˆ·çº¿ç¨‹ä¸è½»é‡çº§è¿›ç¨‹ä¹‹é—´æ˜¯ N:M çš„å…³ç³»ã€‚ 2. çº¿ç¨‹è°ƒåº¦ ååŒå¼çº¿ç¨‹è°ƒåº¦ï¼šå®ç°ç®€å•ï¼Œä½†çº¿ç¨‹æ‰§è¡Œæ—¶é—´ä¸å¯æ§ æŠ¢å å¼çº¿ç¨‹è°ƒåº¦ï¼šJavaä¸€å…±10ä¸ªä¼˜å…ˆçº§ï¼Œä½†windowsç³»ç»Ÿåªæœ‰7ä¸ª 3. çŠ¶æ€è½¬æ¢","raw":null,"content":null,"categories":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://fxbing.github.io/categories/%E6%8A%80%E6%9C%AF/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://fxbing.github.io/tags/Java/"}]},{"title":"Pulsar æºç é˜…è¯»ï¼š Retention","slug":"2019-07-23-Pulsar-Retention","date":"2019-07-22T16:00:00.000Z","updated":"2019-07-22T16:00:00.000Z","comments":true,"path":"2019/07/23/2019-07-23-Pulsar-Retention/","link":"","permalink":"http://fxbing.github.io/2019/07/23/2019-07-23-Pulsar-Retention/","excerpt":"å¯¹äºå·²ç»æ¶ˆè´¹ç¡®è®¤çš„æ¶ˆæ¯ï¼ŒPulsar å¯ä»¥é€šè¿‡é…ç½® Retention ç­–ç•¥å†³å®šä¿ç•™çš„æ—¶é—´åŠå¤§å°ã€‚\nå…·ä½“å‚è§å®˜æ–¹æ–‡æ¡£ï¼šMessage retention and expiry\nPulsar æºç ä¸­æœ‰ä¸‰ä¸ªéƒ¨åˆ†ä¸ Retention ç›¸å…³ã€‚","text":"å¯¹äºå·²ç»æ¶ˆè´¹ç¡®è®¤çš„æ¶ˆæ¯ï¼ŒPulsar å¯ä»¥é€šè¿‡é…ç½® Retention ç­–ç•¥å†³å®šä¿ç•™çš„æ—¶é—´åŠå¤§å°ã€‚ å…·ä½“å‚è§å®˜æ–¹æ–‡æ¡£ï¼šMessage retention and expiry Pulsar æºç ä¸­æœ‰ä¸‰ä¸ªéƒ¨åˆ†ä¸ Retention ç›¸å…³ã€‚ 1. PersistentTopic åœ¨BrokerServiceå¯åŠ¨ä¹‹åï¼Œthis.startInactivityMonitor();æ“ä½œä¼šå¯¹ä¸æ´»åŠ¨ä»»åŠ¡è¿›è¡Œå®šæœŸæ¸…ç†ï¼Œå…¶ä¸­åŒ…æ‹¬ GC æ“ä½œï¼š 123public void checkGC(int gcIntervalInSeconds) &#123; forEachTopic(topic -&gt; topic.checkGC(gcIntervalInSeconds)); &#125; è¯¥æ“ä½œä¼šå¯¹ Broker ä¸­çš„æ¯ä¸ª Topic è¿›è¡Œ GC æ£€æŸ¥æ¸…ç†çš„æ“ä½œã€‚ å…¶ä¸­checkGC()ä¸ºPersistentTopicç±»ä¸­çš„å®ç°ï¼Œå¦‚ä¸‹ï¼š 1234567891011if (isActive()) &#123; lastActive = System.nanoTime();&#125; else if (System.nanoTime() - lastActive &lt; TimeUnit.SECONDS.toNanos(gcIntervalInSeconds)) &#123; // Gc interval did not expire yet return;&#125; else if (shouldTopicBeRetained()) &#123; // Topic activity is still within the retention period return; &#125; else &#123; ...&#125; shouldTopicBeRetained()å‡½æ•°ä¼šå¯¹éœ€è¦ retention çš„æ•°æ®è¿›è¡Œæ£€æŸ¥ã€‚ 1234567891011121314151617181920212223/** * Check whether the topic should be retained (based on time), even tough there are no producers/consumers and it&#x27;s * marked as inactive. */ private boolean shouldTopicBeRetained() &#123; TopicName name = TopicName.get(topic); try &#123; // ä»é…ç½®ç¼“å­˜ä¸­è¯»å–é…ç½®ä¿¡æ¯ Optional&lt;Policies&gt; policies = brokerService.pulsar().getConfigurationCache().policiesCache() .get(AdminResource.path(POLICIES, name.getNamespace())); // å¦‚æœæ²¡æœ‰é…ç½®ä¿¡æ¯ï¼Œé»˜è®¤è¯¥ Topic ä¸éœ€è¦ Retention ï¼Œæ¸…ç†ã€‚ // å¦‚æœæœ‰é…ç½®ä¿¡æ¯ï¼Œæ ¹æ®æ˜¯å¦è¶…è¿‡è®¾å®šçš„ Retention æ—¶é—´é€‰æ‹©æ˜¯å¦è¿›è¡Œæ¸…ç† return policies.map(p -&gt; p.retention_policies).map(rp -&gt; &#123; long retentionTime = TimeUnit.MINUTES.toNanos(rp.getRetentionTimeInMinutes()); return retentionTime &lt; 0 || (System.nanoTime() - lastActive) &lt; retentionTime; &#125;).orElse(false); &#125; catch (Exception e) &#123; if (log.isDebugEnabled()) &#123; log.debug(&quot;[&#123;&#125;] Error getting policies&quot;, topic); &#125; // Don&#x27;t delete in case we cannot get the policies return true; &#125; ä¸Šé¢å¯¹æ˜¯å¦åˆ°è¾¾ Retention æ—¶é—´çš„æ£€æŸ¥ç”¨åˆ°äº† AbstractTopic ç±»ä¸­çš„lastActiveå­—æ®µï¼š 12// Timestamp of when this topic was last seen active protected volatile long lastActive; è¯¥å­—æ®µåœ¨æ¯æ¬¡ç§»é™¤Producerã€ç§»é™¤è®¢é˜…å’Œæ‰§è¡ŒcheckGC()çš„æ—¶å€™è¿›è¡Œæ›´æ–°ã€‚è¿™é‡Œæ ¹æ®æˆ‘çš„ç†è§£å¯¹ä¸¤ä¸ªé—®é¢˜è¿›è¡Œè§£é‡Šï¼š ä¸ºä»€ä¹ˆåªåœ¨ç§»é™¤çš„æ—¶å€™æ›´æ–°ï¼Œè€Œä¸å†åŠ å…¥çš„æ—¶å€™æ›´æ–°ï¼Ÿ lastActiveæŒ‡çš„æ˜¯æœ€åçš„å­˜æ´»æ—¶é—´ï¼Œæ‰€ä»¥åªæœ‰ç§»é™¤æ‰€æœ‰çš„producerã€consumerä¹‹åæ‰å¯èƒ½éœ€è¦æ›´æ–°ã€‚ åœ¨æ¯æ¬¡ç§»é™¤Producerå’Œconsumerä¹‹åéƒ½è¿›è¡Œæ›´æ–°ï¼Œå¦‚æœä¿è¯lastActiveå°±ä»£è¡¨äº†è¯¥Topicæ¸…ç©ºProducerå’ŒConsumerçš„æ—¶é—´ï¼Ÿ shiyonglastActiveå¹¶ä¸èƒ½ä»£è¡¨è¿™ä¸ªæ„æ€ï¼Œé¦–å…ˆlastActiveåªåœ¨åˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡ŒGCå’Œæ˜¯å¦éœ€è¦è¢«ä¿ç•™çš„æ—¶å€™ä½¿ç”¨ï¼ˆåè€…æ˜¯åœ¨å‰è€…ä¹‹ä¸­è°ƒç”¨çš„ï¼‰ï¼Œåœ¨ä½¿ç”¨lastActiveä¹‹å‰ï¼Œä¼šæ‰§è¡ŒisActive()å‡½æ•°ï¼Œè¯¥å‡½æ•°æ˜¯å¯¹è¯¥Topicæ˜¯å¦è¿˜æœ‰ä¸å…¶è¿æ¥çš„Producerå’ŒConsumerï¼Œæ‰€æœ‰ä¹‹åä½¿ç”¨lastActiveå‚æ•°æ—¶å·²ç»ä¿è¯äº†isActive()ä¸æˆç«‹ï¼Œå³ï¼šè¯¥Topicä¸Šå·²ç»ä¸å­˜åœ¨Producerå’ŒConsumeräº†ã€‚ ä»¥ä¸Šæ˜¯BrokerServiceä¸­è¿›è¡ŒTopicæ¸…ç†æ—¶å¯¹**RetentionTime**çš„ä½¿ç”¨ï¼Œè¿™ä¸€éƒ¨åˆ†æ˜¯åœ¨æ¸…ç† Topic ä¹‹å‰æ ¹æ® Retention ç­–ç•¥å†³å®šè¯¥ Topic æ˜¯å¦åº”è¯¥è¢«æ¸…ç†ã€‚ 2. ManagedLedgerImpl Ledger æœ‰å…³çš„ Retention ç‰¹æ€§æ˜¯åœ¨**ManagedLedgerImpl**ç±»ä¸­å®ç°çš„ï¼Œä¸‹é¢ä»‹ç»è¯¥éƒ¨åˆ†ã€‚ åœ¨å¯åŠ¨BrokerServiceçš„æ—¶å€™ï¼Œä¼šè®¾ç½®managedLedgerConfig: 12managedLedgerConfig.setRetentionTime(retentionPolicies.getRetentionTimeInMinutes(), TimeUnit.MINUTES);managedLedgerConfig.setRetentionSizeInMB(retentionPolicies.getRetentionSizeInMB()); åœ¨ManagedLedgerImplç±»ä¸­ï¼Œä¸‹é¢çš„å‡½æ•°ä¼šå¯¹å·²ç»å®Œå…¨è¢«æ¶ˆè´¹ï¼ˆæ‰€æœ‰æ¶ˆæ¯å·²ç»è¢«æ‰€æœ‰ Consumer æ¶ˆè´¹å’Œç¡®è®¤è¿‡ï¼‰Ledgerè¿›è¡Œå‘¨æœŸæ€§æ£€æŸ¥æ¸…ç†ï¼Œ 1void internalTrimConsumedLedgers(CompletableFuture&lt;?&gt; promise) åœ¨ä¸Šé¢çš„å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šé€šè¿‡hasLedgerRetentionExpiredå‡½æ•°åˆ¤æ–­è¯¥Ledgeræ˜¯å¦éœ€è¦è¢«Retentionã€‚ 12345678private boolean hasLedgerRetentionExpired(long ledgerTimestamp) &#123; if (config.getRetentionTimeMillis() &lt; 0) &#123; // Negative retention time equates to infinite retention return false; &#125; long elapsedMs = clock.millis() - ledgerTimestamp; return elapsedMs &gt; config.getRetentionTimeMillis(); &#125; å…¶ä¸­ledgerTimestampå‚æ•°è¡¨ç¤ºLedgerå»ºç«‹çš„æ—¶é—´ã€‚ 3. NamespaceBase è¿˜æœ‰ä¸€ä¸ªç”¨åˆ°Retentionçš„åœ°æ–¹æ˜¯åœ¨NamespaceBaseç±»ä¸­ï¼Œå¯ä»¥å¯¹å­˜å‚¨åœ¨Zookeeperä¸­çš„Retentioné…ç½®ä¿¡æ¯è¿›è¡Œgetå’Œsetï¼Œå®ƒé€šè¿‡Namespacesç±»ä¸­çš„Restfulæ¥å£å¯¹å¤–æä¾›æœåŠ¡ï¼Œclientä¸­çš„cmd/namepacesä¹Ÿæ˜¯é€šè¿‡è°ƒç”¨Restfulæ¥å£å®ç°çš„å¯¹Brokerç«¯çš„é…ç½®çš„ä¿®æ”¹ã€‚ Retention å±äº Namespace çº§åˆ«çš„é…ç½®ï¼ŒNamespace åªæ˜¯ä¸€ä¸ªé€»è¾‘ä¸Šçš„æ¦‚å¿µï¼Œå…·ä½“æ¶ˆæ¯çš„å­˜å‚¨æ˜¯é€šè¿‡ Ledger è¿›è¡Œçš„ï¼ˆLedger æ˜¯ Pulsar ä¸­å¢åŠ åˆ é™¤æŒä¹…åŒ–ä¿¡æ¯çš„æœ€å°å•ä½ï¼‰ï¼Œæ‰€ä»¥ Retention è¿™ä¸€ç‰¹æ€§ä¹Ÿæ˜¯æœ‰ Ledger éƒ¨åˆ†å®ç°çš„ã€‚","raw":null,"content":null,"categories":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://fxbing.github.io/categories/%E6%8A%80%E6%9C%AF/"}],"tags":[{"name":"Pulsar","slug":"Pulsar","permalink":"http://fxbing.github.io/tags/Pulsar/"}]},{"title":"Hello World, Hello Blog","slug":"2019-05-09-hello-2019","date":"2019-05-08T16:00:00.000Z","updated":"2019-05-08T16:00:00.000Z","comments":true,"path":"2019/05/09/2019-05-09-hello-2019/","link":"","permalink":"http://fxbing.github.io/2019/05/09/2019-05-09-hello-2019/","excerpt":"","text":"å¼€é—¨å•¦ ä¸‡äº‹å¼€å¤´éš¾ æˆ‘çš„åšå®¢ç»ˆäºå¼€é€šäº†ï¼Œä¹‹åä¼šåœ¨è¿™é‡Œå†™ä¸€äº›ä¸œè¥¿ï¼Œå¯èƒ½æ˜¯ä¸€äº›æƒ³æ³•ï¼Œå¯èƒ½æ˜¯ä¸€äº›ç¬”è®°ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€äº›æŠ€æœ¯æ–‡ç« ï¼Œæ€»ä¹‹ï¼Œå¸Œæœ›æˆ‘çš„åšå®¢å¯ä»¥å‘å±•èµ·æ¥ï¼ï¼ï¼","raw":null,"content":null,"categories":[{"name":"ç”Ÿæ´»","slug":"ç”Ÿæ´»","permalink":"http://fxbing.github.io/categories/%E7%94%9F%E6%B4%BB/"}],"tags":[{"name":"ç”Ÿæ´»","slug":"ç”Ÿæ´»","permalink":"http://fxbing.github.io/tags/%E7%94%9F%E6%B4%BB/"}]}]}